
 <!DOCTYPE HTML>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  
    <title>Edgar&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Edgar">
    

    
    <meta name="description" content="Android | 全栈工程师">
<meta property="og:type" content="website">
<meta property="og:title" content="Edgar's Blog">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Edgar's Blog">
<meta property="og:description" content="Android | 全栈工程师">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Edgar's Blog">
<meta name="twitter:description" content="Android | 全栈工程师">

    
    <link rel="alternative" href="atom.xml" title="Edgar&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/unnamed4_n_mSY_icon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/profile.png">
    <link rel="apple-touch-icon-precomposed" href="/img/profile.png">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Edgar&#39;s Blog">Edgar&#39;s Blog</a></h1>
				<h2 class="blog-motto">等待执剑少年修炼归来！</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜單">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:yoursite.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/07/29/Android-源码分析之MediaScanner-2/" title="Android 源码分析之MediaScanner[2]" itemprop="url">Android 源码分析之MediaScanner[2]</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Edgar" target="_blank" itemprop="author">Edgar</a>
		
  <p class="article-time">
    <time datetime="2016-07-29T02:40:48.000Z" itemprop="datePublished"> 發表於 2016-07-29</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h4 id="&#x97F3;&#x9891;&#x89C6;&#x9891;&#x6587;&#x4EF6;&#x5E27;&#x4FE1;&#x606F;&#x7684;&#x83B7;&#x53D6;"><a href="#&#x97F3;&#x9891;&#x89C6;&#x9891;&#x6587;&#x4EF6;&#x5E27;&#x4FE1;&#x606F;&#x7684;&#x83B7;&#x53D6;" class="headerlink" title="&#x97F3;&#x9891;&#x89C6;&#x9891;&#x6587;&#x4EF6;&#x5E27;&#x4FE1;&#x606F;&#x7684;&#x83B7;&#x53D6;"></a>&#x97F3;&#x9891;&#x89C6;&#x9891;&#x6587;&#x4EF6;&#x5E27;&#x4FE1;&#x606F;&#x7684;&#x83B7;&#x53D6;</h4><p>&#x4E0A;&#x9762;&#x5206;&#x6790;&#x7684;&#x662F;&#x975E;&#x97F3;&#x9891;&#x89C6;&#x9891;&#x56FE;&#x50CF;&#x6587;&#x4EF6;&#x7684;&#x626B;&#x63CF;&#x6D41;&#x7A0B;&#xFF0C;&#x5728;&#x63A5;&#x4E0B;&#x6765;&#x7684;&#x7AE0;&#x8282;&#x5C06;&#x4ECB;&#x7ECD;&#x591A;&#x5A92;&#x4F53;&#x6587;&#x4EF6;&#x4FE1;&#x606F;&#x7684;&#x83B7;&#x53D6;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x7684;&#x90E8;&#x5206;&#x4EE5;MP3&#x683C;&#x5F0F;&#x7684;&#x97F3;&#x9891;&#x6587;&#x4EF6;&#x4F5C;&#x4E3A;&#x5206;&#x6790;&#x5BF9;&#x8C61;&#x8FDB;&#x884C;&#x4ECB;&#x7ECD;&#xFF1A;<br>&#x5BF9;&#x4E8E;MP3&#x683C;&#x5F0F;&#x5927;&#x5BB6;&#x53EF;&#x4EE5;&#x5728;&#x7F51;&#x4E0A;&#x627E;&#x4E0B;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x5C55;&#x5F00;&#x4ECB;&#x7ECD;&#x4E86;&#x3002;</p>
<h5 id="&#x97F3;&#x9891;&#x89C6;&#x9891;&#x6587;&#x4EF6;&#x7684;TAG&#x89E3;&#x6790;&#x6D41;&#x7A0B;&#x5206;&#x6790;"><a href="#&#x97F3;&#x9891;&#x89C6;&#x9891;&#x6587;&#x4EF6;&#x7684;TAG&#x89E3;&#x6790;&#x6D41;&#x7A0B;&#x5206;&#x6790;" class="headerlink" title="&#x97F3;&#x9891;&#x89C6;&#x9891;&#x6587;&#x4EF6;&#x7684;TAG&#x89E3;&#x6790;&#x6D41;&#x7A0B;&#x5206;&#x6790;"></a>&#x97F3;&#x9891;&#x89C6;&#x9891;&#x6587;&#x4EF6;&#x7684;TAG&#x89E3;&#x6790;&#x6D41;&#x7A0B;&#x5206;&#x6790;</h5><p>&#x5728;doScanFile&#x4E2D;&#x4F1A;&#x6267;&#x884C;&#x5BF9;&#x5E94;&#x7684;&#x5224;&#x65AD;&#xFF0C;&#x5982;&#x679C;&#x5F53;&#x524D;&#x626B;&#x63CF;&#x6587;&#x4EF6;&#x4E3A;&#x97F3;&#x9891;&#x6216;&#x8005;&#x89C6;&#x9891;&#x6587;&#x4EF6;&#x5219;&#x8C03;&#x7528;processFile&#x65B9;&#x6CD5;&#x8FDB;&#x884C;&#x5904;&#x7406;&#x3002;<br><figure class="highlight processing"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Uri doScanFile(<span class="keyword">String</span> path, <span class="keyword">String</span> mimeType, <span class="keyword">long</span> lastModified,<span class="keyword">long</span> fileSize, <span class="built_in">boolean</span> isDirectory, <span class="built_in">boolean</span> scanAlways, <span class="built_in">boolean</span> noMedia) {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        FileEntry entry = beginFile(path, mimeType, lastModified,</span><br><span class="line">                fileSize, isDirectory, noMedia);</span><br><span class="line">        <span class="comment">//......</span></span><br><span class="line">        <span class="keyword">if</span> (entry != <span class="keyword">null</span> &amp;&amp; (entry.mLastModifiedChanged || scanAlways)) {</span><br><span class="line">            <span class="keyword">if</span> (noMedia) {</span><br><span class="line">                <span class="comment">//.........</span></span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">//........</span></span><br><span class="line">                <span class="comment">// &#x5982;&#x679C;&#x662F;&#x97F3;&#x9891;&#x6587;&#x4EF6;&#x6216;&#x8005;&#x89C6;&#x9891;&#x6587;&#x4EF6;&#x8C03;&#x7528;processFile&#x62BD;&#x53D6;&#x5143;&#x6570;&#x636E;</span></span><br><span class="line">                <span class="comment">// we only extract metadata for audio and video files</span></span><br><span class="line">                <span class="keyword">if</span> (isaudio || isvideo) {</span><br><span class="line">                    processFile(path, mimeType, <span class="keyword">this</span>);</span><br><span class="line">                }</span><br><span class="line">                <span class="comment">//.........</span></span><br><span class="line">                result = endFile(entry, ringtones, notifications, alarms, music, podcasts);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (RemoteException e) {</span><br><span class="line">        <span class="comment">//...................</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x5728;doScanFile&#x8C03;&#x7528;&#x7684;processFile&#x662F;native&#x65B9;&#x6CD5;&#xFF0C;<br>&#x56E0;&#x6B64;&#x9996;&#x5148;&#x8C03;&#x7528;android_media_Mediascanner.cpp.&#x4E2D;&#x7684;android_media_MediaScanner_processFile&#x65B9;&#x6CD5;&#xFF0C;&#x5728;&#x8BE5;&#x65B9;&#x6CD5;&#x4E2D;&#x5C31;&#x76F4;&#x63A5;&#x8C03;&#x7528;StageFrightMediaScanner&#x7684;processFile&#x65B9;&#x6CD5;&#x3002;<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line"><span class="title">android_media_MediaScanner_processFile</span><span class="params">(</span><br><span class="line">        JNIEnv *env, jobject thiz, jstring path,</span><br><span class="line">        jstring mimeType, jobject client)</span></span><br><span class="line"></span>{</span><br><span class="line">    MediaScanner *mp = getNativeScanner_l(env, thiz);</span><br><span class="line">    <span class="comment">//........</span></span><br><span class="line">    <span class="comment">//&#x83B7;&#x53D6;MimeType</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *mimeTypeStr = (mimeType ? env-&gt;GetStringUTFChars(mimeType, <span class="literal">NULL</span>) : <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">//...........</span></span><br><span class="line">    <span class="function">MyMediaScannerClient <span class="title">myClient</span><span class="params">(env, client)</span></span>;</span><br><span class="line">    <span class="comment">//&#x8C03;&#x7528;StageFrightMediaScanner&#x7684;processFile&#x65B9;&#x6CD5;</span></span><br><span class="line">    MediaScanResult result = mp-&gt;processFile(pathStr, mimeTypeStr, myClient);</span><br><span class="line">    <span class="comment">//..........</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x6211;&#x4EEC;&#x5148;&#x6765;&#x770B;&#x4E0B;getNativeScanner_l&#xFF1A;<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> MediaScanner *<span class="title">getNativeScanner_l</span><span class="params">(JNIEnv* env, jobject thiz)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> (MediaScanner *) env-&gt;GetLongField(thiz, fields.context);</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x5B83;&#x662F;&#x5C06;fields.context&#x8F6C;&#x6362;&#x4E3A;MediaScanner&#xFF0C;fields.context&#x8FD9;&#x4E2A;&#x662F;&#x600E;&#x4E48;&#x6765;&#x7684;&#x8FD8;&#x8BB0;&#x5F97;&#x5427;&#xFF1A;<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line"><span class="title">android_media_MediaScanner_native_setup</span><span class="params">(JNIEnv *env, jobject thiz)</span></span><br><span class="line"></span>{</span><br><span class="line">    ALOGV(<span class="string">&quot;native_setup&quot;</span>);</span><br><span class="line">    MediaScanner *mp = <span class="keyword">new</span> StagefrightMediaScanner;</span><br><span class="line">    <span class="comment">//..............</span></span><br><span class="line">    env-&gt;SetLongField(thiz, fields.context, (jlong)mp);</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x7684;getNativeScanner_l&#x8FD4;&#x56DE;&#x7684;&#x662F;StagefrightMediaScanner<br>&#x800C;&#x5728;StagefrightMediaScanner&#x7684;processFile&#x65B9;&#x6CD5;&#x4E2D;&#x5219;&#x76F4;&#x63A5;&#x8C03;&#x7528;MediaScannerClient&#x7C7B;&#x4E2D;&#x7684;beginFile&#x4EE5;&#x53CA;endFile&#x65B9;&#x6CD5;&#x8FD8;&#x6709;StagefrightMediaScanner &#x7684;processFileInternal&#x65B9;&#x6CD5;&#x3002;<br><figure class="highlight nimrod"><table><tr><td class="code"><pre><span class="line"><span class="type">MediaScanResult</span> <span class="type">StagefrightMediaScanner</span>::processFile(</span><br><span class="line">        <span class="keyword">const</span> <span class="type">char</span> *path, <span class="keyword">const</span> <span class="type">char</span> *mimeType,</span><br><span class="line">        <span class="type">MediaScannerClient</span> &amp;client) {</span><br><span class="line">    <span class="type">ALOGV</span>(<span class="string">&quot;processFile &apos;%s&apos;.&quot;</span>, path);</span><br><span class="line"></span><br><span class="line">    client.setLocale(locale());</span><br><span class="line">    //client = <span class="type">MyMediaScannerClient</span></span><br><span class="line">    client.beginFile();</span><br><span class="line">    <span class="type">MediaScanResult</span> <span class="literal">result</span> = processFileInternal(path, mimeType, client);</span><br><span class="line">    client.endFile();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x6211;&#x4EEC;&#x5148;&#x6765;&#x770B;&#x4E0B;MyMediaScannerClient::beginFile<br><figure class="highlight processing"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> FileEntry beginFile(<span class="keyword">String</span> path, <span class="keyword">String</span> mimeType, <span class="keyword">long</span> lastModified,</span><br><span class="line">        <span class="keyword">long</span> fileSize, <span class="built_in">boolean</span> isDirectory, <span class="built_in">boolean</span> noMedia) {</span><br><span class="line">    mMimeType = mimeType;</span><br><span class="line">    mFileType = <span class="number">0</span>;</span><br><span class="line">    mFileSize = fileSize;</span><br><span class="line">    mIsDrm = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isDirectory) {</span><br><span class="line">        <span class="keyword">if</span> (!noMedia &amp;&amp; isNoMediaFile(path)) {</span><br><span class="line">            noMedia = <span class="keyword">true</span>;</span><br><span class="line">        }</span><br><span class="line">        mNoMedia = noMedia;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// try mimeType first, if it is specified</span></span><br><span class="line">        <span class="keyword">if</span> (mimeType != <span class="keyword">null</span>) {</span><br><span class="line">            mFileType = MediaFile.getFileTypeForMimeType(mimeType);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// if mimeType was not specified, compute file type based on file extension.</span></span><br><span class="line">        <span class="keyword">if</span> (mFileType == <span class="number">0</span>) {</span><br><span class="line">            MediaFile.MediaFileType mediaFileType = MediaFile.getFileType(path);</span><br><span class="line">            <span class="keyword">if</span> (mediaFileType != <span class="keyword">null</span>) {</span><br><span class="line">                mFileType = mediaFileType.fileType;</span><br><span class="line">                <span class="keyword">if</span> (mMimeType == <span class="keyword">null</span>) {</span><br><span class="line">                    mMimeType = mediaFileType.mimeType;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isDrmEnabled() &amp;&amp; MediaFile.isDrmFileType(mFileType)) {</span><br><span class="line">            mFileType = getFileTypeFromDrm(path);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    FileEntry entry = makeEntryFor(path);</span><br><span class="line">    <span class="comment">// add some slack to avoid a rounding error</span></span><br><span class="line">    <span class="keyword">long</span> delta = (entry != <span class="keyword">null</span>) ? (lastModified - entry.mLastModified) : <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">boolean</span> wasModified = delta &gt; <span class="number">1</span> || delta &lt; -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (entry == <span class="keyword">null</span> || wasModified) {</span><br><span class="line">        <span class="keyword">if</span> (wasModified) {</span><br><span class="line">            entry.mLastModified = lastModified;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            entry = <span class="keyword">new</span> FileEntry(<span class="number">0</span>, path, lastModified,</span><br><span class="line">                    (isDirectory ? MtpConstants.FORMAT_ASSOCIATION : <span class="number">0</span>));</span><br><span class="line">        }</span><br><span class="line">        entry.mLastModifiedChanged = <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mProcessPlaylists &amp;&amp; MediaFile.isPlayListFileType(mFileType)) {</span><br><span class="line">        mPlayLists.<span class="built_in">add</span>(entry);</span><br><span class="line">        <span class="comment">// we don&apos;t process playlists in the main scan, so return null</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// clear all the metadata</span></span><br><span class="line">    mArtist = <span class="keyword">null</span>;</span><br><span class="line">    mAlbumArtist = <span class="keyword">null</span>;</span><br><span class="line">    mAlbum = <span class="keyword">null</span>;</span><br><span class="line">    mTitle = <span class="keyword">null</span>;</span><br><span class="line">    mComposer = <span class="keyword">null</span>;</span><br><span class="line">    mGenre = <span class="keyword">null</span>;</span><br><span class="line">    mTrack = <span class="number">0</span>;</span><br><span class="line">    mYear = <span class="number">0</span>;</span><br><span class="line">    mDuration = <span class="number">0</span>;</span><br><span class="line">    mPath = path;</span><br><span class="line">    mLastModified = lastModified;</span><br><span class="line">    mWriter = <span class="keyword">null</span>;</span><br><span class="line">    mCompilation = <span class="number">0</span>;</span><br><span class="line">    mWidth = <span class="number">0</span>;</span><br><span class="line">    mHeight = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> entry;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x4ECE;processFileInternal&#x65B9;&#x6CD5;&#x5F00;&#x59CB;&#x5C31;&#x5F00;&#x59CB;&#x83B7;&#x53D6;&#x97F3;&#x9891;&#x89C6;&#x9891;&#x5185;&#x90E8;&#x7684;&#x6570;&#x636E;&#x4E86;&#xFF0C;&#x5728;processFileInternal&#x4E2D;&#x5BF9;&#x6587;&#x4EF6;&#x7684;&#x5904;&#x7406;&#x5206;&#x5982;&#x4E0B;&#x51E0;&#x4E2A;&#x90E8;&#x5206;&#xFF1A;</p>
<ul>
<li>&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x97F3;&#x9891;&#x89C6;&#x9891;&#x6587;&#x4EF6;&#x7684;&#x6269;&#x5C55;&#x540D;&#xFF0C;&#x770B;&#x662F;&#x5426;&#x662F;&#x5E73;&#x53F0;&#x6240;&#x652F;&#x6301;&#x7684;&#x6587;&#x4EF6;&#x7C7B;&#x578B;&#xFF0C;&#x5982;&#x679C;&#x4E3A;&#x7A7A;&#x6216;&#x8005;&#x4E0D;&#x652F;&#x6301;&#x5C31;&#x8FD4;&#x56DE;MEDIA_SCAN_RESULT_SKIPPED&#x3002;</li>
<li>&#x6839;&#x636E;&#x6587;&#x4EF6;&#x6269;&#x5C55;&#x540D;&#x5224;&#x65AD;&#x5F53;&#x524D;&#x626B;&#x63CF;&#x7684;&#x6587;&#x4EF6;&#x662F;&#x5426;&#x662F;DRM&#x6587;&#x4EF6;&#xFF0C;&#x5982;&#x679C;&#x662F;&#x7684;&#x8BDD;&#x5219;&#x5F00;&#x59CB;&#x83B7;&#x53D6;DRM&#x7684;&#x4FE1;&#x606F;&#x3002;DRM&#x4FE1;&#x606F;&#x662F;&#x901A;&#x8FC7;&#x8C03;&#x7528;drmManagerClient-&gt;getMetadata(&amp;tmp)&#x65B9;&#x6CD5;&#x6765;&#x83B7;&#x53D6;&#x7684;&#xFF0C;&#x83B7;&#x53D6;&#x5230;&#x7684;&#x4FE1;&#x606F;&#x5C01;&#x88C5;&#x5728;DrmMetadata&#x5BF9;&#x8C61;&#x4E2D;&#x3002;&#x8FD9;&#x90E8;&#x5206;&#x5C06;&#x653E;&#x5728;&#x4ECA;&#x540E;&#x7684;DRM&#x90E8;&#x5206;&#x4ECB;&#x7ECD;&#x3002;</li>
<li>&#x83B7;&#x53D6;&#x97F3;&#x9891;&#x89C6;&#x9891;&#x7684;TAG&#x4FE1;&#x606F;&#xFF1A;<br>&#x8FD9;&#x90E8;&#x5206;&#x6700;&#x91CD;&#x8981;&#x7684;&#x662F;&#x5982;&#x4E0B;&#x4E24;&#x4E2A;&#x65B9;&#x6CD5;&#xFF1A;<br>StagefrightMetadataRetriever ::setDataSource<br>StagefrightMetadataRetriever ::extractMetadata</li>
</ul>
<p>&#x8FD9;&#x90E8;&#x5206;&#x4EE3;&#x7801;&#x662F;&#x6BD4;&#x8F83;&#x91CD;&#x8981;&#x7684;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x5C06;&#x5BF9;&#x4E0B;&#x9762;&#x7684;&#x65B9;&#x6CD5;&#x8FDB;&#x884C;&#x8BE6;&#x7EC6;&#x4ECB;&#x7ECD;&#xFF1A;<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">MediaScanResult StagefrightMediaScanner::processFileInternal(</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">const</span> <span class="keyword">char</span> * <span class="comment">/* mimeType */</span>,</span><br><span class="line">        MediaScannerClient &amp;client) {</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//&#x5224;&#x65AD;&#x5F53;&#x524D;&#x6587;&#x4EF6;&#x662F;&#x5426;&#x6709;&#x6269;&#x5C55;&#x540D;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *extension = <span class="built_in">strrchr</span>(path, <span class="string">&apos;.&apos;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!extension) {</span><br><span class="line">        <span class="keyword">return</span> MEDIA_SCAN_RESULT_SKIPPED;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//&#x5224;&#x65AD;&#x5F53;&#x524D;&#x6269;&#x5C55;&#x540D;&#x5341;&#x5206;&#x652F;&#x6301;</span></span><br><span class="line">    <span class="keyword">if</span> (!FileHasAcceptableExtension(extension)) {</span><br><span class="line">        <span class="keyword">return</span> MEDIA_SCAN_RESULT_SKIPPED;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//&#x521B;&#x5EFA;&#x5A92;&#x4F53;&#x62BD;&#x53D6;&#x5668;</span></span><br><span class="line">    sp&lt;MediaMetadataRetriever&gt; mRetriever(<span class="keyword">new</span> MediaMetadataRetriever);</span><br><span class="line">    <span class="comment">//&#x6253;&#x5F00;&#x6587;&#x4EF6;</span></span><br><span class="line">    <span class="keyword">int</span> fd = open(path, O_RDONLY | O_LARGEFILE);</span><br><span class="line">    <span class="keyword">status_t</span> status;</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) {</span><br><span class="line">        <span class="comment">// couldn&apos;t open it locally, maybe the media server can?</span></span><br><span class="line">        <span class="comment">//&#x6253;&#x4E0D;&#x5F00;&#x5C1D;&#x8BD5;&#x4ECE;&#x7F51;&#x7EDC;&#x4E0A;&#x83B7;&#x53D6;</span></span><br><span class="line">        status = mRetriever-&gt;setDataSource(<span class="literal">NULL</span> <span class="comment">/* httpService */</span>, path);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">//&#x8BBE;&#x7F6E;&#x6570;&#x636E;&#x6E90;</span></span><br><span class="line">        status = mRetriever-&gt;setDataSource(fd, <span class="number">0</span>, <span class="number">0x7ffffffffffffff</span>L);</span><br><span class="line">        close(fd);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//&#x62BD;&#x53D6;&#x5A92;&#x4F53;&#x5934;&#x6570;&#x636E;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *value;</span><br><span class="line">    <span class="keyword">if</span> ((value = mRetriever-&gt;extractMetadata(METADATA_KEY_MIMETYPE)) != <span class="literal">NULL</span>) {</span><br><span class="line">        status = client.setMimeType(value);</span><br><span class="line">        <span class="keyword">if</span> (status) {</span><br><span class="line">            <span class="keyword">return</span> MEDIA_SCAN_RESULT_ERROR;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> KeyMap {</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *tag;</span><br><span class="line">        <span class="keyword">int</span> key;</span><br><span class="line">    };</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> KeyMap kKeyMap[] = {</span><br><span class="line">        { <span class="string">&quot;tracknumber&quot;</span>, METADATA_KEY_CD_TRACK_NUMBER },</span><br><span class="line">        { <span class="string">&quot;discnumber&quot;</span>, METADATA_KEY_DISC_NUMBER },</span><br><span class="line">        { <span class="string">&quot;album&quot;</span>, METADATA_KEY_ALBUM },</span><br><span class="line">        { <span class="string">&quot;artist&quot;</span>, METADATA_KEY_ARTIST },</span><br><span class="line">        { <span class="string">&quot;albumartist&quot;</span>, METADATA_KEY_ALBUMARTIST },</span><br><span class="line">        { <span class="string">&quot;composer&quot;</span>, METADATA_KEY_COMPOSER },</span><br><span class="line">        { <span class="string">&quot;genre&quot;</span>, METADATA_KEY_GENRE },</span><br><span class="line">        { <span class="string">&quot;title&quot;</span>, METADATA_KEY_TITLE },</span><br><span class="line">        { <span class="string">&quot;year&quot;</span>, METADATA_KEY_YEAR },</span><br><span class="line">        { <span class="string">&quot;duration&quot;</span>, METADATA_KEY_DURATION },</span><br><span class="line">        { <span class="string">&quot;writer&quot;</span>, METADATA_KEY_WRITER },</span><br><span class="line">        { <span class="string">&quot;compilation&quot;</span>, METADATA_KEY_COMPILATION },</span><br><span class="line">        { <span class="string">&quot;isdrm&quot;</span>, METADATA_KEY_IS_DRM },</span><br><span class="line">        { <span class="string">&quot;width&quot;</span>, METADATA_KEY_VIDEO_WIDTH },</span><br><span class="line">        { <span class="string">&quot;height&quot;</span>, METADATA_KEY_VIDEO_HEIGHT },</span><br><span class="line">    };</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">size_t</span> kNumEntries = <span class="keyword">sizeof</span>(kKeyMap) / <span class="keyword">sizeof</span>(kKeyMap[<span class="number">0</span>]);</span><br><span class="line">    <span class="comment">//&#x6309;&#x7167;kKeyMap&#x8868;&#x683C;&#x7684;&#x987A;&#x5E8F;&#x4ECE;&#x5A92;&#x4F53;&#x6587;&#x4EF6;&#x4E2D;&#x83B7;&#x53D6;TAG&#x5E76;&#x6DFB;&#x52A0;&#x5230;client&#x4E2D;</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; kNumEntries; ++i) {</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *value;</span><br><span class="line">        <span class="keyword">if</span> ((value = mRetriever-&gt;extractMetadata(kKeyMap[i].key)) != <span class="literal">NULL</span>) {</span><br><span class="line">            status = client.addStringTag(kKeyMap[i].tag, value);</span><br><span class="line">            <span class="keyword">if</span> (status != OK) {</span><br><span class="line">                <span class="keyword">return</span> MEDIA_SCAN_RESULT_ERROR;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> MEDIA_SCAN_RESULT_OK;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x6211;&#x4EEC;&#x5148;&#x6765;&#x770B;&#x4E0B;&#x80FD;&#x591F;&#x652F;&#x6301;&#x7684;&#x5A92;&#x4F53;&#x683C;&#x5F0F;&#xFF1A;<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">FileHasAcceptableExtension</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *extension)</span> </span>{</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *kValidExtensions[] = {</span><br><span class="line">        <span class="string">&quot;.mp3&quot;</span>, <span class="string">&quot;.mp4&quot;</span>, <span class="string">&quot;.m4a&quot;</span>, <span class="string">&quot;.3gp&quot;</span>, <span class="string">&quot;.3gpp&quot;</span>, <span class="string">&quot;.3g2&quot;</span>, <span class="string">&quot;.3gpp2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;.mpeg&quot;</span>, <span class="string">&quot;.ogg&quot;</span>, <span class="string">&quot;.mid&quot;</span>, <span class="string">&quot;.smf&quot;</span>, <span class="string">&quot;.imy&quot;</span>, <span class="string">&quot;.wma&quot;</span>, <span class="string">&quot;.aac&quot;</span>,</span><br><span class="line">        <span class="string">&quot;.wav&quot;</span>, <span class="string">&quot;.amr&quot;</span>, <span class="string">&quot;.midi&quot;</span>, <span class="string">&quot;.xmf&quot;</span>, <span class="string">&quot;.rtttl&quot;</span>, <span class="string">&quot;.rtx&quot;</span>, <span class="string">&quot;.ota&quot;</span>,</span><br><span class="line">        <span class="string">&quot;.mkv&quot;</span>, <span class="string">&quot;.mka&quot;</span>, <span class="string">&quot;.webm&quot;</span>, <span class="string">&quot;.ts&quot;</span>, <span class="string">&quot;.fl&quot;</span>, <span class="string">&quot;.flac&quot;</span>, <span class="string">&quot;.mxmf&quot;</span>,</span><br><span class="line">        <span class="string">&quot;.avi&quot;</span>, <span class="string">&quot;.mpeg&quot;</span>, <span class="string">&quot;.mpg&quot;</span>, <span class="string">&quot;.awb&quot;</span>, <span class="string">&quot;.mpga&quot;</span></span><br><span class="line">    };</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">size_t</span> kNumValidExtensions =</span><br><span class="line">        <span class="keyword">sizeof</span>(kValidExtensions) / <span class="keyword">sizeof</span>(kValidExtensions[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; kNumValidExtensions; ++i) {</span><br><span class="line">        <span class="keyword">if</span> (!strcasecmp(extension, kValidExtensions[i])) {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x6211;&#x4EEC;&#x770B;&#x4E0B;setDataSource&#xFF0C;&#x5B83;&#x9996;&#x5148;&#x4F1A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;FileSource&#x3002;</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="function"><span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(FileDescriptor fd, <span class="keyword">long</span> offset, <span class="keyword">long</span> length)</span></span><br><span class="line">        <span class="keyword">throws</span> IllegalArgumentException</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5728;setDataSource&#x4E2D;&#x6211;&#x4EEC;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;FileSource&#x5E76;&#x5C06;&#x5176;&#x4F20;&#x9012;&#x5230;MediaExtractor::Create&#x4E2D;&#x6839;&#x636E;FileSource&#x6765;&#x521B;&#x5EFA;&#x51FA;&#x5408;&#x9002;&#x7684;MediaExtractor<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">status_t</span> StagefrightMetadataRetriever::setDataSource(<span class="keyword">int</span> fd, <span class="keyword">int64_t</span> offset, <span class="keyword">int64_t</span> length) {</span><br><span class="line">    fd = dup(fd);</span><br><span class="line">    ALOGV(<span class="string">&quot;setDataSource(%d, %&quot;</span> PRId64 <span class="string">&quot;, %&quot;</span> PRId64 <span class="string">&quot;)&quot;</span>, fd, offset, length);</span><br><span class="line">    clearMetadata();</span><br><span class="line">    mSource = <span class="keyword">new</span> FileSource(fd, offset, length);</span><br><span class="line">    <span class="keyword">status_t</span> err;</span><br><span class="line">    <span class="comment">//&#x68C0;&#x67E5;&#x662F;&#x5426;&#x6253;&#x5F00;&#x6587;&#x4EF6;&#x6210;&#x529F;</span></span><br><span class="line">    <span class="keyword">if</span> ((err = mSource-&gt;initCheck()) != OK) {</span><br><span class="line">        mSource.clear();</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//&#x5C06;FileSource&#x4F20;&#x5165;&#x540E;&#x6839;&#x636E;FileSource&#x7684;&#x4FE1;&#x606F;&#x521B;&#x5EFA;&#x51FA;&#x5408;&#x9002;&#x7684;MediaExtractor</span></span><br><span class="line">    mExtractor = MediaExtractor::Create(mSource);</span><br><span class="line">    <span class="keyword">if</span> (mExtractor == <span class="literal">NULL</span>) {</span><br><span class="line">        mSource.clear();</span><br><span class="line">        <span class="keyword">return</span> UNKNOWN_ERROR;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x6211;&#x4EEC;&#x63A5;&#x4E0B;&#x6765;&#x770B;&#x4E0B;&#x662F;&#x5982;&#x4F55;&#x521B;&#x5EFA;&#x5BF9;&#x5E94;&#x7684;MediaExtractor&#x7684;&#xFF0C;&#x9996;&#x5148;&#x4F1A;&#x5148;&#x8C03;&#x7528;DataSource&#x7684;sniff&#xFF0C;&#x5728;DataSource&#x7684;sniff&#x4E2D;&#x4F1A;&#x8C03;&#x7528;&#x6BCF;&#x4E2A;&#x6CE8;&#x518C;&#x7684;Sniffers&#x5BF9;&#x5176;&#x8FDB;&#x884C;&#x63A2;&#x6D4B;&#xFF0C;&#x6765;&#x9009;&#x51FA;&#x6700;&#x5339;&#x914D;&#x7684;&#x3002;&#x4EE5;mimetype&#x5F62;&#x5F0F;&#x8FD4;&#x56DE;&#x3002;&#x6839;&#x636E;&#x8FD4;&#x56DE;&#x7684;mimetype&#x521B;&#x5EFA;MediaExtractor<br><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"><span class="comment">// static</span></span><br><span class="line">sp&lt;MediaExtractor&gt; MediaExtractor::Create(const sp&lt;DataSource&gt; &amp;<span class="keyword">source</span>, const <span class="keyword">char</span> *mime) {</span><br><span class="line">    sp&lt;AMessage&gt; meta;</span><br><span class="line">    String8 tmp;</span><br><span class="line">    <span class="keyword">if</span> (mime == <span class="keyword">NULL</span>) {</span><br><span class="line">        <span class="keyword">float</span> confidence;</span><br><span class="line">        <span class="comment">//&#x9996;&#x5148;&#x6211;&#x4EEC;&#x4F1A;&#x8C03;&#x7528;DataSource&#x7684;sniff</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">source</span>-&gt;sniff(&amp;tmp, &amp;confidence, &amp;meta)) {</span><br><span class="line">            ALOGV(<span class="string">&quot;FAILED to autodetect media content.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">NULL</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        mime = tmp.string();</span><br><span class="line">        ALOGV(<span class="string">&quot;Autodetected media content as &apos;%s&apos; with confidence %.2f&quot;</span>,</span><br><span class="line">             mime, confidence);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    bool isDrm = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// DRM MIME type syntax is &quot;drm+type+original&quot; where</span></span><br><span class="line">    <span class="comment">// type is &quot;es_based&quot; or &quot;container_based&quot; and</span></span><br><span class="line">    <span class="comment">// original is the content&apos;s cleartext MIME type</span></span><br><span class="line">    <span class="keyword">if</span> (!strncmp(mime, <span class="string">&quot;drm+&quot;</span>, <span class="number">4</span>)) {</span><br><span class="line">        const <span class="keyword">char</span> *originalMime = strchr(mime+<span class="number">4</span>, <span class="string">&apos;+&apos;</span>);</span><br><span class="line">        <span class="keyword">if</span> (originalMime == <span class="keyword">NULL</span>) {</span><br><span class="line">            <span class="comment">// second + not found</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">NULL</span>;</span><br><span class="line">        }</span><br><span class="line">        ++originalMime;</span><br><span class="line">        <span class="keyword">if</span> (!strncmp(mime, <span class="string">&quot;drm+es_based+&quot;</span>, <span class="number">13</span>)) {</span><br><span class="line">            <span class="comment">// DRMExtractor sets container metadata kKeyIsDRM to 1</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> DRMExtractor(<span class="keyword">source</span>, originalMime);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (!strncmp(mime, <span class="string">&quot;drm+container_based+&quot;</span>, <span class="number">20</span>)) {</span><br><span class="line">            mime = originalMime;</span><br><span class="line">            isDrm = <span class="keyword">true</span>;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">NULL</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    MediaExtractor *ret = <span class="keyword">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_CONTAINER_MPEG4)</span><br><span class="line">            || !strcasecmp(mime, <span class="string">&quot;audio/mp4&quot;</span>)) {</span><br><span class="line">        ret = <span class="keyword">new</span> MPEG4Extractor(<span class="keyword">source</span>);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_AUDIO_MPEG)) {</span><br><span class="line">        ret = <span class="keyword">new</span> MP3Extractor(<span class="keyword">source</span>, meta);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_AUDIO_AMR_NB)</span><br><span class="line">            || !strcasecmp(mime, MEDIA_MIMETYPE_AUDIO_AMR_WB)) {</span><br><span class="line">        ret = <span class="keyword">new</span> AMRExtractor(<span class="keyword">source</span>);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_AUDIO_FLAC)) {</span><br><span class="line">        ret = <span class="keyword">new</span> FLACExtractor(<span class="keyword">source</span>);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_CONTAINER_WAV)) {</span><br><span class="line">        ret = <span class="keyword">new</span> WAVExtractor(<span class="keyword">source</span>);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_CONTAINER_OGG)) {</span><br><span class="line">        ret = <span class="keyword">new</span> OggExtractor(<span class="keyword">source</span>);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_CONTAINER_MATROSKA)) {</span><br><span class="line">        ret = <span class="keyword">new</span> MatroskaExtractor(<span class="keyword">source</span>);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_CONTAINER_MPEG2TS)) {</span><br><span class="line">        ret = <span class="keyword">new</span> MPEG2TSExtractor(<span class="keyword">source</span>);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_CONTAINER_WVM)) {</span><br><span class="line">        <span class="comment">// Return now.  WVExtractor should not have the DrmFlag set in the block below.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WVMExtractor(<span class="keyword">source</span>);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_AUDIO_AAC_ADTS)) {</span><br><span class="line">        ret = <span class="keyword">new</span> AACExtractor(<span class="keyword">source</span>, meta);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_CONTAINER_MPEG2PS)) {</span><br><span class="line">        ret = <span class="keyword">new</span> MPEG2PSExtractor(<span class="keyword">source</span>);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_AUDIO_MIDI)) {</span><br><span class="line">        ret = <span class="keyword">new</span> MidiExtractor(<span class="keyword">source</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="keyword">NULL</span>) {</span><br><span class="line">       <span class="keyword">if</span> (isDrm) {</span><br><span class="line">           ret-&gt;setDrmFlag(<span class="keyword">true</span>);</span><br><span class="line">       } <span class="keyword">else</span> {</span><br><span class="line">           ret-&gt;setDrmFlag(<span class="keyword">false</span>);</span><br><span class="line">       }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x4E0B;&#x9762;&#x662F;sniff&#x65B9;&#x6CD5;&#x3002;<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">bool</span> DataSource::sniff(String8 *mimeType, <span class="keyword">float</span> *confidence, sp&lt;AMessage&gt; *meta) {</span><br><span class="line">    *mimeType = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    *confidence = <span class="number">0.0f</span>;</span><br><span class="line">    meta-&gt;clear();</span><br><span class="line">    {</span><br><span class="line">        Mutex::<span class="function">Autolock <span class="title">autoLock</span><span class="params">(gSnifferMutex)</span></span>;</span><br><span class="line">        <span class="keyword">if</span> (!gSniffersRegistered) {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span> (List&lt;SnifferFunc&gt;::iterator it = gSniffers.begin();</span><br><span class="line">         it != gSniffers.end(); ++it) {</span><br><span class="line">        String8 newMimeType;</span><br><span class="line">        <span class="keyword">float</span> newConfidence;</span><br><span class="line">        sp&lt;AMessage&gt; newMeta;</span><br><span class="line">        <span class="comment">//&#x8C03;&#x7528;&#x5404;&#x79CD;&#x55C5;&#x63A2;&#x5668;&#x7684;&#x65B9;&#x6CD5;&#x83B7;&#x53D6;&#x7C7B;&#x578B;&#x548C;&#x53EF;&#x4FE1;&#x5EA6;</span></span><br><span class="line">        <span class="keyword">if</span> ((*it)(<span class="keyword">this</span>, &amp;newMimeType, &amp;newConfidence, &amp;newMeta)) {</span><br><span class="line">            <span class="keyword">if</span> (newConfidence &gt; *confidence) {</span><br><span class="line">                *mimeType = newMimeType;</span><br><span class="line">                *confidence = newConfidence;</span><br><span class="line">                *meta = newMeta;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> *confidence &gt; <span class="number">0.0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x8FD9;&#x4E9B;sniff&#x662F;&#x5728;StagefrightMetadataRetriever&#x521B;&#x5EFA;&#x7684;&#x65F6;&#x5019;&#x6CE8;&#x518C;&#x7684;&#xFF1A;<br><figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line">StagefrightMetadataRetriever::StagefrightMetadataRetriever()</span><br><span class="line">    : mParsedMetaData(<span class="keyword">false</span>),</span><br><span class="line">      mAlbumArt(NULL) {</span><br><span class="line">    <span class="comment">//&#x6CE8;&#x518C;&#x9ED8;&#x8BA4;&#x7684;&#x97F3;&#x9891;&#x683C;&#x5F0F;&#x55C5;&#x63A2;&#x5668;</span></span><br><span class="line">    DataSource::RegisterDefaultSniffers();</span><br><span class="line">    CHECK_EQ(mClient.connect(), (status_t)OK);</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x4E0B;&#x9762;&#x662F;&#x6CE8;&#x518C;&#x7684;sniff<br><figure class="highlight dns"><table><tr><td class="code"><pre><span class="line">//static</span><br><span class="line">void DataSour<span class="number">ce::</span>RegisterDefaultSniffers() {</span><br><span class="line">    Mutex<span class="number">::A</span>utolock autoLock(gSnifferMutex)<span class="comment">;</span></span><br><span class="line">    if (gSniffersRegistered) {</span><br><span class="line">        return<span class="comment">;</span></span><br><span class="line">    }</span><br><span class="line">    RegisterSniffer_l(SniffMPEG4)<span class="comment">;</span></span><br><span class="line">    RegisterSniffer_l(SniffMatroska)<span class="comment">;</span></span><br><span class="line">    RegisterSniffer_l(SniffOgg)<span class="comment">;</span></span><br><span class="line">    RegisterSniffer_l(SniffWAV)<span class="comment">;</span></span><br><span class="line">    RegisterSniffer_l(SniffFLAC)<span class="comment">;</span></span><br><span class="line">    RegisterSniffer_l(SniffAMR)<span class="comment">;</span></span><br><span class="line">    RegisterSniffer_l(SniffMPEG2TS)<span class="comment">;</span></span><br><span class="line">    RegisterSniffer_l(SniffMP3)<span class="comment">;</span></span><br><span class="line">    RegisterSniffer_l(SniffAAC)<span class="comment">;</span></span><br><span class="line">    RegisterSniffer_l(SniffMPEG2PS)<span class="comment">;</span></span><br><span class="line">    RegisterSniffer_l(SniffWVM)<span class="comment">;</span></span><br><span class="line">    RegisterSniffer_l(SniffMidi)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    char value[PROPERTY_VALUE_MAX]<span class="comment">;</span></span><br><span class="line">    if (property_get(&quot;drm.service.enabled&quot;, value, NULL)</span><br><span class="line">            &amp;&amp; (!strcmp(value, &quot;1&quot;) || !strcasecmp(value, &quot;true&quot;))) {</span><br><span class="line">        RegisterSniffer_l(SniffDRM)<span class="comment">;</span></span><br><span class="line">    }</span><br><span class="line">    gSniffersRegistered = true<span class="comment">;</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x90A3;&#x4E48;sniff&#x53C8;&#x662F;&#x600E;&#x6837;&#x5B8C;&#x6210;&#x6587;&#x4EF6;&#x7C7B;&#x578B;&#x5224;&#x65AD;&#x7684;&#x4EFB;&#x52A1;&#x7684;&#x5462;&#xFF1F;&#x6211;&#x4EEC;&#x770B;&#x5230;&#x4E0A;&#x9762;&#x7684;RegisterDefaultSniffers&#x6211;&#x4EEC;&#x4EE5;MP3&#x4E3A;&#x4F8B;&#x5B50;&#xFF0C;&#x90A3;&#x4E48;&#x4F7F;&#x7528;&#x7684;sniff&#x4E3A;SniffMP3<br>&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x53EA;&#x5173;&#x6CE8;MP3&#x7684;sniff&#x2013;SniffMP3&#x3002;SniffMP3&#x9996;&#x5148;&#x4F1A;&#x8C03;&#x7528;Resync&#x65B9;&#x6CD5;&#x5BF9;&#x97F3;&#x4E50;&#x5185;&#x5BB9;&#x5E27;&#x7684;&#x5E27;&#x5934;&#x8FDB;&#x884C;&#x91CD;&#x65B0;&#x91CD;&#x5B9A;&#x4F4D;&#xFF0C;&#x5B83;&#x4F1A;&#x5728;&#x97F3;&#x4E50;&#x5185;&#x5BB9;&#x5E27;&#x5185;&#x5BF9;&#x5E27;&#x5934;&#x8FDB;&#x884C;&#x641C;&#x7D22;&#xFF1A;&#x6BCF;&#x6B21;&#x8BFB;&#x5165;1024&#x5B57;&#x8282;&#x7684;&#x5185;&#x5BB9;&#x5230;&#x5F85;&#x68C0;&#x6D4B;&#x7F13;&#x51B2;&#x533A;&#xFF0C;&#x518D;&#x4ECE;&#x7F13;&#x51B2;&#x533A;&#x4E2D;&#x6BCF;&#x6B21;&#x8BFB;&#x53D6;4&#x4E2A;&#x5B57;&#x8282;32&#x4F4D;&#x8FDB;&#x884C;&#x5339;&#x914D;&#xFF0C;&#x5982;&#x679C;&#x627E;&#x5230;&#x5339;&#x914D;&#x7684;&#x8BDD;&#x8FD8;&#x4F1A;&#x8BFB;&#x5165;&#x540E;&#x7EED;&#x7684;&#x8FDE;&#x7EED;3&#x4E2A;&#x5E27;&#x7684;&#x5E27;&#x5934;&#x6570;&#x636E;&#x8FDB;&#x884C;&#x68C0;&#x6D4B;&#x3002;&#x5982;&#x679C;4&#x6B21;&#x68C0;&#x6D4B;&#x5747;&#x6210;&#x529F;&#x7684;&#x8BDD;&#x5C06;&#x5F53;&#x524D;&#x4F4D;&#x7F6E;&#x4F5C;&#x4E3A;&#x97F3;&#x4E50;&#x5185;&#x5BB9;&#x5E27;&#x7684;&#x8D77;&#x59CB;&#x4F4D;&#x7F6E;&#x8FD4;&#x56DE;&#xFF0C;&#x68C0;&#x6D4B;&#x8FC7;&#x7A0B;&#x662F;&#x901A;&#x8FC7;GetMPEGAudioFrameSize&#x65B9;&#x6CD5;&#x6765;&#x5B8C;&#x6210;&#x7684;&#xFF0C;&#x5982;&#x679C;&#x5F53;&#x524D;&#x5F85;&#x68C0;&#x6D4B;&#x7F13;&#x51B2;&#x533A;&#x5185;&#x6570;&#x636E;&#x6CA1;&#x6709;&#x5339;&#x914D;&#x7684;&#x5219;&#x518D;&#x6B21;&#x8BFB;&#x5165;&#x6570;&#x636E;&#x5230;&#x7F13;&#x51B2;&#x533A;&#x76F4;&#x5230;&#x68C0;&#x6D4B;&#x7684;&#x4F4D;&#x7F6E;&#x8FBE;&#x5230;&#x6700;&#x5927;&#x68C0;&#x6D4B;&#x5B57;&#x8282;&#x6570;128*1024&#x5B57;&#x8282;&#x4E3A;&#x6B62;&#x3002;</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">SniffMP3</span><span class="params">(<span class="keyword">const</span> sp&lt;DataSource&gt; &amp;source, String8 *mimeType,</span><br><span class="line">        <span class="keyword">float</span> *confidence, sp&lt;AMessage&gt; *meta)</span> </span>{</span><br><span class="line">    <span class="keyword">off64_t</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">off64_t</span> post_id3_pos;</span><br><span class="line">    <span class="keyword">uint32_t</span> header;</span><br><span class="line">    <span class="keyword">if</span> (!Resync(source, <span class="number">0</span>, &amp;pos, &amp;post_id3_pos, &amp;header)) {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    *meta = <span class="keyword">new</span> AMessage;</span><br><span class="line">    (*meta)-&gt;setInt64(<span class="string">&quot;offset&quot;</span>, pos);</span><br><span class="line">    (*meta)-&gt;setInt32(<span class="string">&quot;header&quot;</span>, header);</span><br><span class="line">    (*meta)-&gt;setInt64(<span class="string">&quot;post-id3-offset&quot;</span>, post_id3_pos);</span><br><span class="line"></span><br><span class="line">    *mimeType = MEDIA_MIMETYPE_AUDIO_MPEG;</span><br><span class="line">    *confidence = <span class="number">0.2f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">Resync</span><span class="params">(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;DataSource&gt; &amp;source, uint32_t match_header,</span><br><span class="line">        off64_t *inout_pos, off64_t *post_id3_pos, uint32_t *out_header)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (post_id3_pos != <span class="literal">NULL</span>) {</span><br><span class="line">        *post_id3_pos = <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//&#x8DF3;&#x8FC7;&#x6807;&#x9898;&#x5E27;&#x7684;&#x4F4D;&#x7F6E;&#x5F00;&#x59CB;&#x540C;&#x6B65;&#x3002;</span></span><br><span class="line">    <span class="keyword">if</span> (*inout_pos == <span class="number">0</span>) {</span><br><span class="line">        <span class="comment">// Skip an optional ID3 header if syncing at the very beginning</span></span><br><span class="line">        <span class="comment">// of the datasource.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (;;) {</span><br><span class="line">            <span class="keyword">uint8_t</span> id3header[<span class="number">10</span>];</span><br><span class="line">            <span class="comment">//&#x8BFB;&#x53D6;&#x5934;10&#x4E2A;&#x5B57;&#x8282;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x591F;10&#x4E2A;&#x5B57;&#x8282;&#x8868;&#x793A;&#x5B58;&#x5728;&#x9519;&#x8BEF;&#x8FD4;&#x56DE;false</span></span><br><span class="line">            <span class="keyword">if</span> (source-&gt;readAt(*inout_pos, id3header, <span class="keyword">sizeof</span>(id3header))</span><br><span class="line">                    &lt; (<span class="keyword">ssize_t</span>)<span class="keyword">sizeof</span>(id3header)) {</span><br><span class="line">                <span class="comment">// If we can&apos;t even read these 10 bytes, we might as well bail</span></span><br><span class="line">                <span class="comment">// out, even if there _were_ 10 bytes of valid mp3 audio data...</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">//&#x5982;&#x679C;&#x5934;3&#x4E2A;&#x5B57;&#x8282;&#x4E0D;&#x662F;ID3&#x9000;&#x51FA;&#x8BE5;&#x5FAA;&#x73AF;</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">memcmp</span>(<span class="string">&quot;ID3&quot;</span>, id3header, <span class="number">3</span>)) {</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Skip the ID3v2 header.</span></span><br><span class="line">            <span class="comment">// &#x83B7;&#x53D6;&#x6807;&#x7B7E;&#x5E27;&#x7684;&#x957F;&#x5EA6;</span></span><br><span class="line">            <span class="keyword">size_t</span> len =</span><br><span class="line">                ((id3header[<span class="number">6</span>] &amp; <span class="number">0x7f</span>) &lt;&lt; <span class="number">21</span>)</span><br><span class="line">                | ((id3header[<span class="number">7</span>] &amp; <span class="number">0x7f</span>) &lt;&lt; <span class="number">14</span>)</span><br><span class="line">                | ((id3header[<span class="number">8</span>] &amp; <span class="number">0x7f</span>) &lt;&lt; <span class="number">7</span>)</span><br><span class="line">                | (id3header[<span class="number">9</span>] &amp; <span class="number">0x7f</span>);</span><br><span class="line"></span><br><span class="line">            len += <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">            *inout_pos += len; <span class="comment">// inout_pos &#x6307;&#x5411;&#x97F3;&#x4E50;&#x5185;&#x5BB9;&#x533A;&#x7684;&#x9996;&#x5730;&#x5740;</span></span><br><span class="line"></span><br><span class="line">            ALOGV(<span class="string">&quot;skipped ID3 tag, new starting offset is %lld (0x%016llx)&quot;</span>,</span><br><span class="line">                    (<span class="keyword">long</span> <span class="keyword">long</span>)*inout_pos, (<span class="keyword">long</span> <span class="keyword">long</span>)*inout_pos);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (post_id3_pos != <span class="literal">NULL</span>) {</span><br><span class="line">            *post_id3_pos = *inout_pos;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">off64_t</span> pos = *inout_pos;</span><br><span class="line">    <span class="keyword">bool</span> valid = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> kMaxReadBytes = <span class="number">1024</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> kMaxBytesChecked = <span class="number">128</span> * <span class="number">1024</span>;</span><br><span class="line">    <span class="keyword">uint8_t</span> buf[kMaxReadBytes];</span><br><span class="line">    <span class="keyword">ssize_t</span> bytesToRead = kMaxReadBytes;</span><br><span class="line">    <span class="keyword">ssize_t</span> totalBytesRead = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">ssize_t</span> remainingBytes = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">bool</span> reachEOS = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">uint8_t</span> *tmp = buf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> {</span><br><span class="line">        <span class="comment">//&#x5982;&#x679C;&#x5F53;&#x524D;&#x7684;&#x626B;&#x63CF;&#x4F4D;&#x7F6E;&#x8D85;&#x8FC7;&#x97F3;&#x4E50;&#x5185;&#x5BB9;&#x533A;&#x7684;kMaxBytesChecked&#xFF08;128K&#xFF09;&#x5C31;&#x505C;&#x6B62;&#x626B;&#x63CF;</span></span><br><span class="line">        <span class="keyword">if</span> (pos &gt;= (<span class="keyword">off64_t</span>)(*inout_pos + kMaxBytesChecked)) {</span><br><span class="line">            <span class="comment">// Don&apos;t scan forever.</span></span><br><span class="line">            ALOGV(<span class="string">&quot;giving up at offset %lld&quot;</span>, (<span class="keyword">long</span> <span class="keyword">long</span>)pos);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//&#x52A0;&#x8F7D;&#x4E00;&#x4E2A;&#x7F13;&#x51B2;&#x533A;&#x7684;&#x5185;&#x5BB9;&#x3002;</span></span><br><span class="line">        <span class="keyword">if</span> (remainingBytes &lt; <span class="number">4</span>) {</span><br><span class="line">            <span class="keyword">if</span> (reachEOS) {</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="built_in">memcpy</span>(buf, tmp, remainingBytes);</span><br><span class="line">                bytesToRead = kMaxReadBytes - remainingBytes;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span><br><span class="line">                 * The next read position should start from the end of</span><br><span class="line">                 * the last buffer, and thus should include the remaining</span><br><span class="line">                 * bytes in the buffer.</span><br><span class="line">                 */</span></span><br><span class="line">                totalBytesRead = source-&gt;readAt(pos + remainingBytes,</span><br><span class="line">                                                buf + remainingBytes,</span><br><span class="line">                                                bytesToRead);</span><br><span class="line">                <span class="keyword">if</span> (totalBytesRead &lt;= <span class="number">0</span>) {</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                }</span><br><span class="line">                reachEOS = (totalBytesRead != bytesToRead);</span><br><span class="line">                totalBytesRead += remainingBytes;</span><br><span class="line">                remainingBytes = totalBytesRead;</span><br><span class="line">                tmp = buf;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//&#x4ECE;tmp&#x7F13;&#x51B2;&#x533A;&#x4E2D;&#x53D6;&#x51FA;&#x5934;</span></span><br><span class="line">        <span class="keyword">uint32_t</span> header = U32_AT(tmp);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (match_header != <span class="number">0</span> &amp;&amp; (header &amp; kMask) != (match_header &amp; kMask)) {</span><br><span class="line">            <span class="comment">//&#x5982;&#x679C;&#x5E27;&#x7684;&#x683C;&#x5F0F;&#x6821;&#x9A8C;&#x5931;&#x8D25;&#x5219;&#x4ECE;&#x5F53;&#x524D;&#x5176;&#x5B9E;&#x4F4D;&#x7F6E;&#x4E0B;&#x4E00;&#x4E2A;&#x4F4D;&#x7F6E;&#x5F00;&#x59CB;&#x83B7;&#x53D6;32&#x5B57;&#x8282;</span></span><br><span class="line">            ++pos;</span><br><span class="line">            ++tmp;</span><br><span class="line">            --remainingBytes;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">size_t</span> frame_size;</span><br><span class="line">        <span class="keyword">int</span> sample_rate, num_channels, bitrate;</span><br><span class="line">        <span class="keyword">if</span> (!GetMPEGAudioFrameSize(</span><br><span class="line">                    header, &amp;frame_size,</span><br><span class="line">                    &amp;sample_rate, &amp;num_channels, &amp;bitrate)) {</span><br><span class="line">            ++pos;</span><br><span class="line">            ++tmp;</span><br><span class="line">            --remainingBytes;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        ALOGV(<span class="string">&quot;found possible 1st frame at %lld (header = 0x%08x)&quot;</span>, (<span class="keyword">long</span> <span class="keyword">long</span>)pos, header);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We found what looks like a valid frame,</span></span><br><span class="line">        <span class="comment">// now find its successors.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">off64_t</span> test_pos = pos + frame_size;</span><br><span class="line"></span><br><span class="line">        valid = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">//&#x518D;&#x8FDE;&#x7EED;&#x8BFB;&#x53D6;3&#x4E09;&#x4E2A;&#x97F3;&#x4E50;&#x5185;&#x5BB9;&#x533A;&#x7684;&#x5E27;&#x5934;&#x8FDB;&#x884C;&#x68C0;&#x67E5;&#xFF0C;&#x5982;&#x679C;&#x90FD;&#x6B63;&#x786E;&#x5C31;&#x9000;&#x51FA;&#x68C0;&#x6D4B;&#xFF0C;&#x5C06;&#x627E;&#x5230;&#x7684;&#x97F3;&#x4E50;&#x5185;&#x5BB9;&#x533A;&#x57DF;&#x7684;&#x4F4D;&#x7F6E;&#x4EE5;&#x53CA;&#x97F3;&#x4E50;&#x5185;&#x5BB9;&#x5E27;&#x7684;&#x5E27;&#x5934;&#x8FD4;&#x56DE;&#x3002;</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">3</span>; ++j) {</span><br><span class="line">            <span class="keyword">uint8_t</span> tmp[<span class="number">4</span>];</span><br><span class="line">            <span class="keyword">if</span> (source-&gt;readAt(test_pos, tmp, <span class="number">4</span>) &lt; <span class="number">4</span>) {</span><br><span class="line">                valid = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">uint32_t</span> test_header = U32_AT(tmp);</span><br><span class="line"></span><br><span class="line">            ALOGV(<span class="string">&quot;subsequent header is %08x&quot;</span>, test_header);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((test_header &amp; kMask) != (header &amp; kMask)) {</span><br><span class="line">                valid = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">size_t</span> test_frame_size;</span><br><span class="line">            <span class="keyword">if</span> (!GetMPEGAudioFrameSize(</span><br><span class="line">                        test_header, &amp;test_frame_size)) {</span><br><span class="line">                valid = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            ALOGV(<span class="string">&quot;found subsequent frame #%d at %lld&quot;</span>, j + <span class="number">2</span>, (<span class="keyword">long</span> <span class="keyword">long</span>)test_pos);</span><br><span class="line"></span><br><span class="line">            test_pos += test_frame_size;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (valid) {</span><br><span class="line">            *inout_pos = pos;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (out_header != <span class="literal">NULL</span>) {</span><br><span class="line">                *out_header = header;</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            ALOGV(<span class="string">&quot;no dice, no valid sequence of frames found.&quot;</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        ++pos;</span><br><span class="line">        ++tmp;</span><br><span class="line">        --remainingBytes;</span><br><span class="line">    } <span class="keyword">while</span> (!valid);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> valid;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5728;MediaExtractor::Create &#x65B9;&#x6CD5;&#x4E2D;&#x6211;&#x4EEC;&#x901A;&#x8FC7;sniff&#x6765;&#x8BC6;&#x522B;&#x5F53;&#x524D;&#x97F3;&#x9891;&#x7684;&#x6587;&#x4EF6;&#x7C7B;&#x578B;&#xFF0C;&#x5E76;&#x6839;&#x636E;&#x8FD4;&#x56DE;&#x7684;mimeType&#x4EE5;&#x53CA;&#x53EF;&#x884C;&#x5EA6;&#x6765;&#x521B;&#x5EFA;&#x5177;&#x4F53;&#x7684;Extractor &#xFF0C;&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x4EE5;MP3&#x6587;&#x4EF6;&#x4E3A;&#x4F8B;&#xFF0C;&#x6839;&#x636E;sniff&#x5224;&#x65AD;&#x540E;&#x5728;MediaExtractor::Create&#x4E2D;&#x5C06;&#x4F1A;&#x521B;&#x5EFA;MP3Extractor&#x5BF9;&#x8C61;&#xFF0C;&#x5728;MP3Extractor&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x4ECE;&#x4F20;&#x5165;&#x7684;header&#x4E2D;&#x83B7;&#x53D6;&#x91C7;&#x6837;&#x9891;&#x7387;&#xFF0C;&#x901A;&#x9053;&#x6570;&#xFF0C;&#x5E27;&#x5927;&#x5C0F;&#x7B49;&#x6570;&#x636E;&#xFF0C;&#x5E76;&#x5C06;&#x5176;&#x5B58;&#x5165;MetaData&#x5BF9;&#x8C61;&#x4E2D;&#x3002;</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">MP3Extractor::MP3Extractor(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;DataSource&gt; &amp;source, <span class="keyword">const</span> sp&lt;AMessage&gt; &amp;meta)</span><br><span class="line">    : mInitCheck(NO_INIT),</span><br><span class="line">      mDataSource(source),</span><br><span class="line">      mFirstFramePos(-<span class="number">1</span>),</span><br><span class="line">      mFixedHeader(<span class="number">0</span>) {</span><br><span class="line">    <span class="keyword">off64_t</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">off64_t</span> post_id3_pos;</span><br><span class="line">    <span class="keyword">uint32_t</span> header;</span><br><span class="line">    <span class="keyword">bool</span> success;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//&#x4E0B;&#x9762;&#x8FD9;&#x4E9B;&#x503C;&#x5728;SniffMP3&#x4E2D;&#x5DF2;&#x7ECF;&#x83B7;&#x53D6;&#x4E86;</span></span><br><span class="line">    <span class="keyword">int64_t</span> meta_offset;<span class="comment">/*&#x8868;&#x793A;&#x5E27;&#x6570;&#x636E;&#x7684;&#x504F;&#x79FB;*/</span></span><br><span class="line">    <span class="keyword">uint32_t</span> meta_header;<span class="comment">/*&#x8868;&#x793A;&#x5E27;&#x5934;*/</span></span><br><span class="line">    <span class="keyword">int64_t</span> meta_post_id3_offset;<span class="comment">/*&#x8868;&#x793A;TAB&#x5E27;&#x7684;&#x504F;&#x79FB;*/</span></span><br><span class="line">    <span class="keyword">if</span> (meta != <span class="literal">NULL</span>&amp;&amp; meta-&gt;findInt64(<span class="string">&quot;offset&quot;</span>, &amp;meta_offset)</span><br><span class="line">            &amp;&amp; meta-&gt;findInt32(<span class="string">&quot;header&quot;</span>, (<span class="keyword">int32_t</span> *)&amp;meta_header)</span><br><span class="line">            &amp;&amp; meta-&gt;findInt64(<span class="string">&quot;post-id3-offset&quot;</span>, &amp;meta_post_id3_offset)) {</span><br><span class="line">        <span class="comment">// The sniffer has already done all the hard work for us, simply</span></span><br><span class="line">        <span class="comment">// accept its judgement.</span></span><br><span class="line">        pos = (<span class="keyword">off64_t</span>)meta_offset;</span><br><span class="line">        header = meta_header;</span><br><span class="line">        post_id3_pos = (<span class="keyword">off64_t</span>)meta_post_id3_offset;</span><br><span class="line">        success = <span class="literal">true</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    mFirstFramePos = pos;</span><br><span class="line">    mFixedHeader = header;</span><br><span class="line">    mMeta = <span class="keyword">new</span> MetaData;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> frame_size;</span><br><span class="line">    <span class="keyword">int</span> sample_rate;</span><br><span class="line">    <span class="keyword">int</span> num_channels;</span><br><span class="line">    <span class="keyword">int</span> bitrate;</span><br><span class="line">    GetMPEGAudioFrameSize(header, &amp;frame_size, &amp;sample_rate, &amp;num_channels, &amp;bitrate);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> layer = <span class="number">4</span> - ((header &gt;&gt; <span class="number">17</span>) &amp; <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (layer) {</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            mMeta-&gt;setCString(kKeyMIMEType, MEDIA_MIMETYPE_AUDIO_MPEG_LAYER_I);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            mMeta-&gt;setCString(kKeyMIMEType, MEDIA_MIMETYPE_AUDIO_MPEG_LAYER_II);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            mMeta-&gt;setCString(kKeyMIMEType, MEDIA_MIMETYPE_AUDIO_MPEG);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            TRESPASS();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    mMeta-&gt;setInt32(kKeySampleRate, sample_rate);</span><br><span class="line">    mMeta-&gt;setInt32(kKeyBitRate, bitrate * <span class="number">1000</span>);</span><br><span class="line">    mMeta-&gt;setInt32(kKeyChannelCount, num_channels);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int64_t</span> durationUs;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (durationUs &gt;= <span class="number">0</span>) {</span><br><span class="line">        mMeta-&gt;setInt64(kKeyDuration, durationUs);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    mInitCheck = OK;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get iTunes-style gapless info if present.</span></span><br><span class="line">    <span class="comment">// When getting the id3 tag, skip the V1 tags to prevent the source cache</span></span><br><span class="line">    <span class="comment">// from being iterated to the end of the file.</span></span><br><span class="line">    <span class="function">ID3 <span class="title">id3</span><span class="params">(mDataSource, <span class="literal">true</span>)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (id3.isValid()) {</span><br><span class="line">        ID3::Iterator *com = <span class="keyword">new</span> ID3::Iterator(id3, <span class="string">&quot;COM&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (com-&gt;done()) {</span><br><span class="line">            <span class="keyword">delete</span> com;</span><br><span class="line">            com = <span class="keyword">new</span> ID3::Iterator(id3, <span class="string">&quot;COMM&quot;</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">while</span>(!com-&gt;done()) {</span><br><span class="line">            String8 commentdesc;</span><br><span class="line">            String8 commentvalue;</span><br><span class="line">            com-&gt;getString(&amp;commentdesc, &amp;commentvalue);</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span> * desc = commentdesc.<span class="built_in">string</span>();</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span> * value = commentvalue.<span class="built_in">string</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// first 3 characters are the language, which we don&apos;t care about</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">strlen</span>(desc) &gt; <span class="number">3</span> &amp;&amp; <span class="built_in">strcmp</span>(desc + <span class="number">3</span>, <span class="string">&quot;iTunSMPB&quot;</span>) == <span class="number">0</span>) {</span><br><span class="line">                <span class="keyword">int32_t</span> delay, padding;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">sscanf</span>(value, <span class="string">&quot; %*x %x %x %*x&quot;</span>, &amp;delay, &amp;padding) == <span class="number">2</span>) {</span><br><span class="line">                    mMeta-&gt;setInt32(kKeyEncoderDelay, delay);</span><br><span class="line">                    mMeta-&gt;setInt32(kKeyEncoderPadding, padding);</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">            com-&gt;next();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">delete</span> com;</span><br><span class="line">        com = <span class="literal">NULL</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5230;&#x76EE;&#x524D;&#x4E3A;&#x6B62;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x8BC6;&#x522B;&#x51FA;&#x4E86;&#x5F53;&#x524D;&#x626B;&#x63CF;&#x97F3;&#x9891;&#x6587;&#x4EF6;&#x7684;&#x683C;&#x5F0F;&#x7C7B;&#x578B;&#xFF0C;&#x5E76;&#x4ECE;&#x5BF9;&#x5E94;&#x7684;&#x97F3;&#x4E50;&#x5185;&#x5BB9;&#x6570;&#x636E;&#x5E27;&#x5934;&#x90E8;&#xFF08;HEAD&#xFF09;&#x83B7;&#x53D6;&#x5230;&#x4E86;&#x91C7;&#x6837;&#x7387;&#xFF0C;&#x6BD4;&#x7279;&#x7387;&#x7B49;&#x4FE1;&#x606F;&#xFF0C;&#x4F46;&#x662F;&#x6211;&#x4EEC;&#x8FD8;&#x6709;&#x4E00;&#x90E8;&#x5206;&#x975E;&#x5E38;&#x91CD;&#x8981;&#x7684;&#x4FE1;&#x606F;&#x9700;&#x8981;&#x83B7;&#x53D6;&#xFF0C;&#x90A3;&#x5C31;&#x662F;&#x6807;&#x7B7E;&#x5E27;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x5728;&#x90A3;&#x91CC;&#x8BB0;&#x5F55;&#x8005;&#x6B4C;&#x66F2;&#x4F5C;&#x8005;&#xFF0C;&#x4E13;&#x8F91;&#x540D;&#xFF0C;&#x6B4C;&#x66F2;&#x540D;&#xFF0C;&#x751A;&#x81F3;&#x4E13;&#x8F91;&#x5C01;&#x9762;&#x56FE;&#x7247;&#x548C;&#x5185;&#x5D4C;&#x6B4C;&#x8BCD;&#x7B49;&#x4FE1;&#x606F;&#xFF0C;&#x4E0B;&#x9762;&#x90E8;&#x5206;&#x6211;&#x4EEC;&#x5C31;&#x91CD;&#x70B9;&#x4ECB;&#x7ECD;&#x8FD9;&#x4E9B;&#x4FE1;&#x606F;&#x7684;&#x83B7;&#x53D6;&#x8FC7;&#x7A0B;&#x3002;<br>&#x6211;&#x4EEC;&#x518D;&#x6B21;&#x56DE;&#x5230;processFileInternal&#x65B9;&#x6CD5;&#xFF0C;Tags&#x6587;&#x4EF6;&#x7684;&#x83B7;&#x53D6;&#x662F;&#x5728;mRetriever-&gt;extractMetadata(kKeyMap[i].key)&#x4E2D;&#x5B8C;&#x6210;&#x7684;&#xFF0C;<br>&#x5728;extractMetadata&#x65B9;&#x6CD5;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;&#x4E3A;&#x8981;&#x5BFB;&#x627E;&#x7684;&#x90A3;&#x4E2A;Tag&#x7684;key&#xFF0C;&#x5982;&#x679C;&#x5F53;&#x524D;&#x5C1A;&#x672A;&#x5BF9;&#x5E27;&#x6807;&#x7B7E;&#x5E27;&#x8FDB;&#x884C;&#x89E3;&#x6790;&#x5219;&#x5148;&#x8C03;&#x7528;parseMetaData&#x65B9;&#x6CD5;&#x5BF9;Tag&#x6807;&#x7B7E;&#x8FDB;&#x884C;&#x89E3;&#x6790;&#xFF0C;&#x5982;&#x679C;&#x5DF2;&#x7ECF;&#x89E3;&#x6790;&#x8FC7;&#x4E86;&#x5219;&#x8FD9;&#x65F6;&#x5019;&#x5C31;&#x4F7F;&#x7528;&#x4F20;&#x4EBA;&#x5230;keyCode &#x5230;mMetaData&#x4E2D;&#x8FDB;&#x884C;&#x67E5;&#x627E;&#xFF0C;&#x5E76;&#x8FD4;&#x56DE;&#x7684;&#x9700;&#x8981;&#x67E5;&#x627E;&#x5230;&#x90A3;&#x4E2A;Tag&#x7684;&#x503C;.<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *StagefrightMetadataRetriever::extractMetadata(<span class="keyword">int</span> keyCode) {</span><br><span class="line">    <span class="keyword">if</span> (mExtractor == <span class="literal">NULL</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//&#x8C03;&#x7528;parseMetaData()&#x89E3;&#x6790;&#x6807;&#x7B7E;&#x5E27;</span></span><br><span class="line">    <span class="keyword">if</span> (!mParsedMetaData) {</span><br><span class="line">        parseMetaData();</span><br><span class="line">        mParsedMetaData = <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">ssize_t</span> index = mMetaData.indexOfKey(keyCode);</span><br><span class="line">    <span class="keyword">if</span> (index &lt; <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    }</span><br><span class="line">    /&#x5C06;&#x6570;&#x636E;&#x6DFB;&#x52A0;&#x5230;mMetaData</span><br><span class="line">    <span class="keyword">return</span> mMetaData.valueAt(index).<span class="built_in">string</span>();</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<figure class="highlight autohotkey"><table><tr><td class="code"><pre><span class="line"><span class="label">void StagefrightMetadataRetriever::</span>parseMetaData() {</span><br><span class="line">    //&#x83B7;&#x53D6;MetaData</span><br><span class="line">    sp&lt;MetaData&gt; meta = mExtractor-&gt;getMetaData()<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    //TAG&#x5BF9;&#x5E94;&#x7684;map</span><br><span class="line">    struct Map {</span><br><span class="line">        int from<span class="comment">;</span></span><br><span class="line">        int to<span class="comment">;</span></span><br><span class="line">        const char *name<span class="comment">;</span></span><br><span class="line">    }<span class="comment">;</span></span><br><span class="line">    static const Map kMap[] = {</span><br><span class="line">        { kKeyMIMEType, METADAT<span class="built_in">A_KEY</span>_MIMETYPE, NULL },</span><br><span class="line">        { kKeyCDTrackNumber, METADAT<span class="built_in">A_KEY</span>_CD_TRACK_NUMBER, <span class="string">&quot;tracknumber&quot;</span> },</span><br><span class="line">        { kKeyDiscNumber, METADAT<span class="built_in">A_KEY</span>_DISC_NUMBER, <span class="string">&quot;discnumber&quot;</span> },</span><br><span class="line">        { kKeyAlbum, METADAT<span class="built_in">A_KEY</span>_ALBUM, <span class="string">&quot;album&quot;</span> },</span><br><span class="line">        { kKeyArtist, METADAT<span class="built_in">A_KEY</span>_ARTIST, <span class="string">&quot;artist&quot;</span> },</span><br><span class="line">        { kKeyAlbumArtist, METADAT<span class="built_in">A_KEY</span>_ALBUMARTIST, <span class="string">&quot;albumartist&quot;</span> },</span><br><span class="line">        { kKeyAuthor, METADAT<span class="built_in">A_KEY</span>_AUTHOR, NULL },</span><br><span class="line">        { kKeyComposer, METADAT<span class="built_in">A_KEY</span>_COMPOSER, <span class="string">&quot;composer&quot;</span> },</span><br><span class="line">        { kKeyDate, METADAT<span class="built_in">A_KEY</span>_DATE, NULL },</span><br><span class="line">        { kKeyGenre, METADAT<span class="built_in">A_KEY</span>_GENRE, <span class="string">&quot;genre&quot;</span> },</span><br><span class="line">        { kKeyTitle, METADAT<span class="built_in">A_KEY</span>_TITLE, <span class="string">&quot;title&quot;</span> },</span><br><span class="line">        { kKeyYear, METADAT<span class="built_in">A_KEY</span>_YEAR, <span class="string">&quot;year&quot;</span> },</span><br><span class="line">        { kKeyWriter, METADAT<span class="built_in">A_KEY</span>_WRITER, <span class="string">&quot;writer&quot;</span> },</span><br><span class="line">        { kKeyCompilation, METADAT<span class="built_in">A_KEY</span>_COMPILATION, <span class="string">&quot;compilation&quot;</span> },</span><br><span class="line">        { kKeyLocation, METADAT<span class="built_in">A_KEY</span>_LOCATION, NULL },</span><br><span class="line">    }<span class="comment">;</span></span><br><span class="line">    static const size_t kNumMapEntries = sizeof(kMap) / sizeof(kMap[<span class="number">0</span>])<span class="comment">;</span></span><br><span class="line">    //&#x521B;&#x5EFA;&#x5224;&#x65AD;&#x5B57;&#x7B26;&#x7F16;&#x7801;&#x68C0;&#x6D4B;&#x5668;</span><br><span class="line">    CharacterEncodingDetector *detector = new CharacterEncodingDetector()<span class="comment">;</span></span><br><span class="line">    //&#x5C06;&#x5BF9;&#x5E94;&#x7684;TAG&#x6DFB;&#x52A0;&#x5230;detector&#x4E2D;</span><br><span class="line">    for (size_t i = <span class="number">0</span><span class="comment">; i &lt; kNumMapEntries; ++i) {</span></span><br><span class="line">        const char *value<span class="comment">;</span></span><br><span class="line">        <span class="keyword">if</span> (meta-&gt;findCString(kMap[i].from, &amp;value)) {</span><br><span class="line">            <span class="keyword">if</span> (kMap[i].name) {</span><br><span class="line">                // add to charset detector</span><br><span class="line">                //&#x8FD9;&#x91CC;&#x6CA1;&#x6709;&#x76F4;&#x63A5;&#x6DFB;&#x52A0;&#x5230;mMetaData&#x800C;&#x662F;&#x5148;&#x6DFB;&#x52A0;&#x5230;CharacterEncodingDetector&#x7684;mNames&#xFF0C;mValues&#x4E2D;&#x7B49;&#x5F85;&#x8F6C;&#x6362;&#x7F16;&#x7801;</span><br><span class="line">                detector-&gt;addTag(kMap[i].name, value)<span class="comment">;</span></span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                // directly add to output list</span><br><span class="line">                mMetaData.add(kMap[i].to, String8(value))<span class="comment">;</span></span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    /*</span><br><span class="line"><span class="label">    void CharacterEncodingDetector::</span>addTag(const char *name, const char *value) {</span><br><span class="line">        mNames.push_back(name)<span class="comment">;</span></span><br><span class="line">        mValues.push_back(value)<span class="comment">;</span></span><br><span class="line">    }</span><br><span class="line">    &#xD7;/</span><br><span class="line">    //&#x5F00;&#x59CB;&#x8F6C;&#x5316;&#x7F16;&#x7801;&#xFF0C;&#x8FD9;&#x90E8;&#x5206;&#x653E;&#x5728;&#x540E;&#x9762;&#x8FDB;&#x884C;&#x4ECB;&#x7ECD;</span><br><span class="line">    detector-&gt;detectAndConvert()<span class="comment">;</span></span><br><span class="line">    int size = detector-&gt;size()<span class="comment">;</span></span><br><span class="line">    <span class="keyword">if</span> (size) {</span><br><span class="line">        //&#x5C06;&#x8F6C;&#x6362;&#x540E;&#x7684;TAG&#x653E;&#x5230;mMetaData&#xFF0C;&#x8FD9;&#x65F6;&#x5019;&#x6574;&#x4E2A;mMetaData&#x5B58;&#x653E;&#x7684;&#x90FD;&#x662F;&#x6B63;&#x786E;&#x7F16;&#x7801;&#x540E;&#x7684;&#x5185;&#x5BB9;</span><br><span class="line">        for (int i = <span class="number">0</span><span class="comment">; i &lt; size; i++) {</span></span><br><span class="line">            const char *name<span class="comment">;</span></span><br><span class="line">            const char *value<span class="comment">;</span></span><br><span class="line">            detector-&gt;getTag(i, &amp;name, &amp;value)<span class="comment">;</span></span><br><span class="line">            for (size_t j = <span class="number">0</span><span class="comment">; j &lt; kNumMapEntries; ++j) {</span></span><br><span class="line">                <span class="keyword">if</span> (kMap[j].name &amp;&amp; !strcmp(kMap[j].name, name)) {</span><br><span class="line">                    mMetaData.add(kMap[j].to, String8(value))<span class="comment">;</span></span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    delete detector<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    const void *data<span class="comment">;</span></span><br><span class="line">    uint32_t type<span class="comment">;</span></span><br><span class="line">    size_t dataSize<span class="comment">;</span></span><br><span class="line">    <span class="keyword">if</span> (meta-&gt;findData(kKeyAlbumArt, &amp;type, &amp;data, &amp;dataSize)&amp;&amp; mAlbumArt == NULL) {</span><br><span class="line"><span class="label">        mAlbumArt = MediaAlbumArt::</span>fromData(dataSize, data)<span class="comment">;</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    size_t numTracks = mExtractor-&gt;countTracks()<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    char tmp[<span class="number">32</span>]<span class="comment">;</span></span><br><span class="line">    sprintf(tmp, <span class="string">&quot;%zu&quot;</span>, numTracks)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    mMetaData.add(METADAT<span class="built_in">A_KEY</span>_NUM_TRACKS, String8(tmp))<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    float captureFps<span class="comment">;</span></span><br><span class="line">    <span class="keyword">if</span> (meta-&gt;findFloat(kKeyCaptureFramerate, &amp;captureFps)) {</span><br><span class="line">        sprintf(tmp, <span class="string">&quot;%f&quot;</span>, captureFps)<span class="comment">;</span></span><br><span class="line">        mMetaData.add(METADAT<span class="built_in">A_KEY</span>_CAPTURE_FRAMERATE, String8(tmp))<span class="comment">;</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    bool hasAudio = <span class="literal">false</span><span class="comment">;</span></span><br><span class="line">    bool hasVideo = <span class="literal">false</span><span class="comment">;</span></span><br><span class="line">    int32_t videoWidth = -<span class="number">1</span><span class="comment">;</span></span><br><span class="line">    int32_t videoHeight = -<span class="number">1</span><span class="comment">;</span></span><br><span class="line">    int32_t audioBitrate = -<span class="number">1</span><span class="comment">;</span></span><br><span class="line">    int32_t rotationAngle = -<span class="number">1</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    // The overall duration is the duration of the longest track.</span><br><span class="line">    int64_t maxDurationUs = <span class="number">0</span><span class="comment">;</span></span><br><span class="line">    String8 timedTextLang<span class="comment">;</span></span><br><span class="line">    for (size_t i = <span class="number">0</span><span class="comment">; i &lt; numTracks; ++i) {</span></span><br><span class="line">        sp&lt;MetaData&gt; trackMeta = mExtractor-&gt;getTrackMetaData(i)<span class="comment">;</span></span><br><span class="line">        int64_t durationUs<span class="comment">;</span></span><br><span class="line">        <span class="keyword">if</span> (trackMeta-&gt;findInt64(kKeyDuration, &amp;durationUs)) {</span><br><span class="line">            <span class="keyword">if</span> (durationUs &gt; maxDurationUs) {</span><br><span class="line">                maxDurationUs = durationUs<span class="comment">;</span></span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        const char *mime<span class="comment">;</span></span><br><span class="line">        <span class="keyword">if</span> (trackMeta-&gt;findCString(kKeyMIMEType, &amp;mime)) {</span><br><span class="line">            <span class="keyword">if</span> (!hasAudio &amp;&amp; !strncasecmp(<span class="string">&quot;audio/&quot;</span>, mime, <span class="number">6</span>)) {</span><br><span class="line">                hasAudio = <span class="literal">true</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!trackMeta-&gt;findInt32(kKeyBitRate, &amp;audioBitrate)) {</span><br><span class="line">                    audioBitrate = -<span class="number">1</span><span class="comment">;</span></span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (!hasVideo &amp;&amp; !strncasecmp(<span class="string">&quot;video/&quot;</span>, mime, <span class="number">6</span>)) {</span><br><span class="line">                hasVideo = <span class="literal">true</span><span class="comment">;</span></span><br><span class="line">                CHECK(trackMeta-&gt;findInt32(kKeyWidth, &amp;videoWidth))<span class="comment">;</span></span><br><span class="line">                CHECK(trackMeta-&gt;findInt32(kKeyHeight, &amp;videoHeight))<span class="comment">;</span></span><br><span class="line">                <span class="keyword">if</span> (!trackMeta-&gt;findInt32(kKeyRotation, &amp;rotationAngle)) {</span><br><span class="line">                    rotationAngle = <span class="number">0</span><span class="comment">;</span></span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDI<span class="built_in">A_MIMETYPE</span>_TEXT_3GPP)) {</span><br><span class="line">                const char *lang<span class="comment">;</span></span><br><span class="line">                trackMeta-&gt;findCString(kKeyMediaLanguage, &amp;lang)<span class="comment">;</span></span><br><span class="line">                timedTextLang.append(String8(lang))<span class="comment">;</span></span><br><span class="line">                timedTextLang.append(String8(<span class="string">&quot;:&quot;</span>))<span class="comment">;</span></span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    // To save the language codes for all timed text tracks</span><br><span class="line">    // <span class="keyword">If</span> multiple text tracks present, the format will look</span><br><span class="line">    // like <span class="string">&quot;eng:chi&quot;</span></span><br><span class="line">    <span class="keyword">if</span> (!timedTextLang.isEmpty()) {</span><br><span class="line">        mMetaData.add(METADAT<span class="built_in">A_KEY</span>_TIMED_TEXT_LANGUAGES, timedTextLang)<span class="comment">;</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    // The duration value is <span class="literal">a</span> string representing the duration in ms.</span><br><span class="line">    sprintf(tmp, <span class="string">&quot;%&quot;</span> PRId64, (maxDurationUs + <span class="number">500</span>) / <span class="number">1000</span>)<span class="comment">;</span></span><br><span class="line">    mMetaData.add(METADAT<span class="built_in">A_KEY</span>_DURATION, String8(tmp))<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hasAudio) {</span><br><span class="line">        mMetaData.add(METADAT<span class="built_in">A_KEY</span>_HAS_AUDIO, String8(<span class="string">&quot;yes&quot;</span>))<span class="comment">;</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hasVideo) {</span><br><span class="line">        mMetaData.add(METADAT<span class="built_in">A_KEY</span>_HAS_VIDEO, String8(<span class="string">&quot;yes&quot;</span>))<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">        sprintf(tmp, <span class="string">&quot;%d&quot;</span>, videoWidth)<span class="comment">;</span></span><br><span class="line">        mMetaData.add(METADAT<span class="built_in">A_KEY</span>_VIDEO_WIDTH, String8(tmp))<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">        sprintf(tmp, <span class="string">&quot;%d&quot;</span>, videoHeight)<span class="comment">;</span></span><br><span class="line">        mMetaData.add(METADAT<span class="built_in">A_KEY</span>_VIDEO_HEIGHT, String8(tmp))<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">        sprintf(tmp, <span class="string">&quot;%d&quot;</span>, rotationAngle)<span class="comment">;</span></span><br><span class="line">        mMetaData.add(METADAT<span class="built_in">A_KEY</span>_VIDEO_ROTATION, String8(tmp))<span class="comment">;</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (numTracks == <span class="number">1</span> &amp;&amp; hasAudio &amp;&amp; audioBitrate &gt;= <span class="number">0</span>) {</span><br><span class="line">        sprintf(tmp, <span class="string">&quot;%d&quot;</span>, audioBitrate)<span class="comment">;</span></span><br><span class="line">        mMetaData.add(METADAT<span class="built_in">A_KEY</span>_BITRATE, String8(tmp))<span class="comment">;</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        off64_t sourceSize<span class="comment">;</span></span><br><span class="line">        <span class="keyword">if</span> (mSource-&gt;getSize(&amp;sourceSize) == OK) {</span><br><span class="line">            int64_t avgBitRate = (int64_t)(sourceSize * <span class="number">8</span>E6 / maxDurationUs)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">            sprintf(tmp, <span class="string">&quot;%&quot;</span> PRId64, avgBitRate)<span class="comment">;</span></span><br><span class="line">            mMetaData.add(METADAT<span class="built_in">A_KEY</span>_BITRATE, String8(tmp))<span class="comment">;</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (numTracks == <span class="number">1</span>) {</span><br><span class="line">        const char *fileMIME<span class="comment">;</span></span><br><span class="line">        CHECK(meta-&gt;findCString(kKeyMIMEType, &amp;fileMIME))<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!strcasecmp(fileMIME, <span class="string">&quot;video/x-matroska&quot;</span>)) {</span><br><span class="line">            sp&lt;MetaData&gt; trackMeta = mExtractor-&gt;getTrackMetaData(<span class="number">0</span>)<span class="comment">;</span></span><br><span class="line">            const char *trackMIME<span class="comment">;</span></span><br><span class="line">            CHECK(trackMeta-&gt;findCString(kKeyMIMEType, &amp;trackMIME))<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!strncasecmp(<span class="string">&quot;audio/&quot;</span>, trackMIME, <span class="number">6</span>)) {</span><br><span class="line">                // The matroska file only contains <span class="literal">a</span> single audio track,</span><br><span class="line">                // rewrite its mime type.</span><br><span class="line">                mMetaData.add(</span><br><span class="line">                        METADAT<span class="built_in">A_KEY</span>_MIMETYPE, String8(<span class="string">&quot;audio/x-matroska&quot;</span>))<span class="comment">;</span></span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    // To check whether the media file is drm-protected</span><br><span class="line">    <span class="keyword">if</span> (mExtractor-&gt;getDrmFlag()) {</span><br><span class="line">        mMetaData.add(METADAT<span class="built_in">A_KEY</span>_IS_DRM, String8(<span class="string">&quot;1&quot;</span>))<span class="comment">;</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x4ECE;&#x4E0A;&#x9762;&#x4EE3;&#x7801;&#x4E2D;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x5B8C;&#x6210;&#x5173;&#x952E;&#x5DE5;&#x4F5C;&#x5C31;&#x662F;&#x4ECE;Meta&#x4E2D;&#x53D6;&#x51FA;&#x5404;&#x4E2A;TAG&#xFF0C;&#x7ECF;&#x8FC7;&#x5B57;&#x7B26;&#x7F16;&#x7801;&#x8F6C;&#x6362;&#x540E;&#x6DFB;&#x52A0;&#x5230;mMetaData&#x4E2D;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x770B;&#x5230;&#x8FD9;&#x91CC;&#x4E0D;&#x8981;&#x5FFD;&#x7565;&#x4E86;getMetaData&#xFF0C;getMetaData&#x65B9;&#x6CD5;&#x4E2D;&#x901A;&#x8FC7;&#x521B;&#x5EFA;&#x7528;&#x4E8E;&#x5BF9;&#x5B58;&#x50A8;&#x5728;&#x6587;&#x4EF6;&#x5934;&#x7684;ID3V2&#x6807;&#x7B7E;&#x5E27;&#x548C;&#x5B58;&#x50A8;&#x5728;&#x6587;&#x4EF6;&#x5C3E;&#x90E8;&#x7684;ID3V1&#x5E27;&#x8FDB;&#x884C;&#x89E3;&#x6790;&#x7684;ID3&#x5BF9;&#x8C61;&#x6765;&#x5B8C;&#x6210;&#x6807;&#x7B7E;&#x5E27;&#x5230;&#x89E3;&#x6790;&#xFF0C;&#x8FD9;&#x91CC;&#x89E3;&#x6790;&#x7684;&#x5185;&#x5BB9;&#x5305;&#x62EC;&#x57FA;&#x672C;&#x7684;&#x6B4C;&#x66F2;&#x4FE1;&#x606F;&#x6807;&#x7B7E;&#x4EE5;&#x53CA;&#x6B4C;&#x8BCD;&#xFF0C;&#x4E13;&#x8F91;&#x5C01;&#x9762;&#x7B49;&#x4FE1;&#x606F;&#x3002;&#x60F3;&#x8981;&#x771F;&#x6B63;&#x4E86;&#x89E3;&#x6574;&#x4E2A;&#x89E3;&#x6790;&#x8FC7;&#x7A0B;&#x6211;&#x4EEC;&#x8FD8;&#x5F97;&#x7EE7;&#x7EED;&#x770B;&#x4E0B;ID3&#x7C7B;&#x7684;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x548C;ID3::Iterator&#x65B9;&#x6CD5;&#x3002;</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">sp&lt;MetaData&gt; MP3Extractor::getMetaData() {</span><br><span class="line">    sp&lt;MetaData&gt; meta = <span class="keyword">new</span> MetaData;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mInitCheck != OK) {</span><br><span class="line">        <span class="keyword">return</span> meta;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//&#x8BBE;&#x7F6E;mimetype</span></span><br><span class="line">    meta-&gt;setCString(kKeyMIMEType, <span class="string">&quot;audio/mpeg&quot;</span>);</span><br><span class="line">    <span class="comment">//&#x521B;&#x5EFA;id3</span></span><br><span class="line">    <span class="function">ID3 <span class="title">id3</span><span class="params">(mDataSource)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!id3.isValid()) {</span><br><span class="line">        <span class="keyword">return</span> meta;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> Map {</span><br><span class="line">        <span class="keyword">int</span> key;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *tag1;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *tag2;</span><br><span class="line">    };</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> Map kMap[] = {</span><br><span class="line">        { kKeyAlbum, <span class="string">&quot;TALB&quot;</span>, <span class="string">&quot;TAL&quot;</span> },</span><br><span class="line">        { kKeyArtist, <span class="string">&quot;TPE1&quot;</span>, <span class="string">&quot;TP1&quot;</span> },</span><br><span class="line">        { kKeyAlbumArtist, <span class="string">&quot;TPE2&quot;</span>, <span class="string">&quot;TP2&quot;</span> },</span><br><span class="line">        { kKeyComposer, <span class="string">&quot;TCOM&quot;</span>, <span class="string">&quot;TCM&quot;</span> },</span><br><span class="line">        { kKeyGenre, <span class="string">&quot;TCON&quot;</span>, <span class="string">&quot;TCO&quot;</span> },</span><br><span class="line">        { kKeyTitle, <span class="string">&quot;TIT2&quot;</span>, <span class="string">&quot;TT2&quot;</span> },</span><br><span class="line">        { kKeyYear, <span class="string">&quot;TYE&quot;</span>, <span class="string">&quot;TYER&quot;</span> },</span><br><span class="line">        { kKeyAuthor, <span class="string">&quot;TXT&quot;</span>, <span class="string">&quot;TEXT&quot;</span> },</span><br><span class="line">        { kKeyCDTrackNumber, <span class="string">&quot;TRK&quot;</span>, <span class="string">&quot;TRCK&quot;</span> },</span><br><span class="line">        { kKeyDiscNumber, <span class="string">&quot;TPA&quot;</span>, <span class="string">&quot;TPOS&quot;</span> },</span><br><span class="line">        { kKeyCompilation, <span class="string">&quot;TCP&quot;</span>, <span class="string">&quot;TCMP&quot;</span> },</span><br><span class="line">    };</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">size_t</span> kNumMapEntries = <span class="keyword">sizeof</span>(kMap) / <span class="keyword">sizeof</span>(kMap[<span class="number">0</span>]);</span><br><span class="line">    <span class="comment">//&#x83B7;&#x53D6;&#x4E0A;&#x9762;&#x63D0;&#x5230;&#x7684;TAG</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; kNumMapEntries; ++i) {</span><br><span class="line">        ID3::Iterator *it = <span class="keyword">new</span> ID3::Iterator(id3, kMap[i].tag1);</span><br><span class="line">        <span class="keyword">if</span> (it-&gt;done()) {</span><br><span class="line">            <span class="keyword">delete</span> it;</span><br><span class="line">            it = <span class="keyword">new</span> ID3::Iterator(id3, kMap[i].tag2);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (it-&gt;done()) {</span><br><span class="line">            <span class="keyword">delete</span> it;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        }</span><br><span class="line">        String8 s;</span><br><span class="line">        it-&gt;getString(&amp;s);</span><br><span class="line">        <span class="keyword">delete</span> it;</span><br><span class="line">        meta-&gt;setCString(kMap[i].key, s);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> dataSize;</span><br><span class="line">    String8 mime;</span><br><span class="line">    <span class="comment">//&#x83B7;&#x53D6;&#x4E13;&#x8F91;&#x5C01;&#x9762;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">void</span> *data = id3.getAlbumArt(&amp;dataSize, &amp;mime);</span><br><span class="line">    <span class="keyword">if</span> (data) {</span><br><span class="line">        meta-&gt;setData(kKeyAlbumArt, MetaData::TYPE_NONE, data, dataSize);</span><br><span class="line">        meta-&gt;setCString(kKeyAlbumArtMIME, mime.<span class="built_in">string</span>());</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> meta;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x6211;&#x4EEC;&#x5148;&#x770B;&#x4E0B;ID3&#x7684;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#xFF0C;&#x5728;ID3&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x4F1A;&#x5148;&#x8C03;&#x7528;parseV2&#xFF0C;&#x5982;&#x679C;parseV2&#x8FD4;&#x56DE;false&#x7684;&#x8BDD;&#x4F1A;&#x8C03;&#x7528;parseV1&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;ID3&#x4F1A;&#x9996;&#x5148;&#x89E3;&#x6790;&#x4F4D;&#x4E8E;&#x6587;&#x4EF6;&#x5934;&#x5230;ID3V2&#x6807;&#x7B7E;&#x5E27;&#xFF0C;&#x5982;&#x679C;&#x89E3;&#x6790;&#x5931;&#x8D25;&#x5219;&#x4F1A;&#x5C1D;&#x8BD5;&#x89E3;&#x6790;ID3V1&#x5E27;&#x3002;<br><figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line">ID3::ID3(<span class="keyword">const</span> sp&lt;DataSource&gt; &amp;source, bool ignoreV1, off64_t offset)</span><br><span class="line">    : mIsValid(<span class="keyword">false</span>),</span><br><span class="line">      mData(NULL),</span><br><span class="line">      mSize(0),</span><br><span class="line">      mFirstFrameOffset(0),</span><br><span class="line">      mVersion(ID3_UNKNOWN),</span><br><span class="line">      mRawSize(0) {</span><br><span class="line">    <span class="comment">//&#x89E3;&#x6790;ID3V2Tab&#x5185;&#x5BB9;</span></span><br><span class="line">    mIsValid = parseV2(source, offset);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mIsValid &amp;&amp; !ignoreV1) {</span><br><span class="line">        <span class="comment">//&#x89E3;&#x6790;ID3V1 TAB &#x5185;&#x5BB9;</span></span><br><span class="line">        mIsValid = parseV1(source);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x800C;&#x5728;parseV2&#x4EE5;&#x53CA;parseV1&#x65B9;&#x6CD5;&#x4E2D;&#x5B9E;&#x9645;&#x4E0A;&#x4E5F;&#x8FD8;&#x6CA1;&#x5F00;&#x59CB;&#x89E3;&#x6790;&#xFF0C;&#x5B83;&#x4EEC;&#x53EA;&#x662F;&#x5F00;&#x8F9F;&#x4E2A;mData &#x7A7A;&#x95F4;&#x5C06;&#x5BF9;&#x5E94;&#x7684;TAG&#x6807;&#x7B7E;&#x52A0;&#x8F7D;&#x5230;mData&#x4E2D;&#xFF0C;&#x540E;&#x7EED;&#x7684;&#x89E3;&#x6790;&#x5DE5;&#x4F5C;&#x5C06;&#x4F1A;&#x9488;&#x5BF9;mData&#x4E2D;&#x7684;&#x8FD9;&#x4E9B;&#x6570;&#x636E;&#x8FDB;&#x884C;&#x89E3;&#x6790;&#x3002;<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">bool</span> ID3::parseV2(<span class="keyword">const</span> sp&lt;DataSource&gt; &amp;source) {</span><br><span class="line"><span class="keyword">struct</span> id3_header {</span><br><span class="line">    <span class="comment">//&#x6807;&#x7B7E;&#x5934;10&#x4E2A;&#x5B57;&#x8282;</span></span><br><span class="line">    <span class="keyword">char</span> id[<span class="number">3</span>]; <span class="comment">/*&#x5FC5;&#x987B;&#x4E3A;&quot;ID3&quot;&#x5426;&#x5219;&#x8BA4;&#x4E3A;&#x6807;&#x7B7E;&#x4E0D;&#x5B58;&#x5728;*/</span></span><br><span class="line">    <span class="keyword">uint8_t</span> version_major;  <span class="comment">/*&#x7248;&#x672C;&#x53F7;ID3V2.3&#x5C31;&#x8BB0;&#x5F55;3*/</span></span><br><span class="line">    <span class="keyword">uint8_t</span> version_minor;  <span class="comment">/*&#x526F;&#x7248;&#x672C;&#x53F7;&#x6B64;&#x7248;&#x672C;&#x8BB0;&#x5F55;&#x4E3A;0*/</span></span><br><span class="line">    <span class="keyword">uint8_t</span> flags; <span class="comment">/*&#x5B58;&#x653E;&#x6807;&#x5FD7;&#x7684;&#x5B57;&#x8282;&#xFF0C;&#x8FD9;&#x4E2A;&#x7248;&#x672C;&#x53EA;&#x5B9A;&#x4E49;&#x4E86;&#x4E09;&#x4F4D;*/</span></span><br><span class="line">    <span class="keyword">uint8_t</span> enc_size[<span class="number">4</span>];  <span class="comment">/*&#x6807;&#x7B7E;&#x5927;&#x5C0F;&#xFF0C;&#x4E0D;&#x5305;&#x62EC;&#x6807;&#x7B7E;&#x5934;&#x7684;10&#x4E2A;&#x5B57;&#x8282;*/</span></span><br><span class="line">    };</span><br><span class="line">    id3_header header;</span><br><span class="line">    <span class="keyword">if</span> (source-&gt;readAt(<span class="number">0</span>, &amp;header, <span class="keyword">sizeof</span>(header)) != (<span class="keyword">ssize_t</span>)<span class="keyword">sizeof</span>(header)) {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">/*&#x5FC5;&#x987B;&#x4E3A;&quot;ID3&quot;&#x5426;&#x5219;&#x8BA4;&#x4E3A;&#x6807;&#x7B7E;&#x4E0D;&#x5B58;&#x5728;*/</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">memcmp</span>(header.id, <span class="string">&quot;ID3&quot;</span>, <span class="number">3</span>)) {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//&#x5982;&#x679C;&#x4E3B;&#x7248;&#x672C;&#x53F7;&#x548C;&#x526F;&#x7248;&#x672C;&#x53F7;&#x90FD;&#x662F;0xff&#x5219;&#x8868;&#x793A;&#x9519;&#x8BEF;</span></span><br><span class="line">    <span class="keyword">if</span> (header.version_major == <span class="number">0xff</span> || header.version_minor == <span class="number">0xff</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">   <span class="keyword">if</span> (header.version_major == <span class="number">2</span>) {</span><br><span class="line">      <span class="comment">//&#x5982;&#x679C;&#x4E3B;&#x7248;&#x672C;&#x53F7;&#x4E3A;2</span></span><br><span class="line">     <span class="comment">//............................................</span></span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (header.version_major == <span class="number">3</span>) {</span><br><span class="line">    <span class="comment">//&#x5982;&#x679C;&#x4E3B;&#x7248;&#x672C;&#x53F7;&#x4E3A;3</span></span><br><span class="line">        <span class="keyword">if</span> (header.flags &amp; <span class="number">0x1f</span>) {</span><br><span class="line">            <span class="comment">// We only support the 3 high bits, if any of the lower bits are</span></span><br><span class="line">            <span class="comment">// set, we cannot guarantee to understand the tag format.</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (header.version_major == <span class="number">4</span>) {</span><br><span class="line">        <span class="comment">//&#x5982;&#x679C;&#x4E3B;&#x7248;&#x672C;&#x53F7;&#x4E3A;4</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">    <span class="comment">//&#x5982;&#x679C;&#x4E3B;&#x7248;&#x672C;&#x53F7;&#x4E0D;&#x662F;&#x4E0A;&#x8FF0;&#x7684;&#x5219;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;false</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//&#x83B7;&#x53D6;&#x6807;&#x7B7E;&#x5927;&#x5C0F;</span></span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">    <span class="keyword">if</span> (!ParseSyncsafeInteger(header.enc_size, &amp;size)) {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//static const size_t kMaxMetadataSize = 3 * 1024 * 1024;</span></span><br><span class="line">    <span class="comment">//&#x5982;&#x679C;&#x5927;&#x5C0F;&#x8D85;&#x8FC7;3M&#x5219;&#x9000;&#x51FA;</span></span><br><span class="line">    <span class="keyword">if</span> (size &gt; kMaxMetadataSize) {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//&#x5206;&#x914D;&#x7528;&#x4E8E;&#x5B58;&#x653E;&#x6807;&#x7B7E;&#x5185;&#x5BB9;&#x7684;&#x7A7A;&#x95F4;</span></span><br><span class="line">    mData = (<span class="keyword">uint8_t</span> *)<span class="built_in">malloc</span>(size);</span><br><span class="line">    mSize = size;</span><br><span class="line">    mRawSize = mSize + <span class="keyword">sizeof</span>(header);</span><br><span class="line">    <span class="comment">//mRawSize &#x8868;&#x793A; &#x6807;&#x7B7E;&#x5E27;&#x5927;&#x5C0F;&#x52A0;&#x4E0A; &#x6807;&#x7B7E;&#x5934;&#x5927;&#x5C0F;10&#x4E2A;&#x5B57;&#x8282; </span></span><br><span class="line">    <span class="comment">//&#x8BFB;&#x53D6;&#x6807;&#x7B7E;&#x5E27;&#x6570;&#x636E;</span></span><br><span class="line">    <span class="keyword">if</span> (source-&gt;readAt(<span class="keyword">sizeof</span>(header), mData, mSize) != (<span class="keyword">ssize_t</span>)mSize) {</span><br><span class="line">        <span class="built_in">free</span>(mData);</span><br><span class="line">        mData = <span class="literal">NULL</span> ;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//..........................................................</span></span><br><span class="line">    mFirstFrameOffset = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//..........................................................</span></span><br><span class="line">    <span class="keyword">if</span> (header.version_major == <span class="number">2</span>) {</span><br><span class="line">        mVersion = ID3_V2_2;</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (header.version_major == <span class="number">3</span>) {</span><br><span class="line">        mVersion = ID3_V2_3;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        CHECK_EQ(header.version_major, <span class="number">4</span>);</span><br><span class="line">        mVersion = ID3_V2_4;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">bool</span> ID3::parseV1(<span class="keyword">const</span> sp&lt;DataSource&gt; &amp;source) {</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> V1_TAG_SIZE = <span class="number">128</span>;</span><br><span class="line">    <span class="keyword">off64_t</span> size;</span><br><span class="line">    <span class="keyword">if</span> (source-&gt;getSize(&amp;size) != OK || size &lt; (<span class="keyword">off64_t</span>)V1_TAG_SIZE) {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//&#x5206;&#x914D;&#x7A7A;&#x95F4;</span></span><br><span class="line">    mData = (<span class="keyword">uint8_t</span> *)<span class="built_in">malloc</span>(V1_TAG_SIZE);</span><br><span class="line">    <span class="comment">//&#x8BFB;&#x53D6;&#x4F4D;&#x4E8E;&#x6587;&#x4EF6;&#x5C3E;&#x90E8;128&#x5B57;&#x8282;&#x7684;V1&#x6807;&#x7B7E;&#x5E27;</span></span><br><span class="line">    <span class="keyword">if</span> (source-&gt;readAt(size - V1_TAG_SIZE, mData, V1_TAG_SIZE)</span><br><span class="line">            != (<span class="keyword">ssize_t</span>)V1_TAG_SIZE) {</span><br><span class="line">        <span class="built_in">free</span>(mData);</span><br><span class="line">        mData = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">memcmp</span>(<span class="string">&quot;TAG&quot;</span>, mData, <span class="number">3</span>)) {</span><br><span class="line">        <span class="built_in">free</span>(mData);</span><br><span class="line">        mData = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">    mSize = V1_TAG_SIZE;</span><br><span class="line">    mFirstFrameOffset = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">if</span> (mData[V1_TAG_SIZE - <span class="number">3</span>] != <span class="number">0</span>) {</span><br><span class="line">        mVersion = ID3_V1;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        mVersion = ID3_V1_1;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x771F;&#x6B63;&#x7684;&#x89E3;&#x6790;&#x6D41;&#x7A0B;&#x662F;&#x4ECE;Iterator&#x5F00;&#x59CB;&#x7684;&#xFF0C;&#x5728;Iterator&#x4E2D;&#x5148;&#x662F;&#x8C03;&#x7528;strdup(id)&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x8981;&#x83B7;&#x53D6;&#x7684;Tag&#x5230;ID&#x503C;&#x653E;&#x5230;mID&#x4E2D;&#xFF0C;&#x63A5;&#x7740;&#x8C03;&#x7528;findFrame&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x5230;&#x5E27;&#x3002;<br><figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line">ID3::Iterator::Iterator(<span class="keyword">const</span> ID3 &amp;parent, <span class="keyword">const</span> <span class="keyword">char</span> *id)</span><br><span class="line">    : mParent(parent),</span><br><span class="line">      mID(NULL),</span><br><span class="line">      mOffset(mParent.mFirstFrameOffset),</span><br><span class="line">      mFrameData(NULL),</span><br><span class="line">      mFrameSize(0) {</span><br><span class="line">    <span class="keyword">if</span> (id) {</span><br><span class="line">        mID = strdup(id);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//&#x627E;&#x5230;&#x5E27;&#x5BF9;&#x5E94;&#x7684;&#x4F4D;&#x7F6E;</span></span><br><span class="line">    findFrame();</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x5728;findFrame&#x4E2D;&#x5C06;&#x5F53;&#x524D;ID&#x4E0E;&#x5B58;&#x50A8;&#x7740;&#x5168;&#x90E8;&#x6807;&#x7B7E;&#x5E27;&#x6570;&#x636E;&#x7684;mData&#x7A7A;&#x95F4;&#x4E2D;&#x7684;&#x6BCF;&#x4E2A;&#x5E27;&#x8FDB;&#x884C;&#x5BF9;&#x6BD4;&#xFF0C;&#x5982;&#x679C;&#x627E;&#x5230;&#x5E27;&#x6807;&#x5FD7;&#x7B49;&#x4E8E;&#x5F53;&#x524D;ID&#x7684;&#x6570;&#x636E;&#x7684;&#x65F6;&#x5019;&#x5C31;&#x9000;&#x51FA;&#x904D;&#x5386;&#x5FAA;&#x73AF;&#xFF0C;&#x8FD9;&#x65F6;&#x5019;mID&#x5C31;&#x6307;&#x5411;&#x8981;&#x5BFB;&#x627E;&#x6807;&#x7B7E;&#x6570;&#x636E;&#x7684;&#x4F4D;&#x7F6E;&#x3002;<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> ID3::Iterator::findFrame() {</span><br><span class="line">    <span class="keyword">for</span> (;;) {</span><br><span class="line">        mFrameData = <span class="literal">NULL</span>;</span><br><span class="line">        mFrameSize = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (mParent.mVersion == ID3_V2_2) {</span><br><span class="line">           <span class="comment">//..................................................</span></span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (mParent.mVersion == ID3_V2_3</span><br><span class="line">                || mParent.mVersion == ID3_V2_4) {</span><br><span class="line">            <span class="comment">//&#x8FD9;&#x662F;&#x6B63;&#x5E38;&#x7684;MP3&#x683C;&#x5F0F;</span></span><br><span class="line">            <span class="keyword">if</span> (mOffset + <span class="number">10</span> &gt; mParent.mSize) {</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">//&#x5982;&#x679C;&#x5934;&#x56DB;&#x4E2A;&#x5B57;&#x8282;&#x4E3A;0000&#x5219;&#x8FD4;&#x56DE;</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">memcmp</span>(&amp;mParent.mData[mOffset], <span class="string">&quot;\0\0\0\0&quot;</span>, <span class="number">4</span>)) {</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">size_t</span> baseSize;</span><br><span class="line">            <span class="keyword">if</span> (mParent.mVersion == ID3_V2_4) {</span><br><span class="line">                <span class="comment">//.......................................................................</span></span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">//&#x83B7;&#x53D6;&#x6807;&#x7B7E;&#x5E27;&#x7684;&#x5185;&#x5BB9;&#x5927;&#x5C0F;</span></span><br><span class="line">                baseSize = U32_AT(&amp;mParent.mData[mOffset + <span class="number">4</span>]);</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">//&#x8868;&#x793A;&#x5305;&#x542B;&#x5E27;&#x5934;&#x7684;&#x603B;&#x5171;&#x5927;&#x5C0F;</span></span><br><span class="line">            mFrameSize = <span class="number">10</span> + baseSize;</span><br><span class="line">            <span class="keyword">if</span> (mOffset + mFrameSize &gt; mParent.mSize) {</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">//&#x5F53;&#x524D;&#x6807;&#x7B7E;&#x5E27;&#x7684;&#x5185;&#x5BB9;&#x6570;&#x636E;</span></span><br><span class="line">            mFrameData = &amp;mParent.mData[mOffset + <span class="number">10</span>];</span><br><span class="line">            <span class="keyword">if</span> (!mID) {</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">//&#x5C06;Tab &#x590D;&#x5236;&#x5230;id&#x4E0A;&#xFF0C;&#x5224;&#x65AD;id&#x662F;&#x5426;&#x7B49;&#x4E8E;mID&#x5982;&#x679C;&#x4E0D;&#x7B49;&#x5219;&#x7EE7;&#x7EED;&#x67E5;&#x627E;</span></span><br><span class="line">            <span class="keyword">char</span> id[<span class="number">5</span>];</span><br><span class="line">            <span class="built_in">memcpy</span>(id, &amp;mParent.mData[mOffset], <span class="number">4</span>);</span><br><span class="line">            id[<span class="number">4</span>] = <span class="string">&apos;\0&apos;</span>;</span><br><span class="line">            <span class="comment">//&#x5982;&#x679C;&#x7B49;&#x4E8E;&#x8981;&#x627E;&#x7684;ID &#x5219;&#x9000;&#x51FA;&#x5FAA;&#x73AF;&#xFF0C;&#x8FD9;&#x65F6;&#x5019;mOffset &#x6307;&#x5411;&#x7684;&#x662F;&#x8981;&#x67E5;&#x627E;&#x5E27;&#x7684;&#x4F4D;&#x7F6E;</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(id, mID)) {</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">           <span class="comment">//.................................................</span></span><br><span class="line">        }</span><br><span class="line">        mOffset += mFrameSize;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x83B7;&#x53D6;&#x4E13;&#x8F91;&#x56FE;&#x7247;&#xFF1A;<br>&#x4E13;&#x8F91;&#x56FE;&#x7247;&#x7684;&#x83B7;&#x53D6;&#x8FC7;&#x7A0B;&#x5B9E;&#x9645;&#x548C;&#x83B7;&#x53D6;&#x5176;&#x4ED6;TAG&#x7684;&#x65B9;&#x5F0F;&#x662F;&#x4E00;&#x6837;&#x7684;&#xFF0C;&#x4E5F;&#x662F;&#x901A;&#x8FC7;&#x904D;&#x5386;&#x5B58;&#x653E;ID3&#x6807;&#x7B7E;&#x539F;&#x59CB;&#x6570;&#x636E;&#x7684;mData&#x7A7A;&#x95F4;&#xFF0C;&#x627E;&#x5230;&#x6807;&#x7B7E;&#x4E3A;&#x201D;APIC&#x201D;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x5C06;&#x6307;&#x5411;&#x4E13;&#x8F91;&#x56FE;&#x7247;&#x7684;&#x6570;&#x636E;&#x7684;&#x9996;&#x5730;&#x5740;&#x8FD4;&#x56DE;&#x3002;<br><figure class="highlight processing"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">void</span> *</span><br><span class="line">ID3::getAlbumArt(size_t *length, String8 *mime) <span class="keyword">const</span> {</span><br><span class="line">    *length = <span class="number">0</span>;</span><br><span class="line">    mime-&gt;setTo(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="comment">//APIC Attached picture &#x5B9A;&#x4F4D;&#x4E13;&#x8F91;&#x56FE;&#x7247;&#x7684;&#x4F4D;&#x7F6E;</span></span><br><span class="line">    Iterator it(*<span class="keyword">this</span>,(mVersion == ID3_V2_3 || mVersion == ID3_V2_4) ? <span class="string">&quot;APIC&quot;</span> : <span class="string">&quot;PIC&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (!it.done()) {</span><br><span class="line">        size_t <span class="built_in">size</span>;</span><br><span class="line">        <span class="comment">//&#x6307;&#x5411;&#x4E13;&#x8F91;&#x56FE;&#x7247;&#x6570;&#x636E;</span></span><br><span class="line">        <span class="keyword">const</span> uint8_t *data = it.getData(&amp;<span class="built_in">size</span>);</span><br><span class="line">        <span class="keyword">if</span> (mVersion == ID3_V2_3 || mVersion == ID3_V2_4) {</span><br><span class="line">            uint8_t encoding = data[<span class="number">0</span>];</span><br><span class="line">            mime-&gt;setTo((<span class="keyword">const</span> <span class="built_in">char</span> *)&amp;data[<span class="number">1</span>]);</span><br><span class="line">            size_t mimeLen = strlen((<span class="keyword">const</span> <span class="built_in">char</span> *)&amp;data[<span class="number">1</span>]) + <span class="number">1</span>;</span><br><span class="line">            <span class="comment">//&#x8FD4;&#x56DE;&#x56FE;&#x7247;&#x7684;&#x7C7B;&#x578B;</span></span><br><span class="line">            uint8_t picType = data[<span class="number">1</span> + mimeLen];</span><br><span class="line">            <span class="comment">//&#x56FE;&#x7247;&#x63CF;&#x8FF0;&#x7684;&#x5185;&#x5BB9;&#x957F;&#x5EA6;</span></span><br><span class="line">            size_t descLen = StringSize(&amp;data[<span class="number">2</span> + mimeLen], encoding);</span><br><span class="line">            <span class="comment">//&#x56FE;&#x7247;&#x7684;&#x5B9E;&#x9645;&#x957F;&#x5EA6;</span></span><br><span class="line">            *length = <span class="built_in">size</span> - <span class="number">2</span> - mimeLen - descLen;</span><br><span class="line">            <span class="comment">//&#x8FD4;&#x56DE;&#x56FE;&#x7247;&#x7684;&#x5730;&#x5740;</span></span><br><span class="line">            <span class="keyword">return</span> &amp;data[<span class="number">2</span> + mimeLen + descLen];</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">         <span class="comment">//...........................................................</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> NULL;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x4E0A;&#x8FF0;&#x5C31;&#x662F;&#x83B7;&#x53D6;&#x5404;&#x4E2A;&#x6807;&#x7B7E;&#x5E27;&#x6570;&#x636E;&#x7684;&#x6D41;&#x7A0B;&#xFF0C;&#x627E;&#x51FA;&#x6807;&#x7B7E;&#x5E27;&#x7684;&#x503C;&#x540E;&#x5C31;&#x5C06;&#x53EF;&#x4EE5;&#x5C06;&#x5176;&#x53D6;&#x51FA;&#x5B58;&#x50A8;&#x5230;mMetaData&#x4E2D;&#x4E86;&#x3002;<br>&#x6211;&#x4EEC;&#x518D;&#x56DE;&#x5230;processFileInternal&#x65B9;&#x6CD5;&#xFF0C;&#x770B;&#x4E0B;&#x63A5;&#x4E0B;&#x6765;&#x9700;&#x8981;&#x505A;&#x54EA;&#x4E9B;&#x64CD;&#x4F5C;&#xFF1A;&#x5B83;&#x5C06;&#x4F1A;&#x8C03;&#x7528;status = client.addStringTag(kKeyMap[i].tag, value);&#x5C06;&#x8BE5;Tag&#x4F20;&#x9012;&#x5230;MediaScannerClient&#x4E2D;&#x8FDB;&#x884C;&#x5904;&#x7406;&#xFF0C;&#x90A3;&#x4E48;&#x5728;MediaScannerClient&#x4E2D;&#x4F1A;&#x505A;&#x54EA;&#x4E9B;&#x5904;&#x7406;&#x5462;&#xFF1F;</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">status_t</span> MediaScannerClient::addStringTag(<span class="keyword">const</span> <span class="keyword">char</span>* name, <span class="keyword">const</span> <span class="keyword">char</span>* value)</span><br><span class="line">{</span><br><span class="line">    handleStringTag(name, value);</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5728;MediaScanner.java&#x4E2D;&#x5C06;&#x4ECE;&#x5E95;&#x5C42;&#x4F20;&#x6765;&#x7684;&#x5BF9;&#x5E94;&#x503C;&#x8D4B;&#x7ED9;&#x5BF9;&#x5E94;&#x7684;&#x6210;&#x5458;&#x53D8;&#x91CF;&#x3002;&#x81F3;&#x6B64;&#x5C31;&#x5B8C;&#x6210;&#x4E86;&#x97F3;&#x9891;&#x89C6;&#x9891;&#x6587;&#x4EF6;&#x7684;Tag&#x6807;&#x7B7E;&#x7684;&#x83B7;&#x53D6;&#x8FC7;&#x7A0B;&#x3002;&#x63A5;&#x4E0B;&#x6765;&#x548C;&#x5176;&#x4ED6;&#x666E;&#x901A;&#x6587;&#x4EF6;&#x7684;&#x5904;&#x7406;&#x65B9;&#x5F0F;&#x4E00;&#x6837;&#xFF0C;&#x5C31;&#x662F;&#x901A;&#x8FC7;MediaProvider&#x5C06;&#x5176;&#x5B58;&#x50A8;&#x5230;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x3002;&#x4ECE;&#x800C;&#x5B8C;&#x6210;&#x5A92;&#x4F53;&#x626B;&#x63CF;&#x7684;&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x3002;<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleStringTag</span><span class="params">(String name, String value)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (name.equalsIgnoreCase(<span class="string">&quot;title&quot;</span>) || name.startsWith(<span class="string">&quot;title;&quot;</span>)) {</span><br><span class="line">        <span class="comment">// Don&apos;t trim() here, to preserve the special \001 character</span></span><br><span class="line">        <span class="comment">// used to force sorting. The media provider will trim() before</span></span><br><span class="line">        <span class="comment">// inserting the title in to the database.</span></span><br><span class="line">        mTitle = value;</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (name.equalsIgnoreCase(<span class="string">&quot;artist&quot;</span>) || name.startsWith(<span class="string">&quot;artist;&quot;</span>)) {</span><br><span class="line">        mArtist = value.trim();</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (name.equalsIgnoreCase(<span class="string">&quot;albumartist&quot;</span>) || name.startsWith(<span class="string">&quot;albumartist;&quot;</span>)</span><br><span class="line">            || name.equalsIgnoreCase(<span class="string">&quot;band&quot;</span>) || name.startsWith(<span class="string">&quot;band;&quot;</span>)) {</span><br><span class="line">        mAlbumArtist = value.trim();</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (name.equalsIgnoreCase(<span class="string">&quot;album&quot;</span>) || name.startsWith(<span class="string">&quot;album;&quot;</span>)) {</span><br><span class="line">        mAlbum = value.trim();</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (name.equalsIgnoreCase(<span class="string">&quot;composer&quot;</span>) || name.startsWith(<span class="string">&quot;composer;&quot;</span>)) {</span><br><span class="line">        mComposer = value.trim();</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (mProcessGenres &amp;&amp;</span><br><span class="line">            (name.equalsIgnoreCase(<span class="string">&quot;genre&quot;</span>) || name.startsWith(<span class="string">&quot;genre;&quot;</span>))) {</span><br><span class="line">        mGenre = getGenreName(value);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (name.equalsIgnoreCase(<span class="string">&quot;year&quot;</span>) || name.startsWith(<span class="string">&quot;year;&quot;</span>)) {</span><br><span class="line">        mYear = parseSubstring(value, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (name.equalsIgnoreCase(<span class="string">&quot;tracknumber&quot;</span>) || name.startsWith(<span class="string">&quot;tracknumber;&quot;</span>)) {</span><br><span class="line">        <span class="comment">// track number might be of the form &quot;2/12&quot;</span></span><br><span class="line">        <span class="comment">// we just read the number before the slash</span></span><br><span class="line">        <span class="keyword">int</span> num = parseSubstring(value, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        mTrack = (mTrack / <span class="number">1000</span>) * <span class="number">1000</span> + num;</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (name.equalsIgnoreCase(<span class="string">&quot;discnumber&quot;</span>) ||</span><br><span class="line">            name.equals(<span class="string">&quot;set&quot;</span>) || name.startsWith(<span class="string">&quot;set;&quot;</span>)) {</span><br><span class="line">        <span class="comment">// set number might be of the form &quot;1/3&quot;</span></span><br><span class="line">        <span class="comment">// we just read the number before the slash</span></span><br><span class="line">        <span class="keyword">int</span> num = parseSubstring(value, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        mTrack = (num * <span class="number">1000</span>) + (mTrack % <span class="number">1000</span>);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (name.equalsIgnoreCase(<span class="string">&quot;duration&quot;</span>)) {</span><br><span class="line">        mDuration = parseSubstring(value, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (name.equalsIgnoreCase(<span class="string">&quot;writer&quot;</span>) || name.startsWith(<span class="string">&quot;writer;&quot;</span>)) {</span><br><span class="line">        mWriter = value.trim();</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (name.equalsIgnoreCase(<span class="string">&quot;compilation&quot;</span>)) {</span><br><span class="line">        mCompilation = parseSubstring(value, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (name.equalsIgnoreCase(<span class="string">&quot;isdrm&quot;</span>)) {</span><br><span class="line">        mIsDrm = (parseSubstring(value, <span class="number">0</span>, <span class="number">0</span>) == <span class="number">1</span>);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (name.equalsIgnoreCase(<span class="string">&quot;width&quot;</span>)) {</span><br><span class="line">        mWidth = parseSubstring(value, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (name.equalsIgnoreCase(<span class="string">&quot;height&quot;</span>)) {</span><br><span class="line">        mHeight = parseSubstring(value, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">//Log.v(TAG, &quot;unknown tag: &quot; + name + &quot; (&quot; + mProcessGenres + &quot;)&quot;);</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x81F3;&#x6B64;TAG&#x7684;&#x89E3;&#x6790;&#x4EE5;&#x53CA;&#x89E3;&#x7801;&#x8FC7;&#x7A0B;&#x5DF2;&#x7ECF;&#x7ED3;&#x675F;&#xFF0C;&#x6211;&#x4EEC;&#x6700;&#x540E;&#x8FD8;&#x9700;&#x8981;&#x770B;&#x4E0B;handleStringTag&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E2D;&#x4F1A;&#x5C06;&#x89E3;&#x7801;&#x540E;&#x7684;TAG&#x5982;&#x4F55;&#x505A;&#x5904;&#x7406;&#x5462;&#xFF1F;<br>&#x6211;&#x4EEC;&#x9996;&#x5148;&#x9700;&#x8981;&#x770B;&#x4E0B;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x662F;&#x5982;&#x4F55;&#x4ECE;native&#x5C42;&#x4E0A;&#x5347;&#x5230;Java&#x5C42;&#x7684;&#xFF0C;&#x8BF4;&#x5230;&#x8FD9;&#x4E2A;&#x5C31;&#x5FC5;&#x987B;&#x8003;&#x8651;android_media_MediaScanner.cpp&#x8FD9;&#x4E2A;&#x8FC7;&#x6E21;&#x7C7B;&#xFF0C;&#x5728;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x4E2D;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x627E;&#x5230;handleStringTag&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x548C;&#x5176;&#x4ED6;&#x4E00;&#x6837;&#x5728;&#x8FD9;&#x91CC;&#x8C03;&#x7528;&#x4E86;CallVoidMethod&#x65B9;&#x6CD5;&#x8FDB;&#x5165;&#x5230;java&#x5C42;&#x3002;&#x8FD9;&#x6837;java&#x5C42;&#x4E2D;&#x7684;handleStringTag&#x5C31;&#x4F1A;&#x88AB;&#x8C03;&#x7528;&#x3002;<br><figure class="highlight zephir"><table><tr><td class="code"><pre><span class="line">virtual status_t handleStringTag(<span class="keyword">const</span> <span class="keyword">char</span>* name, <span class="keyword">const</span> <span class="keyword">char</span>* value)</span><br><span class="line">{</span><br><span class="line">    ALOGV(<span class="string">&quot;MediaScanner handleStringTag: name(%s) and value(%s)&quot;</span>, name, value);</span><br><span class="line">    jstring nameStr, valueStr;</span><br><span class="line">    <span class="keyword">if</span> ((nameStr = mEnv-&gt;NewStringUTF(name)) == <span class="keyword">NULL</span>) {</span><br><span class="line">        mEnv-&gt;ExceptionClear();</span><br><span class="line">        <span class="keyword">return</span> NO_MEMORY;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">char</span> *cleaned = <span class="keyword">NULL</span>;</span><br><span class="line">    <span class="comment">//&#x5982;&#x679C;&#x4E0D;&#x662F;&#x6B63;&#x5E38;&#x7684;UTF-8&#x5219;&#x5C06;&#x5176;&#x7F6E;&#x4E3A;&#xFF1F;</span></span><br><span class="line">    <span class="keyword">if</span> (!isValidUtf8(value)) {</span><br><span class="line">        cleaned = strdup(value);</span><br><span class="line">        <span class="keyword">char</span> *chp = cleaned;</span><br><span class="line">        <span class="keyword">char</span> ch;</span><br><span class="line">        <span class="keyword">while</span> ((ch = *chp)) {</span><br><span class="line">            <span class="keyword">if</span> (ch &amp; <span class="number">0x80</span>) {</span><br><span class="line">                *chp = <span class="string">&apos;?&apos;</span>;</span><br><span class="line">            }</span><br><span class="line">            chp++;</span><br><span class="line">        }</span><br><span class="line">        value = cleaned;</span><br><span class="line">    }</span><br><span class="line">    valueStr = mEnv-&gt;NewStringUTF(value);</span><br><span class="line">    free(cleaned);</span><br><span class="line">    <span class="keyword">if</span> (valueStr == <span class="keyword">NULL</span>) {</span><br><span class="line">        mEnv-&gt;DeleteLocalRef(nameStr);</span><br><span class="line">        mEnv-&gt;ExceptionClear();</span><br><span class="line">        <span class="keyword">return</span> NO_MEMORY;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//&#x8C03;&#x7528;JAVA&#x5C42;&#x7684;handleStringTag&#x65B9;&#x6CD5;&#x3002;</span></span><br><span class="line">    mEnv-&gt;CallVoidMethod(mClient, mHandleStringTagMethodID, nameStr, valueStr);</span><br><span class="line">    mEnv-&gt;DeleteLocalRef(nameStr);</span><br><span class="line">    mEnv-&gt;DeleteLocalRef(valueStr);</span><br><span class="line">    <span class="keyword">return</span> checkAndClearExceptionFromCallback(mEnv, <span class="string">&quot;handleStringTag&quot;</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">&#x6700;&#x540E;&#x8FD8;&#x662F;&#x4E0A;&#x4E2A;&#x56FE;&#x5427;&#xFF0C;&#x867D;&#x7136;&#x6D41;&#x7A0B;&#x7B80;&#x5355;&#x4F46;&#x662F;&#x8FD8;&#x662F;&#x5F88;&#x6742;&#x7684;&#xFF0C;&#x5BB9;&#x6613;&#x4E71;&#xFF1A;</span><br><span class="line">![](/Android-&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;MediaScanner-<span class="number">2.</span>md/<span class="number">1.</span>png)</span><br></pre></td></tr></table></figure></p>
<p>&#x9644;&#x5F55;&#xFF1A;&#x5E27;&#x6807;&#x8BC6;&#x7684;&#x542B;&#x4E49;<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">AENC    	Audio encryption</span><br><span class="line">APIC   		Attached picture</span><br><span class="line">COMM		Comments</span><br><span class="line">COMR		Commercial</span><br><span class="line">ENCR		Encryption method registration</span><br><span class="line">EQUA		Equalization</span><br><span class="line">ETCO		Event timing codes</span><br><span class="line">GEOB		General encapsulated object</span><br><span class="line">GRID		Group identification registration</span><br><span class="line">IPLS		Involved people list</span><br><span class="line">LINK		Linked information</span><br><span class="line">MCDI		Music CD identifier</span><br><span class="line">MLLT 		MPEGlocation lookup table</span><br><span class="line">OWNE		Ownership</span><br><span class="line">PRIV		Private</span><br><span class="line">PCNT 		Playcounter</span><br><span class="line">POPM		Popularimeter</span><br><span class="line">POSS		Position synchronisation</span><br><span class="line">RBUF		Recommended buffer size</span><br><span class="line">RVAD		Relative volume adjustment</span><br><span class="line">RVRB		Reverb</span><br><span class="line">SYLT		Synchronized lyric/text</span><br><span class="line">SYTC		Synchronized tempo codes</span><br><span class="line">TALB		Album/Movie/<span class="operator"><span class="keyword">Show</span> title</span><br><span class="line">TBPM 		BPM(beats per <span class="keyword">minute</span>)</span><br><span class="line">TCOM		Composer</span><br><span class="line">TCON		<span class="keyword">Content</span> <span class="keyword">type</span></span><br><span class="line">TCOP		Copyright message</span><br><span class="line">TDAT 		<span class="built_in">Date</span></span><br><span class="line">TDLY		Playlist delay</span><br><span class="line">TENC		Encoded <span class="keyword">by</span></span><br><span class="line"><span class="built_in">TEXT</span>		Lyricist/<span class="built_in">Text</span> writer</span><br><span class="line">TFLT 		Filetype</span><br><span class="line"><span class="keyword">TIME</span> 		<span class="keyword">Time</span></span><br><span class="line">TIT1		<span class="keyword">Content</span> <span class="keyword">group</span> deion</span><br><span class="line">TIT2		Title/songname/<span class="keyword">content</span> deion</span><br><span class="line">TIT3		Subtitle/Deion refinement</span><br><span class="line">TKEY		<span class="keyword">Initial</span> <span class="keyword">key</span></span><br><span class="line">TLAN		<span class="keyword">Language</span>(s)</span><br><span class="line">TLEN		<span class="keyword">Length</span></span><br><span class="line">TMED		Media <span class="keyword">type</span></span><br><span class="line">TOAL		Original album/movie/<span class="keyword">show</span> title</span><br><span class="line">TOFN		Original filename</span><br><span class="line">TOLY		Original lyricist(s)/<span class="built_in">text</span> writer(s)</span><br><span class="line">TOPE		Original artist(s)/performer(s)</span><br><span class="line">TORY		Original <span class="keyword">release</span> <span class="keyword">year</span></span><br><span class="line">TOWN 		Fileowner/licensee</span><br><span class="line">TPE1 		Leadperformer(s)/Soloist(s)</span><br><span class="line">TPE2		Band/orchestra/accompaniment</span><br><span class="line">TPE3		Conductor/performer refinement</span><br><span class="line">TPE4		Interpreted, remixed, <span class="keyword">or</span> otherwise modified <span class="keyword">by</span></span><br><span class="line">TPOS 		Partof a <span class="keyword">set</span></span><br><span class="line">TPUB		Publisher</span><br><span class="line">TRCK		Track <span class="built_in">number</span>/<span class="keyword">Position</span> <span class="keyword">in</span> <span class="keyword">set</span></span><br><span class="line">TRDA		Recording dates</span><br><span class="line">TRSN		Internet radio station <span class="keyword">name</span></span><br><span class="line">TRSO		Internet radio station owner</span><br><span class="line">TSIZ 		<span class="keyword">Size</span></span><br><span class="line">TSRC 		ISRC(international standard recording code)</span><br><span class="line">TSSE		Software/Hardware <span class="keyword">and</span> <span class="keyword">settings</span> used <span class="keyword">for</span> <span class="keyword">encoding</span></span><br><span class="line">TYER		<span class="keyword">Year</span></span><br><span class="line">TXXX 		Userdefined <span class="built_in">text</span> information</span><br><span class="line">UFID		<span class="keyword">Unique</span> <span class="keyword">file</span> identifier</span><br><span class="line"><span class="keyword">USER</span>		Terms <span class="keyword">of</span> <span class="keyword">use</span></span><br><span class="line">USLT		Unsychronized lyric/<span class="built_in">text</span> tranion</span><br><span class="line">WCOM		Commercial information</span><br><span class="line">WCOP		Copyright/Legal information</span><br><span class="line">WOAF		Official audio <span class="keyword">file</span> webpage</span><br><span class="line">WOAR		Official artist/performer webpage</span><br><span class="line">WOAS		Official audio <span class="keyword">source</span> webpage</span><br><span class="line">WORS		Official internet radio station homepage</span><br><span class="line">WPAY		Payment</span><br><span class="line">WPUB		Publishers official webpage</span><br><span class="line">WXXX 		Userdefined <span class="keyword">URL</span> <span class="keyword">link</span></span></span><br></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android-源码分析/">Android 源码分析</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/AOSP-源码/">AOSP 源码</a>
  </div>

</div>



<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/07/29/Android-源码分析之MediaScanner-2/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/07/29/Android-源码分析之MediaScanner-2/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/07/28/Android-源码分析之MediaScanner/" title="Android-源码分析之MediaScanner[1]" itemprop="url">Android-源码分析之MediaScanner[1]</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Edgar" target="_blank" itemprop="author">Edgar</a>
		
  <p class="article-time">
    <time datetime="2016-07-28T04:37:45.000Z" itemprop="datePublished"> 發表於 2016-07-28</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>MediaScanner&#x5A92;&#x4F53;&#x626B;&#x63CF;&#x5668;&#x987E;&#x540D;&#x601D;&#x4E49;&#x5C31;&#x662F;&#x7528;&#x4E8E;&#x626B;&#x63CF;&#x624B;&#x673A;&#x5185;&#x90E8;&#x591A;&#x5A92;&#x4F53;&#x6587;&#x4EF6;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x5E76;&#x5C06;&#x8FD9;&#x4E9B;&#x4FE1;&#x606F;&#x5B58;&#x50A8;&#x5230;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x7684;&#x6A21;&#x5757;&#x3002;&#x6211;&#x4EEC;&#x4ECA;&#x5929;&#x5C31;&#x9488;&#x5BF9;MediaScanner&#x8FD9;&#x4E2A;&#x6A21;&#x5757;&#x8FDB;&#x884C;&#x5206;&#x6790;&#x5B66;&#x4E60;&#x4E00;&#x4E0B;&#xFF1A;</p>
<h4 id="&#x666E;&#x901A;&#x6587;&#x4EF6;&#x7684;&#x626B;&#x63CF;&#x6D41;&#x7A0B;"><a href="#&#x666E;&#x901A;&#x6587;&#x4EF6;&#x7684;&#x626B;&#x63CF;&#x6D41;&#x7A0B;" class="headerlink" title="&#x666E;&#x901A;&#x6587;&#x4EF6;&#x7684;&#x626B;&#x63CF;&#x6D41;&#x7A0B;"></a>&#x666E;&#x901A;&#x6587;&#x4EF6;&#x7684;&#x626B;&#x63CF;&#x6D41;&#x7A0B;</h4><h5 id="&#x626B;&#x63CF;&#x8BF7;&#x6C42;&#x7684;&#x63A5;&#x6536;&#x8005;-MediaScannerReceiver"><a href="#&#x626B;&#x63CF;&#x8BF7;&#x6C42;&#x7684;&#x63A5;&#x6536;&#x8005;-MediaScannerReceiver" class="headerlink" title="&#x626B;&#x63CF;&#x8BF7;&#x6C42;&#x7684;&#x63A5;&#x6536;&#x8005;  MediaScannerReceiver"></a>&#x626B;&#x63CF;&#x8BF7;&#x6C42;&#x7684;&#x63A5;&#x6536;&#x8005;  MediaScannerReceiver</h5><p>MediaScannerReceiver &#x7EE7;&#x627F;&#x81EA;BroadcastReceiver&#x5B83;&#x662F;&#x901A;&#x8FC7;&#x9759;&#x6001;&#x6CE8;&#x518C;&#x7684;&#x65B9;&#x5F0F;&#x8FDB;&#x884C;&#x6CE8;&#x518C;&#x7684;&#xFF1A;<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">receiver</span> <span class="attribute">android:name</span>=<span class="value">&quot;MediaScannerReceiver&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">action</span> <span class="attribute">android:name</span>=<span class="value">&quot;android.intent.action.BOOT_COMPLETED&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">intent-filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">action</span> <span class="attribute">android:name</span>=<span class="value">&quot;android.intent.action.MEDIA_MOUNTED&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">data</span> <span class="attribute">android:scheme</span>=<span class="value">&quot;file&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">intent-filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">action</span> <span class="attribute">android:name</span>=<span class="value">&quot;android.intent.action.MEDIA_UNMOUNTED&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">data</span> <span class="attribute">android:scheme</span>=<span class="value">&quot;file&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">intent-filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">action</span> <span class="attribute">android:name</span>=<span class="value">&quot;android.intent.action.MEDIA_SCANNER_SCAN_FILE&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">data</span> <span class="attribute">android:scheme</span>=<span class="value">&quot;file&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">receiver</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>&#x4ECE;&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x53EF;&#x4EE5;&#x770B;&#x51FA;MediaScannerReceiver&#x63A5;&#x53D7;&#x4E09;&#x79CD;&#x626B;&#x63CF;&#x8BF7;&#x6C42;&#x5E7F;&#x64AD;&#xFF1A;</p>
<ul>
<li>Intent.ACTION_BOOT_COMPLETED:&#x5F00;&#x673A;&#x5E7F;&#x64AD;&#xFF0C;&#x5728;&#x6536;&#x5230;&#x5F00;&#x673A;&#x5E7F;&#x64AD;&#x540E;&#x4F1A;&#x626B;&#x63CF;&#x5185;&#x90E8;&#x548C;&#x5916;&#x90E8;&#x5B58;&#x50A8;&#x8DEF;&#x5F84;&#x4E0B;&#x7684;&#x591A;&#x5A92;&#x4F53;&#x6587;&#x4EF6;&#x3002;</li>
<li>Intent.ACTION_MEDIA_MOUNTED:&#x5728;&#x67D0;&#x4E2A;&#x5916;&#x90E8;&#x5B58;&#x50A8;&#x5668;&#x52A0;&#x8F7D;&#x7684;&#x65F6;&#x5019;&#x3002;</li>
<li>Intent.ACTION_MEDIA_UNMOUNTED: &#x5728;&#x67D0;&#x4E2A;&#x5916;&#x90E8;&#x5B58;&#x50A8;&#x5668;&#x5378;&#x8F7D;&#x7684;&#x65F6;&#x5019;</li>
<li>Intent.ACTION_MEDIA_SCANNER_SCAN_FILE&#xFF1A;&#x5728;&#x63A5;&#x53D7;&#x5230;&#x5BF9;&#x67D0;&#x4E2A;&#x6587;&#x4EF6;&#x8FDB;&#x884C;&#x626B;&#x63CF;&#x7684;&#x8BF7;&#x6C42;&#x7684;&#x65F6;&#x5019;&#x8C03;&#x7528;scanFile&#x65B9;&#x6CD5;&#x8FDB;&#x884C;&#x626B;&#x63CF;&#x3002;</li>
</ul>
<p>&#x90A3;&#x6BCF;&#x79CD;&#x5E7F;&#x64AD;&#x5230;&#x6765;&#x7684;&#x65F6;&#x5019;&#x53C8;&#x4F1A;&#x8FDB;&#x884C;&#x600E;&#x6837;&#x7684;&#x54CD;&#x5E94;&#x5462;&#xFF1F;<br><figure class="highlight lasso"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="literal">void</span> onReceive(Context context, Intent intent) {</span><br><span class="line">    final <span class="built_in">String</span> action = intent<span class="built_in">.</span>getAction();</span><br><span class="line">    final Uri uri = intent<span class="built_in">.</span>getData();</span><br><span class="line">    <span class="comment">//&#x6536;&#x5230;&#x5F00;&#x673A;&#x5E7F;&#x64AD;&#x540E;&#x626B;&#x63CF;</span></span><br><span class="line">    <span class="keyword">if</span> (Intent<span class="built_in">.</span>ACTION_BOOT_COMPLETED<span class="built_in">.</span><span class="keyword">equals</span>(action)) {</span><br><span class="line">        <span class="comment">// Scan both internal and external storage</span></span><br><span class="line">         <span class="comment">//&#x626B;&#x63CF;&#x5185;&#x90E8;&#x5B58;&#x50A8;&#x5668;&#x4E2D;/system/media&#x91CC;&#x9762;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x5B58;&#x653E;&#x7684;&#x662F;&#x94C3;&#x58F0;&#x7B49;&#x591A;&#x5A92;&#x4F53;&#x6587;&#x4EF6;</span></span><br><span class="line">        scan(context, MediaProvider<span class="built_in">.</span>INTERNAL_VOLUME);</span><br><span class="line">        <span class="comment">//&#x626B;&#x63CF;&#x624B;&#x673A;&#x7684;&#x5916;&#x90E8;&#x5B58;&#x50A8;&#x5B9E;&#x9645;&#x626B;&#x63CF;&#x7684;&#x662F;/mnt/sdcard/</span></span><br><span class="line">        scan(context, MediaProvider<span class="built_in">.</span>EXTERNAL_VOLUME);</span><br><span class="line"></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">if</span> (uri<span class="built_in">.</span>getScheme()<span class="built_in">.</span><span class="keyword">equals</span>(<span class="string">&quot;file&quot;</span>)) {</span><br><span class="line">            <span class="comment">// handle intents related to external storage</span></span><br><span class="line">            <span class="built_in">String</span> path = uri<span class="built_in">.</span>getPath();</span><br><span class="line">            <span class="built_in">String</span> externalStoragePath = Environment<span class="built_in">.</span>getExternalStorageDirectory()<span class="built_in">.</span>getPath();</span><br><span class="line">            <span class="built_in">String</span> legacyPath = Environment<span class="built_in">.</span>getLegacyExternalStorageDirectory()<span class="built_in">.</span>getPath();</span><br><span class="line">            try {</span><br><span class="line">                path = <span class="literal">new</span> File(path)<span class="built_in">.</span>getCanonicalPath();</span><br><span class="line">            } catch (IOException e) {</span><br><span class="line">                <span class="keyword">Log</span><span class="built_in">.</span>e(<span class="built_in">TAG</span>, <span class="string">&quot;couldn&apos;t canonicalize &quot;</span> + path);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (path<span class="built_in">.</span>startsWith(legacyPath)) {</span><br><span class="line">                path = externalStoragePath + path<span class="built_in">.</span>substring(legacyPath<span class="built_in">.</span>length());</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">Log</span><span class="built_in">.</span>d(<span class="built_in">TAG</span>, <span class="string">&quot;action: &quot;</span> + action + <span class="string">&quot; path: &quot;</span> + path);</span><br><span class="line">            <span class="comment">//&#x6536;&#x5230;&#x5916;&#x90E8;&#x5B58;&#x50A8;&#x5668;&#x52A0;&#x8F7D;&#x5B8C;&#x6210;&#x5E7F;&#x64AD;&#x7684;&#x626B;&#x63CF;</span></span><br><span class="line">            <span class="keyword">if</span> (Intent<span class="built_in">.</span>ACTION_MEDIA_MOUNTED<span class="built_in">.</span><span class="keyword">equals</span>(action)) {</span><br><span class="line">                <span class="comment">// scan whenever any volume is mounted</span></span><br><span class="line">                scan(context, MediaProvider<span class="built_in">.</span>EXTERNAL_VOLUME);</span><br><span class="line">                <span class="comment">//&#x5982;&#x679C;&#x8BF7;&#x6C42;&#x7684;&#x662F;&#x626B;&#x63CF;&#x8DEF;&#x5F84;&#xFF0C;&#x5E76;&#x4E14;&#x8981;&#x626B;&#x63CF;&#x7684;&#x5C5E;&#x4E8E;&#x5916;&#x90E8;&#x5B58;&#x50A8;&#x8DEF;&#x5F84;&#x5219;&#x5F00;&#x59CB;&#x626B;&#x63CF;</span></span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (Intent<span class="built_in">.</span>ACTION_MEDIA_SCANNER_SCAN_FILE<span class="built_in">.</span><span class="keyword">equals</span>(action) <span class="subst">&amp;&amp;</span></span><br><span class="line">                    path != <span class="built_in">null</span> <span class="subst">&amp;&amp;</span> path<span class="built_in">.</span>startsWith(externalStoragePath + <span class="string">&quot;/&quot;</span>)) {</span><br><span class="line">                scanFile(context, path);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x6211;&#x4EEC;&#x770B;&#x5230;&#x6574;&#x4E2A;&#x626B;&#x63CF;&#x5F52;&#x7ED3;&#x4E8E;scan&#x548C;scanFile&#x4E24;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x8C03;&#x7528;&#x3002;&#x7279;&#x522B;&#x662F;scan&#x65B9;&#x6CD5;&#x65E2;&#x80FD;&#x591F;&#x626B;&#x63CF;&#x5916;&#x90E8;&#x5B58;&#x50A8;&#x53C8;&#x80FD;&#x626B;&#x63CF;&#x624B;&#x673A;&#x5185;&#x5B58;&#xFF0C;&#x552F;&#x4E00;&#x7684;&#x533A;&#x522B;&#x662F;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;&#x4E0D;&#x4E00;&#x6837;&#x800C;&#x5DF2;&#x3002;&#x6211;&#x4EEC;&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x6765;&#x770B;&#x4E0B;&#x8FD9;&#x90E8;&#x5206;&#x7684;&#x5B9E;&#x73B0;&#xFF1A;</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scan</span><span class="params">(Context context, String volume)</span> </span>{</span><br><span class="line">    Bundle args = <span class="keyword">new</span> Bundle();</span><br><span class="line">    args.putString(<span class="string">&quot;volume&quot;</span>, volume);</span><br><span class="line">    context.startService(</span><br><span class="line">            <span class="keyword">new</span> Intent(context, MediaScannerService.<span class="keyword">class</span>).putExtras(args));</span><br><span class="line">}    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scanFile</span><span class="params">(Context context, String path)</span> </span>{</span><br><span class="line">    Bundle args = <span class="keyword">new</span> Bundle();</span><br><span class="line">    args.putString(<span class="string">&quot;filepath&quot;</span>, path);</span><br><span class="line">    context.startService(</span><br><span class="line">            <span class="keyword">new</span> Intent(context, MediaScannerService.<span class="keyword">class</span>).putExtras(args));</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5F88;&#x7B80;&#x5355;&#x5427;&#xFF0C;&#x5C31;&#x76F4;&#x63A5;&#x5C06;&#x8DEF;&#x5F84;&#x4F20;&#x9012;&#x7ED9;MediaScannerService&#x5C31;OK&#x4E86;&#xFF0C;&#x552F;&#x4E00;&#x7684;&#x4E0D;&#x540C;&#x662F;&#x643A;&#x5E26;&#x6570;&#x636E;&#x7684;&#x65F6;&#x5019;key&#x4E0D;&#x4E00;&#x6837;&#x3002;</p>
<p>&#x5F53;&#x8C03;&#x7528;startService&#x540E;&#x5C31;&#x4F1A;&#x542F;&#x52A8;MediaScannerService&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x6765;&#x770B;&#x4E0B;MediaSannerService</p>
<h5 id="&#x626B;&#x63CF;&#x5904;&#x7406;&#x7684;&#x540E;&#x53F0;&#x5904;&#x7406;&#x8005;-MediaScannerService"><a href="#&#x626B;&#x63CF;&#x5904;&#x7406;&#x7684;&#x540E;&#x53F0;&#x5904;&#x7406;&#x8005;-MediaScannerService" class="headerlink" title="&#x626B;&#x63CF;&#x5904;&#x7406;&#x7684;&#x540E;&#x53F0;&#x5904;&#x7406;&#x8005; MediaScannerService"></a>&#x626B;&#x63CF;&#x5904;&#x7406;&#x7684;&#x540E;&#x53F0;&#x5904;&#x7406;&#x8005; MediaScannerService</h5><p>&#x5728;Scan&#x548C;ScanFile&#x542F;&#x52A8;&#x9996;&#x6B21;MediaScannerService&#x7684;&#x65F6;&#x5019;MediaScannerService&#x4F1A;&#x8C03;&#x7528;onCreate&#x65B9;&#x6CD5;&#x521B;&#x5EFA;&#x8FD9;&#x4E2A;&#x670D;&#x52A1;&#xFF0C;&#x5728;onCreate&#x4E2D;&#x6700;&#x91CD;&#x8981;&#x7684;&#x5DE5;&#x4F5C;&#x662F;&#x542F;&#x52A8;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x7528;&#x4E8E;&#x626B;&#x63CF;&#x4EFB;&#x52A1;&#xFF0C;&#x56E0;&#x4E3A;Service&#x8FD0;&#x884C;&#x5728;&#x4E3B;&#x7EBF;&#x7A0B;&#x4E2D;&#xFF0C;&#x5982;&#x679C;&#x76F4;&#x63A5;&#x5728;Service&#x4E2D;&#x6267;&#x884C;&#x626B;&#x63CF;&#x4EFB;&#x52A1;&#x7684;&#x8BDD;&#x4F1A;&#x963B;&#x585E;&#x4E3B;&#x7EBF;&#x7A0B;&#x3002;</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span></span><br><span class="line"></span>{</span><br><span class="line">    PowerManager pm = (PowerManager)getSystemService(Context.POWER_SERVICE);</span><br><span class="line">    mWakeLock = pm.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK, TAG);</span><br><span class="line">    StorageManager storageManager = (StorageManager)getSystemService(Context.STORAGE_SERVICE);</span><br><span class="line">    mExternalStoragePaths = storageManager.getVolumePaths();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start up the thread running the service.  Note that we create a</span></span><br><span class="line">    <span class="comment">// separate thread because the service normally runs in the process&apos;s</span></span><br><span class="line">    <span class="comment">// main thread, which we don&apos;t want to block.</span></span><br><span class="line">    Thread thr = <span class="keyword">new</span> Thread(<span class="keyword">null</span>, <span class="keyword">this</span>, <span class="string">&quot;MediaScannerService&quot;</span>);</span><br><span class="line">    thr.start();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x90A3;&#x4E48;&#x5728;&#x626B;&#x63CF;&#x7EBF;&#x7A0B;thr&#x4E2D;&#x53C8;&#x662F;&#x505A;&#x4E86;&#x54EA;&#x4E9B;&#x5DE5;&#x4F5C;&#x5462;&#xFF1F;&#x4ECE;run&#x65B9;&#x6CD5;&#x4E2D;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x5728;thr&#x7EBF;&#x7A0B;&#x4E2D;&#x4E3B;&#x8981;&#x662F;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;ServiceHandler&#x3002;</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span><br><span class="line"></span>{</span><br><span class="line">    <span class="comment">// reduce priority below other background threads to avoid interfering</span></span><br><span class="line">    <span class="comment">// with other services at boot time.</span></span><br><span class="line">    Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND +Process.THREAD_PRIORITY_LESS_FAVORABLE);</span><br><span class="line">    Looper.prepare();</span><br><span class="line"></span><br><span class="line">    mServiceLooper = Looper.myLooper();</span><br><span class="line">    mServiceHandler = <span class="keyword">new</span> ServiceHandler();</span><br><span class="line">    Looper.loop();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5728;&#x4E4B;&#x540E;&#x8C03;&#x7528;startService&#x7684;&#x65F6;&#x5019;&#xFF0C;MediaScannerService&#x7C7B;&#x4E2D;&#x7684;onStartCommand&#x65B9;&#x6CD5;&#x5C06;&#x4F1A;&#x88AB;&#x8C03;&#x7528;&#x3002;&#x5728;onStartCommand&#x65B9;&#x6CD5;&#x4E2D;&#x5411;mServiceHandler&#x53D1;&#x9001;&#x626B;&#x63CF;&#x8BF7;&#x6C42;&#x3002;&#x5728;&#x4F20;&#x9012;&#x7ED9;mServiceHandler&#x7684;&#x6D88;&#x606F;&#x4E2D;&#x5305;&#x542B;&#x4E86;&#x4ECE;Intent&#x4E2D;&#x83B7;&#x53D6;&#x7684;extra&#x4FE1;&#x606F;&#xFF0C;&#x51ED;&#x501F;&#x7740;&#x8FD9;&#x4E2A;&#x4FE1;&#x606F;&#x53EF;&#x4EE5;&#x533A;&#x5206;&#x5F53;&#x524D;&#x7684;&#x626B;&#x63CF;&#x8BF7;&#x6C42;&#x662F;&#x626B;&#x63CF;&#x6574;&#x4E2A;valum&#x8FD8;&#x662F;&#x5355;&#x4E2A;&#x6587;&#x4EF6;&#x3002;</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span></span><br><span class="line"></span>{</span><br><span class="line">    <span class="keyword">while</span> (mServiceHandler == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                wait(<span class="number">100</span>);</span><br><span class="line">            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (intent == <span class="keyword">null</span>) {</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;Intent is null in onStartCommand: &quot;</span>,</span><br><span class="line">            <span class="keyword">new</span> NullPointerException());</span><br><span class="line">        <span class="keyword">return</span> Service.START_NOT_STICKY;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    Message msg = mServiceHandler.obtainMessage();</span><br><span class="line">    msg.arg1 = startId;</span><br><span class="line">    msg.obj = intent.getExtras();</span><br><span class="line">    mServiceHandler.sendMessage(msg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Try again later if we are killed before we can finish scanning.</span></span><br><span class="line">    <span class="keyword">return</span> Service.START_REDELIVER_INTENT;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceHandler</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">Handler</span></span><br><span class="line"></span>{</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    public void handleMessage(<span class="type">Message</span> msg)</span><br><span class="line">    {</span><br><span class="line">        <span class="type">Bundle</span> arguments = (<span class="type">Bundle</span>) msg.obj;</span><br><span class="line">        <span class="type">String</span> filePath = arguments.getString(<span class="string">&quot;filepath&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">//&#x8FD9;&#x662F;&#x626B;&#x63CF;&#x5355;&#x4E2A;&#x6587;&#x4EF6;&#x7684;&#x60C5;&#x51B5;</span></span><br><span class="line">            <span class="keyword">if</span> (filePath != <span class="literal">null</span>) {</span><br><span class="line">                <span class="type">IBinder</span> binder = arguments.getIBinder(<span class="string">&quot;listener&quot;</span>);</span><br><span class="line">                <span class="type">IMediaScannerListener</span> listener = </span><br><span class="line">                        (binder == <span class="literal">null</span> ? <span class="literal">null</span> : <span class="type">IMediaScannerListener</span>.<span class="type">Stub</span>.asInterface(binder));</span><br><span class="line">                <span class="type">Uri</span> uri = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    <span class="comment">//&#x8C03;&#x7528;scanFile&#x65B9;&#x6CD5;</span></span><br><span class="line">                    uri = scanFile(filePath, arguments.getString(<span class="string">&quot;mimetype&quot;</span>));</span><br><span class="line">                } <span class="keyword">catch</span> (<span class="type">Exception</span> e) {</span><br><span class="line">                    <span class="type">Log</span>.e(<span class="type">TAG</span>, <span class="string">&quot;Exception scanning file&quot;</span>, e);</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">if</span> (listener != <span class="literal">null</span>) {</span><br><span class="line">                    listener.scanCompleted(filePath, uri);</span><br><span class="line">                }</span><br><span class="line">            <span class="comment">//&#x8FD9;&#x662F;&#x626B;&#x63CF;&#x4E00;&#x4E2A;&#x76EE;&#x5F55;&#x7684;&#x60C5;&#x51B5;</span></span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="type">String</span> volume = arguments.getString(<span class="string">&quot;volume&quot;</span>);</span><br><span class="line">                <span class="type">String</span>[] directories = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (<span class="type">MediaProvider</span>.<span class="type">INTERNAL_VOLUME</span>.equals(volume)) {</span><br><span class="line">                    <span class="comment">//&#x8FD9;&#x662F;&#x626B;&#x63CF;&#x5185;&#x90E8;&#x5B58;&#x50A8;&#x7684;&#x60C5;&#x51B5;</span></span><br><span class="line">                    <span class="comment">// scan internal media storage</span></span><br><span class="line">                    directories = <span class="keyword">new</span> <span class="type">String</span>[] {</span><br><span class="line">                            <span class="type">Environment</span>.getRootDirectory() + <span class="string">&quot;/media&quot;</span>,</span><br><span class="line">                            <span class="type">Environment</span>.getOemDirectory() + <span class="string">&quot;/media&quot;</span>,</span><br><span class="line">                    };</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (<span class="type">MediaProvider</span>.<span class="type">EXTERNAL_VOLUME</span>.equals(volume)) {</span><br><span class="line">                    <span class="comment">// scan external storage volumes</span></span><br><span class="line">                    <span class="comment">//&#x8FD9;&#x662F;&#x626B;&#x63CF;&#x5916;&#x90E8;&#x5B58;&#x50A8;&#x7684;&#x60C5;&#x51B5;</span></span><br><span class="line">                    directories = mExternalStoragePaths;</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (directories != <span class="literal">null</span>) {</span><br><span class="line">                    <span class="keyword">if</span> (<span class="literal">false</span>) <span class="type">Log</span>.d(<span class="type">TAG</span>, <span class="string">&quot;start scanning volume &quot;</span> + volume + <span class="string">&quot;: &quot;</span></span><br><span class="line">                            + <span class="type">Arrays</span>.toString(directories));</span><br><span class="line">                    <span class="comment">//&#x8C03;&#x7528;scan&#x65B9;&#x6CD5;</span></span><br><span class="line">                    scan(directories, volume);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="literal">false</span>) <span class="type">Log</span>.d(<span class="type">TAG</span>, <span class="string">&quot;done scanning volume &quot;</span> + volume);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span> (<span class="type">Exception</span> e) {</span><br><span class="line">            <span class="type">Log</span>.e(<span class="type">TAG</span>, <span class="string">&quot;Exception in handleMessage&quot;</span>, e);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//&#x626B;&#x63CF;&#x7ED3;&#x675F;&#x540E;&#x9000;&#x51FA;&#x670D;&#x52A1;</span></span><br><span class="line">        stopSelf(msg.arg1);</span><br><span class="line">    }</span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>&#x4ECE;&#x4E0A;&#x9762;&#x4EE3;&#x7801;&#x4E2D;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x5728;mServiceHandler&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x9996;&#x5148;&#x63D0;&#x53D6;Intent&#x4E2D;&#x643A;&#x5E26;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x643A;&#x5E26;&#x5173;&#x952E;&#x5B57;&#x4E3A;filepath&#x7684;&#x6570;&#x636E;&#x5219;&#x8BF4;&#x660E;&#x7684;&#x662F;&#x9700;&#x8981;&#x626B;&#x63CF;&#x7684;&#x4E3A;&#x6587;&#x4EF6;&#xFF0C;&#x5219;&#x8C03;&#x7528;scanFile&#x65B9;&#x6CD5;&#x5BF9;&#x6307;&#x5B9A;&#x6587;&#x4EF6;&#x8DEF;&#x5F84;&#x7684;&#x6587;&#x4EF6;&#x8FDB;&#x884C;&#x626B;&#x63CF;&#xFF0C;&#x5982;&#x679C;&#x643A;&#x5E26;&#x7684;&#x662F;&#x5173;&#x952E;&#x5B57;&#x4E3A;volume&#x7684;&#x6570;&#x636E;&#x5219;&#x8BF4;&#x660E;&#x5F53;&#x524D;&#x626B;&#x63CF;&#x8BF7;&#x6C42;&#x4E3A;&#x626B;&#x63CF;&#x52A0;&#x8F7D;&#x5377;&#xFF0C;&#x8C03;&#x7528;&#x7684;&#x65B9;&#x6CD5;&#x4E3A;scan&#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x91CD;&#x70B9;&#x5173;&#x6CE8;&#x5BF9;&#x5B58;&#x50A8;&#x5668;&#x52A0;&#x8F7D;&#x5377;&#x7684;&#x626B;&#x63CF;&#x8FC7;&#x7A0B;&#x3002;&#x5BF9;&#x5355;&#x4E2A;&#x6587;&#x4EF6;&#x7684;&#x626B;&#x63CF;&#x539F;&#x7406;&#x5927;&#x81F4;&#x76F8;&#x540C;&#x3002;</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">private <span class="keyword">void</span> scan(<span class="built_in">String</span>[] directories, <span class="built_in">String</span> volumeName) {</span><br><span class="line">    <span class="built_in">Uri</span> uri = <span class="built_in">Uri</span>.parse(<span class="string">&quot;file://&quot;</span> + directories[<span class="number">0</span>]);</span><br><span class="line">    <span class="comment">// don&apos;t sleep while scanning</span></span><br><span class="line">    <span class="comment">//&#x83B7;&#x53D6;&#x5524;&#x9192;&#x9501;&#xFF0C;&#x907F;&#x514D;&#x5728;&#x626B;&#x63CF;&#x7684;&#x65F6;&#x5019;&#x624B;&#x673A;&#x53D1;&#x751F;&#x7761;&#x7720;</span></span><br><span class="line">    mWakeLock.acquire();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        ContentValues values = <span class="keyword">new</span> ContentValues();</span><br><span class="line">        values.put(MediaStore.MEDIA_SCANNER_VOLUME, volumeName);</span><br><span class="line">        <span class="built_in">Uri</span> scanUri = getContentResolver().insert(MediaStore.getMediaScannerUri(), values);</span><br><span class="line">            </span><br><span class="line">        <span class="comment">//&#x53D1;&#x9001;ACTION_MEDIA_SCANNER_STARTED&#x5E7F;&#x64AD;&#x901A;&#x77E5;&#x7CFB;&#x7EDF;&#x5176;&#x4ED6;&#x90E8;&#x4EF6;&#x626B;&#x63CF;&#x5373;&#x5C06;&#x5F00;&#x59CB;</span></span><br><span class="line">        sendBroadcast(<span class="keyword">new</span> Intent(Intent.ACTION_MEDIA_SCANNER_STARTED, uri));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">if</span> (volumeName.equals(MediaProvider.EXTERNAL_VOLUME)) {</span><br><span class="line">                openDatabase(volumeName);</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">//&#x521B;&#x5EFA;MediaScanner&#x5F00;&#x59CB;&#x626B;&#x63CF;</span></span><br><span class="line">            MediaScanner scanner = createMediaScanner();</span><br><span class="line">            scanner.scanDirectories(directories, volumeName);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;exception in MediaScanner.scan()&quot;</span>, e);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        getContentResolver().delete(scanUri, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        <span class="comment">//&#x901A;&#x77E5;&#x5176;&#x4ED6;&#x90E8;&#x4EF6;&#x626B;&#x63CF;&#x7ED3;&#x675F;</span></span><br><span class="line">        sendBroadcast(<span class="keyword">new</span> Intent(Intent.ACTION_MEDIA_SCANNER_FINISHED, uri));</span><br><span class="line">        <span class="comment">//&#x91CA;&#x653E;&#x5524;&#x9192;&#x9501;</span></span><br><span class="line">        mWakeLock.release();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x4E8E;&#x626B;&#x63CF;&#x8FC7;&#x7A0B;&#x662F;&#x4E00;&#x4E2A;&#x8017;&#x65F6;&#x7684;&#x8FC7;&#x7A0B;&#xFF0C;&#x56E0;&#x6B64;&#x5728;&#x5F00;&#x59CB;&#x626B;&#x63CF;&#x4E4B;&#x524D;&#x5FC5;&#x987B;&#x83B7;&#x5F97;&#x7535;&#x6E90;&#x9501;&#xFF0C;&#x907F;&#x514D;&#x5728;&#x626B;&#x63CF;&#x8FC7;&#x7A0B;&#x4E2D;&#x624B;&#x673A;&#x4F11;&#x7720;&#xFF0C;&#x5728;&#x626B;&#x63CF;&#x7ED3;&#x675F;&#x540E;&#x91CA;&#x653E;&#x7535;&#x6E90;&#x9501;&#x3002;&#x5728;&#x626B;&#x63CF;&#x5F00;&#x59CB;&#x4E4B;&#x524D;&#x4F1A;&#x5411;&#x7CFB;&#x7EDF;&#x53D1;&#x9001;&#x4E00;&#x4E2A;Intent.ACTION_MEDIA_SCANNER_STARTED&#x7684;&#x5E7F;&#x64AD;&#xFF0C;&#x901A;&#x77E5;&#x7CFB;&#x7EDF;&#x7684;&#x5176;&#x4ED6;&#x90E8;&#x4EF6;&#x626B;&#x63CF;&#x8FC7;&#x7A0B;&#x7684;&#x5F00;&#x59CB;&#xFF0C;&#x5176;&#x4ED6;&#x90E8;&#x4EF6;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x76D1;&#x542C;&#x8FD9;&#x4E2A;&#x5E7F;&#x64AD;&#x3002;&#x6765;&#x91C7;&#x53D6;&#x5BF9;&#x5E94;&#x7684;&#x5904;&#x7406;&#xFF0C;&#x540C;&#x6837;&#x5728;&#x626B;&#x63CF;&#x7ED3;&#x675F;&#x540E;&#x4F1A;&#x5411;&#x7CFB;&#x7EDF;&#x53D1;&#x9001;&#x4E00;&#x4E2A;Intent.ACTION_MEDIA_SCANNER_FINISHED&#x5E7F;&#x64AD;&#x3002;&#x800C;&#x626B;&#x63CF;&#x4EFB;&#x52A1;&#x662F;&#x901A;&#x8FC7;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;MediaScanner&#x5BF9;&#x8C61;&#xFF0C;&#x5E76;&#x8C03;&#x7528;scanDirectories&#x65B9;&#x6CD5;&#x6765;&#x5B9E;&#x73B0;&#x7684;&#x3002;</p>
<p>&#x5728;&#x5E94;&#x7528;&#x5C42;&#x8F6C;&#x4E86;&#x4E00;&#x5708;&#x540E;&#x7EC8;&#x4E8E;&#x8FDB;&#x5165;frameworks&#x5C42;&#x4E86;&#xFF0C;&#x6211;&#x4EEC;&#x770B;&#x4E0B;frameworks&#x5C42;&#x7684;MediaScanner&#x7C7B;<br>&#x5728;MediaScanner&#x7C7B;&#x4E2D;&#x9996;&#x5148;&#x52A0;&#x8F7D;media_jni&#x5E93;&#xFF0C;&#x5E76;&#x8C03;&#x7528;native_init&#x8FD9;&#x4E2A;native&#x65B9;&#x6CD5;&#x3002;<br><figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> {</span><br><span class="line">    System.loadLibrary(<span class="string">&quot;media_jni&quot;</span>);</span><br><span class="line">    native_init();</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<figure class="highlight dns"><table><tr><td class="code"><pre><span class="line">public MediaScanner(Context c) {</span><br><span class="line">    native_setup()<span class="comment">;</span></span><br><span class="line">    mContext = c<span class="comment">;</span></span><br><span class="line">    mPackageName = c.getPackageName()<span class="comment">;</span></span><br><span class="line">    mBitmapOptions.inSampleSize = 1<span class="comment">;</span></span><br><span class="line">    mBitmapOptions.inJustDecodeBounds = true<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    setDefaultRingtoneFileNames()<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    mExternalStoragePath = Environment.getExternalStorageDirectory().getAbsolutePath()<span class="comment">;</span></span><br><span class="line">    mExternalIsEmulated = Environment.isExternalStorageEmulated()<span class="comment">;</span></span><br><span class="line">    //mClient.testGenreNameConverter()<span class="comment">;</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5728;MediaScanner&#x7684;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x4E2D;&#x6700;&#x91CD;&#x8981;&#x7684;&#x662F;&#x8C03;&#x7528;&#x4E86;native_setup()&#x65B9;&#x6CD5;&#xFF0C;native_setup&#x4E5F;&#x662F;&#x4E00;&#x4E2A;native&#x65B9;&#x6CD5;&#x3002;<br>&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x770B;&#x4E0B;native_init&#x548C;native_setup&#x8FD9;&#x4E24;&#x4E2A;native&#x65B9;&#x6CD5;&#x3002;<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line"><span class="title">android_media_MediaScanner_native_init</span><span class="params">(JNIEnv *env)</span></span><br><span class="line"></span>{</span><br><span class="line">    jclass clazz = env-&gt;FindClass(kClassMediaScanner);</span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="literal">NULL</span>) {</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    fields.context = env-&gt;GetFieldID(clazz, <span class="string">&quot;mNativeContext&quot;</span>, <span class="string">&quot;J&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (fields.context == <span class="literal">NULL</span>) {</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>native_init&#x8D1F;&#x8D23;&#x83B7;&#x53D6;MediaScanner&#x4E2D;&#x7684;mNativeContext&#x53D8;&#x91CF;&#x5E76;&#x4FDD;&#x5B58;&#x5230;fields.context<br>native_setup&#x8D1F;&#x8D23;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;MediaScanner&#x7684;&#x5B50;&#x7C7B;StagefrightMediaScanner&#x5E76;&#x5C06;native_init&#x83B7;&#x53D6;&#x5230;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x4F20;&#x7ED9;StagefrightMediaScanner&#x5BF9;&#x8C61;&#x3002;<br><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">static void</span><br><span class="line">android_media_MediaScanner_native_setup<span class="list">(<span class="keyword">JNIEnv</span> <span class="variable">*env, jobject thiz)</span><br><span class="line">{</span><br><span class="line">    MediaScanner *</span>mp = new StagefrightMediaScanner<span class="comment">;</span></span><br><span class="line">    if <span class="list">(<span class="keyword">mp</span> == NULL)</span> {</span><br><span class="line">        jniThrowException<span class="list">(<span class="keyword">env</span>, kRunTimeException, <span class="string">&quot;Out of memory&quot;</span>)</span><span class="comment">;</span></span><br><span class="line">        return<span class="comment">;</span></span><br><span class="line">    }</span><br><span class="line">    env-&gt;SetLongField<span class="list">(<span class="keyword">thiz</span>, fields.context, <span class="list">(<span class="keyword">jlong</span>)</span>mp)</span><span class="comment">;</span></span><br><span class="line">}</span></span><br></pre></td></tr></table></figure></p>
<p>&#x63A5;&#x7740;&#x6211;&#x4EEC;&#x770B;&#x4E0B;scanDirectories&#x65B9;&#x6CD5;&#xFF1A;</p>
<figure class="highlight processing"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> scanDirectories(<span class="keyword">String</span>[] directories, <span class="keyword">String</span> volumeName) {</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//.......</span></span><br><span class="line">    <span class="comment">//1.&#x626B;&#x63CF;&#x524D;&#x9884;&#x5904;&#x7406;</span></span><br><span class="line">    initialize(volumeName);</span><br><span class="line">    <span class="comment">//2. &#x9884;&#x626B;&#x63CF;</span></span><br><span class="line">    prescan(<span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">//.......</span></span><br><span class="line">    <span class="keyword">if</span> (ENABLE_BULK_INSERTS) {</span><br><span class="line">        <span class="comment">// create MediaInserter for bulk inserts</span></span><br><span class="line">        mMediaInserter = <span class="keyword">new</span> MediaInserter(mMediaProvider, mPackageName, <span class="number">500</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; directories.length; i++) {</span><br><span class="line">        <span class="comment">//3.&#x626B;&#x63CF;&#x67D0;&#x4E2A;&#x76EE;&#x5F55;</span></span><br><span class="line">        processDirectory(directories[i], mClient);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ENABLE_BULK_INSERTS) {</span><br><span class="line">        <span class="comment">// flush remaining inserts</span></span><br><span class="line">        mMediaInserter.flushAll();</span><br><span class="line">        mMediaInserter = <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//4. &#x626B;&#x63CF;&#x540E;&#x5904;&#x7406;</span></span><br><span class="line">    postscan(directories);</span><br><span class="line">    <span class="comment">//.......</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x4E0A;&#x9762;&#x6211;&#x4EEC;&#x8FC7;&#x6EE4;&#x6389;&#x6240;&#x6709;&#x7684;&#x65E0;&#x5173;&#x4EE3;&#x7801;&#xFF0C;&#x6211;&#x4EEC;&#x770B;&#x5230;&#x6574;&#x4E2A;&#x626B;&#x63CF;&#x8FC7;&#x7A0B;&#x5206;&#x6210;&#x5982;&#x4E0B;&#x56DB;&#x4E2A;&#x90E8;&#x5206;&#xFF1A;</p>
<ul>
<li>initialize &#x626B;&#x63CF;&#x524D;&#x9884;&#x5904;&#x7406;</li>
<li>prescan  &#x9884;&#x626B;&#x63CF;</li>
<li>processDirectory&#x626B;&#x63CF;&#x67D0;&#x4E2A;&#x76EE;&#x5F55;</li>
<li>postscan&#x626B;&#x63CF;&#x540E;&#x5904;&#x7406;</li>
</ul>
<ol>
<li><p>&#x626B;&#x63CF;&#x524D;&#x9884;&#x5904;&#x7406;:<br>&#x5728;initialize&#x4E2D;&#x4E3B;&#x8981;&#x521D;&#x59CB;&#x5316;&#x5404;&#x79CD;Uri&#x5730;&#x5740;&#xFF1A;&#x5305;&#x62EC;&#x97F3;&#x9891;&#xFF0C;&#x89C6;&#x9891;&#xFF0C;&#x56FE;&#x50CF;&#xFF0C;&#x56FE;&#x50CF;&#x7F29;&#x7565;&#x56FE;&#xFF0C;&#x89C6;&#x9891;&#x7F29;&#x7565;&#x56FE;&#xFF0C;&#x6587;&#x4EF6;&#x7B49;Uri&#x5730;&#x5740;&#x3002;&#x5982;&#x679C;&#x5F53;&#x524D;&#x626B;&#x63CF;&#x7684;&#x662F;&#x5916;&#x90E8;&#x5B58;&#x50A8;&#x5668;&#x5219;&#x9700;&#x8981;&#x5904;&#x7406;&#x64AD;&#x653E;&#x5217;&#x8868;&#x4EE5;&#x53CA;&#x98CE;&#x683C;&#x3002;</p>
<figure class="highlight lasso"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="literal">void</span> initialize(<span class="built_in">String</span> volumeName) {</span><br><span class="line">    </span><br><span class="line">    mMediaProvider = mContext<span class="built_in">.</span>getContentResolver()<span class="built_in">.</span>acquireProvider(<span class="string">&quot;media&quot;</span>);</span><br><span class="line">    mAudioUri = Audio<span class="built_in">.</span>Media<span class="built_in">.</span>getContentUri(volumeName);</span><br><span class="line">    mVideoUri = Video<span class="built_in">.</span>Media<span class="built_in">.</span>getContentUri(volumeName);</span><br><span class="line">    mImagesUri = Images<span class="built_in">.</span>Media<span class="built_in">.</span>getContentUri(volumeName);</span><br><span class="line">    mThumbsUri = Images<span class="built_in">.</span>Thumbnails<span class="built_in">.</span>getContentUri(volumeName);</span><br><span class="line">    mFilesUri = Files<span class="built_in">.</span>getContentUri(volumeName);</span><br><span class="line">    mFilesUriNoNotify = mFilesUri<span class="built_in">.</span>buildUpon()<span class="built_in">.</span>appendQueryParameter(<span class="string">&quot;nonotify&quot;</span>, <span class="string">&quot;1&quot;</span>)<span class="built_in">.</span>build();</span><br><span class="line">    <span class="keyword">if</span> (<span class="subst">!</span>volumeName<span class="built_in">.</span><span class="keyword">equals</span>(<span class="string">&quot;internal&quot;</span>)) {</span><br><span class="line">        <span class="comment">// we only support playlists on external media</span></span><br><span class="line">        mProcessPlaylists = <span class="literal">true</span>;</span><br><span class="line">        mProcessGenres = <span class="literal">true</span>;</span><br><span class="line">        mPlaylistsUri = Playlists<span class="built_in">.</span>getContentUri(volumeName);</span><br><span class="line">        mCaseInsensitivePaths = <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</li>
<li><p>&#x9884;&#x626B;&#x63CF;&#x5904;&#x7406;:<br>&#x9884;&#x626B;&#x63CF;&#x5904;&#x7406;&#x4E3B;&#x8981;&#x5B8C;&#x6210;&#x5982;&#x4E0B;&#x5DE5;&#x4F5C;&#xFF1A;</p>
</li>
</ol>
<ul>
<li>&#x5EFA;&#x7ACB;mPlayLists&#xFF0C;&#x56E0;&#x4E3A;&#x5728;&#x4E3B;&#x626B;&#x63CF;&#x8FC7;&#x7A0B;&#x4E2D;&#x5BF9;&#x4E8E;&#x64AD;&#x653E;&#x5217;&#x8868;&#x662F;&#x653E;&#x5230;&#x540E;&#x9762;&#x5904;&#x7406;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x8981;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;mPlayLists&#x7528;&#x4E8E;&#x5B58;&#x50A8;&#x64AD;&#x653E;&#x5217;&#x8868;&#x6587;&#x4EF6;&#x8BB0;&#x5F55;&#xFF0C;&#x5728;beginFile&#x626B;&#x5230;&#x64AD;&#x653E;&#x5217;&#x8868;&#x7684;&#x65F6;&#x5019;&#x9700;&#x8981;&#x5148;&#x5C06;&#x5176;&#x5B58;&#x50A8;&#x5230;mPlayLists&#x4E2D;&#xFF0C;&#x7B49;&#x5230;postscan&#x9636;&#x6BB5;&#x5BF9;&#x5176;&#x8FDB;&#x884C;&#x7EDF;&#x4E00;&#x5904;&#x7406;&#x3002;</li>
<li>&#x626B;&#x63CF;&#x6570;&#x636E;&#x5E93;&#x5E76;&#x67E5;&#x627E;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x7684;&#x6BCF;&#x4E00;&#x9879;&#x7684;&#x672C;&#x5730;&#x6587;&#x4EF6;&#x662F;&#x5426;&#x5B58;&#x5728;&#xFF0C;&#x8FD9;&#x91CC;&#x6BCF;&#x6B21;&#x53EA;&#x626B;&#x63CF;1000&#x6761;&#x6570;&#x636E;&#xFF0C;&#x907F;&#x514D;&#x56E0;&#x4E3A;&#x52A0;&#x8F7D;&#x592A;&#x591A;&#x6570;&#x636E;&#x800C;&#x51FA;&#x73B0;&#x5361;&#x987F;&#x73B0;&#x8C61;&#xFF0C;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#x8FD9;&#x91CC;&#x5E76;&#x4E0D;&#x9700;&#x8981;&#x5220;&#x9664;&#x771F;&#x5B9E;&#x7684;&#x6587;&#x4EF6;&#x8FD9;&#x662F;&#x56E0;&#x4E3A;&#x5982;&#x679C;&#x6587;&#x4EF6;&#x786E;&#x5B9E;&#x6D88;&#x5931;&#x4E86;&#x5219;&#x4E0D;&#x9700;&#x8981;&#x5220;&#x9664;&#xFF0C;&#x5982;&#x679C;&#x662F;&#x56E0;&#x4E3A;&#x5728;&#x626B;&#x63CF;&#x671F;&#x95F4;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x88AB;&#x5378;&#x8F7D;&#x800C;&#x540E;&#x53C8;&#x6302;&#x8F7D;&#xFF0C;&#x8FD9;&#x65F6;&#x5019;&#x5220;&#x9664;&#x64CD;&#x4F5C;&#x4E5F;&#x662F;&#x4E0D;&#x9700;&#x8981;&#x7684;&#x3002;&#x5982;&#x679C;&#x5F53;&#x524D;&#x9879;&#x6240;&#x5BF9;&#x5E94;&#x7684;&#x672C;&#x5730;&#x6587;&#x4EF6;&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x5219;&#x770B;&#x4E0B;&#x662F;&#x5426;&#x662F;&#x64AD;&#x653E;&#x5217;&#x8868;&#x6587;&#x4EF6;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x662F;&#x64AD;&#x653E;&#x5217;&#x8868;&#x6587;&#x4EF6;&#x5219;&#x4ECE;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x5220;&#x9664;&#x3002;&#x5982;&#x679C;&#x662F;&#x64AD;&#x653E;&#x5217;&#x8868;&#x7C7B;&#x578B;&#x5219;&#x4E0D;&#x5220;&#x9664;&#xFF0C;&#x56E0;&#x4E3A;&#x8FD9;&#x6709;&#x53EF;&#x80FD;&#x662F;&#x7531;&#x4E8E;&#x64AD;&#x653E;&#x5217;&#x8868;&#x4FE1;&#x606F;&#x88AB;&#x7528;&#x6237;&#x4FEE;&#x6539;&#x5BFC;&#x81F4;&#x7684;&#x3002;&#x7528;&#x6237;&#x53EF;&#x4EE5;&#x5728;&#x64AD;&#x653E;&#x5668;&#x4E2D;&#x5220;&#x9664;&#x5B83;&#x4EEC;&#x3002;</li>
<li>&#x5728;&#x6E05;&#x7A7A;&#x7F3A;&#x4E4F;&#x5B9E;&#x9645;&#x6587;&#x4EF6;&#x7684;&#x6570;&#x636E;&#x9879;&#x540E;&#x91CD;&#x65B0;&#x67E5;&#x8BE2;&#x56FE;&#x7247;&#x6570;&#x76EE;&#xFF0C;&#x97F3;&#x9891;&#xFF0C;&#x89C6;&#x9891;&#x7684;&#x6570;&#x76EE;</li>
</ul>
<figure class="highlight processing"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> prescan(<span class="keyword">String</span> filePath, <span class="built_in">boolean</span> prescanFiles) <span class="keyword">throws</span> RemoteException {</span><br><span class="line">    Cursor c = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">String</span> where = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">String</span>[] selectionArgs = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//&#x5EFA;&#x7ACB;mPlayLists</span></span><br><span class="line">    <span class="keyword">if</span> (mPlayLists == <span class="keyword">null</span>) {</span><br><span class="line">        mPlayLists = <span class="keyword">new</span> ArrayList&lt;FileEntry&gt;();</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        mPlayLists.<span class="built_in">clear</span>();</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//&#x901A;&#x8FC7;&#x4E0A;&#x8FF0;&#x5904;&#x7406;mPlayLists&#x5C06;&#x4F1A;&#x88AB;&#x6E05;&#x7A7A;&#xFF0C;</span></span><br><span class="line">    <span class="keyword">if</span> (filePath != <span class="keyword">null</span>) {</span><br><span class="line">        <span class="comment">// query for only one file</span></span><br><span class="line">        where = MediaStore.Files.FileColumns._ID + <span class="string">&quot;&gt;?&quot;</span> +<span class="string">&quot; AND &quot;</span> + Files.FileColumns.DATA + <span class="string">&quot;=?&quot;</span>;</span><br><span class="line">        selectionArgs = <span class="keyword">new</span> <span class="keyword">String</span>[] { <span class="string">&quot;&quot;</span>, filePath };</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        where = MediaStore.Files.FileColumns._ID + <span class="string">&quot;&gt;?&quot;</span>;</span><br><span class="line">        selectionArgs = <span class="keyword">new</span> <span class="keyword">String</span>[] { <span class="string">&quot;&quot;</span> };</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Tell the provider to not delete the file.</span></span><br><span class="line">    <span class="comment">// If the file is truly gone the delete is unnecessary, and we want to avoid</span></span><br><span class="line">    <span class="comment">// accidentally deleting files that are really there (this may happen if the</span></span><br><span class="line">    <span class="comment">// filesystem is mounted and unmounted while the scanner is running).</span></span><br><span class="line">    <span class="comment">//&#x5728;&#x8FD9;&#x91CC;&#x544A;&#x8BC9;provider&#x4E0D;&#x8981;&#x5220;&#x9664;&#x90A3;&#x4E9B;&#x901A;&#x8FC7;&#x626B;&#x63CF;&#x53D1;&#x73B0;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#x6587;&#x4EF6;&#xFF0C;</span></span><br><span class="line">    &#x4E3A;&#x7684;&#x662F;&#x907F;&#x514D;&#x5728;&#x626B;&#x63CF;&#x7684;&#x65F6;&#x5019;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x5378;&#x8F7D;&#x4E86;&#xFF0C;&#x4F46;&#x662F;&#x5728;&#x4EE5;&#x540E;&#x7684;&#x65F6;&#x5019;&#x53C8;&#x6302;&#x8F7D;&#x4E0A;&#x4E86;&#x3002;</span><br><span class="line">    Uri.Builder builder = mFilesUri.buildUpon();</span><br><span class="line">    builder.appendQueryParameter(MediaStore.PARAM_DELETE_DATA, <span class="string">&quot;false&quot;</span>);</span><br><span class="line">    MediaBulkDeleter deleter = <span class="keyword">new</span> MediaBulkDeleter(mMediaProvider, mPackageName,builder.build());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Build the list of files from the content provider</span></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">if</span> (prescanFiles) {</span><br><span class="line">            <span class="comment">// First read existing files from the files table.</span></span><br><span class="line">            <span class="comment">// Because we&apos;ll be deleting entries for missing files as we go,</span></span><br><span class="line">            <span class="comment">// we need to query the database in small batches, to avoid problems</span></span><br><span class="line">            <span class="comment">// with CursorWindow positioning.</span></span><br><span class="line">            <span class="keyword">long</span> lastId = Long.MIN_VALUE;</span><br><span class="line">            Uri limitUri = mFilesUri.buildUpon().appendQueryParameter(<span class="string">&quot;limit&quot;</span>, <span class="string">&quot;1000&quot;</span>).build();</span><br><span class="line">            mWasEmptyPriorToScan = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) {</span><br><span class="line">                selectionArgs[<span class="number">0</span>] = <span class="string">&quot;&quot;</span> + lastId;</span><br><span class="line">                <span class="keyword">if</span> (c != <span class="keyword">null</span>) {</span><br><span class="line">                    c.close();</span><br><span class="line">                    c = <span class="keyword">null</span>;</span><br><span class="line">                }</span><br><span class="line">                c = mMediaProvider.query(mPackageName, limitUri, FILES_PRESCAN_PROJECTION,where, selectionArgs, MediaStore.Files.FileColumns._ID, <span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">if</span> (c == <span class="keyword">null</span>) {</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                }</span><br><span class="line">                <span class="built_in">int</span> num = c.getCount();</span><br><span class="line">                <span class="keyword">if</span> (num == <span class="number">0</span>) {</span><br><span class="line">                    <span class="comment">//&#x5982;&#x679C;&#x4E3A;0&#x8868;&#x793A;&#x5DF2;&#x7ECF;&#x67E5;&#x8BE2;&#x5B8C;&#x5168;&#x90E8;&#x6587;&#x4EF6;&#x4FE1;&#x606F;,&#x9000;&#x51FA;&#x5FAA;&#x73AF;</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                }</span><br><span class="line">                mWasEmptyPriorToScan = <span class="keyword">false</span>;</span><br><span class="line">                <span class="comment">//&#x5F00;&#x59CB;&#x83B7;&#x53D6;&#x8FD9;&#x4E00;&#x6279;&#x67E5;&#x8BE2;&#x5230;&#x7684;&#x8981;&#x626B;&#x63CF;&#x7684;&#x8DEF;&#x5F84;&#x7B49;&#x4FE1;&#x606F;</span></span><br><span class="line">                <span class="keyword">while</span> (c.moveToNext()) {</span><br><span class="line">                    <span class="keyword">long</span> rowId = c.getLong(FILES_PRESCAN_ID_COLUMN_INDEX);</span><br><span class="line">                    <span class="keyword">String</span> path = c.getString(FILES_PRESCAN_PATH_COLUMN_INDEX);</span><br><span class="line">                    <span class="built_in">int</span> format = c.getInt(FILES_PRESCAN_FORMAT_COLUMN_INDEX);</span><br><span class="line">                    <span class="keyword">long</span> lastModified = c.getLong(FILES_PRESCAN_DATE_MODIFIED_COLUMN_INDEX);</span><br><span class="line">                    lastId = rowId;</span><br><span class="line">                    <span class="comment">// Only consider entries with absolute path names.</span></span><br><span class="line">                    <span class="comment">// This allows storing URIs in the database without the</span></span><br><span class="line">                    <span class="comment">// media scanner removing them.</span></span><br><span class="line">                    <span class="keyword">if</span> (path != <span class="keyword">null</span> &amp;&amp; path.startsWith(<span class="string">&quot;/&quot;</span>)) {</span><br><span class="line">                        <span class="built_in">boolean</span> exists = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="keyword">try</span> {</span><br><span class="line">                            <span class="comment">//&#x67E5;&#x770B;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x5BF9;&#x5E94;&#x9879;&#x7684;&#x672C;&#x5730;&#x6587;&#x4EF6;&#x662F;&#x5426;&#x5B58;&#x5728;</span></span><br><span class="line">                            exists = Os.access(path, android.system.OsConstants.F_OK);</span><br><span class="line">                        } <span class="keyword">catch</span> (ErrnoException e1) {</span><br><span class="line">                        }</span><br><span class="line">                        <span class="keyword">if</span> (!exists &amp;&amp; !MtpConstants.isAbstractObject(format)) {</span><br><span class="line">                            <span class="comment">// do not delete missing playlists, since they may have been</span></span><br><span class="line">                            <span class="comment">// modified by the user.</span></span><br><span class="line">                            <span class="comment">// The user can delete them in the media player instead.</span></span><br><span class="line">                            <span class="comment">// instead, clear the path and lastModified fields in the row</span></span><br><span class="line">                            MediaFile.MediaFileType mediaFileType = MediaFile.getFileType(path);</span><br><span class="line">                            <span class="built_in">int</span> fileType = (mediaFileType == <span class="keyword">null</span> ? <span class="number">0</span> : mediaFileType.fileType);</span><br><span class="line">                            </span><br><span class="line">                            <span class="comment">//&#x5982;&#x679C;&#x5F53;&#x524D;&#x8BB0;&#x5F55;&#x5728;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x5B58;&#x5728;&#xFF0C;&#x5728;&#x672C;&#x5730;&#x4E2D;&#x6587;&#x4EF6;&#x5E76;&#x4E0D;&#x5B58;&#x5728;&#xFF0C;</span></span><br><span class="line">                            <span class="comment">//&#x5E76;&#x4E14;&#x4E22;&#x5931;&#x7684;&#x6587;&#x4EF6;&#x7C7B;&#x578B;&#x4E0D;&#x662F;&#x64AD;&#x653E;&#x5217;&#x8868;&#x5219;&#x5C06;&#x8BB0;&#x5F55;&#x4ECE;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x5220;&#x9664;</span></span><br><span class="line">                            <span class="comment">//&#x5982;&#x679C;&#x662F;&#x64AD;&#x653E;&#x5217;&#x8868;&#x7C7B;&#x578B;&#x5219;&#x4E0D;&#x5220;&#x9664;</span></span><br><span class="line">                            <span class="keyword">if</span> (!MediaFile.isPlayListFileType(fileType)) {</span><br><span class="line">                                deleter.delete(rowId);</span><br><span class="line">                                <span class="keyword">if</span> (path.toLowerCase(Locale.US).endsWith(<span class="string">&quot;/.nomedia&quot;</span>)) {</span><br><span class="line">                                    deleter.flush();</span><br><span class="line">                                    <span class="keyword">String</span> parent = <span class="keyword">new</span> File(path).getParent();</span><br><span class="line">                                    mMediaProvider.call(mPackageName, MediaStore.UNHIDE_CALL,parent, <span class="keyword">null</span>);</span><br><span class="line">                                }</span><br><span class="line">                            }</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">finally</span> {</span><br><span class="line">        <span class="keyword">if</span> (c != <span class="keyword">null</span>) {</span><br><span class="line">            c.close();</span><br><span class="line">        }</span><br><span class="line">        deleter.flush();</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// compute original size of images</span></span><br><span class="line">    mOriginalCount = <span class="number">0</span>;</span><br><span class="line">    c = mMediaProvider.query(mPackageName, mImagesUri, ID_PROJECTION, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">if</span> (c != <span class="keyword">null</span>) {</span><br><span class="line">        mOriginalCount = c.getCount();</span><br><span class="line">        c.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x901A;&#x8FC7;&#x9884;&#x5904;&#x7406;&#x4FDD;&#x8BC1;&#x6570;&#x636E;&#x5E93;&#x7684;&#x6587;&#x4EF6;&#x8BB0;&#x5F55;&#x4E0E;&#x672C;&#x5730;&#x7684;&#x5B9E;&#x9645;&#x6587;&#x4EF6;&#x5C06;&#x4E00;&#x4E00;&#x5BF9;&#x5E94;&#x3002;&#x7D27;&#x63A5;&#x7740;&#x5C31;&#x8FDB;&#x5165;&#x4E86;&#x626B;&#x63CF;&#x9636;&#x6BB5;&#x5728;scanDirectories&#x65B9;&#x6CD5;&#x4E2D;&#x5C06;&#x4F1A;&#x5BF9;&#x6BCF;&#x4E2A;&#x9700;&#x8981;&#x626B;&#x63CF;&#x7684;&#x76EE;&#x5F55;&#x8C03;&#x7528;processDirectory(directories[i], mClient);&#x65B9;&#x6CD5;&#x3002;processDirectory&#x662F;&#x4E00;&#x4E2A;nativie&#x65B9;&#x6CD5;&#x3002;<br>&#x5728;JNI&#x5C42;&#x7684;android_media_MediaScanner_processDirectory&#x5C06;&#x4F1A;&#x88AB;&#x8C03;&#x7528;&#xFF0C;&#x5728;&#x8BE5;&#x65B9;&#x6CD5;&#x4E2D;&#x5C06;&#x4F1A;&#x8C03;&#x7528;native&#x5C42;&#x7684;MediaScanner.cpp&#x7684;processDirectory&#x65B9;&#x6CD5;&#x3002;</p>
<figure class="highlight nimrod"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">void</span></span><br><span class="line">android_media_MediaScanner_processDirectory(</span><br><span class="line">        <span class="type">JNIEnv</span> *env, jobject thiz, jstring path, jobject client)</span><br><span class="line">{</span><br><span class="line">    <span class="type">ALOGV</span>(<span class="string">&quot;processDirectory&quot;</span>);</span><br><span class="line">    //&#x83B7;&#x5F97;<span class="type">Native</span>&#x5C42;&#x7684;&#x5A92;&#x4F53;&#x626B;&#x63CF;&#x5668;</span><br><span class="line">    <span class="type">MediaScanner</span> *mp = getNativeScanner_l(env, thiz);</span><br><span class="line">    //.......</span><br><span class="line">    //&#x8FD9;&#x91CC;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;<span class="type">MyMediaScannerClient</span>&#x5BF9;&#x8C61;&#x7136;&#x540E;&#x5C06;&#x5176;&#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#x4F20;&#x9012;&#x5230;processDirectory&#x4E2D;</span><br><span class="line">    <span class="type">MyMediaScannerClient</span> myClient(env, client);</span><br><span class="line">    <span class="type">MediaScanResult</span> <span class="literal">result</span> = mp-&gt;processDirectory(pathStr, myClient);</span><br><span class="line">    //............</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<figure class="highlight nimrod"><table><tr><td class="code"><pre><span class="line"><span class="type">MediaScanResult</span> <span class="type">MediaScanner</span>::processDirectory(</span><br><span class="line">        <span class="keyword">const</span> <span class="type">char</span> *path, <span class="type">MediaScannerClient</span> &amp;client) {</span><br><span class="line">    //..........</span><br><span class="line">    client.setLocale(locale());</span><br><span class="line">    ////&#x8C03;&#x7528;doProcessDirectory&#x5904;&#x7406;</span><br><span class="line">    <span class="type">MediaScanResult</span> <span class="literal">result</span> = doProcessDirectory(pathBuffer, pathRemaining, client, <span class="literal">false</span>);</span><br><span class="line">    //.....</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x6211;&#x4EEC;&#x7EE7;&#x7EED;&#x770B;&#x4E0B;native&#x5C42;MediaScannner&#x662F;&#x5982;&#x4F55;&#x5B8C;&#x6210;&#x626B;&#x63CF;&#x5DE5;&#x4F5C;&#x7684;&#xFF1A;&#x5728;MediaScannner&#x4E2D;&#x7684;processDirectory &#x65B9;&#x6CD5;&#x4E2D;&#x4F1A;&#x5BF9;&#x6BCF;&#x4E2A;&#x626B;&#x63CF;&#x8DEF;&#x5F84;&#x8C03;&#x7528;&#x4E00;&#x6B21;processDirectory&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x91CC;&#x7684;path&#x4E3A;&#x5916;&#x90E8;&#x5B58;&#x50A8;&#x7684;&#x6216;&#x8005;&#x5185;&#x90E8;&#x5B58;&#x50A8;&#x7684;&#x8DEF;&#x5F84;</p>
<figure class="highlight nimrod"><table><tr><td class="code"><pre><span class="line"><span class="type">MediaScanResult</span> <span class="type">MediaScanner</span>::doProcessDirectory(</span><br><span class="line">        <span class="type">char</span> *path, <span class="type">int</span> pathRemaining, <span class="type">MediaScannerClient</span> &amp;client, <span class="type">bool</span> noMedia) {</span><br><span class="line"></span><br><span class="line">    //.......</span><br><span class="line">    <span class="type">DIR</span>* dir = opendir(path);</span><br><span class="line">    //...........</span><br><span class="line">    <span class="type">MediaScanResult</span> <span class="literal">result</span> = <span class="type">MEDIA_SCAN_RESULT_OK</span>;</span><br><span class="line">    <span class="keyword">while</span> ((entry = readdir(dir))) {</span><br><span class="line">        <span class="keyword">if</span> (doProcessDirectoryEntry(path, pathRemaining, client, noMedia, entry, fileSpot) == <span class="type">MEDIA_SCAN_RESULT_ERROR</span>) {</span><br><span class="line">            <span class="literal">result</span> = <span class="type">MEDIA_SCAN_RESULT_ERROR</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    closedir(dir);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>doProcessDirectory&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4F1A;&#x5BF9;&#x6BCF;&#x4E2A;&#x4E3B;&#x8DEF;&#x5F84;&#x4E0B;&#x7684;&#x5B50;&#x6587;&#x4EF6;&#x8C03;&#x7528;doProcessDirectoryEntry&#x8FDB;&#x884C;&#x626B;&#x63CF;&#x3002;<br>&#x5728;&#x5F00;&#x59CB;&#x626B;&#x63CF;&#x4E4B;&#x524D;&#x9700;&#x4E8B;&#x5148;&#x5224;&#x65AD;&#x5F53;&#x524D;&#x7684;&#x6587;&#x4EF6;&#x7C7B;&#x578B;&#xFF0C;&#x5E76;&#x6839;&#x636E;&#x4E0D;&#x540C;&#x7684;&#x6587;&#x4EF6;&#x7C7B;&#x578B;&#x8FDB;&#x884C;&#x4E0D;&#x540C;&#x7684;&#x5904;&#x7406;&#xFF1A;</p>
<ul>
<li>&#x5982;&#x679C;&#x5F53;&#x524D;&#x6587;&#x4EF6;&#x7C7B;&#x578B;&#x4E3A;&#x76EE;&#x5F55;&#x5219;&#x76F4;&#x63A5;&#x8C03;&#x7528;client.scanFile&#x65B9;&#x6CD5;&#xFF0C;&#x5C06;&#x626B;&#x63CF;&#x7684;&#x5DE5;&#x4F5C;&#x4EA4;&#x7ED9;MyMediaScannerClient&#xFF0C;&#x7D27;&#x63A5;&#x7740;&#x8C03;&#x7528;doProcessDirectory&#x5BF9;&#x8BE5;&#x76EE;&#x5F55;&#x4E0B;&#x7684;&#x5B50;&#x6587;&#x4EF6;&#x518D;&#x8FDB;&#x884C;&#x9012;&#x5F52;&#x626B;&#x63CF;&#x3002;</li>
<li>&#x5982;&#x679C;&#x5F53;&#x524D;&#x6587;&#x4EF6;&#x7C7B;&#x578B;&#x4E3A;&#x666E;&#x901A;&#x6587;&#x4EF6;&#x7C7B;&#x578B;&#x5219;&#x76F4;&#x63A5;&#x8C03;&#x7528;client.scanFile&#x65B9;&#x6CD5;&#xFF0C;&#x4F46;&#x662F;&#x4E0E;&#x6587;&#x4EF6;&#x7C7B;&#x578B;&#x4E3A;&#x76EE;&#x5F55;&#x4E0D;&#x540C;&#x7684;&#x662F;&#x5F53;&#x6587;&#x4EF6;&#x7C7B;&#x578B;&#x4E3A;&#x666E;&#x901A;&#x6587;&#x4EF6;&#x7C7B;&#x578B;&#x7684;&#x65F6;&#x5019;&#x8C03;&#x7528;client.scanFile&#x7684;&#x65F6;&#x5019;&#x4F20;&#x5165;isDirectory&#x53C2;&#x6570;&#x4E3A;false&#x3002;</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">MediaScanResult MediaScanner::doProcessDirectoryEntry(<span class="keyword">char</span> *path, <span class="keyword">int</span> pathRemaining, MediaScannerClient &amp;client, <span class="keyword">bool</span> noMedia,<span class="keyword">struct</span> dirent* entry, <span class="keyword">char</span>* fileSpot) {</span><br><span class="line">    <span class="keyword">struct</span> stat statbuf;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* name = entry-&gt;d_name;</span><br><span class="line">    <span class="keyword">if</span> (type == DT_DIR) {</span><br><span class="line">        <span class="comment">// report the directory to the client</span></span><br><span class="line">        <span class="comment">//&#x5982;&#x679C;&#x662F;&#x76EE;&#x5F55;&#x7C7B;&#x578B;</span></span><br><span class="line">        <span class="keyword">if</span> (stat(path, &amp;statbuf) == <span class="number">0</span>) {</span><br><span class="line">            <span class="comment">//&#x8C03;&#x7528;client.scanFile&#x626B;&#x63CF;&#x76EE;&#x5F55;&#xFF1A;&#x8FD9;&#x91CC;&#x7684;isDirectory = true</span></span><br><span class="line">            <span class="keyword">status_t</span> status = client.scanFile(path, statbuf.st_mtime, <span class="number">0</span>,<span class="literal">true</span> <span class="comment">/*isDirectory*/</span>, childNoMedia);</span><br><span class="line">            <span class="keyword">if</span> (status) {</span><br><span class="line">                <span class="keyword">return</span> MEDIA_SCAN_RESULT_ERROR;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// and now process its contents</span></span><br><span class="line">        <span class="comment">//&#x5728;&#x8FD9;&#x4E2A;&#x5730;&#x65B9;&#x5F00;&#x59CB;&#x626B;&#x63CF;&#x8BE5;&#x76EE;&#x5F55;&#x7684;&#x5B50;&#x6587;&#x4EF6;</span></span><br><span class="line">        <span class="built_in">strcat</span>(fileSpot, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">        MediaScanResult result = doProcessDirectory(path, pathRemaining - nameLength - <span class="number">1</span>, client, childNoMedia);</span><br><span class="line">        <span class="keyword">if</span> (result == MEDIA_SCAN_RESULT_ERROR) {</span><br><span class="line">            <span class="keyword">return</span> MEDIA_SCAN_RESULT_ERROR;</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (type == DT_REG) {</span><br><span class="line">        <span class="comment">//&#x5982;&#x679C;&#x662F;&#x666E;&#x901A;&#x6587;&#x4EF6;  &#x8FD9;&#x91CC;&#x7684;isDirectory = false</span></span><br><span class="line">        stat(path, &amp;statbuf);</span><br><span class="line">        <span class="keyword">status_t</span> status = client.scanFile(path, statbuf.st_mtime, statbuf.st_size,<span class="literal">false</span> <span class="comment">/*isDirectory*/</span>, noMedia);</span><br><span class="line">        <span class="keyword">if</span> (status) {</span><br><span class="line">            <span class="keyword">return</span> MEDIA_SCAN_RESULT_ERROR;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> MEDIA_SCAN_RESULT_OK;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x4E0D;&#x8BBA;&#x600E;&#x6837;&#x8FD9;&#x91CC;&#x90FD;&#x662F;&#x8C03;&#x7528;&#x7684;client.scanFile&#x53EA;&#x4E0D;&#x8FC7;&#xFF0C;&#x4F20;&#x5165;&#x7684;isDirectory&#x4E0D;&#x4E00;&#x6837;&#x7F62;&#x4E86;&#x3002;&#x5927;&#x5BB6;&#x8FD8;&#x8BB0;&#x5F97;client&#x4E3A;MyMediaScannerClient&#x5427;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x6765;&#x770B;&#x4E0B;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF1A;</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> status_t <span class="title">scanFile</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* path, <span class="keyword">long</span> <span class="keyword">long</span> lastModified,</span><br><span class="line">            <span class="keyword">long</span> <span class="keyword">long</span> fileSize, <span class="keyword">bool</span> isDirectory, <span class="keyword">bool</span> noMedia)</span></span><br><span class="line"></span>{</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    mEnv-&gt;CallVoidMethod(mClient, mScanFileMethodID, pathStr, lastModified,</span><br><span class="line">            fileSize, isDirectory, noMedia);</span><br><span class="line">     <span class="comment">//......</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5728;&#x4E0A;&#x8FF0;&#x65B9;&#x6CD5;&#x4E2D;&#x4E3B;&#x8981;&#x8C03;&#x7528;&#x7684;&#x662F;mEnv-&gt;CallVoidMethod(mClient, mScanFileMethodID, pathStr, lastModified,fileSize, isDirectory, noMedia);&#x8FD9;&#x662F;&#x8C03;&#x7528;&#x54EA;&#x4E2A;&#x65B9;&#x6CD5;&#x5462;&#xFF1F;&#x8981;&#x89E3;&#x51B3;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x5FC5;&#x987B;&#x627E;&#x5230;mScanFileMethodID<br><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">MyMediaScannerClient<span class="list">(<span class="keyword">JNIEnv</span> <span class="variable">*env, jobject client)</span><br><span class="line">        :   mEnv(env),</span><br><span class="line">            mClient(env-&gt;NewGlobalRef(client)),</span><br><span class="line">            mScanFileMethodID(0),</span><br><span class="line">            mHandleStringTagMethodID(0),</span><br><span class="line">            mSetMimeTypeMethodID(0)</span><br><span class="line">{</span><br><span class="line">    jclass mediaScannerClientInterface =</span><br><span class="line">            env-&gt;FindClass(kClassMediaScannerClient);</span><br><span class="line">    // static const char*</span> const kClassMediaScannerClient =</span><br><span class="line">    <span class="string">&quot;android/media/MediaScannerClient&quot;</span><span class="comment">;</span></span><br><span class="line">    if <span class="list">(<span class="keyword">mediaScannerClientInterface</span> == NULL)</span> {</span><br><span class="line">        ALOGE<span class="list">(<span class="string">&quot;Class %s not found&quot;</span>, kClassMediaScannerClient)</span><span class="comment">;</span></span><br><span class="line">    } else {</span><br><span class="line">        mScanFileMethodID = env-&gt;GetMethodID<span class="list">(</span><br><span class="line">                                <span class="keyword">mediaScannerClientInterface</span>,</span><br><span class="line">                                <span class="string">&quot;scanFile&quot;</span>,</span><br><span class="line">                                <span class="string">&quot;(Ljava/lang/String;JJZZ)V&quot;</span>)</span><span class="comment">;</span></span><br><span class="line">        mHandleStringTagMethodID = env-&gt;GetMethodID<span class="list">(</span><br><span class="line">                                <span class="keyword">mediaScannerClientInterface</span>,</span><br><span class="line">                                <span class="string">&quot;handleStringTag&quot;</span>,</span><br><span class="line">                                <span class="string">&quot;(Ljava/lang/String;Ljava/lang/String;)V&quot;</span>)</span><span class="comment">;</span></span><br><span class="line">        mSetMimeTypeMethodID = env-&gt;GetMethodID<span class="list">(</span><br><span class="line">                                <span class="keyword">mediaScannerClientInterface</span>,</span><br><span class="line">                                <span class="string">&quot;setMimeType&quot;</span>,</span><br><span class="line">                                <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>)</span><span class="comment">;</span></span><br><span class="line">    }</span><br><span class="line">}</span></span><br></pre></td></tr></table></figure></p>
<p>&#x4ECE;&#x4E0A;&#x9762;&#x53EF;&#x4EE5;&#x770B;&#x51FA;MyMediaScannerClient&#x5B9E;&#x4F8B;&#x4E2D;&#x7684;scanFile&#x65B9;&#x6CD5;&#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x8C03;&#x7528;&#x4F4D;&#x4E8E;MediaScanner.java&#x6587;&#x4EF6;&#x4E2D;&#x7684;MyMediaScannerClient&#x7684;ScanFile&#x65B9;&#x6CD5;&#xFF1A;</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">scanFile</span><span class="params">(String path, <span class="keyword">long</span> lastModified, <span class="keyword">long</span> fileSize,</span><br><span class="line">        <span class="keyword">boolean</span> isDirectory, <span class="keyword">boolean</span> noMedia)</span> </span>{</span><br><span class="line">    <span class="comment">// This is the callback funtion from native codes.</span></span><br><span class="line">    <span class="comment">// Log.v(TAG, &quot;scanFile: &quot;+path);</span></span><br><span class="line">    doScanFile(path, <span class="keyword">null</span>, lastModified, fileSize, isDirectory, <span class="keyword">false</span>, noMedia);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>ScanFile&#x65B9;&#x6CD5;&#x5F88;&#x7B80;&#x5355;&#x5C31;&#x76F4;&#x63A5;&#x8C03;&#x7528;doScanFile&#x65B9;&#x6CD5;&#x3002;&#x5728;doScanFile&#x65B9;&#x6CD5;&#x4E2D;&#x5C06;&#x4F1A;&#x8FDB;&#x5165;&#x4E0B;&#x4E00;&#x4E2A;&#x91CD;&#x8981;&#x7684;&#x9636;&#x6BB5;&#x2014;&#x83B7;&#x53D6;&#x97F3;&#x9891;&#x89C6;&#x9891;&#x6587;&#x4EF6;&#x7684;TAG&#x6570;&#x636E;&#x3002;&#x4F46;&#x662F;&#x5728;&#x4ECB;&#x7ECD;&#x8FD9;&#x4E2A;&#x91CD;&#x8981;&#x9636;&#x6BB5;&#x4E4B;&#x524D;&#x8FD8;&#x662F;&#x5148;&#x4ECB;&#x7ECD;&#x4E0B;beginFile&#x3002;</p>
<figure class="highlight processing"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Uri doScanFile(<span class="keyword">String</span> path, <span class="keyword">String</span> mimeType, <span class="keyword">long</span> lastModified,</span><br><span class="line">        <span class="keyword">long</span> fileSize, <span class="built_in">boolean</span> isDirectory, <span class="built_in">boolean</span> scanAlways, <span class="built_in">boolean</span> noMedia) {</span><br><span class="line"></span><br><span class="line">    <span class="comment">//&#x8C03;&#x7528;beginFile</span></span><br><span class="line">    FileEntry entry = beginFile(path, mimeType, lastModified,</span><br><span class="line">            fileSize, isDirectory, noMedia);</span><br><span class="line">           </span><br><span class="line">    <span class="keyword">if</span> (entry != <span class="keyword">null</span> &amp;&amp; (entry.mLastModifiedChanged || scanAlways)) {</span><br><span class="line">        <span class="keyword">if</span> (noMedia) {</span><br><span class="line">            </span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">String</span> lowpath = path.toLowerCase(Locale.ROOT);</span><br><span class="line">            <span class="built_in">boolean</span> ringtones = (lowpath.indexOf(RINGTONES_DIR) &gt; <span class="number">0</span>);</span><br><span class="line">            <span class="built_in">boolean</span> notifications = (lowpath.indexOf(NOTIFICATIONS_DIR) &gt; <span class="number">0</span>);</span><br><span class="line">            <span class="built_in">boolean</span> alarms = (lowpath.indexOf(ALARMS_DIR) &gt; <span class="number">0</span>);</span><br><span class="line">            <span class="built_in">boolean</span> podcasts = (lowpath.indexOf(PODCAST_DIR) &gt; <span class="number">0</span>);</span><br><span class="line">            <span class="built_in">boolean</span> music = (lowpath.indexOf(MUSIC_DIR) &gt; <span class="number">0</span>) ||</span><br><span class="line">                (!ringtones &amp;&amp; !notifications &amp;&amp; !alarms &amp;&amp; !podcasts);</span><br><span class="line">            <span class="built_in">boolean</span> isaudio = MediaFile.isAudioFileType(mFileType);</span><br><span class="line">            <span class="built_in">boolean</span> isvideo = MediaFile.isVideoFileType(mFileType);</span><br><span class="line">            <span class="built_in">boolean</span> isimage = MediaFile.isImageFileType(mFileType);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (isaudio || isvideo || isimage) {</span><br><span class="line">                path = Environment.maybeTranslateEmulatedPathToInternal(<span class="keyword">new</span> File(path))</span><br><span class="line">                        .getAbsolutePath();</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">//&#x5982;&#x679C;&#x4E3A;&#x97F3;&#x9891;&#x6216;&#x8005;&#x89C6;&#x9891;&#x6587;&#x4EF6;&#x62BD;&#x53D6;&#x5143;&#x6570;&#x636E;</span></span><br><span class="line">            <span class="comment">// we only extract metadata for audio and video files</span></span><br><span class="line">            <span class="keyword">if</span> (isaudio || isvideo) {</span><br><span class="line">                processFile(path, mimeType, <span class="keyword">this</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">//&#x5982;&#x679C;&#x662F;&#x56FE;&#x50CF;&#x5219;&#x8C03;&#x7528;processImageFile</span></span><br><span class="line">            <span class="keyword">if</span> (isimage) {</span><br><span class="line">                processImageFile(path);</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">//&#x8C03;&#x7528;endFile</span></span><br><span class="line">            result = endFile(entry, ringtones, notifications, alarms, music, podcasts);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>beginFile&#x6545;&#x540D;&#x601D;&#x8BAE;&#x5C31;&#x662F;&#x5728;&#x626B;&#x63CF;&#x524D;&#x8FDB;&#x884C;&#x7684;&#x4E00;&#x4E9B;&#x5904;&#x7406;:</p>
<ul>
<li>&#x5982;&#x679C;&#x5F53;&#x524D;&#x626B;&#x63CF;&#x7684;&#x6587;&#x4EF6;&#x662F;&#x666E;&#x901A;&#x6587;&#x4EF6;&#x5219;&#x786E;&#x5B9A;&#x5F53;&#x524D;&#x666E;&#x901A;&#x6587;&#x4EF6;&#x7684;&#x6587;&#x4EF6;&#x7C7B;&#x578B;&#x3002;</li>
<li>&#x4F7F;&#x7528;&#x5F53;&#x524D;path&#x53C2;&#x6570;&#x5230;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x8FDB;&#x884C;&#x67E5;&#x8BE2;&#xFF0C;&#x8FD9;&#x65F6;&#x5019;&#x6709;&#x4E24;&#x79CD;&#x60C5;&#x51B5;&#xFF0C;&#x8BE5;&#x6587;&#x4EF6;&#x7684;&#x8BB0;&#x5F55;&#x5DF2;&#x7ECF;&#x5B58;&#x5728;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x4E86;&#xFF0C;&#x8FD9;&#x65F6;&#x5019;&#x4F7F;&#x7528;path&#x5728;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x6587;&#x4EF6;&#x4FE1;&#x606F;&#xFF0C;&#x5E76;&#x4F7F;&#x7528;&#x8FD9;&#x4E9B;&#x4FE1;&#x606F;&#x6765;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;FileEntry&#xFF0C;&#x5982;&#x679C;&#x5F53;&#x524D;&#x7684;&#x6587;&#x4EF6;&#x662F;&#x65B0;&#x6DFB;&#x52A0;&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x5219;&#x5728;&#x6570;&#x636E;&#x4E2D;&#x5E76;&#x6CA1;&#x6709;&#x5173;&#x4E8E;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x5219;new&#x51FA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;FileEntry&#xFF1A;<br>entry = new FileEntry(0, path, lastModified,(isDirectory ? MtpConstants.FORMAT_ASSOCIATION : 0));</li>
<li>&#x5982;&#x679C;&#x5F53;&#x524D;&#x6587;&#x4EF6;&#x662F;&#x64AD;&#x653E;&#x5217;&#x8868;&#x7C7B;&#x578B;&#x5219;&#x5C06;&#x5176;&#x5148;&#x5B58;&#x50A8;&#x5230;mPlayLists&#x4E2D;&#xFF0C;&#x5728;&#x4E3B;&#x626B;&#x63CF;&#x8FDB;&#x7A0B;&#x4E2D;&#x5148;&#x4E0D;&#x505A;&#x5904;&#x7406;&#x3002;</li>
<li>&#x6E05;&#x7A7A;&#x5143;&#x6570;&#x636E;&#xFF0C;&#x4E3A;&#x63A5;&#x4E0B;&#x6765;&#x7684;&#x626B;&#x63CF;&#x505A;&#x51C6;&#x5907;&#x3002;<figure class="highlight processing"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> FileEntry beginFile(<span class="keyword">String</span> path, <span class="keyword">String</span> mimeType, <span class="keyword">long</span> lastModified,<span class="keyword">long</span> fileSize, <span class="built_in">boolean</span> isDirectory, <span class="built_in">boolean</span> noMedia) {</span><br><span class="line">    mMimeType = mimeType;</span><br><span class="line">    mFileType = <span class="number">0</span>;</span><br><span class="line">    mFileSize = fileSize;</span><br><span class="line">    mIsDrm = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isDirectory) {</span><br><span class="line">        <span class="keyword">if</span> (!noMedia &amp;&amp; isNoMediaFile(path)) {</span><br><span class="line">            noMedia = <span class="keyword">true</span>;</span><br><span class="line">        }</span><br><span class="line">        mNoMedia = noMedia;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// try mimeType first, if it is specified</span></span><br><span class="line">        <span class="keyword">if</span> (mimeType != <span class="keyword">null</span>) {</span><br><span class="line">            mFileType = MediaFile.getFileTypeForMimeType(mimeType);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// if mimeType was not specified, compute file type based on file extension.</span></span><br><span class="line">        <span class="keyword">if</span> (mFileType == <span class="number">0</span>) {</span><br><span class="line">            MediaFile.MediaFileType mediaFileType = MediaFile.getFileType(path);</span><br><span class="line">            <span class="keyword">if</span> (mediaFileType != <span class="keyword">null</span>) {</span><br><span class="line">                mFileType = mediaFileType.fileType;</span><br><span class="line">                <span class="keyword">if</span> (mMimeType == <span class="keyword">null</span>) {</span><br><span class="line">                    mMimeType = mediaFileType.mimeType;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (isDrmEnabled() &amp;&amp; MediaFile.isDrmFileType(mFileType)) {</span><br><span class="line">            mFileType = getFileTypeFromDrm(path);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//&#x4F7F;&#x7528;path&#x67E5;&#x8BE2;&#x6570;&#x636E;&#x5E93;&#xFF0C;&#x5728;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x6587;&#x4EF6;&#x4FE1;&#x606F;&#xFF0C;</span></span><br><span class="line">    &#x5E76;&#x4F7F;&#x7528;&#x8FD9;&#x4E9B;&#x4FE1;&#x606F;&#x6765;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;FileEntry</span><br><span class="line">    FileEntry entry = makeEntryFor(path);</span><br><span class="line">    <span class="comment">// add some slack to avoid a rounding error</span></span><br><span class="line">    <span class="keyword">long</span> delta = (entry != <span class="keyword">null</span>) ? (lastModified - entry.mLastModified) : <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">boolean</span> wasModified = delta &gt; <span class="number">1</span> || delta &lt; -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (entry == <span class="keyword">null</span> || wasModified) {</span><br><span class="line">        <span class="keyword">if</span> (wasModified) {</span><br><span class="line">            entry.mLastModified = lastModified;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            entry = <span class="keyword">new</span> FileEntry(<span class="number">0</span>, path, lastModified,</span><br><span class="line">                    (isDirectory ? MtpConstants.FORMAT_ASSOCIATION : <span class="number">0</span>));</span><br><span class="line">        }</span><br><span class="line">        entry.mLastModifiedChanged = <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line">     <span class="comment">//&#x5982;&#x679C;&#x5F53;&#x524D;&#x7C7B;&#x578B;&#x4E3A;&#x64AD;&#x653E;&#x5217;&#x8868;&#x7C7B;&#x578B;</span></span><br><span class="line">    <span class="keyword">if</span> (mProcessPlaylists &amp;&amp; MediaFile.isPlayListFileType(mFileType)) {</span><br><span class="line">        <span class="comment">//&#x5C06;&#x6570;&#x636E;&#x5B58;&#x50A8;&#x5230;&#x961F;&#x5217;&#x4E2D;&#x5728;&#x540E;&#x7EED;&#x7684;&#x90E8;&#x5206;&#x5904;&#x7406;&#xFF0C;&#x4E0D;&#x5728;&#x4E3B;&#x626B;&#x63CF;&#x8FC7;&#x7A0B;&#x4E2D;&#x5904;&#x7406;</span></span><br><span class="line">        mPlayLists.<span class="built_in">add</span>(entry);</span><br><span class="line">        <span class="comment">// we don&apos;t process playlists in the main scan, so return null</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// clear all the metadata</span></span><br><span class="line">    mArtist = <span class="keyword">null</span>;</span><br><span class="line">    mAlbumArtist = <span class="keyword">null</span>;</span><br><span class="line">    mAlbum = <span class="keyword">null</span>;</span><br><span class="line">    mTitle = <span class="keyword">null</span>;</span><br><span class="line">    mComposer = <span class="keyword">null</span>;</span><br><span class="line">    mGenre = <span class="keyword">null</span>;</span><br><span class="line">    mTrack = <span class="number">0</span>;</span><br><span class="line">    mYear = <span class="number">0</span>;</span><br><span class="line">    mDuration = <span class="number">0</span>;</span><br><span class="line">    mPath = path;</span><br><span class="line">    mLastModified = lastModified;</span><br><span class="line">    mWriter = <span class="keyword">null</span>;</span><br><span class="line">    mCompilation = <span class="number">0</span>;</span><br><span class="line">    mWidth = <span class="number">0</span>;</span><br><span class="line">    mHeight = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> entry;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>&#x5982;&#x679C;&#x5F53;&#x524D;&#x6587;&#x4EF6;&#x4E0D;&#x662F;&#x97F3;&#x9891;&#x89C6;&#x9891;&#x6216;&#x8005;&#x56FE;&#x50CF;&#x6587;&#x4EF6;&#x5219;&#x76F4;&#x63A5;&#x5728;doScanFile&#x4E2D;&#x8C03;&#x7528;endFile&#x5C06;&#x4FE1;&#x606F;&#x5B58;&#x50A8;&#x5230;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x3002;&#x6211;&#x4EEC;&#x770B;&#x4E0B;endFile&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x3002;<br>&#x5728;endFile&#x65B9;&#x6CD5;&#x4E2D;&#x505A;&#x4E86;&#x5982;&#x4E0B;&#x5DE5;&#x4F5C;&#xFF1A;</p>
<ul>
<li>&#x5982;&#x679C;&#x6B4C;&#x624B;&#x4FE1;&#x606F;&#x4E0D;&#x5B58;&#x5728;&#x5219;&#x4F7F;&#x7528;&#x4E13;&#x8F91;&#x4F5C;&#x8005;&#x4F5C;&#x4E3A;&#x6B4C;&#x624B;&#x4FE1;&#x606F;.</li>
<li>&#x63A5;&#x7740;&#x8C03;&#x7528;toValues&#x65B9;&#x6CD5;&#x5C06;&#x6587;&#x4EF6;&#x7684;&#x57FA;&#x672C;&#x4FE1;&#x606F;&#x6DFB;&#x52A0;&#x5230;ContentValues&#x4E2D;</li>
<li>&#x5BF9;toValues&#x65B9;&#x6CD5;&#x6DFB;&#x52A0;&#x7684;&#x57FA;&#x672C;&#x4FE1;&#x606F;&#x8FDB;&#x884C;&#x4FEE;&#x6B63;&#x3002;</li>
<li>&#x5982;&#x679C;&#x662F;&#x65B0;&#x6DFB;&#x52A0;&#x7684;&#x97F3;&#x9891;&#x6587;&#x4EF6;&#x5219;&#x5C06;&#x4F20;&#x5165;&#x7684;ringtones&#xFF0C;notifications&#xFF0C;alarms&#xFF0C;music&#xFF0C;podcasts&#x6DFB;&#x52A0;&#x5230;ContentValues&#x4E2D;&#xFF0C;&#x5982;&#x679C;&#x662F;&#x56FE;&#x7247;&#x5219;&#x4ECE;ExifInterface&#x4E2D;&#x83B7;&#x53D6;&#x56FE;&#x7247;&#x7684;&#x957F;&#x5EA6;&#x5BBD;&#x5EA6;&#xFF0C;&#x7ECF;&#x7EAC;&#x5EA6;&#xFF0C;&#x65F6;&#x533A;&#x4FE1;&#x606F;&#x3002;</li>
<li>&#x5982;&#x679C;&#x5F53;&#x524D;&#x626B;&#x63CF;&#x7684;&#x6587;&#x4EF6;&#x662F;&#x65B0;&#x589E;&#x7684;&#x5219;&#x5C06;&#x5F53;&#x524D;&#x7684;ContentValues&#x63D2;&#x5165;&#x5230;&#x6570;&#x636E;&#x5E93;&#x4E2D;,&#x5982;&#x679C;&#x5F53;&#x524D;&#x7684;&#x6587;&#x4EF6;&#x7684;&#x8BB0;&#x5F55;&#x5728;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x672C;&#x6765;&#x5C31;&#x6709;&#x7684;&#x5219;&#x8C03;&#x7528;update&#x5BF9;&#x6570;&#x636E;&#x5E93;&#x539F;&#x5148;&#x5B58;&#x5728;&#x7684;&#x9879;&#x8FDB;&#x884C;&#x66F4;&#x65B0;&#x3002;</li>
<li>&#x66F4;&#x65B0;Setting&#x4E0A;&#x7684;&#x76F8;&#x5173;&#x8BBE;&#x7F6E;.</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Uri <span class="title">endFile</span><span class="params">(FileEntry entry, boolean ringtones, boolean notifications,</span><br><span class="line">        boolean alarms, boolean music, boolean podcasts)</span></span><br><span class="line">        throws RemoteException </span>{</span><br><span class="line">    <span class="comment">// update database</span></span><br><span class="line">    <span class="comment">// use album artist if artist is missing</span></span><br><span class="line">    <span class="keyword">if</span> (mArtist == null || mArtist.length() == <span class="number">0</span>) {</span><br><span class="line">        mArtist = mAlbumArtist;</span><br><span class="line">    }</span><br><span class="line">    ContentValues values = toValues();</span><br><span class="line">    String title = values.getAsString(MediaStore.MediaColumns.TITLE);</span><br><span class="line">    <span class="keyword">if</span> (title == null || TextUtils.isEmpty(title.trim())) {</span><br><span class="line">        title = MediaFile.getFileTitle(values.getAsString(MediaStore.MediaColumns.DATA));</span><br><span class="line">        values.put(MediaStore.MediaColumns.TITLE, title);</span><br><span class="line">    }</span><br><span class="line">    String album = values.getAsString(Audio.Media.ALBUM);</span><br><span class="line">    <span class="keyword">if</span> (MediaStore.UNKNOWN_STRING.equals(album)) {</span><br><span class="line">        album = values.getAsString(MediaStore.MediaColumns.DATA);</span><br><span class="line">        <span class="comment">// extract last path segment before file name</span></span><br><span class="line">        <span class="keyword">int</span> lastSlash = album.lastIndexOf(<span class="string">&apos;/&apos;</span>);</span><br><span class="line">        <span class="keyword">if</span> (lastSlash &gt;= <span class="number">0</span>) {</span><br><span class="line">            <span class="keyword">int</span> previousSlash = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">                <span class="keyword">int</span> idx = album.indexOf(<span class="string">&apos;/&apos;</span>, previousSlash + <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> (idx &lt; <span class="number">0</span> || idx &gt;= lastSlash) {</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                }</span><br><span class="line">                previousSlash = idx;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (previousSlash != <span class="number">0</span>) {</span><br><span class="line">                album = album.substring(previousSlash + <span class="number">1</span>, lastSlash);</span><br><span class="line">                values.put(Audio.Media.ALBUM, album);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">long</span> rowId = entry.mRowId;</span><br><span class="line">    <span class="keyword">if</span> (MediaFile.isAudioFileType(mFileType) &amp;&amp; (rowId == <span class="number">0</span> || mMtpObjectHandle != <span class="number">0</span>)) {</span><br><span class="line">        <span class="comment">// Only set these for new entries. For existing entries, they</span></span><br><span class="line">        <span class="comment">// may have been modified later, and we want to keep the current</span></span><br><span class="line">        <span class="comment">// values so that custom ringtones still show up in the ringtone</span></span><br><span class="line">        <span class="comment">// picker.</span></span><br><span class="line">        values.put(Audio.Media.IS_RINGTONE, ringtones);</span><br><span class="line">        values.put(Audio.Media.IS_NOTIFICATION, notifications);</span><br><span class="line">        values.put(Audio.Media.IS_ALARM, alarms);</span><br><span class="line">        values.put(Audio.Media.IS_MUSIC, music);</span><br><span class="line">        values.put(Audio.Media.IS_PODCAST, podcasts);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (mFileType == MediaFile.FILE_TYPE_JPEG &amp;&amp; !mNoMedia) {</span><br><span class="line">        ExifInterface exif = null;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            exif = <span class="keyword">new</span> ExifInterface(entry.mPath);</span><br><span class="line">        } <span class="keyword">catch</span> (IOException ex) {</span><br><span class="line">            <span class="comment">// exif is null</span></span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (exif != null) {</span><br><span class="line">            <span class="keyword">float</span>[] latlng = <span class="keyword">new</span> <span class="keyword">float</span>[<span class="number">2</span>];</span><br><span class="line">            <span class="keyword">if</span> (exif.getLatLong(latlng)) {</span><br><span class="line">                values.put(Images.Media.LATITUDE, latlng[<span class="number">0</span>]);</span><br><span class="line">                values.put(Images.Media.LONGITUDE, latlng[<span class="number">1</span>]);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">long</span> time = exif.getGpsDateTime();</span><br><span class="line">            <span class="keyword">if</span> (time != -<span class="number">1</span>) {</span><br><span class="line">                values.put(Images.Media.DATE_TAKEN, time);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// If no time zone information is available, we should consider using</span></span><br><span class="line">                <span class="comment">// EXIF local time as taken time if the difference between file time</span></span><br><span class="line">                <span class="comment">// and EXIF local time is not less than 1 Day, otherwise MediaProvider</span></span><br><span class="line">                <span class="comment">// will use file time as taken time.</span></span><br><span class="line">                time = exif.getDateTime();</span><br><span class="line">                <span class="keyword">if</span> (time != -<span class="number">1</span> &amp;&amp; Math.<span class="built_in">abs</span>(mLastModified * <span class="number">1000</span> - time) &gt;= <span class="number">86400000</span>) {</span><br><span class="line">                    values.put(Images.Media.DATE_TAKEN, time);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> orientation = exif.getAttributeInt(</span><br><span class="line">                ExifInterface.TAG_ORIENTATION, -<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (orientation != -<span class="number">1</span>) {</span><br><span class="line">                <span class="comment">// We only recognize a subset of orientation tag values.</span></span><br><span class="line">                <span class="keyword">int</span> degree;</span><br><span class="line">                <span class="keyword">switch</span>(orientation) {</span><br><span class="line">                    <span class="keyword">case</span> ExifInterface.ORIENTATION_ROTATE_90:</span><br><span class="line">                        degree = <span class="number">90</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> ExifInterface.ORIENTATION_ROTATE_180:</span><br><span class="line">                        degree = <span class="number">180</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> ExifInterface.ORIENTATION_ROTATE_270:</span><br><span class="line">                        degree = <span class="number">270</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        degree = <span class="number">0</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                }</span><br><span class="line">                values.put(Images.Media.ORIENTATION, degree);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    Uri tableUri = mFilesUri;</span><br><span class="line">    MediaInserter inserter = mMediaInserter;</span><br><span class="line">    <span class="keyword">if</span> (!mNoMedia) {</span><br><span class="line">        <span class="keyword">if</span> (MediaFile.isVideoFileType(mFileType)) {</span><br><span class="line">            tableUri = mVideoUri;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (MediaFile.isImageFileType(mFileType)) {</span><br><span class="line">            tableUri = mImagesUri;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (MediaFile.isAudioFileType(mFileType)) {</span><br><span class="line">            tableUri = mAudioUri;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    Uri result = null;</span><br><span class="line">    boolean needToSetSettings = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (rowId == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">if</span> (mMtpObjectHandle != <span class="number">0</span>) {</span><br><span class="line">            values.put(MediaStore.MediaColumns.MEDIA_SCANNER_NEW_OBJECT_ID, mMtpObjectHandle);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (tableUri == mFilesUri) {</span><br><span class="line">            <span class="keyword">int</span> format = entry.mFormat;</span><br><span class="line">            <span class="keyword">if</span> (format == <span class="number">0</span>) {</span><br><span class="line">                format = MediaFile.getFormatCode(entry.mPath, mMimeType);</span><br><span class="line">            }</span><br><span class="line">            values.put(Files.FileColumns.FORMAT, format);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// Setting a flag in order not to use bulk insert for the file related with</span></span><br><span class="line">        <span class="comment">// notifications, ringtones, and alarms, because the rowId of the inserted file is</span></span><br><span class="line">        <span class="comment">// needed.</span></span><br><span class="line">        <span class="keyword">if</span> (mWasEmptyPriorToScan) {</span><br><span class="line">            <span class="keyword">if</span> (notifications &amp;&amp; !mDefaultNotificationSet) {</span><br><span class="line">                <span class="keyword">if</span> (TextUtils.isEmpty(mDefaultNotificationFilename) ||</span><br><span class="line">                        doesPathHaveFilename(entry.mPath, mDefaultNotificationFilename)) {</span><br><span class="line">                    needToSetSettings = <span class="literal">true</span>;</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (ringtones &amp;&amp; !mDefaultRingtoneSet) {</span><br><span class="line">                <span class="keyword">if</span> (TextUtils.isEmpty(mDefaultRingtoneFilename) ||</span><br><span class="line">                        doesPathHaveFilename(entry.mPath, mDefaultRingtoneFilename)) {</span><br><span class="line">                    needToSetSettings = <span class="literal">true</span>;</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (alarms &amp;&amp; !mDefaultAlarmSet) {</span><br><span class="line">                <span class="keyword">if</span> (TextUtils.isEmpty(mDefaultAlarmAlertFilename) ||</span><br><span class="line">                        doesPathHaveFilename(entry.mPath, mDefaultAlarmAlertFilename)) {</span><br><span class="line">                    needToSetSettings = <span class="literal">true</span>;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// New file, insert it.</span></span><br><span class="line">        <span class="comment">// Directories need to be inserted before the files they contain, so they</span></span><br><span class="line">        <span class="comment">// get priority when bulk inserting.</span></span><br><span class="line">        <span class="comment">// If the rowId of the inserted file is needed, it gets inserted immediately,</span></span><br><span class="line">        <span class="comment">// bypassing the bulk inserter.</span></span><br><span class="line">        <span class="keyword">if</span> (inserter == null || needToSetSettings) {</span><br><span class="line">            <span class="keyword">if</span> (inserter != null) {</span><br><span class="line">                inserter.flushAll();</span><br><span class="line">            }</span><br><span class="line">            result = mMediaProvider.insert(mPackageName, tableUri, values);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (entry.mFormat == MtpConstants.FORMAT_ASSOCIATION) {</span><br><span class="line">            inserter.insertwithPriority(tableUri, values);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            inserter.insert(tableUri, values);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (result != null) {</span><br><span class="line">            rowId = ContentUris.parseId(result);</span><br><span class="line">            entry.mRowId = rowId;</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// updated file</span></span><br><span class="line">        result = ContentUris.withAppendedId(tableUri, rowId);</span><br><span class="line">        <span class="comment">// path should never change, and we want to avoid replacing mixed cased paths</span></span><br><span class="line">        <span class="comment">// with squashed lower case paths</span></span><br><span class="line">        values.remove(MediaStore.MediaColumns.DATA);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> mediaType = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (!MediaScanner.isNoMediaPath(entry.mPath)) {</span><br><span class="line">            <span class="keyword">int</span> fileType = MediaFile.getFileTypeForMimeType(mMimeType);</span><br><span class="line">            <span class="keyword">if</span> (MediaFile.isAudioFileType(fileType)) {</span><br><span class="line">                mediaType = FileColumns.MEDIA_TYPE_AUDIO;</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (MediaFile.isVideoFileType(fileType)) {</span><br><span class="line">                mediaType = FileColumns.MEDIA_TYPE_VIDEO;</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (MediaFile.isImageFileType(fileType)) {</span><br><span class="line">                mediaType = FileColumns.MEDIA_TYPE_IMAGE;</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (MediaFile.isPlayListFileType(fileType)) {</span><br><span class="line">                mediaType = FileColumns.MEDIA_TYPE_PLAYLIST;</span><br><span class="line">            }</span><br><span class="line">            values.put(FileColumns.MEDIA_TYPE, mediaType);</span><br><span class="line">        }</span><br><span class="line">        mMediaProvider.update(mPackageName, result, values, null, null);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(needToSetSettings) {</span><br><span class="line">        <span class="keyword">if</span> (notifications) {</span><br><span class="line">            setSettingIfNotSet(Settings.System.NOTIFICATION_SOUND, tableUri, rowId);</span><br><span class="line">            mDefaultNotificationSet = <span class="literal">true</span>;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (ringtones) {</span><br><span class="line">            setSettingIfNotSet(Settings.System.RINGTONE, tableUri, rowId);</span><br><span class="line">            mDefaultRingtoneSet = <span class="literal">true</span>;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (alarms) {</span><br><span class="line">            setSettingIfNotSet(Settings.System.ALARM_ALERT, tableUri, rowId);</span><br><span class="line">            mDefaultAlarmSet = <span class="literal">true</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5230;&#x76EE;&#x524D;&#x4E3A;&#x6B62;processDirectory&#x65B9;&#x6CD5;&#x7684;&#x6574;&#x4E2A;&#x6D41;&#x7A0B;&#x5DF2;&#x7ECF;&#x4ECB;&#x7ECD;&#x5B8C;&#x6BD5;&#xFF0C;&#x5982;&#x679C;&#x662F;&#x975E;&#x89C6;&#x9891;&#x97F3;&#x9891;&#x56FE;&#x50CF;&#x6587;&#x4EF6;&#x5219;&#x5DF2;&#x7ECF;&#x7ED3;&#x675F;&#x4E86;&#x6574;&#x4E2A;&#x626B;&#x63CF;&#x7684;&#x8FC7;&#x7A0B;&#xFF0C;&#x4F46;&#x662F;&#x6211;&#x4EEC;&#x4E0A;&#x9762;&#x4ECB;&#x7ECD;&#x7684;&#x65F6;&#x5019;&#x8FD8;&#x5FFD;&#x7565;&#x4E86;&#x64AD;&#x653E;&#x5217;&#x8868;&#x6587;&#x4EF6;&#x3002;&#x6240;&#x4EE5;&#x5728;&#x4E0B;&#x9762;&#x7684;&#x90E8;&#x5206;&#x4ECB;&#x7ECD;&#x64AD;&#x653E;&#x5217;&#x8868;&#x6587;&#x4EF6;&#xFF0C;&#x97F3;&#x9891;&#xFF0C;&#x89C6;&#x9891;&#xFF0C;&#x56FE;&#x50CF;&#x6587;&#x4EF6;&#x7684;&#x5904;&#x7406;&#x3002;</p>
<h4 id="&#x64AD;&#x653E;&#x5217;&#x8868;&#x7684;&#x5904;&#x7406;"><a href="#&#x64AD;&#x653E;&#x5217;&#x8868;&#x7684;&#x5904;&#x7406;" class="headerlink" title="&#x64AD;&#x653E;&#x5217;&#x8868;&#x7684;&#x5904;&#x7406;:"></a>&#x64AD;&#x653E;&#x5217;&#x8868;&#x7684;&#x5904;&#x7406;:</h4><p>&#x6211;&#x4EEC;&#x5728;&#x4ECB;&#x7ECD;beginFile&#x65B9;&#x6CD5;&#x7684;&#x65F6;&#x5019;&#x8BF4;&#x5230;&#x5728;&#x4E3B;&#x626B;&#x63CF;&#x8FDB;&#x7A0B;&#x4E2D;&#x5E76;&#x4E0D;&#x5BF9;&#x626B;&#x63CF;&#x5230;&#x7684;&#x64AD;&#x653E;&#x5217;&#x8868;&#x8FDB;&#x884C;&#x5904;&#x7406;&#xFF0C;&#x53EA;&#x662F;&#x5C06;&#x5176;&#x653E;&#x5230;mPlayLists&#x4E2D;&#x3002;&#x90A3;&#x4E48;&#x8FD9;&#x4E9B;&#x64AD;&#x653E;&#x5217;&#x8868;&#x662F;&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x5904;&#x7406;&#x5462;&#xFF1F;&#x53C8;&#x5C06;&#x5982;&#x4F55;&#x5904;&#x7406;&#x8FD9;&#x4E9B;&#x64AD;&#x653E;&#x5217;&#x8868;&#xFF1F;&#x5728;MediaScanner&#x4E2D;&#x64AD;&#x653E;&#x5217;&#x8868;&#x6587;&#x4EF6;&#x7684;&#x5904;&#x7406;&#x4F4D;&#x4E8E;postscan&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x8FD9;&#x65F6;&#x5019;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x77E5;&#x9053;&#x4E86;&#x5B58;&#x50A8;&#x5668;&#x4E2D;&#x6709;&#x54EA;&#x4E9B;&#x591A;&#x5A92;&#x4F53;&#x6587;&#x4EF6;&#x3002;&#x5728;processPlayLists&#x65B9;&#x6CD5;&#x4E2D;&#x53EA;&#x5904;&#x7406;&#x6700;&#x65B0;&#x7684;&#x548C;&#x4E0A;&#x6B21;&#x626B;&#x63CF;&#x4EE5;&#x540E;&#x4FEE;&#x6539;&#x540E;&#x7684;&#x64AD;&#x653E;&#x5217;&#x8868;&#x6587;&#x4EF6;&#xFF0C;&#x901A;&#x8FC7;&#x83B7;&#x53D6;&#x64AD;&#x653E;&#x5217;&#x8868;&#x7684;&#x7C7B;&#x578B;&#xFF0C;&#x518D;&#x6839;&#x636E;&#x64AD;&#x653E;&#x5217;&#x8868;&#x7684;&#x7C7B;&#x578B;&#x8C03;&#x7528;&#x4E0D;&#x540C;&#x7684;&#x65B9;&#x6CD5;&#x5904;&#x7406;&#x64AD;&#x653E;&#x5217;&#x8868;&#x6587;&#x4EF6;&#x3002;<br><figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">postscan</span><span class="params">(String[] directories)</span> <span class="keyword">throws</span> RemoteException </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">// handle playlists last, after we know what media files are on the storage.</span></span><br><span class="line">    <span class="comment">//&#x5982;&#x679C;&#x5F53;&#x524D;&#x626B;&#x63CF;&#x8DEF;&#x5F84;&#x4E3A;&#x5916;&#x90E8;&#x5B58;&#x50A8;&#x8DEF;&#x5F84;&#x5219;&#xFF0C;&#x5219;&#x5904;&#x7406;&#x64AD;&#x653E;&#x5217;&#x8868;</span></span><br><span class="line">    <span class="keyword">if</span> (mProcessPlaylists) {</span><br><span class="line">        <span class="comment">//&#x53EA;&#x5904;&#x7406;&#x6700;&#x65B0;&#x7684;&#x548C;&#x4E0A;&#x6B21;&#x626B;&#x63CF;&#x4EE5;&#x540E;&#x4FEE;&#x6539;&#x540E;&#x7684;&#x64AD;&#x653E;&#x5217;&#x8868;&#x6587;&#x4EF6;,</span></span><br><span class="line">        <span class="comment">//&#x83B7;&#x5F97;&#x6700;&#x540E;&#x7684;&#x540D;&#x5B57;&#x4EE5;&#x53CA;&#x6700;&#x540E;&#x7684;&#x4FEE;&#x6539;&#x65F6;&#x95F4;,</span></span><br><span class="line">        <span class="comment">//&#x5E76;&#x6839;&#x636E;&#x64AD;&#x653E;&#x5217;&#x8868;&#x7684;&#x7C7B;&#x578B;&#x8C03;&#x7528;&#x4E0D;&#x540C;&#x7684;&#x65B9;&#x6CD5;&#x5904;&#x7406;&#x64AD;&#x653E;&#x5217;&#x8868;&#x6587;&#x4EF6;</span></span><br><span class="line">        processPlayLists();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mOriginalCount == <span class="number">0</span> &amp;&amp; mImagesUri.equals(Images.Media.getContentUri(<span class="string">&quot;external&quot;</span>)))</span><br><span class="line">        pruneDeadThumbnailFiles();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// allow GC to clean up</span></span><br><span class="line">    mPlayLists = <span class="keyword">null</span>;</span><br><span class="line">    mMediaProvider = <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>processPlayLists&#x65B9;&#x6CD5;&#x4E2D;&#x9996;&#x5148;&#x83B7;&#x53D6;&#x5168;&#x90E8;&#x7684;&#x97F3;&#x9891;&#x6587;&#x4EF6;&#xFF0C;&#x5E76;&#x4F7F;&#x7528;&#x5168;&#x90E8;&#x7684;&#x97F3;&#x9891;&#x6587;&#x4EF6;&#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#xFF0C;&#x4F20;&#x5165;processPlayList&#xFF0C;&#x8FD9;&#x4E2A;&#x53C2;&#x6570;&#x5728;&#x540E;&#x7EED;&#x5C06;&#x4F1A;&#x4ECB;&#x7ECD;&#xFF0C;&#x5176;&#x5B9E;&#x4E4B;&#x6240;&#x4EE5;&#x4F20;&#x5165;&#x5168;&#x90E8;&#x97F3;&#x9891;&#x6587;&#x4EF6;&#x662F;&#x7528;&#x4E8E;&#x83B7;&#x53D6;&#x6BCF;&#x4E2A;&#x64AD;&#x653E;&#x5217;&#x8868;&#x7684;Playlist Member&#xFF08;&#x64AD;&#x653E;&#x5217;&#x8868;&#x6210;&#x5458;&#x6B4C;&#x66F2;&#xFF09;</p>
<figure class="highlight nimrod"><table><tr><td class="code"><pre><span class="line">private <span class="type">void</span> processPlayLists() throws <span class="type">RemoteException</span> {</span><br><span class="line">        <span class="type">Iterator</span>&lt;<span class="type">FileEntry</span>&gt; <span class="keyword">iterator</span> = mPlayLists.<span class="keyword">iterator</span>();</span><br><span class="line">        <span class="type">Cursor</span> fileList = null;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            // use the files uri <span class="keyword">and</span> projection because we need the format column,</span><br><span class="line">            // but restrict the query to just audio files</span><br><span class="line">            /&#x83B7;&#x53D6;&#x5168;&#x90E8;&#x7684;&#x97F3;&#x9891;&#x6587;&#x4EF6;</span><br><span class="line">            fileList = mMediaProvider.query(mPackageName, mFilesUri, <span class="type">FILES_PRESCAN_PROJECTION</span>,</span><br><span class="line">                    <span class="string">&quot;media_type=2&quot;</span>, null, null, null);</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">iterator</span>.hasNext()) {</span><br><span class="line">                <span class="type">FileEntry</span> entry = <span class="keyword">iterator</span>.next();</span><br><span class="line">                // only process playlist files <span class="keyword">if</span> they are new <span class="keyword">or</span> have been modified since the last scan</span><br><span class="line">                // &#x53EA;&#x5904;&#x7406;&#x6700;&#x65B0;&#x7684;&#x548C;&#x4E0A;&#x6B21;&#x626B;&#x63CF;&#x4EE5;&#x540E;&#x4FEE;&#x6539;&#x540E;&#x7684;&#x64AD;&#x653E;&#x5217;&#x8868;&#x6587;&#x4EF6;</span><br><span class="line">                <span class="keyword">if</span> (entry.mLastModifiedChanged) {</span><br><span class="line">                    processPlayList(entry, fileList);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        } catch (<span class="type">RemoteException</span> e1) {</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            <span class="keyword">if</span> (fileList != null) {</span><br><span class="line">                fileList.close();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>
<p>&#x6211;&#x4EEC;&#x770B;&#x4E0B;&#x5BF9;&#x6BCF;&#x4E2A;&#x64AD;&#x653E;&#x5217;&#x8868;&#x662F;&#x600E;&#x4E48;&#x5904;&#x7406;&#x7684;&#xFF0C;&#x5728;&#x5904;&#x7406;&#x524D;&#x5FC5;&#x987B;&#x786E;&#x4FDD;&#x6709;&#x4E00;&#x4E2A;&#x64AD;&#x653E;&#x5217;&#x8868;&#x7684;&#x540D;&#x5B57;&#xFF0C;&#x9996;&#x5148;&#x901A;&#x8FC7;&#x67E5;&#x627E;MediaStore.Audio.Playlists.NAME&#x5BF9;&#x5E94;&#x7684;&#x503C;&#xFF0C;&#x770B;&#x4E0B;&#x662F;&#x5426;&#x5B58;&#x5728;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x5B58;&#x5728;&#x5219;&#x4ECE;MediaStore.MediaColumns.TITLE&#x4E2D;&#x83B7;&#x53D6;&#xFF0C;&#x5982;&#x679C;&#x8FD8;&#x662F;&#x6CA1;&#x6709;&#x503C;&#xFF0C;&#x5C31;&#x518D;&#x5C1D;&#x8BD5;&#x4ECE;&#x6587;&#x4EF6;&#x540D;&#x4E2D;&#x83B7;&#x53D6;&#x3002;&#x5982;&#x679C;&#x5F53;&#x524D;&#x7684;&#x64AD;&#x653E;&#x5217;&#x8868;&#x662F;&#x65B0;&#x589E;&#x7684;&#x5219;&#x5F80;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x63D2;&#x5165;&#x65B0;&#x7684;&#x64AD;&#x653E;&#x5217;&#x8868;&#x4FE1;&#x606F;&#xFF0C;&#x5E76;&#x83B7;&#x53D6;&#x64AD;&#x653E;&#x5217;&#x8868;&#x6210;&#x5458;&#x7684;Uri&#xFF0C;&#x5982;&#x679C;&#x5F53;&#x524D;&#x64AD;&#x653E;&#x5217;&#x8868;&#x5B58;&#x5728;&#x7684;&#x8BDD;&#x5C31;&#x66F4;&#x65B0;&#x5176;&#x5185;&#x5BB9;&#x5E76;&#x4E14;&#x5220;&#x9664;&#x539F;&#x6765;&#x7684;member Uri&#x3002;&#x6700;&#x540E;&#x83B7;&#x53D6;&#x64AD;&#x653E;&#x5217;&#x8868;&#x6587;&#x4EF6;&#x7684;&#x7C7B;&#x578B;&#xFF0C;&#x6839;&#x636E;&#x4E0D;&#x540C;&#x7684;&#x6587;&#x4EF6;&#x7C7B;&#x578B;&#x8C03;&#x7528;&#x4E0D;&#x540C;&#x7684;&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x4E0D;&#x540C;&#x7684;&#x65B9;&#x6CD5;&#x5904;&#x7406;&#x3002;<br><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">private <span class="keyword">void</span> processPlayList(FileEntry entry, Cursor fileList) throws RemoteException {</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">String</span> path = entry.mPath;</span><br><span class="line">    ContentValues values = <span class="keyword">new</span> ContentValues();</span><br><span class="line">    <span class="built_in">int</span> lastSlash = path.lastIndexOf(<span class="string">&apos;/&apos;</span>);</span><br><span class="line">    <span class="keyword">if</span> (lastSlash &lt; <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;bad path &quot;</span> + path);</span><br><span class="line">    <span class="built_in">Uri</span> uri, membersUri;</span><br><span class="line">    <span class="comment">//&#x4ECE;FileEnty&#x4E2D;&#x83B7;&#x53D6;rowId</span></span><br><span class="line">    long rowId = entry.mRowId;</span><br><span class="line">    <span class="comment">// &#x786E;&#x4FDD;&#x6709;&#x4E00;&#x4E2A;&#x64AD;&#x653E;&#x5217;&#x8868;&#x540D;&#x5B57;&#xFF0C;&#x9996;&#x5148;&#x67E5;&#x770B;MediaStore.Audio.Playlists.NAME</span></span><br><span class="line">    <span class="comment">// &#x518D;&#x67E5;&#x770B;MediaStore.MediaColumns.TITLE &#x5982;&#x679C;&#x8FD8;&#x662F;&#x4E3A;&#x7A7A;&#x5219;&#x83B7;&#x53D6;&#x6700;&#x540E;&#x7684;.&#x540E;&#x9762;&#x7684;&#x5B57;&#x7B26;</span></span><br><span class="line">    <span class="built_in">String</span> name = values.getAsString(MediaStore.Audio.Playlists.NAME);</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="keyword">null</span>) {</span><br><span class="line">        name = values.getAsString(MediaStore.MediaColumns.TITLE);</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="comment">// &#x4ECE;&#x6587;&#x4EF6;&#x4E2D;&#x83B7;&#x53D6;&#x64AD;&#x653E;&#x5217;&#x8868;&#x540D;&#x5B57;</span></span><br><span class="line">            <span class="built_in">int</span> lastDot = path.lastIndexOf(<span class="string">&apos;.&apos;</span>);</span><br><span class="line">            name = (lastDot &lt; <span class="number">0</span> ? path.substring(lastSlash + <span class="number">1</span>): </span><br><span class="line">                   path.substring(lastSlash + <span class="number">1</span>, lastDot));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//&#x5C06;&#x64AD;&#x653E;&#x5217;&#x8868;&#x7684;&#x540D;&#x5B57;&#x548C;&#x4FEE;&#x6539;&#x65F6;&#x95F4;&#x6DFB;&#x52A0;&#x5230;&#x6570;&#x636E;&#x5E93;&#x4E2D;</span></span><br><span class="line">    values.put(MediaStore.Audio.Playlists.NAME, name);</span><br><span class="line">    values.put(MediaStore.Audio.Playlists.DATE_MODIFIED, entry.mLastModified);</span><br><span class="line">    <span class="keyword">if</span> (rowId == <span class="number">0</span>) {</span><br><span class="line">        <span class="comment">//&#x5982;&#x679C;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#x8BDD;&#x63D2;&#x5165;&#x65B0;&#x7684;&#x64AD;&#x653E;&#x5217;&#x8868;&#x4FE1;&#x606F;</span></span><br><span class="line">        values.put(MediaStore.Audio.Playlists.DATA, path);</span><br><span class="line">        <span class="comment">//&#x8FD9;&#x65F6;&#x5019;value&#x5305;&#x542B;NAME  DATA  DATE_MODIFIED</span></span><br><span class="line">        uri = mMediaProvider.insert(mPackageName, mPlaylistsUri, values);</span><br><span class="line">        rowId = ContentUris.parseId(uri);</span><br><span class="line">        <span class="comment">//&#x83B7;&#x5F97;&#x63D2;&#x5165;&#x7684;&#x884C;id </span></span><br><span class="line">        <span class="comment">//&#x83B7;&#x5F97;&#x64AD;&#x653E;&#x5217;&#x8868;&#x6210;&#x5458;&#x7684;Uri</span></span><br><span class="line">        membersUri = <span class="built_in">Uri</span>.withAppendedPath(uri, Playlists.Members.CONTENT_DIRECTORY);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">//&#x5982;&#x679C;&#x5B58;&#x5728;&#x7684;&#x8BDD;&#x5C31;&#x66F4;&#x65B0;&#x5E76;&#x4E14;&#x5220;&#x9664;&#x539F;&#x6765;&#x7684;member Uri</span></span><br><span class="line">        uri = ContentUris.withAppendedId(mPlaylistsUri, rowId);</span><br><span class="line">        mMediaProvider.update(mPackageName, uri, values, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        membersUri = <span class="built_in">Uri</span>.withAppendedPath(uri, Playlists.Members.CONTENT_DIRECTORY);</span><br><span class="line">        mMediaProvider.delete(mPackageName, membersUri, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//&#x83B7;&#x53D6;&#x64AD;&#x653E;&#x5217;&#x8868;&#x7684;&#x76EE;&#x5F55;</span></span><br><span class="line">    <span class="built_in">String</span> playListDirectory = path.substring(<span class="number">0</span>, lastSlash + <span class="number">1</span>);</span><br><span class="line">    <span class="comment">//&#x83B7;&#x53D6;&#x64AD;&#x653E;&#x5217;&#x8868;&#x7684;&#x6587;&#x4EF6;&#x7C7B;&#x578B;</span></span><br><span class="line">    MediaFile.MediaFileType mediaFileType = MediaFile.getFileType(path);</span><br><span class="line">    <span class="built_in">int</span> fileType = (mediaFileType == <span class="keyword">null</span> ? <span class="number">0</span> : mediaFileType.fileType);</span><br><span class="line">    <span class="comment">//&#x6839;&#x636E;&#x4E0D;&#x540C;&#x7684;&#x6587;&#x4EF6;&#x7C7B;&#x578B;&#x8C03;&#x7528;&#x4E0D;&#x540C;&#x7684;&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x4E0D;&#x540C;&#x7684;&#x65B9;&#x6CD5;&#x5904;&#x7406;</span></span><br><span class="line">    <span class="keyword">if</span> (fileType == MediaFile.FILE_TYPE_M3U) {</span><br><span class="line">        processM3uPlayList(path, playListDirectory, membersUri, values, fileList);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (fileType == MediaFile.FILE_TYPE_PLS) {</span><br><span class="line">        processPlsPlayList(path, playListDirectory, membersUri, values, fileList);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (fileType == MediaFile.FILE_TYPE_WPL) {</span><br><span class="line">        processWplPlayList(path, playListDirectory, membersUri, values, fileList);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x5982;&#x679C;&#x662F;M3U&#x64AD;&#x653E;&#x5217;&#x8868;&#xFF1A;&#x5219;&#x8C03;&#x7528;processM3uPlayList&#x65B9;&#x6CD5;&#x5904;&#x7406;&#xFF1A;<br>&#x5728;processM3uPlayList&#x65B9;&#x6CD5;&#x6253;&#x5F00;&#x64AD;&#x653E;&#x5217;&#x8868;&#x6587;&#x4EF6;&#xFF0C;&#x5E76;&#x8BFB;&#x53D6;&#x64AD;&#x653E;&#x5217;&#x8868;&#x5185;&#x5BB9;&#xFF0C;&#x5C06;&#x8BFB;&#x53D6;&#x5230;&#x7684;&#x64AD;&#x653E;&#x5217;&#x8868;&#x6210;&#x5458;&#x8BB0;&#x5F55;&#x6DFB;&#x52A0;&#x5230;mPlsylist&#x961F;&#x5217;&#x4E2D;&#x8C03;&#x7528;processCachedPlaylist&#x5904;&#x7406;&#x3002;<br><figure class="highlight processing"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> processM3uPlayList(<span class="keyword">String</span> path, <span class="keyword">String</span> playListDirectory, Uri uri,</span><br><span class="line">        ContentValues values, Cursor fileList) {</span><br><span class="line">    <span class="keyword">BufferedReader</span> reader = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        File f = <span class="keyword">new</span> File(path);</span><br><span class="line">        <span class="comment">//&#x5224;&#x65AD;&#x64AD;&#x653E;&#x5217;&#x8868;&#x6587;&#x4EF6;&#x662F;&#x5426;&#x5B58;&#x5728;&#xFF0C;&#x5982;&#x679C;&#x5B58;&#x5728;&#x5219;&#x8C03;&#x7528;cachePlaylistEntry</span></span><br><span class="line">        <span class="comment">//&#x8BFB;&#x53D6;&#x540E;&#x6DFB;&#x52A0;&#x5230;mPlsylist&#x961F;&#x5217;&#x4E2D;&#x8C03;&#x7528;processCachedPlaylist&#x5904;&#x7406;</span></span><br><span class="line">        <span class="keyword">if</span> (f.exists()) {</span><br><span class="line">            reader = <span class="keyword">new</span> <span class="keyword">BufferedReader</span>(<span class="keyword">new</span> InputStreamReader(<span class="keyword">new</span> FileInputStream(f)), </span><br><span class="line">            <span class="number">8192</span>);</span><br><span class="line">            <span class="keyword">String</span> <span class="built_in">line</span> = reader.readLine();</span><br><span class="line">            <span class="comment">//&#x6E05;&#x9664;&#x64AD;&#x653E;&#x5217;&#x8868;&#x7F13;&#x51B2;&#x5217;&#x8868;</span></span><br><span class="line">            mPlaylistEntries.<span class="built_in">clear</span>();</span><br><span class="line">            <span class="keyword">while</span> (<span class="built_in">line</span> != <span class="keyword">null</span>) {</span><br><span class="line">                <span class="comment">// &#x5FFD;&#x7565;&#x6CE8;&#x91CA;&#x884C;</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">line</span>.length() &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">line</span>.charAt(<span class="number">0</span>) != <span class="string">&apos;#&apos;</span>) {</span><br><span class="line">                    <span class="comment">//&#x5982;&#x679C;&#x4E0D;&#x662F;&#x6CE8;&#x91CA;&#x884C;&#xFF0C;&#x5219;&#x8868;&#x793A;&#x4E3A;&#x64AD;&#x653E;&#x5217;&#x8868;&#x4FE1;&#x606F;&#xFF0C;&#x5219;&#x5C06;&#x5176;&#x5904;&#x7406;&#x540E;&#x6DFB;&#x52A0;&#x5230;mPlsylist&#x961F;&#x5217;&#x4E2D;</span></span><br><span class="line">                    cachePlaylistEntry(<span class="built_in">line</span>, playListDirectory);</span><br><span class="line">                }</span><br><span class="line">                <span class="built_in">line</span> = reader.readLine();</span><br><span class="line">            }</span><br><span class="line">            processCachedPlaylist(fileList, values, uri);</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">if</span> (reader != <span class="keyword">null</span>)</span><br><span class="line">                reader.close();</span><br><span class="line">        } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x5982;&#x679C;&#x662F;PLS&#x683C;&#x5F0F;&#x7684;&#x64AD;&#x653E;&#x5217;&#x8868;&#x5219;&#x5C06;&#x5305;&#x542B;&#x201C;File = &#x201D;&#x5F00;&#x5934;&#x7684;&#x884C;&#xFF0C;&#x5219;&#x5C06;&#x7B49;&#x53F7;&#x540E;&#x9762;&#x7684;&#x5185;&#x5BB9;&#x8BFB;&#x53D6;&#x51FA;&#x6765;&#xFF08;&#x8FD9;&#x4E9B;&#x5C31;&#x662F;&#x64AD;&#x653E;&#x5217;&#x8868;&#x6210;&#x5458;&#x7684;&#x8BB0;&#x5F55;&#xFF09;&#x5E76;&#x5B58;&#x50A8;&#x5230;mPlsylist&#x4E2D;&#xFF0C;&#x5E76;&#x8C03;&#x7528;processCachedPlaylist&#x8FDB;&#x884C;&#x5904;&#x7406;&#x3002;<br><figure class="highlight processing"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> processPlsPlayList(<span class="keyword">String</span> path, <span class="keyword">String</span> playListDirectory, Uri uri,</span><br><span class="line">    ContentValues values, Cursor fileList) {</span><br><span class="line">    <span class="keyword">BufferedReader</span> reader = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        File f = <span class="keyword">new</span> File(path);</span><br><span class="line">        <span class="keyword">if</span> (f.exists()) {</span><br><span class="line">            reader = <span class="keyword">new</span> <span class="keyword">BufferedReader</span>(</span><br><span class="line">            <span class="keyword">new</span> InputStreamReader(<span class="keyword">new</span> FileInputStream(f)), <span class="number">8192</span>);</span><br><span class="line">            <span class="keyword">String</span> <span class="built_in">line</span> = reader.readLine();</span><br><span class="line">            mPlaylistEntries.<span class="built_in">clear</span>();</span><br><span class="line">            <span class="keyword">while</span> (<span class="built_in">line</span> != <span class="keyword">null</span>) {</span><br><span class="line">                <span class="comment">//&#x5982;&#x679C;&#x662F;File&#x5F00;&#x5934;&#x7684;&#x884C;&#x5219;&#x8868;&#x793A;&#x662F;PLS&#x683C;&#x5F0F;&#x7684;&#x64AD;&#x653E;&#x5217;&#x8868;&#x4FE1;&#x606F;</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">line</span>.startsWith(<span class="string">&quot;File&quot;</span>)) {</span><br><span class="line">                    <span class="built_in">int</span> equals = <span class="built_in">line</span>.indexOf(<span class="string">&apos;=&apos;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (equals &gt; <span class="number">0</span>) {</span><br><span class="line">             <span class="comment">//&#x5C06;=&#x540E;&#x9762;&#x7684;&#x5185;&#x5BB9;&#x6DFB;&#x52A0;&#x5230;mPlsylist&#x4E2D;&#xFF0C;&#x8C03;&#x7528;processCachedPlaylist&#x8FDB;&#x884C;&#x5904;&#x7406;</span></span><br><span class="line">                        cachePlaylistEntry(<span class="built_in">line</span>.substring(equals + <span class="number">1</span>), playListDirectory);</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">                <span class="built_in">line</span> = reader.readLine();</span><br><span class="line">            }</span><br><span class="line">            processCachedPlaylist(fileList, values, uri);</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">if</span> (reader != <span class="keyword">null</span>)</span><br><span class="line">                reader.close();</span><br><span class="line">        } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line"></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x5982;&#x679C;&#x662F;WPL&#x683C;&#x5F0F;&#x7684;&#x64AD;&#x653E;&#x5217;&#x8868;&#x6587;&#x4EF6;&#x5219;&#x4F7F;&#x7528;Xml&#x89E3;&#x6790;&#x5668;&#x5BF9;&#x5176;&#x8FDB;&#x884C;&#x89E3;&#x6790;&#x3002;&#x540C;&#x6837;&#x6700;&#x540E;&#x4E5F;&#x662F;&#x8C03;&#x7528;processCachedPlaylist&#x5BF9;&#x5176;&#x4E2D;&#x7684;&#x64AD;&#x653E;&#x5217;&#x8868;&#x8FDB;&#x884C;&#x5904;&#x7406;&#x3002;<br><figure class="highlight processing"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> processWplPlayList(<span class="keyword">String</span> path, <span class="keyword">String</span> playListDirectory, Uri uri,</span><br><span class="line">        ContentValues values, Cursor fileList) {</span><br><span class="line">    Xlog.i(TAG,<span class="string">&quot;MediaScanner#processWplPlayList()&quot;</span>);</span><br><span class="line">    FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        File f = <span class="keyword">new</span> File(path);</span><br><span class="line">        <span class="keyword">if</span> (f.exists()) {</span><br><span class="line">            fis = <span class="keyword">new</span> FileInputStream(f);</span><br><span class="line">            mPlaylistEntries.<span class="built_in">clear</span>();</span><br><span class="line">            Xml.parse(fis, Xml.findEncodingByName(<span class="string">&quot;UTF-8&quot;</span>),</span><br><span class="line">                    <span class="keyword">new</span> WplHandler(playListDirectory, uri, fileList).getContentHandler());</span><br><span class="line">            processCachedPlaylist(fileList, values, uri);</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (SAXException e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">if</span> (fis != <span class="keyword">null</span>)</span><br><span class="line">                fis.close();</span><br><span class="line">        } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">            Xlog.e(TAG, <span class="string">&quot;IOException in MediaScanner.processWplPlayList()&quot;</span>, e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>cachePlaylistEntry&#x8D1F;&#x8D23;&#x8BB2;&#x4ECE;&#x64AD;&#x653E;&#x5217;&#x8868;&#x6587;&#x4EF6;&#x4E2D;&#x8BFB;&#x53D6;&#x5230;&#x7684;&#x64AD;&#x653E;&#x5217;&#x8868;&#x884C;&#x8FDB;&#x884C;&#x5904;&#x7406;&#x540E;&#x6DFB;&#x52A0;&#x5230;mPlaylistEntries&#x4E2D;&#x3002;<br><figure class="highlight processing"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> cachePlaylistEntry(<span class="keyword">String</span> <span class="built_in">line</span>, <span class="keyword">String</span> playListDirectory) {</span><br><span class="line">    PlaylistEntry entry = <span class="keyword">new</span> PlaylistEntry();</span><br><span class="line">    <span class="comment">// &#x53BB;&#x9664;&#x5C3E;&#x90E8;&#x7684;&#x7A7A;&#x767D;&#x7B26;</span></span><br><span class="line">    <span class="built_in">int</span> entryLength = <span class="built_in">line</span>.length();</span><br><span class="line">    <span class="keyword">while</span> (entryLength &gt; <span class="number">0</span> &amp;&amp; Character.isWhitespace(<span class="built_in">line</span>.charAt(entryLength - <span class="number">1</span>))) entryLength--;</span><br><span class="line">    <span class="keyword">if</span> (entryLength &lt; <span class="number">3</span>) <span class="keyword">return</span>;<span class="comment">//&#x5982;&#x679C;&#x5C0F;&#x4E8E;&#x4E09;&#x4E2A;&#x5B57;&#x7B26;&#x5219;&#x4E0D;&#x5408;&#x6CD5;</span></span><br><span class="line">    <span class="keyword">if</span> (entryLength &lt; <span class="built_in">line</span>.length()) <span class="built_in">line</span> = <span class="built_in">line</span>.substring(<span class="number">0</span>, entryLength);</span><br><span class="line">    <span class="comment">//&#x5982;&#x679C;entryLength&#x5C0F;&#x4E8E;line.length()&#x8868;&#x793A;&#x5C3E;&#x90E8;&#x6709;&#x7A7A;&#x683C;&#x5219;&#x5220;&#x9664;&#x5C3E;&#x90E8;&#x7684;&#x7A7A;&#x767D;&#x7B26;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//&#x5F53;&#x524D;&#x8DEF;&#x5F84;&#x662F;&#x5426;&#x662F;&#x7EDD;&#x5BF9;&#x8DEF;&#x5F84;&#xFF1F;</span></span><br><span class="line">    <span class="built_in">char</span> ch1 = <span class="built_in">line</span>.charAt(<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">boolean</span> fullPath = (ch1 == <span class="string">&apos;/&apos;</span> ||</span><br><span class="line">            (Character.isLetter(ch1) &amp;&amp; <span class="built_in">line</span>.charAt(<span class="number">1</span>) == <span class="string">&apos;:&apos;</span> &amp;&amp; <span class="built_in">line</span>.charAt(<span class="number">2</span>) == <span class="string">&apos;\\&apos;</span>));</span><br><span class="line">    <span class="comment">// &#x5982;&#x679C;&#x662F;&#x4E00;&#x4E2A;&#x76F8;&#x5BF9;&#x8DEF;&#x5F84;&#xFF0C;&#x5219;&#x901A;&#x8FC7;&#x548C;playListDirectory&#x8FDB;&#x884C;&#x5408;&#x5E76;&#x6784;&#x6210;&#x5168;&#x8DEF;&#x5F84;</span></span><br><span class="line">    <span class="keyword">if</span> (!fullPath)</span><br><span class="line">        <span class="built_in">line</span> = playListDirectory + <span class="built_in">line</span>;</span><br><span class="line">    entry.path = <span class="built_in">line</span>;</span><br><span class="line">    <span class="comment">// &#x5C06;&#x5168;&#x8DEF;&#x5F84;&#x4FDD;&#x5B58;&#x5230;mPlaylistEntries</span></span><br><span class="line">    mPlaylistEntries.<span class="built_in">add</span>(entry);</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>processCachedPlaylist&#x65B9;&#x6CD5;&#x4E2D;&#x5C06;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x5168;&#x90E8;&#x97F3;&#x9891;&#x6587;&#x4EF6;&#x6570;&#x636E;&#x4E0E;&#x5B58;&#x50A8;&#x5728;mPlaylistEntries&#x7684;&#x5F53;&#x524D;&#x64AD;&#x653E;&#x5217;&#x8868;&#x7684;&#x6210;&#x5458;&#x6B4C;&#x66F2;&#x8BB0;&#x5F55;&#x8FDB;&#x884C;&#x5339;&#x914D;&#xFF0C;&#x5339;&#x914D;&#x8FC7;&#x7A0B;&#x662F;&#x8C03;&#x7528;matchEntries&#x65B9;&#x6CD5;&#x6765;&#x5B8C;&#x6210;&#x7684;&#xFF0C;&#x5B83;&#x4F1A;&#x4F7F;&#x7528;&#x5168;&#x90E8;&#x97F3;&#x9891;&#x6587;&#x4EF6;&#x4E0E;mPlaylistEntries&#x4E2D;&#x672A;&#x5339;&#x914D;&#x7684;&#x9879;&#x8FDB;&#x884C;&#x5BF9;&#x6BD4;&#xFF0C;&#x5982;&#x679C;&#x8DEF;&#x5F84;&#x76F8;&#x540C;&#x5219;&#x8BA4;&#x4E3A;&#x627E;&#x5230;&#x5339;&#x914D;&#x7684;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x5B8C;&#x5168;&#x4E00;&#x81F4;&#x5C31;&#x901A;&#x8FC7;&#x5BF9;&#x6BD4;&#x8DEF;&#x5F84;&#x7684;&#x5404;&#x4E2A;&#x90E8;&#x5206;&#xFF0C;&#x5BFB;&#x627E;&#x6700;&#x5339;&#x914D;&#x7684;&#x90A3;&#x4E2A;&#x3002; &#x5982;&#x679C;mPlaylistEntries&#x4E2D;&#x5168;&#x90E8;&#x9879;&#x90FD;&#x5339;&#x914D;&#x4E86;&#xFF0C;&#x5219;&#x8FD4;&#x56DE;true&#x3002;&#x6700;&#x540E;&#x5C06;mPlaylistEntries&#x4E2D;&#x7684;&#x6210;&#x5458;&#x4F5C;&#x4E3A;&#x5F53;&#x524D;&#x64AD;&#x653E;&#x5217;&#x8868;&#x7684;playlist member&#x6DFB;&#x52A0;&#x5230;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x3002;<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processCachedPlaylist</span><span class="params">(Cursor fileList, ContentValues values, Uri playlistUri)</span> </span>{</span><br><span class="line">    fileList.moveToPosition(-<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">while</span> (fileList.moveToNext()) {</span><br><span class="line">        <span class="keyword">long</span> rowId = fileList.getLong(FILES_PRESCAN_ID_COLUMN_INDEX);</span><br><span class="line">        String data = fileList.getString(FILES_PRESCAN_PATH_COLUMN_INDEX);</span><br><span class="line">        <span class="comment">// mPlaylistEntries&#x4E2D;&#x5168;&#x90E8;&#x9879;&#x90FD;&#x5339;&#x914D;&#x4E86;</span></span><br><span class="line">        <span class="keyword">if</span> (matchEntries(rowId, data)) {</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">int</span> len = mPlaylistEntries.size();</span><br><span class="line">    <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) {</span><br><span class="line">        PlaylistEntry entry = mPlaylistEntries.get(i);</span><br><span class="line">        <span class="keyword">if</span> (entry.bestmatchlevel &gt; <span class="number">0</span>) {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="comment">//&#x5C06;mPlaylistEntries&#x4E2D;&#x7684;&#x6210;&#x5458;&#x4F5C;&#x4E3A;&#x5F53;&#x524D;&#x64AD;&#x653E;&#x5217;&#x8868;&#x7684;playlist member</span></span><br><span class="line">                <span class="comment">//&#x6DFB;&#x52A0;&#x5230;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x3002;</span></span><br><span class="line">                values.clear();</span><br><span class="line">                values.put(MediaStore.Audio.Playlists.Members.PLAY_ORDER, </span><br><span class="line">                Integer.valueOf(index));</span><br><span class="line">                values.put(MediaStore.Audio.Playlists.Members.AUDIO_ID, </span><br><span class="line">                Long.valueOf(entry.bestmatchid));</span><br><span class="line">                mMediaProvider.insert(mPackageName, playlistUri, values);</span><br><span class="line">                index++;</span><br><span class="line">            } <span class="keyword">catch</span> (RemoteException e) {</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">}</span><br><span class="line">    mPlaylistEntries.clear();</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<figure class="highlight armasm"><table><tr><td class="code"><pre><span class="line"><span class="label">private</span> <span class="keyword">boolean </span>matchEntries(long rowId, <span class="keyword">String </span><span class="preprocessor">data</span>) {</span><br><span class="line">    </span><br><span class="line">    int len = mPlaylistEntries.size()<span class="comment">;</span></span><br><span class="line">    <span class="keyword">boolean </span>done = true<span class="comment">;</span></span><br><span class="line">    for (int i = <span class="number">0</span><span class="comment">; i &lt; len; i++) {</span></span><br><span class="line">        PlaylistEntry <span class="preprocessor">entry</span> = mPlaylistEntries.get(i)<span class="comment">;</span></span><br><span class="line">        //&#x5982;&#x679C;<span class="preprocessor">entry</span>.<span class="keyword">bestmatchlevel </span>== Integer.MAX_VALUE &#x5219;&#x8868;&#x793A;&#x5DF2;&#x7ECF;&#x88AB;&#x5339;&#x914D;&#x4E86;</span><br><span class="line">        //&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#x5C06;&#x5F53;&#x524D;&#x7684;&#x4E0E;mPlaylistEntries&#x7684;&#x8FDB;&#x884C;&#x6BD4;&#x8F83;</span><br><span class="line">        <span class="preprocessor">if</span> (<span class="preprocessor">entry</span>.<span class="keyword">bestmatchlevel </span>== Integer.MAX_VALUE) {</span><br><span class="line">            continue<span class="comment">; </span></span><br><span class="line">        }</span><br><span class="line">        //&#x5F00;&#x59CB;&#x6BD4;&#x8F83;&#x7684;&#x65F6;&#x5019;&#x5148;&#x5C06;done&#x7F6E;&#x4E3A;false</span><br><span class="line">        done = false<span class="comment">;</span></span><br><span class="line">        //<span class="preprocessor">data</span>&#x5B57;&#x6BB5;&#x5DF2;&#x7ECF;&#x5339;&#x914D;&#x4E0D;&#x9700;&#x8981;&#x8FDB;&#x884C;&#x8DEF;&#x5F84;&#x5339;&#x914D;&#x4E86;</span><br><span class="line">        <span class="preprocessor">if</span> (<span class="preprocessor">data</span>.equalsIgnoreCase(<span class="preprocessor">entry</span>.path)) {</span><br><span class="line">            <span class="preprocessor">entry</span>.<span class="keyword">bestmatchid </span>= rowId<span class="comment">;</span></span><br><span class="line">            <span class="preprocessor">entry</span>.<span class="keyword">bestmatchlevel </span>= Integer.MAX_VALUE<span class="comment">;</span></span><br><span class="line">            continue<span class="comment">; </span></span><br><span class="line">        }</span><br><span class="line">        //&#x901A;&#x8FC7;&#x6BD4;&#x5BF9;&#x8DEF;&#x5F84;&#x7684;&#x6BCF;&#x4E2A;&#x5B57;&#x6BB5;&#x5BFB;&#x627E;&#x6700;&#x6BD4;&#x914D;&#x7684;&#x90A3;&#x4E2A;&#x64AD;&#x653E;&#x5217;&#x8868;</span><br><span class="line">        int matchLength = matchPaths(<span class="preprocessor">data</span>, <span class="preprocessor">entry</span>.path)<span class="comment">;</span></span><br><span class="line">        <span class="preprocessor">if</span> (matchLength &gt; <span class="preprocessor">entry</span>.<span class="keyword">bestmatchlevel) </span>{</span><br><span class="line">            <span class="preprocessor">entry</span>.<span class="keyword">bestmatchid </span>= rowId<span class="comment">;</span></span><br><span class="line">            <span class="preprocessor">entry</span>.<span class="keyword">bestmatchlevel </span>= matchLength<span class="comment">;</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    return done<span class="comment">;</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x603B;&#x7ED3;&#x4EE5;&#x4E0B;&#xFF0C;&#x64AD;&#x653E;&#x5217;&#x8868;&#x7684;&#x5904;&#x7406;&#x662F;&#x5C06;&#x64AD;&#x653E;&#x5217;&#x8868;&#x6587;&#x4EF6;&#x8FDB;&#x884C;&#x89E3;&#x6790;&#xFF0C;&#x7136;&#x540E;&#x5C06;&#x64AD;&#x653E;&#x5217;&#x8868;&#x6587;&#x4EF6;&#x4E2D;&#x7684;&#x6210;&#x5458;&#x6DFB;&#x52A0;&#x5230;&#x4E00;&#x4E2A;&#x5BB9;&#x5668;&#x4E2D;&#xFF0C;&#x7136;&#x540E;&#x5BF9;&#x5BB9;&#x5668;&#x8FDB;&#x884C;&#x904D;&#x5386;&#xFF0C;&#x5E76;&#x5728;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x5BF9;&#x5176;&#x8FDB;&#x884C;&#x5339;&#x914D;&#xFF0C;&#x5982;&#x679C;&#x5339;&#x914D;&#x5219;&#x6DFB;&#x52A0;&#x5230;Playlist Member&#x4E2D;</p>
<h4 id="&#x7F29;&#x7565;&#x56FE;&#x5904;&#x7406;&#xFF1A;"><a href="#&#x7F29;&#x7565;&#x56FE;&#x5904;&#x7406;&#xFF1A;" class="headerlink" title="&#x7F29;&#x7565;&#x56FE;&#x5904;&#x7406;&#xFF1A;"></a>&#x7F29;&#x7565;&#x56FE;&#x5904;&#x7406;&#xFF1A;</h4><p>&#x5728;MediaScanner&#x4E2D;&#x5BF9;&#x7F29;&#x7565;&#x56FE;&#x5904;&#x7406;&#x4E5F;&#x662F;&#x4F4D;&#x4E8E;Postscan&#x65B9;&#x6CD5;&#x4E2D;&#x3002;&#x5728;pruneDeadThumbnailFiles&#x65B9;&#x6CD5;&#x4E2D;&#x5148;&#x83B7;&#x53D6;DCIM/thumbnails&#x76EE;&#x5F55;&#x4E0B;&#x7684;&#x6240;&#x6709;&#x6587;&#x4EF6;&#x5217;&#x8868;&#xFF0C;&#x5728;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x5939;&#x4E0B;&#x5B58;&#x653E;&#x7684;&#x662F;&#x6240;&#x6709;&#x7684;&#x7F29;&#x7565;&#x56FE;&#xFF0C;&#x800C;&#x540E;&#x518D;&#x67E5;&#x770B;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x7684;&#x89C6;&#x9891;&#x548C;&#x56FE;&#x50CF;&#x7684;&#x7F29;&#x7565;&#x56FE;&#x4FE1;&#x606F;&#xFF0C;&#x5982;&#x679C;&#x5728;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x5B58;&#x5728;&#x8BE5;&#x8BB0;&#x5F55;&#x5219;&#x8868;&#x793A;&#x8BE5;&#x7F29;&#x7565;&#x56FE;&#x6709;&#x7528;&#xFF0C;&#x4ECE;existingFiles&#x4E2D;&#x79FB;&#x9664;&#xFF0C;&#x5230;&#x6700;&#x540E;existingFiles&#x4E2D;&#x5269;&#x4F59;&#x7684;&#x5C31;&#x662F;&#x90A3;&#x4E9B;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x4E0D;&#x9700;&#x8981;&#x7684;&#x7F29;&#x7565;&#x56FE;&#x4E86;&#xFF0C;&#x8FD9;&#x4E9B;&#x4E0D;&#x9700;&#x8981;&#x7684;&#x7F29;&#x7565;&#x56FE;&#x53EF;&#x4EE5;&#x4ECE;DCIM/.thumbnails&#x4E2D;&#x5220;&#x9664;&#xFF0C;&#x6700;&#x540E;&#x5220;&#x9664;Mini &#x7F29;&#x7565;&#x56FE;&#x6587;&#x4EF6;&#x3002;<br><figure class="highlight processing"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> pruneDeadThumbnailFiles() {</span><br><span class="line">    HashSet&lt;<span class="keyword">String</span>&gt; existingFiles = <span class="keyword">new</span> HashSet&lt;<span class="keyword">String</span>&gt;();</span><br><span class="line">    <span class="keyword">String</span> directory = <span class="string">&quot;/sdcard/DCIM/.thumbnails&quot;</span>;</span><br><span class="line">    <span class="keyword">String</span> [] files = (<span class="keyword">new</span> File(directory)).list();</span><br><span class="line">    Cursor c = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (files == <span class="keyword">null</span>)</span><br><span class="line">        files = <span class="keyword">new</span> <span class="keyword">String</span>[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; files.length; i++) {</span><br><span class="line">        <span class="keyword">String</span> fullPathString = directory + <span class="string">&quot;/&quot;</span> + files[i];</span><br><span class="line">        existingFiles.<span class="built_in">add</span>(fullPathString);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        c = mMediaProvider.query(</span><br><span class="line">                mPackageName,</span><br><span class="line">                mThumbsUri,</span><br><span class="line">                <span class="keyword">new</span> <span class="keyword">String</span> [] { <span class="string">&quot;_data&quot;</span> },</span><br><span class="line">                <span class="keyword">null</span>,</span><br><span class="line">                <span class="keyword">null</span>,</span><br><span class="line">                <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        Log.v(TAG, <span class="string">&quot;pruneDeadThumbnailFiles... &quot;</span> + c);</span><br><span class="line">        <span class="keyword">if</span> (c != <span class="keyword">null</span> &amp;&amp; c.moveToFirst()) {</span><br><span class="line">            do {</span><br><span class="line">                <span class="keyword">String</span> fullPathString = c.getString(<span class="number">0</span>);</span><br><span class="line">                existingFiles.remove(fullPathString);</span><br><span class="line">            } <span class="keyword">while</span> (c.moveToNext());</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">String</span> fileToDelete : existingFiles) {</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">false</span>)</span><br><span class="line">                Log.v(TAG, <span class="string">&quot;fileToDelete is &quot;</span> + fileToDelete);</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                (<span class="keyword">new</span> File(fileToDelete)).delete();</span><br><span class="line">            } <span class="keyword">catch</span> (SecurityException ex) {</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        Log.v(TAG, <span class="string">&quot;/pruneDeadThumbnailFiles... &quot;</span> + c);</span><br><span class="line">    } <span class="keyword">catch</span> (RemoteException e) {</span><br><span class="line">        <span class="comment">// We will soon be killed...</span></span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        <span class="keyword">if</span> (c != <span class="keyword">null</span>) {</span><br><span class="line">            c.close();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<h5 id="&#x97F3;&#x9891;&#x89C6;&#x9891;&#x6587;&#x4EF6;&#x5E27;&#x4FE1;&#x606F;&#x7684;&#x83B7;&#x53D6;"><a href="#&#x97F3;&#x9891;&#x89C6;&#x9891;&#x6587;&#x4EF6;&#x5E27;&#x4FE1;&#x606F;&#x7684;&#x83B7;&#x53D6;" class="headerlink" title="&#x97F3;&#x9891;&#x89C6;&#x9891;&#x6587;&#x4EF6;&#x5E27;&#x4FE1;&#x606F;&#x7684;&#x83B7;&#x53D6;"></a>&#x97F3;&#x9891;&#x89C6;&#x9891;&#x6587;&#x4EF6;&#x5E27;&#x4FE1;&#x606F;&#x7684;&#x83B7;&#x53D6;</h5><p>&#x8FD9;&#x90E8;&#x5206;&#x6BD4;&#x8F83;&#x590D;&#x6742;&#x6211;&#x4EEC;&#x5C06;&#x653E;&#x5728;&#x4E0B;&#x4E00;&#x7BC7;&#x535A;&#x5BA2;&#x4E2D;&#x4ECB;&#x7ECD;</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android-源码分析/">Android 源码分析</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/AOSP-源码/">AOSP 源码</a>
  </div>

</div>



<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/07/28/Android-源码分析之MediaScanner/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/07/28/Android-源码分析之MediaScanner/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/07/28/Android-源码分析之Binder/" title="Android-源码分析之Binder" itemprop="url">Android-源码分析之Binder</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Edgar" target="_blank" itemprop="author">Edgar</a>
		
  <p class="article-time">
    <time datetime="2016-07-28T04:30:33.000Z" itemprop="datePublished"> 發表於 2016-07-28</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>&#x4E0B;&#x9762;&#x8FD9;&#x4FE9;&#x5F20;&#x662F;&#x6839;&#x636E;Android&#x6846;&#x67B6;&#x63ED;&#x79D8;&#x6539;&#x7F16;&#xFF0C;&#x8FD9;&#x672C;&#x4E66;&#x5F88;&#x9002;&#x5408;&#x521D;&#x5B66;&#x8005;&#x5FEB;&#x901F;&#x4E86;&#x89E3;&#x6574;&#x4E2A;&#x7CFB;&#x7EDF;&#x7684;&#x5927;&#x4F53;&#x7ED3;&#x6784;&#xFF0C;&#x5F88;&#x5F62;&#x8C61;&#x751F;&#x52A8;&#xFF0C;&#x770B;&#x4EE3;&#x7801;&#x7684;&#x65F6;&#x5019;&#x53EF;&#x4EE5;&#x5BF9;&#x7740;&#x4E0A;&#x9762;&#x7684;&#x56FE;&#x8FDB;&#x884C;&#x9605;&#x8BFB;&#x4F1A;&#x52A0;&#x6DF1;&#x7406;&#x89E3;&#x3002;&#x4E0B;&#x9762;&#x8FD9;&#x4E24;&#x5F20;&#x56FE;&#x5C31;&#x5F53;&#x4F5C;&#x8FD9;&#x7BC7;&#x535A;&#x5BA2;&#x7684;&#x540E;&#x7EED;&#x5199;&#x4F5C;&#x7EB2;&#x8981;&#x5427;&#x3002;&#x8FD9;&#x6BB5;&#x65F6;&#x95F4;&#x6709;&#x70B9;&#x5FD9;&#x3002;&#x53EA;&#x80FD;&#x6709;&#x7A7A;&#x7684;&#x65F6;&#x5019;&#x6784;&#x601D;&#x3002;</p>
<p><img src="/2016/07/28/Android-&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;Binder/1.png" alt=""></p>
<p><img src="/2016/07/28/Android-&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;Binder/2.png" alt=""></p>
<p><img src="/2016/07/28/Android-&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;Binder/3.png" alt=""></p>
<p><img src="/2016/07/28/Android-&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;Binder/4.png" alt=""></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android-源码分析/">Android 源码分析</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/AOSP-源码/">AOSP 源码</a>
  </div>

</div>



<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/07/28/Android-源码分析之Binder/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/07/28/Android-源码分析之Binder/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/07/28/Android-源码分析之AsyncTask/" title="Android-源码分析之AsyncTask" itemprop="url">Android-源码分析之AsyncTask</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Edgar" target="_blank" itemprop="author">Edgar</a>
		
  <p class="article-time">
    <time datetime="2016-07-28T04:28:09.000Z" itemprop="datePublished"> 發表於 2016-07-28</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>&#x5728;&#x4E4B;&#x524D;&#x7684;&#x535A;&#x5BA2;&#x4E2D;&#x5DF2;&#x7ECF;&#x4ECB;&#x7ECD;&#x8FC7;&#x4E86;Handler&#xFF0C;&#x6211;&#x4EEC;&#x77E5;&#x9053;&#x4E3B;&#x7EBF;&#x5176;&#x5B9E;&#x5C31;&#x662F;UI&#x754C;&#x9762;&#x7684;&#x5B88;&#x62A4;&#x8FDB;&#x7A0B;&#x4E00;&#x6837;&#xFF0C;&#x53EA;&#x6709;&#x5B83;&#x624D;&#x80FD;&#x4FEE;&#x6539;UI&#x754C;&#x9762;&#x4E0A;&#x7684;&#x5143;&#x7D20;&#xFF0C;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x5982;&#x679C;&#x8981;&#x66F4;&#x65B0;&#x754C;&#x9762;&#x9700;&#x8981;&#x901A;&#x8FC7;&#x4E3B;&#x7EBF;&#x7A0B;&#x7684;Handler&#x6765;&#x66F4;&#x65B0;&#xFF0C;&#x540E;&#x6765;&#x4E3A;&#x4E86;&#x66F4;&#x52A0;&#x65B9;&#x4FBF;&#x6211;&#x4EEC;&#x5728;&#x5B50;&#x7EBF;&#x7A0B;&#x4E2D;&#x66F4;&#x65B0;UI&#x5143;&#x7D20;&#xFF0C;Android&#x5F15;&#x5165;&#x4E86;&#x4E00;&#x4E2A;AsyncTask&#x7C7B;&#xFF0C;&#x901A;&#x8FC7;&#x5B83;&#x53EF;&#x4EE5;&#x5F88;&#x65B9;&#x4FBF;&#x5730;&#x5728;&#x540E;&#x53F0;&#x7EBF;&#x7A0B;&#x548C;UI&#x7EBF;&#x7A0B;&#x4E4B;&#x95F4;&#x8FDB;&#x884C;&#x5207;&#x6362;&#x3002;&#x6781;&#x5927;&#x5F97;&#x7B80;&#x4FBF;&#x4E86;&#x6211;&#x4EEC;&#x7684;&#x65E5;&#x5E38;&#x5F00;&#x53D1;&#x3002;</p>
<figure class="highlight crystal"><table><tr><td class="code"><pre><span class="line">public <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncTask</span><span class="inheritance">&lt;<span class="parent">Params</span></span>, <span class="title">Progress</span>, <span class="title">Result</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>AsyncTask&#x662F;&#x4E00;&#x4E2A;&#x62BD;&#x8C61;&#x7C7B;&#xFF0C;&#x5982;&#x679C;&#x8981;&#x4F7F;&#x7528;&#x9700;&#x8981;&#x7EE7;&#x627F;&#x8FD9;&#x4E2A;&#x7C7B;&#xFF0C;&#x8FD9;&#x91CC;&#x9700;&#x8981;&#x518D;&#x63D0;&#x4E0B;&#x8FD9;&#x4E09;&#x4E2A;&#x53C2;&#x6570;&#x7684;&#x542B;&#x4E49;&#xFF1A;</p>
<ul>
<li>Params &#x8868;&#x793A;&#x5728;&#x542F;&#x52A8;AsyncTask&#x65F6;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;&#x5728;&#x540E;&#x53F0;&#x4EFB;&#x52A1;&#x4E2D;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x4F5C;&#x4E3A;&#x8F93;&#x5165;&#x6570;&#x636E;&#x3002;&#x5982;&#x679C;&#x4E0D;&#x9700;&#x8981;&#x4EFB;&#x4F55;&#x53C2;&#x6570;&#x5219;&#x53EF;&#x4EE5;&#x4F20;&#x5165;Void</li>
<li>Progress &#x7528;&#x4E8E;&#x5728;&#x540E;&#x53F0;&#x4EFB;&#x52A1;&#x5728;&#x6267;&#x884C;&#x65F6;&#x8C03;&#x7528;onProgressUpdate&#x65B9;&#x6CD5;&#x5728;&#x754C;&#x9762;&#x4E0A;&#x663E;&#x793A;&#x5F53;&#x524D;&#x7684;&#x8FDB;&#x5EA6;&#x3002;</li>
<li>Result &#x8868;&#x793A;&#x5F53;&#x524D;&#x540E;&#x53F0;&#x4EFB;&#x52A1;&#x5B8C;&#x6210;&#x540E;&#x7684;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;</li>
</ul>
<p>&#x5177;&#x4F53;&#x7684;&#x7528;&#x6CD5;&#x89C1;Android&#x8FDB;&#x9636;&#x4E4B;&#x591A;&#x7EBF;&#x7A0B;&#x6280;&#x672F;&#x8FD9;&#x7BC7;&#x535A;&#x5BA2;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x518D;&#x4F5C;&#x5C55;&#x5F00;&#x4ECB;&#x7ECD;&#x4E86;&#xFF0C;&#x6211;&#x4EEC;&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x4EE5;&#x4E00;&#x4E2A;&#x573A;&#x666F;&#x6765;&#x5C55;&#x5F00;&#x4ECB;&#x7ECD;</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DownloadAsyncTask</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">AsyncTask&lt;Void</span>, <span class="title">Integer</span>, <span class="title">Boolean&gt;</span> {</span>  </span><br><span class="line">    </span><br><span class="line">    <span class="annotation">@Override</span>  </span><br><span class="line">    <span class="keyword">protected</span> void onPreExecute() {  </span><br><span class="line">        downloadProgressDialog.show();  </span><br><span class="line">    }  </span><br><span class="line">    <span class="annotation">@Override</span>  </span><br><span class="line">    <span class="keyword">protected</span> <span class="type">Boolean</span> doInBackground(<span class="type">Void</span>... params) {  </span><br><span class="line">        <span class="keyword">try</span> {  </span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) {  </span><br><span class="line">                int process = downloadTask();  </span><br><span class="line">                publishProgress(process);  </span><br><span class="line">                <span class="keyword">if</span> (process &gt;= <span class="number">100</span>) {  </span><br><span class="line">                    <span class="keyword">break</span>;  </span><br><span class="line">                }  </span><br><span class="line">            }  </span><br><span class="line">        } <span class="keyword">catch</span> (<span class="type">Exception</span> e) {  </span><br><span class="line">            <span class="type">Log</span>.e(<span class="type">TAG</span>,<span class="string">&quot;There is something error !&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;  </span><br><span class="line">        }  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">    }  </span><br><span class="line">    <span class="annotation">@Override</span>  </span><br><span class="line">    <span class="keyword">protected</span> void onProgressUpdate(<span class="type">Integer</span>... values) {  </span><br><span class="line">        downloadProgressDialog.setMessage(<span class="string">&quot;&#x4E0B;&#x8F7D;&#x8FDB;&#x5EA6;&#xFF1A;&quot;</span> + values[<span class="number">0</span>] + <span class="string">&quot;%&quot;</span>);  </span><br><span class="line">    }  </span><br><span class="line">    </span><br><span class="line">    <span class="annotation">@Override</span>  </span><br><span class="line">    <span class="keyword">protected</span> void onPostExecute(<span class="type">Boolean</span> result) {  </span><br><span class="line">        downloadProgressDialog.dismiss();  </span><br><span class="line">        <span class="keyword">if</span> (result) {  </span><br><span class="line">            <span class="type">Toast</span>.makeText(context, <span class="string">&quot;&#x4E0B;&#x8F7D;&#x6210;&#x529F;&quot;</span>, <span class="type">Toast</span>.<span class="type">LENGTH_SHORT</span>).show();  </span><br><span class="line">        } <span class="keyword">else</span> {  </span><br><span class="line">            <span class="type">Toast</span>.makeText(context, <span class="string">&quot;&#x4E0B;&#x8F7D;&#x5931;&#x8D25;&quot;</span>, <span class="type">Toast</span>.<span class="type">LENGTH_SHORT</span>).show();  </span><br><span class="line">        }  </span><br><span class="line">    }  </span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#x7684;&#x6A21;&#x62DF;&#x4E0B;&#x8F7D;&#x7684;&#x793A;&#x4F8B;&#xFF0C;&#x5728;downloadTask&#x6211;&#x4EEC;&#x4F7F;&#x7528;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;sleep&#x540E;&#x66F4;&#x65B0;&#x8FD4;&#x56DE;&#x503C;&#xFF0C;&#x6211;&#x5011;&#x5148;&#x4F86;&#x770B;&#x4E0B;AsycTask&#x7684;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#xFF1A;</p>
<figure class="highlight nimrod"><table><tr><td class="code"><pre><span class="line">public <span class="type">AsyncTask</span>() {</span><br><span class="line">    mWorker = new <span class="type">WorkerRunnable</span>&lt;<span class="type">Params</span>, <span class="type">Result</span>&gt;() {</span><br><span class="line">        public <span class="type">Result</span> call() throws <span class="type">Exception</span> {</span><br><span class="line">            mTaskInvoked.<span class="type">set</span>(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">Process</span>.setThreadPriority(<span class="type">Process</span>.<span class="type">THREAD_PRIORITY_BACKGROUND</span>);</span><br><span class="line">            //noinspection unchecked</span><br><span class="line">            <span class="type">Result</span> <span class="literal">result</span> = doInBackground(mParams);</span><br><span class="line">            <span class="type">Binder</span>.flushPendingCommands();</span><br><span class="line">            <span class="keyword">return</span> postResult(<span class="literal">result</span>);</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    mFuture = new <span class="type">FutureTask</span>&lt;<span class="type">Result</span>&gt;(mWorker) {</span><br><span class="line">        @<span class="type">Override</span></span><br><span class="line">        protected <span class="type">void</span> done() {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                postResultIfNotInvoked(get());</span><br><span class="line">            } catch (<span class="type">InterruptedException</span> e) {</span><br><span class="line">                android.util.<span class="type">Log</span>.w(<span class="type">LOG_TAG</span>, e);</span><br><span class="line">            } catch (<span class="type">ExecutionException</span> e) {</span><br><span class="line">                throw new <span class="type">RuntimeException</span>(<span class="string">&quot;An error occurred while executing doInBackground()&quot;</span>,</span><br><span class="line">                        e.getCause());</span><br><span class="line">            } catch (<span class="type">CancellationException</span> e) {</span><br><span class="line">                postResultIfNotInvoked(null);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x91CC;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;WorkerRunnable&#x5BF9;&#x8C61;&#x4EE5;&#x53CA;FutureTask&#x5BF9;&#x8C61;&#xFF0C;&#x6211;&#x4EEC;&#x5728;&#x7EE7;&#x7EED;&#x6DF1;&#x5165;&#x4EE3;&#x7801;&#x4E4B;&#x524D;&#x5148;&#x5BF9;&#x8FD9;&#x4E24;&#x4E2A;&#x7C7B;&#x6709;&#x5927;&#x6982;&#x7684;&#x4E86;&#x89E3;&#x4E0B;&#xFF1A;<br>WorkerRunnable&#x5B9E;&#x73B0;&#x4E86;Callable&#x63A5;&#x53E3;,&#x662F;&#x4E00;&#x4E2A;&#x6709;&#x8FD4;&#x56DE;&#x503C;&#x7684;&#x7EBF;&#x7A0B;&#x4EFB;&#x52A1;&#x3002;&#x5B83;&#x7684;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x5C31;&#x662F;Result&#xFF0C;FutureTask&#x53EF;&#x4EE5;&#x83B7;&#x53D6;&#x5230;&#x6267;&#x884C;&#x7ED3;&#x679C;&#x5E76;&#x4E14;&#x53EF;&#x4EE5;&#x53D6;&#x6D88;&#x6267;&#x884C;&#x4EFB;&#x52A1;&#xFF0C;&#x901A;&#x8FC7;&#x4F20;&#x5165;Runnable&#x6216;&#x8005;Callable&#x7684;&#x4EFB;&#x52A1;&#x7ED9;FutureTask&#xFF0C;&#x76F4;&#x63A5;&#x8C03;&#x7528;&#x5176;run&#x65B9;&#x6CD5;&#x6216;&#x8005;&#x653E;&#x5165;&#x7EBF;&#x7A0B;&#x6C60;&#x6267;&#x884C;&#xFF0C;&#x4E4B;&#x540E;&#x53EF;&#x4EE5;&#x5728;&#x5916;&#x90E8;&#x901A;&#x8FC7;FutureTask&#x7684;get&#x65B9;&#x6CD5;&#x5F02;&#x6B65;&#x83B7;&#x53D6;&#x6267;&#x884C;&#x7ED3;&#x679C;&#xFF0C;FutureTask&#x975E;&#x5E38;&#x9002;&#x5408;&#x7528;&#x4E8E;&#x8017;&#x65F6;&#x7684;&#x8BA1;&#x7B97;&#xFF0C;&#x4E3B;&#x7EBF;&#x7A0B;&#x53EF;&#x4EE5;&#x5728;&#x5B8C;&#x6210;&#x81EA;&#x5DF1;&#x7684;&#x4EFB;&#x52A1;&#x540E;&#xFF0C;&#x518D;&#x53BB;&#x83B7;&#x53D6;&#x7ED3;&#x679C;&#x3002;&#x53E6;&#x5916;&#xFF0C;FutureTask&#x8FD8;&#x53EF;&#x4EE5;&#x786E;&#x4FDD;&#x5373;&#x4F7F;&#x8C03;&#x7528;&#x4E86;&#x591A;&#x6B21;run&#x65B9;&#x6CD5;&#xFF0C;&#x5B83;&#x90FD;&#x53EA;&#x4F1A;&#x6267;&#x884C;&#x4E00;&#x6B21;Runnable&#x6216;&#x8005;Callable&#x4EFB;&#x52A1;&#xFF0C;&#x6216;&#x8005;&#x901A;&#x8FC7;cancel&#x53D6;&#x6D88;FutureTask&#x7684;&#x6267;&#x884C;&#x7B49;&#x3002;&#x4ECE;&#x4E0A;&#x9762;&#x63CF;&#x8FF0;&#x662F;&#x5426;&#x770B;&#x5230;&#x4E86;AyncTask&#x7684;&#x96CF;&#x5F62;&#x3002;&#x5982;&#x679C;&#x5BF9;&#x8FD9;&#x4E24;&#x4E2A;&#x7C7B;&#x60F3;&#x8981;&#x6709;&#x66F4;&#x591A;&#x7684;&#x4E86;&#x89E3;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5982;&#x4E0B;&#x4E24;&#x7BC7;&#x535A;&#x5BA2;&#x6765;&#x4E86;&#x89E3;&#xFF0C;&#x4E5F;&#x76F8;&#x5F53;&#x4E8E;&#x8BE5;&#x81EA;&#x5DF1;&#x7559;&#x4E2A;&#x5751;&#x540E;&#x7EED;&#x518D;&#x6DF1;&#x5165;&#x4E86;&#x89E3;&#x3002;</p>
<p><a href="http://blog.csdn.net/linchunquan/article/details/22382487" target="_blank" rel="external">http://blog.csdn.net/linchunquan/article/details/22382487</a><br><a href="http://blog.csdn.net/jackchen95/article/details/13631761" target="_blank" rel="external">http://blog.csdn.net/jackchen95/article/details/13631761</a></p>
<p>&#x597D;&#x4E86;&#x6211;&#x4EEC;&#x7EE7;&#x7EED;&#xFF1A;<br>&#x4E0A;&#x9762;&#x8BB2;&#x5230;&#x6211;&#x4EEC;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;WorkerRunnable&#x5BF9;&#x8C61;&#x540E;&#x653E;&#x5230;FutureTask&#x4E2D;&#x8FD0;&#x884C;&#x3002;&#x90A3;&#x4E48;&#x6574;&#x4E2A;&#x521D;&#x59CB;&#x5316;&#x5C31;&#x7ED3;&#x675F;&#x4E86;&#xFF0C;&#x63A5;&#x7740;&#x5C31;&#x8C03;&#x7528;execute&#x65B9;&#x6CD5;&#x542F;&#x52A8;&#x4EFB;&#x52A1;&#x3002;<br><figure class="highlight lasso"><table><tr><td class="code"><pre><span class="line">@MainThread</span><br><span class="line"><span class="keyword">public</span> final AsyncTask&lt;<span class="keyword">Params</span>, Progress, Result&gt; execute(<span class="keyword">Params</span><span class="attribute">...</span> <span class="keyword">params</span>) {</span><br><span class="line">    <span class="keyword">return</span> executeOnExecut<span class="subst">or</span>(sDefaultExecut<span class="subst">or</span>, <span class="keyword">params</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x7D27;&#x63A5;&#x7740;&#x8C03;&#x7528;&#x6211;&#x4EEC;&#x7684;executeOnExecutor&#x65B9;&#x6CD5;&#x3002;</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"> <span class="annotation">@MainThread</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; executeOnExecutor(Executor exec,</span><br><span class="line">        Params... params) {</span><br><span class="line">    <span class="keyword">if</span> (mStatus != Status.PENDING) {</span><br><span class="line">        <span class="keyword">switch</span> (mStatus) {</span><br><span class="line">            <span class="keyword">case</span> RUNNING:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Cannot execute task:&quot;</span></span><br><span class="line">                        + <span class="string">&quot; the task is already running.&quot;</span>);</span><br><span class="line">            <span class="keyword">case</span> FINISHED:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Cannot execute task:&quot;</span></span><br><span class="line">                        + <span class="string">&quot; the task has already been executed &quot;</span></span><br><span class="line">                        + <span class="string">&quot;(a task can be executed only once)&quot;</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    mStatus = Status.RUNNING;</span><br><span class="line"></span><br><span class="line">    onPreExecute();</span><br><span class="line"></span><br><span class="line">    mWorker.mParams = params;</span><br><span class="line">    exec.execute(mFuture);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x91CC;&#x4F20;&#x5165;&#x7684;exec&#x53C2;&#x6570;&#x4E3A;sDefaultExecutor&#xFF0C;&#x5B83;&#x7684;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;<br><figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Executor sDefaultExecutor = SERIAL_EXECUTOR;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Executor SERIAL_EXECUTOR = <span class="keyword">new</span> SerialExecutor();</span><br></pre></td></tr></table></figure></p>
<p>&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x5B83;&#x662F;&#x4E00;&#x4E2A;SerialExecutor&#xFF0C;&#x770B;&#x4E0B;&#x4EE3;&#x7801;&#x4E2D;&#x6709;&#x5982;&#x4E0B;&#x6CE8;&#x91CA;&#xFF1A;<br>&#x8BF4;&#x660E;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x4E32;&#x884C;&#x7684;&#x4EFB;&#x52A1;&#xFF0C;&#x6BCF;&#x6B21;&#x53EA;&#x80FD;&#x6267;&#x884C;&#x4E00;&#x4E2A;&#xFF0C;&#x5F53;&#x5F53;&#x524D;&#x7684;&#x4EFB;&#x52A1;&#x7ED3;&#x675F;&#x7684;&#x65F6;&#x5019;&#x624D;&#x5141;&#x8BB8;&#x6267;&#x884C;&#x4E0B;&#x4E00;&#x4E2A;&#x3002;&#x8FD9;&#x4E5F;&#x662F;&#x5F88;&#x591A;&#x65F6;&#x5019;&#x63D0;&#x5230;&#x7684;AyncTask&#x7684;&#x5F0A;&#x7AEF;&#x3002;&#x6211;&#x95E8;&#x8FD9;&#x91CC;&#x5148;&#x4E0D;&#x8BB2;&#x8FD9;&#x4E9B;&#x3002;&#x7EE7;&#x7EED;&#x6211;&#x4EEC;&#x7684;&#x6E90;&#x7801;&#x5206;&#x6790;&#x3002;<br><figure class="highlight puppet"><table><tr><td class="code"><pre><span class="line">/**</span><br><span class="line">* <span class="name">An</span> {@<span class="literal">link</span> Executor} <span class="name">that</span> <span class="name">executes</span> <span class="name">tasks</span> <span class="name">one</span> <span class="name">at</span> <span class="name">a</span> <span class="name">time</span> <span class="name">in</span> <span class="name">serial</span></span><br><span class="line">* order.  This serialization is global to a particular process.</span><br><span class="line">*/</span><br></pre></td></tr></table></figure></p>
<p>executeOnExecutor&#x4E2D;&#x4F1A;&#x5148;&#x5224;&#x65AD;&#x5F53;&#x524D;&#x7684;&#x72B6;&#x6001;&#x8FD9;&#x91CC;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;AysnTask&#x662F;&#x4E00;&#x4E2A;&#x5355;&#x6B21;&#x6267;&#x884C;&#x7684;&#x4EFB;&#x52A1;&#xFF0C;&#x4E00;&#x65E6;&#x6267;&#x884C;&#x7ED3;&#x675F;&#x540E;&#x518D;&#x8C03;&#x7528;excute&#x5C31;&#x4F1A;&#x629B;&#x51FA;&#x9519;&#x8BEF;&#xFF0C;&#x5FC5;&#x987B;&#x91CD;&#x65B0;new&#x4E00;&#x4E2A;&#x3002;&#x5728;&#x72B6;&#x6001;&#x4E3A;PENDING&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x8BF4;&#x660E;&#x5F53;&#x524D;&#x7684;AsyncTask&#x5C1A;&#x672A;&#x6267;&#x884C;&#xFF0C;&#x8FD9;&#x65F6;&#x5019;&#x4F1A;&#x5C06;&#x5F53;&#x524D;&#x72B6;&#x6001;&#x7F6E;&#x4E3A;Status.RUNNING<br>&#x5E76;&#x5728;&#x8C03;&#x7528;onPreExecute&#x540E;&#x8C03;&#x7528;SerialExecutor&#x7684;execute&#x65B9;&#x6CD5;&#x3002;</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SerialExecutor</span> <span class="keyword">implements</span> <span class="title">Executor</span> </span>{</span><br><span class="line">    <span class="keyword">final</span> ArrayDeque&lt;Runnable&gt; mTasks = <span class="keyword">new</span> ArrayDeque&lt;Runnable&gt;();</span><br><span class="line">    Runnable mActive;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> Runnable r)</span> </span>{</span><br><span class="line">        mTasks.offer(<span class="keyword">new</span> Runnable() {</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    r.run();</span><br><span class="line">                } <span class="keyword">finally</span> {</span><br><span class="line">                    scheduleNext();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">        <span class="keyword">if</span> (mActive == <span class="keyword">null</span>) {</span><br><span class="line">            scheduleNext();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">scheduleNext</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> ((mActive = mTasks.poll()) != <span class="keyword">null</span>) {</span><br><span class="line">            THREAD_POOL_EXECUTOR.execute(mActive);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5728;SerialExecutor&#x7684;execute&#x65B9;&#x6CD5;&#x4E2D;&#x6211;&#x4EEC;&#x8C03;&#x7528;&#x4E86;FutureTask &#x7684; run()&#x65B9;&#x6CD5;&#xFF08;FutureTask &#x4EE3;&#x7801;&#x4E0D;&#x5728;framework&#x5C42;&#x4E2D;&#x800C;&#x662F;&#x5728;libcore&#x4E0B;&#xFF09;</p>
<figure class="highlight nimrod"><table><tr><td class="code"><pre><span class="line">public <span class="type">void</span> run() {</span><br><span class="line">    <span class="keyword">if</span> (state != <span class="type">NEW</span> ||</span><br><span class="line">        !U.compareAndSwapObject(this, <span class="type">RUNNER</span>, null, <span class="type">Thread</span>.currentThread()))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="type">Callable</span>&lt;V&gt; c = callable;</span><br><span class="line">        <span class="keyword">if</span> (c != null &amp;&amp; state == <span class="type">NEW</span>) {</span><br><span class="line">            V <span class="literal">result</span>;</span><br><span class="line">            boolean ran;</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="literal">result</span> = c.call();</span><br><span class="line">                ran = <span class="literal">true</span>;</span><br><span class="line">            } catch (<span class="type">Throwable</span> ex) {</span><br><span class="line">                <span class="literal">result</span> = null;</span><br><span class="line">                ran = <span class="literal">false</span>;</span><br><span class="line">                setException(ex);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (ran)</span><br><span class="line">                <span class="type">set</span>(<span class="literal">result</span>);</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        // runner must be non-null until state <span class="keyword">is</span> settled to</span><br><span class="line">        // prevent concurrent calls to run()</span><br><span class="line">        runner = null;</span><br><span class="line">        // state must be re-read after nulling runner to prevent</span><br><span class="line">        // leaked interrupts</span><br><span class="line">        <span class="type">int</span> s = state;</span><br><span class="line">        <span class="keyword">if</span> (s &gt;= <span class="type">INTERRUPTING</span>)</span><br><span class="line">            handlePossibleCancellationInterrupt(s);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5728;&#x8FD9;&#x91CC;&#x8C03;&#x7528;&#x4E86;<br><figure class="highlight nimrod"><table><tr><td class="code"><pre><span class="line"><span class="literal">result</span> = c.call()</span><br></pre></td></tr></table></figure></p>
<p>&#x4E5F;&#x5C31;&#x662F;&#x4ECB;&#x7ECD;&#x6784;&#x9020;&#x51FD;&#x6570;&#x65F6;&#x63D0;&#x5230;&#x7684;WorkRunable&#xFF0C;&#x4E3A;&#x4E86;&#x907F;&#x514D;&#x5927;&#x5BB6;&#x5728;&#x8FD9;&#x5173;&#x952E;&#x5173;&#x5934;&#x7FFB;&#x4EE3;&#x7801;&#x6211;&#x76F4;&#x63A5;&#x518D;&#x6B21;&#x8D34;&#x5728;&#x4E0B;&#x9762;&#x4E86;&#x3002;<br><figure class="highlight nimrod"><table><tr><td class="code"><pre><span class="line">mWorker = new <span class="type">WorkerRunnable</span>&lt;<span class="type">Params</span>, <span class="type">Result</span>&gt;() {</span><br><span class="line">    public <span class="type">Result</span> call() throws <span class="type">Exception</span> {</span><br><span class="line">        mTaskInvoked.<span class="type">set</span>(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Process</span>.setThreadPriority(<span class="type">Process</span>.<span class="type">THREAD_PRIORITY_BACKGROUND</span>);</span><br><span class="line">        //noinspection unchecked</span><br><span class="line">        <span class="type">Result</span> <span class="literal">result</span> = doInBackground(mParams);</span><br><span class="line">        <span class="type">Binder</span>.flushPendingCommands();</span><br><span class="line">        <span class="keyword">return</span> postResult(<span class="literal">result</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">};</span><br></pre></td></tr></table></figure></p>
<p>&#x8FD9;&#x91CC;&#x5927;&#x5BB6;&#x662F;&#x4E0D;&#x662F;&#x770B;&#x5230;&#x4E86;doInBackground&#x65B9;&#x6CD5;&#xFF1F;&#x90A3;&#x4E48;&#x6267;&#x884C;&#x5B8C;&#x7ED3;&#x679C;&#x600E;&#x4E48;&#x8FD4;&#x56DE;&#x5230;&#x4E3B;&#x7EBF;&#x7A0B;&#x5462;&#xFF1F;&#x6211;&#x4EEC;&#x6CE8;&#x610F;&#x5230;&#x6700;&#x540E;&#x901A;&#x8FC7;postResult&#x6765;&#x5C06;&#x7ED3;&#x679C;&#x8FD4;&#x56DE;&#x3002;</p>
<figure class="highlight nimrod"><table><tr><td class="code"><pre><span class="line">private <span class="type">Result</span> postResult(<span class="type">Result</span> <span class="literal">result</span>) {</span><br><span class="line">    @<span class="type">SuppressWarnings</span>(<span class="string">&quot;unchecked&quot;</span>)</span><br><span class="line">    <span class="type">Message</span> message = getHandler().obtainMessage(<span class="type">MESSAGE_POST_RESULT</span>,</span><br><span class="line">            new <span class="type">AsyncTaskResult</span>&lt;<span class="type">Result</span>&gt;(this, <span class="literal">result</span>));</span><br><span class="line">    message.sendToTarget();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x6211;&#x4EEC;&#x7EE7;&#x7EED;&#x770B;&#x4E0B;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF1A;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x770B;&#x5230;&#x4E86;Handler&#x7684;&#x5F71;&#x5B50;&#x3002;&#x5B83;&#x4F1A;&#x901A;&#x8FC7;getHandler&#x83B7;&#x53D6;&#x5230;&#x4E00;&#x4E2A;Handler&#xFF0C;&#x8FD9;&#x4E2A;Handler&#x5B9E;&#x9645;&#x4E0A;&#x5C31;&#x662F;MainHandler&#xFF0C;&#x6211;&#x4EEC;&#x62ED;&#x76EE;&#x4EE5;&#x5F85;&#xFF1A;</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="function">Handler <span class="title">getHandler</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">synchronized</span> (AsyncTask.class) {</span><br><span class="line">        <span class="keyword">if</span> (sHandler == <span class="keyword">null</span>) {</span><br><span class="line">            sHandler = <span class="keyword">new</span> InternalHandler();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> sHandler;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<figure class="highlight nimrod"><table><tr><td class="code"><pre><span class="line">private <span class="keyword">static</span> class <span class="type">InternalHandler</span> extends <span class="type">Handler</span> {</span><br><span class="line">    public <span class="type">InternalHandler</span>() {</span><br><span class="line">        super(<span class="type">Looper</span>.getMainLooper());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @<span class="type">SuppressWarnings</span>({<span class="string">&quot;unchecked&quot;</span>, <span class="string">&quot;RawUseOfParameterizedType&quot;</span>})</span><br><span class="line">    @<span class="type">Override</span></span><br><span class="line">    public <span class="type">void</span> handleMessage(<span class="type">Message</span> msg) {</span><br><span class="line">        <span class="type">AsyncTaskResult</span>&lt;?&gt; <span class="literal">result</span> = (<span class="type">AsyncTaskResult</span>&lt;?&gt;) msg.obj;</span><br><span class="line">        switch (msg.what) {</span><br><span class="line">            <span class="keyword">case</span> <span class="type">MESSAGE_POST_RESULT</span>:</span><br><span class="line">                // <span class="type">There</span> <span class="keyword">is</span> only one <span class="literal">result</span></span><br><span class="line">                <span class="literal">result</span>.mTask.finish(<span class="literal">result</span>.mData[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="type">MESSAGE_POST_PROGRESS</span>:</span><br><span class="line">                <span class="literal">result</span>.mTask.onProgressUpdate(<span class="literal">result</span>.mData);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x770B;&#x5230;&#x4E86;&#x5427;&#x5728;&#x521B;&#x5EFA;InternalHandler&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x5C06;getMainLooper&#x4F20;&#x5165;&#x3002;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;Handler&#x5C06;MESSAGE_POST_RESULT&#x6D88;&#x606F;&#x53D1;&#x9001;&#x7ED9;MainLooper&#xFF0C;&#x5728;&#x6D88;&#x606F;&#x5FAA;&#x73AF;&#x4E2D;&#x6267;&#x884C;&#x5230;&#x8FD9;&#x4E2A;&#x6D88;&#x606F;&#x7684;&#x65F6;&#x5019;&#x5C31;&#x8C03;&#x7528;InternalHandler&#x7684;handleMessage&#xFF0C;&#x8FDB;&#x800C;&#x8C03;&#x7528;&#xFF1A;<br><figure class="highlight nimrod"><table><tr><td class="code"><pre><span class="line"><span class="literal">result</span>.mTask.finish(<span class="literal">result</span>.mData[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure></p>
<p>&#x5728;&#x7D27;&#x63A5;&#x7740;&#x5C31;&#x662F;&#x8C03;&#x7528;finish&#x65B9;&#x6CD5;&#xFF0C;&#x5E76;&#x5C06;result&#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#x4F20;&#x5165;&#xFF1A;<br><figure class="highlight nimrod"><table><tr><td class="code"><pre><span class="line">private <span class="type">void</span> finish(<span class="type">Result</span> <span class="literal">result</span>) {</span><br><span class="line">    <span class="keyword">if</span> (isCancelled()) {</span><br><span class="line">        onCancelled(<span class="literal">result</span>);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        onPostExecute(<span class="literal">result</span>);</span><br><span class="line">    }</span><br><span class="line">    mStatus = <span class="type">Status</span>.<span class="type">FINISHED</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x5728;&#x8FD9;&#x91CC;&#x5C31;&#x8C03;&#x7528;&#x4E86;onPostExecute&#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x6700;&#x540E;&#x518D;&#x770B;&#x4E0B;publishProgress&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF1A;<br><figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="annotation">@WorkerThread</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="function"><span class="keyword">void</span> <span class="title">publishProgress</span><span class="params">(Progress... values)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (!isCancelled()) {</span><br><span class="line">        getHandler().obtainMessage(MESSAGE_POST_PROGRESS,</span><br><span class="line">                <span class="keyword">new</span> AsyncTaskResult&lt;Progress&gt;(<span class="keyword">this</span>, values)).sendToTarget();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x5176;&#x5B9E;&#x5982;&#x679C;&#x4E0A;&#x9762;&#x7684;&#x6D41;&#x7A0B;&#x5927;&#x5BB6;&#x770B;&#x5F97;&#x61C2;&#x7684;&#x8BDD;&#x8FD9;&#x91CC;&#x53EA;&#x8981;&#x8D34;&#x51FA;&#x4EE3;&#x7801;&#x5C31;&#x77E5;&#x9053;&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x4E86;&#xFF1A;&#x5C31;&#x662F;&#x5F80;MainLooper&#x4E0A;&#x53D1;&#x9001;MESSAGE_POST_PROGRESS&#x6D88;&#x606F;InternalHandler&#x6536;&#x5230;&#x6D88;&#x606F;&#x540E;&#x8C03;&#x7528;onProgressUpdate&#x6267;&#x884C;&#x3002;</p>
<p>&#x5176;&#x5B9E;&#x8FD9;&#x91CC;&#x8FD8;&#x6D89;&#x53CA;&#x5230;SerialExecutor&#x7684;&#x4E32;&#x884C;&#x6267;&#x884C;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x8FD9;&#x4E2A;&#x5C06;&#x653E;&#x5728;&#x540E;&#x9762;&#x7684;&#x535A;&#x5BA2;&#x4E2D;&#x4ECB;&#x7ECD;&#x3002;</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android-源码分析/">Android 源码分析</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/AOSP-源码/">AOSP 源码</a>
  </div>

</div>



<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/07/28/Android-源码分析之AsyncTask/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/07/28/Android-源码分析之AsyncTask/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/07/28/Android-源码分析之HandlerThread/" title="Android-源码分析之HandlerThread" itemprop="url">Android-源码分析之HandlerThread</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Edgar" target="_blank" itemprop="author">Edgar</a>
		
  <p class="article-time">
    <time datetime="2016-07-28T03:55:15.000Z" itemprop="datePublished"> 發表於 2016-07-28</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>&#x4E0A;&#x4E00;&#x7BC7;&#x6211;&#x4EEC;&#x4ECB;&#x7ECD;&#x4E86;Handler &#x6211;&#x4EEC;&#x77E5;&#x9053;&#x4E86;&#x4E00;&#x822C;&#x7684;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x5728;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#x662F;&#x6CA1;&#x6709;&#x6D88;&#x606F;&#x5904;&#x7406;&#x80FD;&#x529B;&#x7684;&#xFF0C;&#x5982;&#x679C;&#x8981;&#x5904;&#x7406;&#x6D88;&#x606F;&#x9700;&#x8981;&#x901A;&#x8FC7;&#x5982;&#x4E0B;&#x7684;&#x4EE3;&#x7801;&#x6765;&#x7ED9;&#x666E;&#x901A;&#x7684;&#x7EBF;&#x7A0B;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;Looper&#x3002;<br><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NonMainThread</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">Thread</span> {</span></span><br><span class="line">      public <span class="type">Handler</span> mHandler;</span><br><span class="line">      public void run() {</span><br><span class="line">          <span class="type">Looper</span>.prepare();</span><br><span class="line">          mHandler = <span class="keyword">new</span> <span class="type">Handler</span>() {</span><br><span class="line">              public void handleMessage(<span class="type">Message</span> msg) {</span><br><span class="line">                  <span class="comment">// process incoming messages here</span></span><br><span class="line">              }</span><br><span class="line">          };</span><br><span class="line">          <span class="type">Looper</span>.loop();</span><br><span class="line">      }</span><br><span class="line">  }</span><br></pre></td></tr></table></figure></p>
<p>&#x8FD9;&#x4E2A;&#x770B;&#x4E0A;&#x53BB;&#x4E0D;&#x662F;&#x5F88;&#x590D;&#x6742;&#xFF0C;&#x4F46;&#x662F;Android&#x4E3A;&#x6211;&#x4EEC;&#x63D0;&#x4F9B;&#x4E86;&#x66F4;&#x4E3A;&#x7B80;&#x5355;&#x7684;&#x5B9E;&#x73B0;&#x65B9;&#x5F0F;&#x2013;HandlerThread<br>&#x9996;&#x5148;&#x6211;&#x4EEC;&#x8FD8;&#x662F;&#x5148;&#x6765;&#x770B;&#x4E0B;&#x5B83;&#x7684;&#x4F7F;&#x7528;&#x65B9;&#x5F0F;&#xFF1A;<br><figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line">mHandlerThread = <span class="keyword">new</span> HandlerThread(<span class="string">&quot;WorkThread&quot;</span>);</span><br><span class="line">mHandlerThread.start();</span><br><span class="line">mThreadHandler = <span class="keyword">new</span> Handler(mHandlerThread.getLooper()) {</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>.handleMessage(msg);</span><br><span class="line">         <span class="comment">//&#x3002;&#x3002;&#x3002;&#x3002;&#x3002;</span></span><br><span class="line">    }</span><br><span class="line">};</span><br></pre></td></tr></table></figure></p>
<p>&#x6211;&#x4EEC;&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x6765;&#x5206;&#x6790;&#x4E0B;&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#xFF1A;</p>
<p>&#x9996;&#x5148;&#x5728;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x4E2D;&#x63A5;&#x53D7;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x4E3A;&#x8FD9;&#x4E2A;HandlerThread&#x7684;&#x540D;&#x5B57;&#xFF0C;&#x63A5;&#x7740;&#x4E3A;&#x6211;&#x4EEC;&#x7684;&#x7EBF;&#x7A0B;&#x8BBE;&#x7F6E;&#x4E00;&#x4E2A;&#x9ED8;&#x8BA4;&#x7684;&#x4F18;&#x5148;&#x7EA7;&#x3002;</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HandlerThread</span><span class="params">(String name)</span> </span>{</span><br><span class="line">    <span class="keyword">super</span>(name);</span><br><span class="line">    mPriority = Process.THREAD_PRIORITY_DEFAULT;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5982;&#x679C;&#x4E0D;&#x60F3;&#x4F7F;&#x7528;&#x9ED8;&#x8BA4;&#x7684;&#x4F18;&#x5148;&#x7EA7;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x4E0B;&#x9762;&#x7684;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#xFF1A;</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HandlerThread</span><span class="params">(String name, <span class="keyword">int</span> priority)</span> </span>{</span><br><span class="line">    <span class="keyword">super</span>(name);</span><br><span class="line">    mPriority = priority;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x7D27;&#x63A5;&#x7740;&#x5728;&#x8C03;&#x7528;start&#x65B9;&#x6CD5;&#x540E;&#xFF0C;run&#x65B9;&#x6CD5;&#x5C06;&#x4F1A;&#x8FD0;&#x884C;&#xFF1A;</p>
<figure class="highlight dns"><table><tr><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void run() {</span><br><span class="line">    mTid = Process.myTid()<span class="comment">;</span></span><br><span class="line">    Looper.prepare()<span class="comment">;</span></span><br><span class="line">    synchronized (this) {</span><br><span class="line">        mLooper = Looper.myLooper()<span class="comment">;</span></span><br><span class="line">        notifyAll()<span class="comment">;</span></span><br><span class="line">    }</span><br><span class="line">    Process.setThreadPriority(mPriority)<span class="comment">;</span></span><br><span class="line">    onLooperPrepared()<span class="comment">;</span></span><br><span class="line">    Looper.loop()<span class="comment">;</span></span><br><span class="line">    mTid = -1<span class="comment">;</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x5F88;&#x719F;&#x6089;&#x5427;&#xFF0C;&#x5176;&#x5B9E;&#x8BE5;&#x535A;&#x5BA2;&#x5F00;&#x5934;&#x63D0;&#x5230;&#x7684;&#x90A3;&#x4E2A;&#x4EE3;&#x7801;&#xFF0C;&#x8FD9;&#x91CC;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;onLooperPrepared()&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x662F;&#x7A7A;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x5982;&#x679C;&#x9700;&#x8981;&#x5728;Looper&#x5FAA;&#x73AF;&#x5F00;&#x59CB;&#x524D;&#x505A;&#x4E9B;&#x5176;&#x4ED6;&#x5904;&#x7406;&#x53EF;&#x4EE5;&#x8986;&#x5199;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x8C03;&#x7528;getLooper&#x65B9;&#x6CD5;&#x8FD4;&#x56DE;&#x5DF2;&#x7ECF;&#x5904;&#x4E8E;loop&#x72B6;&#x6001;&#x7684;Looper&#x4E86;&#xFF0C;&#x4E5F;&#x6709;&#x4E86;MessageQueue&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x521B;&#x5EFA;Handler&#x5904;&#x7406;&#x5176;&#x4ED6;&#x7EBF;&#x7A0B;&#x53D1;&#x8FC7;&#x6765;&#x7684;&#x6D88;&#x606F;&#x4E86;&#xFF0C;&#x6CE8;&#x610F;&#x7684;&#x662F;&#x8FD9;&#x91CC;&#x662F;&#x4E3A;&#x4E86;&#x8BA9;&#x975E;UI&#x7EBF;&#x7A0B;&#x62E5;&#x6709;&#x5904;&#x7406;&#x5176;&#x4ED6;&#x7EBF;&#x7A0B;&#x53D1;&#x9001;&#x8FC7;&#x6765;&#x6D88;&#x606F;&#x80FD;&#x529B;&#x624D;&#x4F7F;&#x7528;HandlerThread&#x7684;&#xFF0C;&#x5982;&#x679C;&#x53EA;&#x9700;&#x8981;&#x5177;&#x6709;&#x6D88;&#x606F;&#x53D1;&#x9001;&#x7684;&#x80FD;&#x529B;&#x5C31;&#x4E0D;&#x9700;&#x8981;&#x4E86;&#xFF0C;&#x8FD9;&#x4E2A;&#x4E00;&#x5B9A;&#x8981;&#x6E05;&#x695A;&#x3002;</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function">Looper <span class="title">getLooper</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (!isAlive()) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// If the thread has been started, wait until the looper has been created.</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) {</span><br><span class="line">        <span class="keyword">while</span> (isAlive() &amp;&amp; mLooper == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                wait();</span><br><span class="line">            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> mLooper;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android-源码分析/">Android 源码分析</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/AOSP-源码/">AOSP 源码</a>
  </div>

</div>



<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/07/28/Android-源码分析之HandlerThread/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/07/28/Android-源码分析之HandlerThread/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/07/28/Android-源码分析之Handler-MessageQueue-Looper/" title="Android 源码分析之Handler MessageQueue Looper" itemprop="url">Android 源码分析之Handler MessageQueue Looper</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Edgar" target="_blank" itemprop="author">Edgar</a>
		
  <p class="article-time">
    <time datetime="2016-07-28T03:19:57.000Z" itemprop="datePublished"> 發表於 2016-07-28</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>&#x6211;&#x4EEC;&#x9996;&#x5148;&#x770B;&#x4E0B;&#x6211;&#x4EEC;&#x7684;&#x65E5;&#x5E38;&#x4F7F;&#x7528;&#x573A;&#x666F;&#xFF1A;<br>&#x4E0B;&#x9762;&#x7684;&#x4F8B;&#x5B50;&#x4E2D;&#x6211;&#x4EEC;&#x542F;&#x52A8;&#x4E86;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x5728;&#x540E;&#x53F0;&#x4E0A;&#x4F5C;&#x4E00;&#x4E9B;&#x8017;&#x65F6;&#x95F4;&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x5728;&#x64CD;&#x4F5C;&#x7ED3;&#x675F;&#x540E;&#x901A;&#x8FC7;Handler&#x5411;&#x4E3B;&#x7EBF;&#x7A0B;&#x53D1;&#x9001;&#x4E00;&#x4E2A;&#x6D88;&#x606F;&#x66F4;&#x65B0;&#x6587;&#x672C;&#xFF0C;&#x6211;&#x4EEC;&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x7740;&#x8FD9;&#x4E2A;&#x60C5;&#x666F;&#x5BF9;Handler&#x6E90;&#x4EE3;&#x7801;&#x8FDB;&#x884C;&#x5B66;&#x4E60;&#x3002;<br><figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> Handler <span class="keyword">handler</span> = <span class="keyword">new</span> Handler() {</span><br><span class="line"></span><br><span class="line">     <span class="annotation">@Override</span></span><br><span class="line">     <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (msg.what == CHANGE_TEXT) {</span><br><span class="line">            textView.setText(String.valueOf(msg.obj));</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">super</span>.handleMessage(msg);</span><br><span class="line">    }</span><br><span class="line">};</span><br></pre></td></tr></table></figure></p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> Thread() {</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line"></span><br><span class="line">            <span class="comment">//&#x4E00;&#x4E9B;&#x8017;&#x65F6;&#x7684;&#x64CD;&#x4F5C;</span></span><br><span class="line">            Message msg = Message.obtain();</span><br><span class="line">            msg.what = CHANGE_TEXT;</span><br><span class="line">            msg.obj = <span class="string">&quot;Hello Handle&quot;</span> ;</span><br><span class="line">            <span class="keyword">handler</span>.sendMessage(msg);</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}.start();</span><br></pre></td></tr></table></figure>
<p>&#x9996;&#x5148;&#x662F;&#x8C03;&#x7528;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;Handler&#x5BF9;&#x8C61;&#xFF0C;&#x5728;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x7684;&#x6CE8;&#x91CA;&#x4E2D;&#x6211;&#x4EEC;&#x770B;&#x5230;&#x4E00;&#x4E2A;&#x6BD4;&#x8F83;&#x6709;&#x4EF7;&#x503C;&#x7684;&#x63D0;&#x793A;&#xFF1A;&#x5C31;&#x662F;&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x6CA1;&#x6709;Looper&#x90A3;&#x4E48;&#x5B83;&#x5C06;&#x4E0D;&#x5177;&#x5907;&#x63A5;&#x53D7;Message&#x7684;&#x80FD;&#x529B;&#xFF0C;&#x5982;&#x679C;&#x5B8C;&#x8FD9;&#x79CD;&#x7EBF;&#x7A0B;&#x4E2D;post&#x6D88;&#x606F;&#x90A3;&#x4E48;&#x5C06;&#x4F1A;&#x6709;&#x5F02;&#x5E38;&#x629B;&#x51FA;&#x3002;</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Default constructor associates this handler with the {<span class="doctag">@link</span> Looper} for the</span><br><span class="line"> * current thread.</span><br><span class="line"> *</span><br><span class="line"> * If this thread does not have a looper, this handler won&apos;t be able to receive messages</span><br><span class="line"> * so an exception is thrown.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>(<span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x4E0A;&#x9762;&#x7684;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x8C03;&#x7528;&#x4E86;Handler&#x7684;&#x53E6;&#x4E00;&#x4E2A;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#xFF1A;</p>
<figure class="highlight monkey"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Handler(Callback callback, boolean async) {</span><br><span class="line">    <span class="keyword">if</span> (FIND_POTENTIAL_LEAKS) {</span><br><span class="line">        <span class="keyword">final</span> <span class="class"><span class="keyword">Class</span>&lt;? <span class="keyword">extends</span> <span class="title">Handler</span>&gt; <span class="title">klass</span> = <span class="title">getClass</span>();</span></span><br><span class="line">        <span class="keyword">if</span> ((klass.isAnonymousClass() || klass.isMemberClass() || klass.isLocalClass()) &amp;&amp;</span><br><span class="line">                (klass.getModifiers() &amp; Modifier.STATIC) == <span class="number">0</span>) {</span><br><span class="line">            <span class="built_in">Log</span>.w(TAG, <span class="string">&quot;The following Handler class should be static or leaks might occur: &quot;</span> +</span><br><span class="line">                klass.getCanonicalName());</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    mLooper = Looper.myLooper();</span><br><span class="line">    <span class="keyword">if</span> (mLooper == <span class="literal">null</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">            <span class="string">&quot;Can&apos;t create handler inside thread that has not called Looper.prepare()&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">    mQueue = mLooper.mQueue;</span><br><span class="line">    mCallback = callback;</span><br><span class="line">    mAsynchronous = async;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5728;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x5F00;&#x59CB;&#x90E8;&#x5206;&#x4F1A;&#x5148;&#x5224;&#x65AD;&#x5F53;&#x524D;&#x7684;Handler&#x7C7B;&#x662F;&#x5426;&#x662F;&#x533F;&#x540D;&#x5185;&#x90E8;&#x7C7B;&#xFF0C;&#x6216;&#x8005;&#x9759;&#x6001;&#x5185;&#x90E8;&#x7C7B;&#xFF0C;&#x6210;&#x5458;&#x5185;&#x90E8;&#x7C7B;&#xFF0C;&#x5982;&#x679C;&#x662F;&#x8FD9;&#x4E9B;&#x7684;&#x8BDD;&#x9700;&#x8981;&#x5C06;Handler&#x58F0;&#x660E;&#x6210;static&#xFF0C;&#x8FD9;&#x4E2A;&#x5728;&#x4E4B;&#x524D;&#x7684;&#x5185;&#x5B58;&#x4F18;&#x5316;&#x7684;&#x535A;&#x5BA2;&#x4E2D;&#x5DF2;&#x7ECF;&#x63D0;&#x5230;&#xFF0C;&#x5982;&#x679C;&#x662F;&#x975E;&#x9759;&#x6001;&#x7684;&#x90A3;&#x4E48;&#x5C06;&#x4F1A;&#x6301;&#x6709;&#x5916;&#x90E8;&#x7C7B;&#x7684;&#x5F15;&#x7528;&#xFF0C;&#x5F88;&#x6709;&#x53EF;&#x80FD;&#x9020;&#x6210;&#x5185;&#x5B58;&#x6CC4;&#x9732;&#x3002;<br>&#x7D27;&#x63A5;&#x7740;&#x8C03;&#x7528;<br><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">Looper.<span class="function"><span class="title">myLooper</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure></p>
<p>&#x5224;&#x65AD;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x662F;&#x5426;&#x6709;Looper&#xFF0C;&#x8FD9;&#x4E00;&#x70B9;&#x6211;&#x4EEC;&#x4E0A;&#x9762;&#x5DF2;&#x7ECF;&#x63D0;&#x5230;&#x4E86;&#x5982;&#x679C;&#x6CA1;&#x6709;Looper&#x5C31;&#x6CA1;&#x6709;&#x5904;&#x7406;&#x6D88;&#x606F;&#x7684;&#x80FD;&#x529B;&#x3002;&#x90A3;&#x4E48;&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x624D;&#x6709;Looper&#x5462;&#xFF1F;<br>&#x6211;&#x4EEC;&#x770B;&#x4E0B;myLooper&#x65B9;&#x6CD5;&#xFF1A;<br><figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Return the Looper object associated with the current thread.  Returns</span><br><span class="line"> * null if the calling thread is not associated with a Looper.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="annotation">@Nullable</span> <span class="function">Looper <span class="title">myLooper</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">return</span> sThreadLocal.<span class="title">get</span><span class="params">()</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x4ECE;&#x6CE8;&#x91CA;&#x4E0A;&#x770B;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5F88;&#x660E;&#x663E;&#x770B;&#x51FA;&#x5B83;&#x662F;&#x7528;&#x4E8E;&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x7684;Looper&#xFF0C;&#x90A3;&#x4E48;&#x8FD9;&#x4E2A;Looper&#x662F;&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x8BBE;&#x7F6E;&#x7684;&#x5462;&#xFF1F; &#x6211;&#x4EEC;&#x63A5;&#x4E0B;&#x6765;&#x770B;&#xFF1A;<br><figure class="highlight cs"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span>(<span class="params">boolean quitAllowed</span>) </span>{</span><br><span class="line">    <span class="keyword">if</span> (sThreadLocal.<span class="keyword">get</span>() != <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Only one Looper may be created per thread&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">    sThreadLocal.<span class="keyword">set</span>(<span class="keyword">new</span> Looper(quitAllowed));</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x4E2D;&#x4F1A;&#x5148;&#x5224;&#x65AD;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x6709;Looper&#x4E86;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x90A3;&#x4E48;&#x5C31;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#xFF0C;&#x8FD9;&#x5C31;&#x610F;&#x5473;&#x7740;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x81F3;&#x591A;&#x53EA;&#x80FD;&#x6709;&#x4E00;&#x4E2A;Looper&#x3002;<br>&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x5E76;&#x6CA1;&#x6709;&#x8C03;&#x7528;&#x8FD9;&#x4E2A;prepare&#x65B9;&#x6CD5;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x6CA1;&#x6709;&#x62A5;&#x9519;&#xFF0C;&#x539F;&#x56E0;&#x5728;&#x4E8E;&#x4E3B;&#x7EBF;&#x7A0B;&#x5728;&#x521B;&#x5EFA;&#x7684;&#x65F6;&#x5019;&#x5C31;&#x5DF2;&#x7ECF;&#x968F;&#x5373;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;MainLooper&#xFF0C;&#x6211;&#x4EEC;&#x770B;&#x6E90;&#x4EE3;&#x7801;&#x4E2D;prepare&#x65B9;&#x6CD5;&#x4E0B;&#x9762;&#x7684;prepareMainLooper&#x65B9;&#x6CD5;&#xFF1A;</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">void</span> <span class="title">prepareMainLooper</span><span class="params">()</span> </span>{</span><br><span class="line">    prepare(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">synchronized</span> (Looper.class) {</span><br><span class="line">        <span class="keyword">if</span> (sMainLooper != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;The main Looper has already been prepared.&quot;</span>);</span><br><span class="line">        }</span><br><span class="line">        sMainLooper = myLooper();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5B83;&#x4F1A;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;Looper&#x540E;&#x5C06;&#x5176;&#x8D4B;&#x7ED9;sMainLooper&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x641C;&#x7D22;&#x4E0B;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x5728;&#x54EA;&#x91CC;&#x88AB;&#x8C03;&#x7528;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;AcitivityThread.java&#x4E2D;&#x7684;main&#x65B9;&#x6CD5;&#x4E2D;&#x6709;&#x8C03;&#x7528;&#x8BE5;&#x65B9;&#x6CD5;&#xFF1A;</p>
<figure class="highlight processing"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="keyword">String</span>[] args) {</span><br><span class="line">    <span class="comment">//.......</span></span><br><span class="line">    Looper.prepareMainLooper();</span><br><span class="line">    ActivityThread thread = <span class="keyword">new</span> ActivityThread();</span><br><span class="line">    thread.attach(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (sMainThreadHandler == <span class="keyword">null</span>) {</span><br><span class="line">        sMainThreadHandler = thread.getHandler();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">false</span>) {</span><br><span class="line">        Looper.myLooper().setMessageLogging(<span class="keyword">new</span></span><br><span class="line">                LogPrinter(Log.DEBUG, <span class="string">&quot;ActivityThread&quot;</span>));</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// End of event ActivityThreadMain.</span></span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">    Looper.<span class="built_in">loop</span>();</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Main thread loop unexpectedly exited&quot;</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5728;&#x8FD9;&#x91CC;&#x4E3B;&#x7EBF;&#x7A0B;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;Looper&#x5E76;&#x6DFB;&#x52A0;&#x5230;sThreadLocal&#x4E2D;&#x3002;</p>
<p>&#x53D1;&#x9001;Message&#xFF1A;<br>Handler&#x53D1;&#x9001;&#x6D88;&#x606F;&#x7684;&#x65B9;&#x5F0F;&#x6709;&#x5F88;&#x591A;&#x79CD;&#x6211;&#x4EEC;&#x4EE5;&#x6700;&#x7B80;&#x5355;&#x7684;sendMessage(Message msg)&#x6765;&#x4F5C;&#x4E3A;&#x5206;&#x6790;&#x5BF9;&#x8C61;&#xFF1A;</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="function"><span class="keyword">boolean</span> <span class="title">sendMessage</span><span class="params">(Message msg)</span></span>{</span><br><span class="line">    <span class="function"><span class="keyword">return</span> <span class="title">sendMessageDelayed</span><span class="params">(msg, <span class="number">0</span>)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x91CC;&#x4F1A;&#x8C03;&#x7528;sendMessageDelayed(Message msg, long delayMillis)&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x7B2C;&#x4E8C;&#x4E2A;&#x53C2;&#x6570;&#x4E3A;&#x5EF6;&#x8FDF;&#x65F6;&#x95F4;&#xFF1A;<br><figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="function"><span class="keyword">boolean</span> <span class="title">sendMessageDelayed</span><span class="params">(Message msg, <span class="keyword">long</span> delayMillis)</span></span><br><span class="line"></span>{</span><br><span class="line">    <span class="keyword">if</span> (delayMillis &lt; <span class="number">0</span>) {</span><br><span class="line">        delayMillis = <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> sendMessageAtTime(msg, SystemClock.uptimeMillis() + delayMillis);</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>sendMessageAtTime &#x4F1A;&#x8C03;&#x7528;enqueueMessage&#x65B9;&#x6CD5;&#x5C06;&#x6D88;&#x606F;&#x5165;&#x961F;<br><figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">sendMessageAtTime</span><span class="params">(Message msg, <span class="keyword">long</span> uptimeMillis)</span> </span>{</span><br><span class="line">    MessageQueue queue = mQueue;</span><br><span class="line">    <span class="keyword">if</span> (queue == <span class="keyword">null</span>) {</span><br><span class="line">        RuntimeException e = <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="keyword">this</span> + <span class="string">&quot; sendMessageAtTime() called with no mQueue&quot;</span>);</span><br><span class="line">        Log.w(<span class="string">&quot;Looper&quot;</span>, e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">return</span> <span class="title">enqueueMessage</span><span class="params">(queue, msg, uptimeMillis)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">boolean</span> <span class="title">enqueueMessage</span><span class="params">(MessageQueue queue, Message msg, <span class="keyword">long</span> uptimeMillis)</span> </span>{</span><br><span class="line">    msg.<span class="keyword">target</span> = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">if</span> (mAsynchronous) {</span><br><span class="line">        msg.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">return</span> queue.<span class="title">enqueueMessage</span><span class="params">(msg, uptimeMillis)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<figure class="highlight cs"><table><tr><td class="code"><pre><span class="line"><span class="function">boolean <span class="title">enqueueMessage</span>(<span class="params">Message msg, <span class="keyword">long</span> <span class="keyword">when</span></span>) </span>{</span><br><span class="line">    <span class="keyword">if</span> (msg.target == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Message must have a target.&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (msg.isInUse()) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(msg + <span class="string">&quot; This message is already in use.&quot;</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    synchronized (<span class="keyword">this</span>) {</span><br><span class="line">        <span class="keyword">if</span> (mQuitting) {</span><br><span class="line">            IllegalStateException e = <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                    msg.target + <span class="string">&quot; sending message to a Handler on a dead thread&quot;</span>);</span><br><span class="line">            Log.w(TAG, e.getMessage(), e);</span><br><span class="line">            msg.recycle();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        msg.markInUse();</span><br><span class="line">        msg.<span class="keyword">when</span> = <span class="keyword">when</span>;</span><br><span class="line">        Message p = mMessages;</span><br><span class="line">        boolean needWake;</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span> || <span class="keyword">when</span> == <span class="number">0</span> || <span class="keyword">when</span> &lt; p.<span class="keyword">when</span>) {</span><br><span class="line">            <span class="comment">// New head, wake up the event queue if blocked.</span></span><br><span class="line">            msg.next = p;</span><br><span class="line">            mMessages = msg;</span><br><span class="line">            needWake = mBlocked;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// Inserted within the middle of the queue.  Usually we don&apos;t have to wake</span></span><br><span class="line">            <span class="comment">// up the event queue unless there is a barrier at the head of the queue</span></span><br><span class="line">            <span class="comment">// and the message is the earliest asynchronous message in the queue.</span></span><br><span class="line">            needWake = mBlocked &amp;&amp; p.target == <span class="keyword">null</span> &amp;&amp; msg.isAsynchronous();</span><br><span class="line">            Message prev;</span><br><span class="line">            <span class="keyword">for</span> (;;) {</span><br><span class="line">                prev = p;</span><br><span class="line">                p = p.next;</span><br><span class="line">                <span class="keyword">if</span> (p == <span class="keyword">null</span> || <span class="keyword">when</span> &lt; p.<span class="keyword">when</span>) {</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">if</span> (needWake &amp;&amp; p.isAsynchronous()) {</span><br><span class="line">                    needWake = <span class="keyword">false</span>;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            msg.next = p; <span class="comment">// invariant: p == prev.next</span></span><br><span class="line">            prev.next = msg;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// We can assume mPtr != 0 because mQuitting is false.</span></span><br><span class="line">        <span class="keyword">if</span> (needWake) {</span><br><span class="line">            nativeWake(mPtr);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x4ECE;&#x4E0A;&#x9762;&#x4EE3;&#x7801;&#x4E2D;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x5F53;&#x6536;&#x5230;&#x4E00;&#x4E2A;Message&#x540E;&#x5C06;&#x4F1A;&#x904D;&#x5386;&#x6574;&#x4E2A;&#x6D88;&#x606F;&#x961F;&#x5217;&#xFF0C;&#x5E76;&#x5C06;&#x5F53;&#x524D;&#x6D88;&#x606F;&#x63D2;&#x5165;&#x6309;&#x7167;&#x65F6;&#x95F4;&#x6392;&#x5E8F;&#x597D;&#x7684;&#x961F;&#x5217;&#x4E2D;&#x3002;</p>
<p>&#x90A3;&#x4E48;&#x6D88;&#x606F;&#x5DF2;&#x7ECF;&#x8FDB;&#x5165;&#x961F;&#x5217;&#x4E86;&#xFF0C;&#x90A3;&#x4E48;&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x88AB;&#x8C03;&#x7528;&#x7684;&#x5462;&#xFF1F;&#x6211;&#x4EEC;&#x5728;&#x770B;AcitivityThread.java&#x4E2D;&#x7684;main&#x65B9;&#x6CD5;&#x7684;&#x65F6;&#x5019;&#x9664;&#x4E86;prepareMainLooer&#x5916;&#x5728;&#x6700;&#x540E;&#x8C03;&#x7528;&#x4E86;loop&#x65B9;&#x6CD5;&#x3002;&#x8FD9;&#x4E2A;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x6D88;&#x606F;&#x5FAA;&#x73AF;&#xFF0C;</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">final</span> Looper me = myLooper();</span><br><span class="line">    <span class="keyword">if</span> (me == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;No Looper; Looper.prepare() wasn&apos;t called on this thread.&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">final</span> MessageQueue queue = me.mQueue;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make sure the identity of this thread is that of the local process,</span></span><br><span class="line">    <span class="comment">// and keep track of what that identity token actually is.</span></span><br><span class="line">    Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) {</span><br><span class="line">        Message msg = queue.next(); <span class="comment">// might block</span></span><br><span class="line">        <span class="keyword">if</span> (msg == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="comment">// No message indicates that the message queue is quitting.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This must be in a local variable, in case a UI event sets the logger</span></span><br><span class="line">        Printer logging = me.mLogging;</span><br><span class="line">        <span class="keyword">if</span> (logging != <span class="keyword">null</span>) {</span><br><span class="line">            logging.println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt; Dispatching to &quot;</span> + msg.<span class="keyword">target</span> + <span class="string">&quot; &quot;</span> +</span><br><span class="line">                    msg.callback + <span class="string">&quot;: &quot;</span> + msg.what);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        msg.<span class="keyword">target</span>.dispatchMessage(msg);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (logging != <span class="keyword">null</span>) {</span><br><span class="line">            logging.println(<span class="string">&quot;&lt;&lt;&lt;&lt;&lt; Finished to &quot;</span> + msg.<span class="keyword">target</span> + <span class="string">&quot; &quot;</span> + msg.callback);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Make sure that during the course of dispatching the</span></span><br><span class="line">        <span class="comment">// identity of the thread wasn&apos;t corrupted.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> newIdent = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">if</span> (ident != newIdent) {</span><br><span class="line">            Log.wtf(TAG, <span class="string">&quot;Thread identity changed from 0x&quot;</span></span><br><span class="line">                    + Long.toHexString(ident) + <span class="string">&quot; to 0x&quot;</span></span><br><span class="line">                    + Long.toHexString(newIdent) + <span class="string">&quot; while dispatching to &quot;</span></span><br><span class="line">                    + msg.<span class="keyword">target</span>.getClass().getName() + <span class="string">&quot; &quot;</span></span><br><span class="line">                    + msg.callback + <span class="string">&quot; what=&quot;</span> + msg.what);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        msg.recycleUnchecked();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x5176;&#x5B9E;&#x4E0D;&#x96BE;&#xFF0C;&#x5F88;&#x5BB9;&#x6613;&#x627E;&#x5230;&#x5173;&#x952E;&#x4EE3;&#x7801;&#xFF1A;<br><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="tag">msg</span><span class="class">.target</span><span class="class">.dispatchMessage</span>(<span class="tag">msg</span>);</span><br></pre></td></tr></table></figure></p>
<p>msg.target &#x662F;&#x4EC0;&#x4E48;&#xFF1F;&#x5176;&#x5B9E;&#x5B83;&#x5C31;&#x662F;&#x5F80;MessageQueue&#x4E2D;post&#x6D88;&#x606F;&#x7684;&#x90A3;&#x4E2A;Handler&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;Looper&#x4F1A;&#x904D;&#x5386;&#x6574;&#x4E2A;&#x6D88;&#x606F;&#x961F;&#x5217;&#xFF0C;&#x627E;&#x5230;&#x6D88;&#x606F;&#x7684;Target&#x7136;&#x540E;&#x8C03;&#x7528;&#x5B83;&#x7684;dispatchMessage&#xFF0C;&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x4E0B;dispatchMessage&#x65B9;&#x6CD5;&#xFF0C;&#x5728;dispatchMessage&#x65B9;&#x6CD5;&#x4E2D;&#x8C03;&#x7528;&#x7684;&#x662F;handleMessage&#x8FD9;&#x4E2A;&#x56DE;&#x8C03;&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x5199;&#x7684;&#x90A3;&#x4E2A;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#x3002;</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">dispatchMessage</span><span class="params">(Message msg)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (msg.callback != <span class="keyword">null</span>) {</span><br><span class="line">        handleCallback(msg);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">if</span> (mCallback != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">if</span> (mCallback.handleMessage(msg)) {</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        handleMessage(msg);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8BFB;&#x5230;&#x8FD9;&#x91CC;&#x53EF;&#x80FD;&#x7EC6;&#x5FC3;&#x7684;&#x540C;&#x5B66;&#x4F1A;&#x7559;&#x610F;&#x5230;&#x90FD;&#x6CA1;&#x4ECB;&#x7ECD;&#x961F;&#x5217;&#x4E2D;&#x600E;&#x4E48;&#x51B3;&#x5B9A;&#x67D0;&#x4E2A;&#x6D88;&#x606F;&#x4F55;&#x65F6;&#x5904;&#x7406;&#xFF0C;&#x662F;&#x7684;&#xFF0C;&#x8FD9;&#x4E2A;&#x5176;&#x5B9E;&#x662F;&#x901A;&#x8FC7;&#x5728;loop&#x4E2D;&#x8C03;&#x7528;queue.next&#x8FDB;&#x884C;&#x51B3;&#x5B9A;&#x7684;&#x3002;</p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">Message <span class="keyword">next</span>() {</span><br><span class="line">    <span class="comment">// Return here if the message loop has already quit and been disposed.</span></span><br><span class="line">    <span class="comment">// This can happen if the application tries to restart a looper after quit</span></span><br><span class="line">    <span class="comment">// which is not supported.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> ptr = mPtr;</span><br><span class="line">    <span class="keyword">if</span> (ptr == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> pendingIdleHandlerCount = -<span class="number">1</span>; <span class="comment">// -1 only during first iteration</span></span><br><span class="line">    <span class="keyword">int</span> nextPollTimeoutMillis = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (;;) {</span><br><span class="line">        <span class="keyword">if</span> (nextPollTimeoutMillis != <span class="number">0</span>) {</span><br><span class="line">            Binder.flushPendingCommands();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        nativePollOnce(ptr, nextPollTimeoutMillis);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) {</span><br><span class="line">            <span class="comment">// Try to retrieve the next message.  Return if found.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line">            Message prevMsg = <span class="keyword">null</span>;</span><br><span class="line">            Message msg = mMessages;</span><br><span class="line">            <span class="keyword">if</span> (msg != <span class="keyword">null</span> &amp;&amp; msg.target == <span class="keyword">null</span>) {</span><br><span class="line">                <span class="comment">// Stalled by a barrier.  Find the next asynchronous message in the queue.</span></span><br><span class="line">                <span class="keyword">do</span> {</span><br><span class="line">                    prevMsg = msg;</span><br><span class="line">                    msg = msg.<span class="keyword">next</span>;</span><br><span class="line">                } <span class="keyword">while</span> (msg != <span class="keyword">null</span> &amp;&amp; !msg.isAsynchronous());</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (msg != <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">if</span> (now &lt; msg.when) {</span><br><span class="line">                    <span class="comment">// Next message is not ready.  Set a timeout to wake up when it is ready.</span></span><br><span class="line">                    nextPollTimeoutMillis = (<span class="keyword">int</span>) Math.min(msg.when - now, Integer.MAX_VALUE);</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    <span class="comment">// Got a message.</span></span><br><span class="line">                    mBlocked = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">if</span> (prevMsg != <span class="keyword">null</span>) {</span><br><span class="line">                        prevMsg.<span class="keyword">next</span> = msg.<span class="keyword">next</span>;</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        mMessages = msg.<span class="keyword">next</span>;</span><br><span class="line">                    }</span><br><span class="line">                    msg.<span class="keyword">next</span> = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">&quot;Returning message: &quot;</span> + msg);</span><br><span class="line">                    msg.markInUse();</span><br><span class="line">                    <span class="keyword">return</span> msg;</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// No more messages.</span></span><br><span class="line">                nextPollTimeoutMillis = -<span class="number">1</span>;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Process the quit message now that all pending messages have been handled.</span></span><br><span class="line">            <span class="keyword">if</span> (mQuitting) {</span><br><span class="line">                dispose();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If first time idle, then get the number of idlers to run.</span></span><br><span class="line">            <span class="comment">// Idle handles only run if the queue is empty or if the first message</span></span><br><span class="line">            <span class="comment">// in the queue (possibly a barrier) is due to be handled in the future.</span></span><br><span class="line">            <span class="keyword">if</span> (pendingIdleHandlerCount &lt; <span class="number">0</span></span><br><span class="line">                    &amp;&amp; (mMessages == <span class="keyword">null</span> || now &lt; mMessages.when)) {</span><br><span class="line">                pendingIdleHandlerCount = mIdleHandlers.<span class="keyword">size</span>();</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (pendingIdleHandlerCount &lt;= <span class="number">0</span>) {</span><br><span class="line">                <span class="comment">// No idle handlers to run.  Loop and wait some more.</span></span><br><span class="line">                mBlocked = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mPendingIdleHandlers == <span class="keyword">null</span>) {</span><br><span class="line">                mPendingIdleHandlers = <span class="keyword">new</span> IdleHandler[Math.max(pendingIdleHandlerCount, <span class="number">4</span>)];</span><br><span class="line">            }</span><br><span class="line">            mPendingIdleHandlers = mIdleHandlers.toArray(mPendingIdleHandlers);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Run the idle handlers.</span></span><br><span class="line">        <span class="comment">// We only ever reach this code block during the first iteration.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pendingIdleHandlerCount; i++) {</span><br><span class="line">            <span class="keyword">final</span> IdleHandler idler = mPendingIdleHandlers[i];</span><br><span class="line">            mPendingIdleHandlers[i] = <span class="keyword">null</span>; <span class="comment">// release the reference to the handler</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> keep = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                keep = idler.queueIdle();</span><br><span class="line">            } <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line">                Log.wtf(TAG, <span class="string">&quot;IdleHandler threw exception&quot;</span>, t);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!keep) {</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="keyword">this</span>) {</span><br><span class="line">                    mIdleHandlers.remove(idler);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Reset the idle handler count to 0 so we do not run them again.</span></span><br><span class="line">        pendingIdleHandlerCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// While calling an idle handler, a new message could have been delivered</span></span><br><span class="line">        <span class="comment">// so go back and look again for a pending message without waiting.</span></span><br><span class="line">        nextPollTimeoutMillis = <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x91CC;&#x7684;&#x4EE3;&#x7801;&#x5F88;&#x957F;&#xFF0C;&#x4F46;&#x662F;&#x5176;&#x5B9E;&#x5173;&#x952E;&#x7684;&#x903B;&#x8F91;&#x4E0D;&#x96BE;&#xFF0C;&#x5B83;&#x5C31;&#x662F;&#x5728;&#x4E00;&#x6BB5;&#x65F6;&#x95F4;&#x5185;&#x4F1A;&#x53BB;&#x7F16;&#x5386;&#x6574;&#x4E2A;&#x6D88;&#x606F;&#x961F;&#x5217;&#xFF0C;&#x67E5;&#x770B;Message&#x4E2D;&#x7684;when&#x5B57;&#x6BB5;&#xFF0C;&#x5E76;&#x548C;&#x5F53;&#x524D;&#x7684;&#x65F6;&#x95F4;&#x8FDB;&#x884C;&#x6BD4;&#x5BF9;&#xFF0C;&#x5982;&#x679C;&#x8FBE;&#x5230;&#x8981;&#x53D1;&#x9001;&#x7684;&#x65F6;&#x523B;&#x90A3;&#x4E48;&#x5C31;&#x8FD4;&#x56DE;&#x8FD9;&#x4E2A;Message&#x7ED9;Looper&#x3002;&#x5230;&#x6B64;&#x6574;&#x4E2A;Handler&#x6E90;&#x4EE3;&#x7801;&#x5B66;&#x4E60;&#x544A;&#x4E00;&#x4E2A;&#x5C0F;&#x6BB5;&#x843D;&#x3002;&#x6211;&#x4EEC;&#x6765;&#x56DE;&#x987E;&#x4E0B;&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#xFF1A;</p>
<p>&#x9996;&#x5148;&#x5728;AcitivityThread.java&#x7684;main&#x65B9;&#x6CD5;&#x4E2D;&#x4F1A;&#x8C03;&#x7528;Looper.prepareMainLooper();&#x521B;&#x5EFA;&#x4E00;&#x4E2A;MainLooper&#xFF0C;&#x7136;&#x540E;&#x8C03;&#x7528;Looper.loop();&#x5F00;&#x542F;&#x6D88;&#x606F;&#x5FAA;&#x73AF;&#xFF0C;&#x8FD9;&#x65F6;&#x5019;&#x5C31;&#x53EF;&#x4EE5;&#x5141;&#x8BB8;Hanlder&#x5F80;&#x4E3B;&#x6D88;&#x606F;&#x961F;&#x5217;&#x6295;&#x9012;&#x6D88;&#x606F;&#x4E86;&#xFF0C;&#x6211;&#x4EEC;&#x5728;&#x4E3B;&#x7EBF;&#x7A0B;&#x4E2D;&#x521B;&#x5EFA;Hanlder&#xFF0C;&#x5728;&#x5B50;&#x7EBF;&#x7A0B;&#x4E2D;&#x5904;&#x7406;&#x5B8C;&#x8017;&#x65F6;&#x64CD;&#x4F5C;&#x540E;&#x5C31;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;Handler&#x5B8C;MainLooper&#x4E2D;sentMessage&#xFF0C;&#x8FD9;&#x4E9B;&#x6D88;&#x606F;&#x4F1A;&#x901A;&#x8FC7;&#x8C03;&#x7528;enqueueMessage&#x52A0;&#x5165;&#x5230;&#x6D88;&#x606F;&#x961F;&#x5217;&#x4E2D;&#xFF0C;&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x7684;Message&#x6301;&#x6709;Handler&#x7684;&#x5F15;&#x7528;&#xFF0C;&#x8FD9;&#x4E5F;&#x662F;&#x4E3A;&#x4EC0;&#x4E48;&#x9700;&#x8981;&#x5C06;&#x533F;&#x540D;&#x5185;&#x90E8;&#x7C7B;&#xFF0C;&#x9759;&#x6001;&#x5185;&#x90E8;&#x7C7B;&#x7684;Handler&#x8BBE;&#x7F6E;&#x4E3A;static&#x7684;&#x539F;&#x56E0;&#x4E86;&#xFF0C;&#x5426;&#x5219;Handler&#x4F1A;&#x6301;&#x6709;&#x5916;&#x90E8;&#x7C7B;&#x7684;&#x5F15;&#x7528;&#xFF0C;&#x90A3;&#x4E48;&#x53EA;&#x8981;&#x6D88;&#x606F;&#x6CA1;&#x53CA;&#x65F6;&#x5904;&#x7406;&#xFF0C;Handler&#x6240;&#x5728;&#x7684;Activity&#x6216;&#x8005;Service&#x4E00;&#x65E6;&#x9000;&#x51FA;&#x4E86;&#x5C31;&#x4F1A;&#x9020;&#x6210;&#x5185;&#x5B58;&#x6CC4;&#x9732;&#x3002;<br>&#x63A5;&#x4E0B;&#x6765;&#x5728;Looper.looper&#x4E2D;&#x4F1A;&#x5B9A;&#x671F;&#x67E5;&#x770B;&#x6BCF;&#x4E2A;&#x6D88;&#x606F;&#xFF0C;&#x5982;&#x679C;&#x65F6;&#x95F4;&#x5230;&#x4E86;&#x5C31;&#x4F1A;&#x8C03;&#x7528;&#x6D88;&#x606F;&#x6240;&#x7ED1;&#x5B9A;Handler&#x7684;dispatchMessage&#x65B9;&#x6CD5;&#x3002;&#x5728;&#x8BE5;&#x65B9;&#x6CD5;&#x4E2D;&#x8C03;&#x7528;&#x6211;&#x4EEC;&#x5B9E;&#x73B0;&#x7684;handleMessage&#x3002;</p>
<p>&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF1A;</p>
<p><img src="/2016/07/28/Android-&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;Handler-MessageQueue-Looper/2.png" alt=""></p>
<p>&#x518D;&#x6765;&#x7AD9;&#x5728;&#x5168;&#x5C40;&#x7684;&#x89D2;&#x5EA6;&#x6765;&#x4E00;&#x5F20;&#x56FE;&#xFF1A;</p>
<p><img src="/2016/07/28/Android-&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;Handler-MessageQueue-Looper/1.png" alt=""></p>
<p>&#x90A3;&#x4E48;&#x5B50;&#x7EBF;&#x7A0B;&#x53EF;&#x4EE5;&#x6709;&#x5904;&#x7406;&#x6D88;&#x606F;&#x7684;&#x80FD;&#x529B;&#x5417;&#xFF0C;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x6211;&#x4EEC;&#x5176;&#x5B9E;&#x5728;&#x4E0A;&#x9762;&#x5DF2;&#x7ECF;&#x8BF4;&#x8FC7;&#x4E86;&#xFF0C;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x662F;&#x6CA1;&#x6709;&#x7684;&#xFF0C;&#x56E0;&#x4E3A;&#x6CA1;&#x6709;Looper&#xFF0C;&#x4F46;&#x662F;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4E3A;&#x4E00;&#x4E2A;&#x5B50;&#x7EBF;&#x7A0B;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;Looper&#x8FD9;&#x6837;&#x5C31;&#x6709;&#x4E86;&#x6D88;&#x606F;&#x5904;&#x7406;&#x7684;&#x80FD;&#x529B;&#x4E86;&#x3002;<br><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NonMainThread</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">Thread</span> {</span></span><br><span class="line">      public <span class="type">Handler</span> mHandler;</span><br><span class="line">      public void run() {</span><br><span class="line">          <span class="type">Looper</span>.prepare();</span><br><span class="line">          mHandler = <span class="keyword">new</span> <span class="type">Handler</span>() {</span><br><span class="line">              public void handleMessage(<span class="type">Message</span> msg) {</span><br><span class="line">                  <span class="comment">// process incoming messages here</span></span><br><span class="line">              }</span><br><span class="line">          };</span><br><span class="line">          <span class="type">Looper</span>.loop();</span><br><span class="line">      }</span><br><span class="line">  }</span><br></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android-源码分析/">Android 源码分析</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/AOSP-源码/">AOSP 源码</a>
  </div>

</div>



<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/07/28/Android-源码分析之Handler-MessageQueue-Looper/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/07/28/Android-源码分析之Handler-MessageQueue-Looper/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/07/27/Android-源码分析之ListView/" title="Android-源码分析之ListView" itemprop="url">Android-源码分析之ListView</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Edgar" target="_blank" itemprop="author">Edgar</a>
		
  <p class="article-time">
    <time datetime="2016-07-27T02:52:44.000Z" itemprop="datePublished"> 發表於 2016-07-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>&#x5728;&#x4E4B;&#x524D;&#x7684;&#x535A;&#x5BA2;&#x5DF2;&#x7ECF;&#x4ECB;&#x7ECD;&#x4E86;ListView&#x548C;Adapter&#x4E86;&#xFF0C;&#x4F46;&#x662F;&#x4E4B;&#x524D;&#x7BC7;&#x6587;&#x7AE0;&#x53EA;&#x662F;&#x7740;&#x773C;&#x4E8E;&#x57FA;&#x672C;&#x7684;&#x4F7F;&#x7528;&#x5E76;&#x6CA1;&#x6709;&#x8BB2;&#x5230;&#x5177;&#x4F53;&#x7684;&#x80CC;&#x540E;&#x7684;&#x539F;&#x7406;&#xFF0C;&#x8FD9;&#x7BC7;&#x535A;&#x5BA2;&#x5C06;&#x4F1A;&#x4EE3;&#x5927;&#x5BB6;&#x8FC7;&#x4E0B;ListView&#x7684;&#x6E90;&#x4EE3;&#x7801;&#xFF0C;&#x8BA9;&#x5927;&#x5BB6;&#x4E86;&#x89E3;&#x4E0B;&#x6574;&#x4E2A;&#x539F;&#x7406;&#xFF1A;&#x91CD;&#x70B9;&#x662F;ListView &#x7F13;&#x5B58;&#x673A;&#x5236;</p>
<h5 id="ListView-&#x7F13;&#x5B58;&#x673A;&#x5236;&#x7684;&#x5B9E;&#x73B0;"><a href="#ListView-&#x7F13;&#x5B58;&#x673A;&#x5236;&#x7684;&#x5B9E;&#x73B0;" class="headerlink" title="ListView &#x7F13;&#x5B58;&#x673A;&#x5236;&#x7684;&#x5B9E;&#x73B0;"></a>ListView &#x7F13;&#x5B58;&#x673A;&#x5236;&#x7684;&#x5B9E;&#x73B0;</h5><h6 id="RecycleBin&#x539F;&#x7406;&#x6982;&#x8FF0;"><a href="#RecycleBin&#x539F;&#x7406;&#x6982;&#x8FF0;" class="headerlink" title="RecycleBin&#x539F;&#x7406;&#x6982;&#x8FF0;"></a>RecycleBin&#x539F;&#x7406;&#x6982;&#x8FF0;</h6><p>&#x5728;&#x4ECB;&#x7ECD;RecycleBin&#x539F;&#x7406;&#x4E4B;&#x524D;&#x6211;&#x4EEC;&#x5148;&#x6765;&#x4ECB;&#x7ECD;&#x4E24;&#x4E2A;&#x5BF9;&#x8C61;&#xFF0C;ActiveView&#x548C;ScrapView&#x3002;&#x6211;&#x4EEC;&#x77E5;&#x9053;ListView&#x4E2D;&#x5305;&#x542B;&#x4E24;&#x7C7B;&#x5B50;View&#xFF0C;&#x4E00;&#x7C7B;&#x662F;&#x53EF;&#x89C1;&#x7684;&#xFF0C;&#x663E;&#x793A;&#x5728;&#x5C4F;&#x5E55;&#x4E0A;&#x7684;&#xFF0C;&#x8FD9;&#x4E2A;&#x5C31;&#x662F;ActiveView&#xFF0C;&#x53E6;&#x4E00;&#x7C7B;&#x662F;&#x4E0D;&#x53EF;&#x89C1;&#x7684;&#x8FD9;&#x4E9B;&#x88AB;&#x79F0;&#x4E3A;ScrapView&#xFF08;Scrap&#x8868;&#x793A;&#x5E9F;&#x5F03;&#x7684;&#x610F;&#x601D;&#xFF09;ListView&#x4F1A;&#x628A;ScrapView&#x5220;&#x9664;&#x7684;&#x540C;&#x65F6;&#x653E;&#x5165;&#x5230;RecycleBin&#x4E2D;&#x7F13;&#x5B58;&#x8D77;&#x6765;&#x3002;&#x5F53;&#x6211;&#x4EEC;&#x6ED1;&#x52A8;ListView&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5C31;&#x4F1A;&#x5BFC;&#x81F4;&#x6709;&#x4E00;&#x90E8;&#x5206;&#x5143;&#x7D20;&#x8FDB;&#x5165;&#x5C4F;&#x5E55;&#xFF0C;&#x4E00;&#x4E9B;item&#x4ECE;&#x5C4F;&#x5E55;&#x4E2D;&#x79FB;&#x51FA;&#xFF0C;&#x5728;&#x79FB;&#x5165;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x4ECE;RecycleBin&#x4E2D;&#x53D6;&#x51FA;&#x4E00;&#x4E2A;ScrapView&#xFF0C;&#x5C06;&#x5176;&#x4F5C;&#x4E3A;convertView&#x53C2;&#x6570;&#x4F20;&#x9012;&#x7ED9;Adapter&#x7684;getView&#x65B9;&#x6CD5;&#xFF0C;&#x4ECE;&#x800C;&#x8FBE;&#x5230;View&#x590D;&#x7528;&#x7684;&#x76EE;&#x7684;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x4E0D;&#x5FC5;&#x5728;Adapter&#x7684;getView&#x65B9;&#x6CD5;&#x4E2D;&#x6267;&#x884C; LayoutInflater.inflate()&#x65B9;&#x6CD5;&#x4E86;&#xFF0C;&#x4ECE;&#x800C;&#x5927;&#x5927;&#x63D0;&#x9AD8;&#x6574;&#x4E2A;&#x6027;&#x80FD;&#xFF0C;&#x5728;&#x7F16;&#x7A0B;&#x7684;&#x4E16;&#x754C;&#x4E2D;&#x6709;&#x4E24;&#x4E2A;&#x4E1C;&#x897F;&#x4E00;&#x76F4;&#x662F;&#x77DB;&#x76FE;&#x7684;&#x90A3;&#x5C31;&#x662F;&#x65F6;&#x95F4;&#x548C;&#x7A7A;&#x95F4;&#xFF0C;&#x800C;ListView&#x4E2D;&#x5728;&#x8FD9;&#x4E24;&#x8005;&#x4E4B;&#x95F4;&#x505A;&#x4E86;&#x5F88;&#x597D;&#x7684;&#x5E73;&#x8861;&#xFF0C;&#x4E2A;&#x4EBA;&#x89C9;&#x5F97;&#x4E4B;&#x6240;&#x4EE5;&#x53EF;&#x4EE5;&#x505A;&#x5230;&#x8FD9;&#x70B9;&#x8FD8;&#x4F9D;&#x8D56;&#x4E8E;ListView item&#x7684;&#x4E00;&#x4E2A;&#x7279;&#x6027;&#xFF0C;&#x90A3;&#x5C31;&#x662F;&#x6BCF;&#x4E2A;item&#x7684;&#x5E03;&#x5C40;&#x662F;&#x4E00;&#x81F4;&#x7684;&#x53EA;&#x4E0D;&#x8FC7;&#x6362;&#x4E86;&#x5185;&#x5BB9;&#x3002;</p>
<p><img src="/2016/07/27/Android-&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;ListView/1.png" alt=""></p>
<figure class="highlight zephir"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RecycleBin</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Views that were on screen at the start of layout. This array is populated at the start of</span><br><span class="line">     * layout, and at the end of layout all view in mActiveViews are moved to mScrapViews.</span><br><span class="line">     * Views in mActiveViews represent a contiguous range of Views, with position of the first</span><br><span class="line">     * view store in mFirstActivePosition.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> View[] mActiveViews = <span class="keyword">new</span> View[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Unsorted views that can be used by the adapter as a convert view.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> ArrayList&lt;View&gt;[] mScrapViews;</span><br><span class="line">	<span class="comment">//.....</span></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Fill ActiveViews with all of the children of the AbsListView.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> childCount The minimum number of views mActiveViews should hold</span><br><span class="line">     * <span class="doctag">@param</span> firstActivePosition The position of the first view that will be stored in</span><br><span class="line">     *        mActiveViews</span><br><span class="line">     */</span></span><br><span class="line">    void fillActiveViews(<span class="keyword">int</span> childCount, <span class="keyword">int</span> firstActivePosition) {</span><br><span class="line">        <span class="keyword">if</span> (mActiveViews.length &lt; childCount) {</span><br><span class="line">            mActiveViews = <span class="keyword">new</span> View[childCount];</span><br><span class="line">        }</span><br><span class="line">        mFirstActivePosition = firstActivePosition;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//noinspection MismatchedReadAndWriteOfArray</span></span><br><span class="line">        <span class="keyword">final</span> View[] activeViews = mActiveViews;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) {</span><br><span class="line">            View child = getChildAt(i);</span><br><span class="line">            AbsListView.LayoutParams lp = (AbsListView.LayoutParams) child.getLayoutParams();</span><br><span class="line">            <span class="comment">// Don&apos;t put header or footer views into the scrap heap</span></span><br><span class="line">            <span class="keyword">if</span> (lp != <span class="keyword">null</span> &amp;&amp; lp.viewType != ITEM_VIEW_TYPE_HEADER_OR_FOOTER) {</span><br><span class="line">                <span class="comment">// <span class="doctag">Note:</span>  We do place AdapterView.ITEM_VIEW_TYPE_IGNORE in active views.</span></span><br><span class="line">                <span class="comment">//        However, we will NOT place them into scrap views.</span></span><br><span class="line">                activeViews[i] = child;</span><br><span class="line">                <span class="comment">// Remember the position so that setupChild() doesn&apos;t reset state.</span></span><br><span class="line">                lp.scrappedFromPosition = firstActivePosition + i;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Get the view corresponding to the specified position. The view will be removed from</span><br><span class="line">     * mActiveViews if it is found.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> position The position to look up in mActiveViews</span><br><span class="line">     * <span class="doctag">@return</span> The view if it is found, null otherwise</span><br><span class="line">     */</span></span><br><span class="line">    View getActiveView(<span class="keyword">int</span> position) {</span><br><span class="line">        <span class="keyword">int</span> index = position - mFirstActivePosition;</span><br><span class="line">        <span class="keyword">final</span> View[] activeViews = mActiveViews;</span><br><span class="line">        <span class="keyword">if</span> (index &gt;=<span class="number">0</span> &amp;&amp; index &lt; activeViews.length) {</span><br><span class="line">            <span class="keyword">final</span> View match = activeViews[index];</span><br><span class="line">            activeViews[index] = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">return</span> match;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@return</span> A view from the ScrapViews collection. These are unordered.</span><br><span class="line">     */</span></span><br><span class="line">    View getScrapView(<span class="keyword">int</span> position) {</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> whichScrap = mAdapter.getItemViewType(position);</span><br><span class="line">        <span class="keyword">if</span> (whichScrap &lt; <span class="number">0</span>) {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (mViewTypeCount == <span class="number">1</span>) {</span><br><span class="line">            <span class="keyword">return</span> retrieveFromScrap(mCurrentScrap, position);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (whichScrap &lt; mScrapViews.length) {</span><br><span class="line">            <span class="keyword">return</span> retrieveFromScrap(mScrapViews[whichScrap], position);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Puts a view into the list of scrap views.</span><br><span class="line">     * &lt;p&gt;</span><br><span class="line">     * If the list data hasn&apos;t changed or the adapter has stable IDs, views</span><br><span class="line">     * with transient state will be preserved for later retrieval.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> scrap The view to add</span><br><span class="line">     * <span class="doctag">@param</span> position The view&apos;s position within its parent</span><br><span class="line">     */</span></span><br><span class="line">    void addScrapView(View scrap, <span class="keyword">int</span> position) {</span><br><span class="line">        <span class="keyword">final</span> AbsListView.LayoutParams lp = (AbsListView.LayoutParams) scrap.getLayoutParams();</span><br><span class="line">        <span class="keyword">if</span> (lp == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="comment">// Can&apos;t recycle, but we don&apos;t know anything about the view.</span></span><br><span class="line">            <span class="comment">// Ignore it completely.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        lp.scrappedFromPosition = position;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Remove but don&apos;t scrap header or footer views, or views that</span></span><br><span class="line">        <span class="comment">// should otherwise not be recycled.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> viewType = lp.viewType;</span><br><span class="line">        <span class="keyword">if</span> (!shouldRecycleViewType(viewType)) {</span><br><span class="line">            <span class="comment">// Can&apos;t recycle. If it&apos;s not a header or footer, which have</span></span><br><span class="line">            <span class="comment">// special handling and should be ignored, then skip the scrap</span></span><br><span class="line">            <span class="comment">// heap and we&apos;ll fully detach the view later.</span></span><br><span class="line">            <span class="keyword">if</span> (viewType != ITEM_VIEW_TYPE_HEADER_OR_FOOTER) {</span><br><span class="line">                getSkippedScrap().add(scrap);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        scrap.dispatchStartTemporaryDetach();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The the accessibility state of the view may change while temporary</span></span><br><span class="line">        <span class="comment">// detached and we do not allow detached views to fire accessibility</span></span><br><span class="line">        <span class="comment">// events. So we are announcing that the subtree changed giving a chance</span></span><br><span class="line">        <span class="comment">// to clients holding on to a view in this subtree to refresh it.</span></span><br><span class="line">        notifyViewAccessibilityStateChangedIfNeeded(</span><br><span class="line">                AccessibilityEvent.CONTENT_CHANGE_TYPE_SUBTREE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Don&apos;t scrap views that have transient state.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> scrapHasTransientState = scrap.hasTransientState();</span><br><span class="line">        <span class="keyword">if</span> (scrapHasTransientState) {</span><br><span class="line">            <span class="keyword">if</span> (mAdapter != <span class="keyword">null</span> &amp;&amp; mAdapterHasStableIds) {</span><br><span class="line">                <span class="comment">// If the adapter has stable IDs, we can reuse the view for</span></span><br><span class="line">                <span class="comment">// the same data.</span></span><br><span class="line">                <span class="keyword">if</span> (mTransientStateViewsById == <span class="keyword">null</span>) {</span><br><span class="line">                    mTransientStateViewsById = <span class="keyword">new</span> LongSparseArray&lt;&gt;();</span><br><span class="line">                }</span><br><span class="line">                mTransientStateViewsById.put(lp.itemId, scrap);</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (!mDataChanged) {</span><br><span class="line">                <span class="comment">// If the data hasn&apos;t changed, we can reuse the views at</span></span><br><span class="line">                <span class="comment">// their old positions.</span></span><br><span class="line">                <span class="keyword">if</span> (mTransientStateViews == <span class="keyword">null</span>) {</span><br><span class="line">                    mTransientStateViews = <span class="keyword">new</span> SparseArray&lt;&gt;();</span><br><span class="line">                }</span><br><span class="line">                mTransientStateViews.put(position, scrap);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// Otherwise, we&apos;ll have to remove the view and start over.</span></span><br><span class="line">                getSkippedScrap().add(scrap);</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">if</span> (mViewTypeCount == <span class="number">1</span>) {</span><br><span class="line">                mCurrentScrap.add(scrap);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                mScrapViews[viewType].add(scrap);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mRecyclerListener != <span class="keyword">null</span>) {</span><br><span class="line">                mRecyclerListener.onMovedToScrapHeap(scrap);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>RecycleBin&#x7684;&#x4EE3;&#x7801;&#x4E0D;&#x662F;&#x5F88;&#x5927;&#x4F46;&#x662F;&#x5168;&#x90E8;&#x5728;&#x535A;&#x5BA2;&#x8BB2;&#x89E3;&#x6BCF;&#x4E2A;&#x7EC6;&#x8282;&#x4E00;&#x6765;&#x81EA;&#x5DF1;&#x4E5F;&#x4E0D;&#x662F;&#x5B8C;&#x5168;&#x61C2;&#x6BCF;&#x4E2A;&#x7EC6;&#x8282;&#xFF0C;&#x800C;&#x4E14;&#x592A;&#x5173;&#x6CE8;&#x7EC6;&#x8282;&#x6211;&#x4EEC;&#x5E38;&#x5E38;&#x4F1A;&#x9677;&#x5165;&#x7EC6;&#x8282;&#x800C;&#x770B;&#x4E0D;&#x5230;&#x6574;&#x4E2A;&#x539F;&#x7406;&#xFF0C;&#x6240;&#x4EE5;&#x5728;&#x5206;&#x6790;&#x6E90;&#x4EE3;&#x7801;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x7B2C;&#x4E00;&#x6B21;&#x4E0D;&#x8981;&#x592A;&#x7EA0;&#x7ED3;&#x7EC6;&#x8282;&#xFF0C;&#x7B49;&#x5230;&#x540E;&#x9762;&#x6709;&#x7591;&#x95EE;&#x6216;&#x8005;&#x9047;&#x5230;&#x95EE;&#x9898;&#x9700;&#x8981;&#x89E3;&#x51B3;&#x7684;&#x65F6;&#x5019;&#x5728;&#x8BA4;&#x771F;&#x5206;&#x6790;&#x5BF9;&#x5E94;&#x7684;&#x7EC6;&#x8282;&#x3002;<br>&#x597D;&#x4E86;&#x8A00;&#x5F52;&#x6B63;&#x4F20;&#xFF0C;&#x6211;&#x4EEC;&#x4E0A;&#x9762;&#x8D34;&#x51FA;&#x4E86;RecycleBin&#x7684;&#x5173;&#x952E;&#x4EE3;&#x7801;&#xFF0C;&#x6B63;&#x5982;&#x4E0A;&#x9762;&#x4ECB;&#x7ECD;&#x7684;RecycleBin&#x5305;&#x542B;mActiveViews&#xFF0C;&#x4EE5;&#x53CA;mScrapViews&#x8FD9;&#x4E24;&#x4E2A;&#x4E3B;&#x8981;&#x6210;&#x5458;&#x53D8;&#x91CF;&#xFF0C;&#x8FD9;&#x91CC;&#x518D;&#x63D2;&#x5165;&#x4E00;&#x4E2A;&#x5206;&#x6790;&#x6E90;&#x4EE3;&#x7801;&#x7684;&#x65B9;&#x6CD5;&#x5C31;&#x662F;&#xFF1A;&#x5728;&#x5B66;&#x4E60;&#x6E90;&#x4EE3;&#x7801;&#x7684;&#x65F6;&#x5019;&#x5148;&#x770B;&#x82F1;&#x6587;&#x6CE8;&#x91CA;&#xFF0C;&#x4E00;&#x822C;Android&#x4EE3;&#x7801;&#x4E2D;&#x5927;&#x90E8;&#x5206;&#x90FD;&#x6709;&#x6BD4;&#x8F83;&#x8BE6;&#x7EC6;&#x7684;&#x6CE8;&#x91CA;&#x7684;&#xFF0C;&#x901A;&#x8FC7;&#x8FD9;&#x4E9B;&#x6CE8;&#x91CA;&#x5F80;&#x5F80;&#x4F1A;&#x5FEB;&#x901F;&#x4E86;&#x89E3;&#x8FD9;&#x4E1C;&#x897F;&#x5230;&#x5E95;&#x662F;&#x5E72;&#x5417;&#x7684;&#xFF0C;&#x5230;&#x5E95;&#x8981;&#x4E0D;&#x8981;&#x7EE7;&#x7EED;&#x6DF1;&#x5165;&#x770B;&#x4E0B;&#x53BB;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x770B;&#x4E0B;mActiveViews &#x7684;&#x6CE8;&#x91CA;&#xFF1A;</p>
<blockquote>
<p>Views that were on screen at the start of layout. This array is populated at the start of layout, and at the end of layout all view in mActiveViews are moved to mScrapViews.Views in mActiveViews represent a contiguous range of Views, with position of the first view store in mFirstActivePosition.</p>
</blockquote>
<p>&#x5927;&#x4F53;&#x7684;&#x610F;&#x601D;&#x5C31;&#x662F;&#x5B83;&#x7528;&#x4E8E;&#x5B58;&#x653E;&#x7684;&#x662F;&#x5728;&#x6BCF;&#x6B21;&#x5F00;&#x59CB;&#x5E03;&#x5C40;&#x4E4B;&#x524D;&#x4F4D;&#x4E8E;&#x5C4F;&#x5E55;&#x4E0A;&#x7684;&#x90A3;&#x4E9B;item View&#xFF0C;&#x5728;&#x5E03;&#x5C40;&#x7ED3;&#x675F;&#x540E;&#x6240;&#x6709;&#x5B58;&#x5728;&#x4E8E;mActiveViews&#x7684;item View&#x90FD;&#x4F1A;&#x79FB;&#x5230;mScrapViews&#xFF0C;mActiveViews&#x5B58;&#x653E;&#x7684;&#x5185;&#x5BB9;&#x662F;&#x8FDE;&#x7EED;&#x7684;&#x4ECE;mFirstActivePosition&#x4F4D;&#x7F6E;&#x5F00;&#x59CB;&#x5230;&#x5C4F;&#x5E55;&#x6240;&#x80FD;&#x663E;&#x793A;&#x4E0B;&#x7684;&#x6700;&#x5927;item&#x6570;&#x76EE;&#x3002;</p>
<p>&#x90A3;&#x4E48;mScrapViews &#x53C8;&#x662F;&#x4EC0;&#x4E48;&#x5462;&#xFF1F;</p>
<blockquote>
<p>Unsorted views that can be used by the adapter as a convert view.</p>
</blockquote>
<p>&#x4ECE;&#x6CE8;&#x91CA;&#x4E2D;&#x53EF;&#x4EE5;&#x4E86;&#x89E3;&#x5230;&#x5B83;&#x662F;&#x4E00;&#x4E2A;&#x65E0;&#x5E8F;&#x6392;&#x5217;&#x7684;&#x5217;&#x8868;&#xFF0C;&#x8FD9;&#x4E9B;&#x89C6;&#x56FE;&#x53EF;&#x4EE5;&#x88AB;&#x4F20;&#x5165;Adapter&#x4E2D;&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;convert view.</p>
<ul>
<li>fillActiveViews &#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7528;&#x4E8E;&#x5C06;AbsListView&#x6240;&#x6709;&#x7684;&#x5B50;item &#x6DFB;&#x52A0;&#x5230;ActiveViews&#x4E2D;&#xFF0C;&#x5B83;&#x63A5;&#x6536;&#x4E24;&#x4E2A;&#x53C2;&#x6570;childCount&#x8868;&#x793A;&#x5C4F;&#x5E55;&#x663E;&#x793A;&#x7684;&#x5B50;item&#x7684;&#x6570;&#x76EE;&#xFF0C;firstActivePosition&#x8868;&#x793A;&#x5C4F;&#x5E55;&#x4E0A;&#x7B2C;&#x4E00;&#x4E2A;item&#x7684;&#x4F4D;&#x7F6E;&#x3002;&#x8FD9;&#x4E2A;&#x5F88;&#x7B80;&#x5355;&#x3002;</li>
<li>getActiveView &#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x5C06;&#x4F1A;&#x4F20;&#x5165;&#x4F4D;&#x7F6E;&#x53C2;&#x6570;&#xFF0C;&#x7136;&#x540E;&#x5C06;&#x4F1A;&#x4ECE;mActiveViews&#x4E2D;&#x5BFB;&#x627E;&#x5E76;&#x53D6;&#x51FA;item View&#xFF0C;&#x5982;&#x679C;&#x627E;&#x5230;&#x5728;mActiveViews&#x4E2D;&#x5BF9;&#x5E94;&#x7684;&#x8FD9;&#x4E2A;&#x4F4D;&#x7F6E;View&#x5C06;&#x4F1A;&#x88AB;&#x7F6E;&#x4E3A;null</li>
<li>addScrapView &#x8FD9;&#x4E2A;&#x4EE3;&#x7801;&#x6BD4;&#x8F83;&#x591A;&#xFF0C;&#x4F46;&#x662F;&#x6240;&#x5904;&#x7406;&#x7684;&#x4EFB;&#x52A1;&#x5F88;&#x7B80;&#x5355;&#x5C31;&#x662F;&#x5C06;&#x5E9F;&#x5F03;&#x7684;View&#x6DFB;&#x52A0;&#x5230;mScrapViews&#x4E2D;&#xFF0C;getScrapView&#x76F8;&#x53CD;&#x5C31;&#x662F;&#x4ECE;ScrapView&#x4E2D;&#x53D6;&#x51FA;view&#x3002;</li>
</ul>
<p>&#x5927;&#x5BB6;&#x770B;&#x5B8C;&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x662F;&#x4E0D;&#x662F;&#x548C;&#x6211;&#x6709;&#x4E00;&#x6837;&#x7684;&#x611F;&#x89C9;&#xFF0C;&#x8FD9;&#x4EE3;&#x7801;&#x6709;&#x5565;&#x8425;&#x517B;&#xFF1F;&#x786E;&#x5B9E;&#x5982;&#x679C;&#x4E0D;&#x7ED3;&#x5408;ListView&#x4EE3;&#x7801;&#x6765;&#x5206;&#x6790;&#xFF0C;&#x662F;&#x5B8C;&#x5168;&#x770B;&#x4E0D;&#x51FA;RecycleBin&#x7684;&#x539F;&#x7406;&#x7684;&#x3002;&#x6211;&#x4EEC;&#x5728;&#x4E86;&#x89E3;&#x5230;RecycleBin&#x4E2D;&#x6709;&#x4EC0;&#x4E48;&#x4E4B;&#x540E;&#x7686;&#x6765;&#x6765;&#x5C31;&#x9700;&#x8981;&#x770B;&#x5B83;&#x600E;&#x4E48;&#x5728;Listview&#x4E2D;&#x8D77;&#x5230;&#x4E00;&#x4E2A;&#x7F13;&#x5B58;&#x7684;&#x4F5C;&#x7528;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x6765;&#x8BB2;&#x89E3;&#x4E0B;ListView&#x548C;RecycleBin&#x5982;&#x4F55;&#x4EA4;&#x4E92;&#x5B9E;&#x73B0;&#x7F13;&#x5B58;&#x7684;&#xFF1A;</p>
<p>&#x4E3B;&#x8981;&#x5173;&#x6CE8;&#x5982;&#x4E0B;&#x4E24;&#x4E2A;&#x60C5;&#x51B5;&#xFF1A;</p>
<ul>
<li>ListView&#x7684;item View &#x56DE;&#x6536;&#x5230; RecycleBin</li>
<li>&#x4ECE;RecycleBin&#x4E2D;&#x53D6;&#x51FA;View&#x4F5C;&#x4E3A;ListView&#x7684;item View</li>
</ul>
<p>&#x6211;&#x4EEC;&#x4ECE;&#x7ED8;&#x5236;&#x7684;&#x89D2;&#x5EA6;&#x51FA;&#x53D1;&#xFF0C;&#x89C2;&#x5BDF;&#x5B83;&#x662F;&#x5982;&#x4F55;&#x5728;&#x7ED8;&#x5236;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#x5B9E;&#x73B0;&#x5B50;View&#x7684;&#x7F13;&#x5B58;&#xFF1A;</p>
<p>&#x9996;&#x5148;&#x5728;&#x5206;&#x6790;&#x4EE3;&#x7801;&#x4E4B;&#x524D;&#x6211;&#x4EEC;&#x5148;&#x6765;&#x4E86;&#x89E3;&#x4E0B;ListView&#x7684;&#x7EE7;&#x627F;&#x5173;&#x7CFB;&#xFF0C;&#x8FD9;&#x6837;&#x6709;&#x5229;&#x4E8E;&#x6211;&#x4EEC;&#x5BF9;&#x4EE3;&#x7801;&#x7684;&#x4E86;&#x89E3;&#xFF08;&#x8BF4;&#x767D;&#x4E86;&#x5C31;&#x662F;&#x77E5;&#x9053;&#x5728;&#x5B50;&#x7C7B;&#x627E;&#x4E0D;&#x5230;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x77E5;&#x9053;&#x5982;&#x4F55;&#x987A;&#x7740;&#x7EE7;&#x627F;&#x5173;&#x7CFB;&#x627E;&#xFF09;</p>
<figure class="highlight elm"><table><tr><td class="code"><pre><span class="line"><span class="type">ListView</span>-&gt; <span class="type">AbsListView</span> -&gt;<span class="type">AdapterView</span> -&gt; <span class="type">ViewGroup</span></span><br></pre></td></tr></table></figure>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>{</span><br><span class="line">    <span class="keyword">super</span>.onLayout(changed, l, t, r, b);</span><br><span class="line">    mInLayout = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = getChildCount();</span><br><span class="line">    <span class="keyword">if</span> (changed) {</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) {</span><br><span class="line">            getChildAt(i).forceLayout();</span><br><span class="line">        }</span><br><span class="line">        mRecycler.markChildrenDirty();</span><br><span class="line">    }</span><br><span class="line">    layoutChildren();</span><br><span class="line">    mInLayout = <span class="keyword">false</span>;</span><br><span class="line">    mOverscrollMax = (b - t) / OVERSCROLL_LIMIT_DIVISOR;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Move somewhere sane. This doesn&apos;t belong in onLayout().</span></span><br><span class="line">    <span class="keyword">if</span> (mFastScroll != <span class="keyword">null</span>) {</span><br><span class="line">        mFastScroll.onItemCountChanged(getChildCount(), mItemCount);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>onlayout&#x65B9;&#x6CD5;&#x662F;&#x5728;AbsListView&#x4E2D;&#x5B9E;&#x73B0;&#x7684;&#xFF0C;ListView&#x4E2D;&#x5E76;&#x6CA1;&#x6709;&#x5B9E;&#x73B0;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x662F;&#x56E0;&#x4E3A;&#x8FD9;&#x90E8;&#x5206;&#x4EE3;&#x7801;&#x5C5E;&#x4E8E;GridView&#x4EE5;&#x53CA;ListView&#x901A;&#x7528;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x5C06;&#x5176;&#x653E;&#x5728;&#x7236;&#x7C7B;&#x4E0A;&#xFF0C;&#x6211;&#x4EEC;&#x77E5;&#x9053;&#x5728;&#x5E03;&#x5C40;&#x5927;&#x5C0F;&#x6216;&#x8005;&#x4F4D;&#x7F6E;&#x7B49;&#x53D1;&#x751F;&#x53D8;&#x5316;&#x7684;&#x65F6;&#x5019;&#x5C06;&#x4F1A;&#x8C03;&#x7528;onLayout()&#x65B9;&#x6CD5;&#xFF0C;&#x5B83;&#x4F1A;&#x5F3A;&#x5236;&#x8981;&#x6C42;&#x6240;&#x6709;&#x5B50;item&#x8FDB;&#x884C;&#x91CD;&#x7ED8;&#x3002;&#x4F46;&#x662F;&#x5982;&#x679C;&#x4ED4;&#x7EC6;&#x770B;&#x4F1A;&#x53D1;&#x73B0;layoutChildren()&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x63A5;&#x4E0B;&#x6765;&#x770B;&#x4E0B;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF1A;</p>
<figure class="highlight axapta"><table><tr><td class="code"><pre><span class="line">@Override</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> layoutChildren() {</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">		<span class="comment">//......</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childrenTop = mListPadding.top;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childrenBottom = mBottom - mTop - mListPadding.bottom;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childCount = getChildCount();</span><br><span class="line">        <span class="keyword">int</span> <span class="keyword">index</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> delta = <span class="number">0</span>;</span><br><span class="line">        View sel;</span><br><span class="line">        View oldSel = <span class="keyword">null</span>;</span><br><span class="line">        View oldFirst = <span class="keyword">null</span>;</span><br><span class="line">        View newSel = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// Remember stuff we will need down below</span></span><br><span class="line">        <span class="keyword">switch</span> (mLayoutMode) {</span><br><span class="line">  		<span class="comment">//......</span></span><br><span class="line">        <span class="keyword">case</span> LAYOUT_MOVE_SELECTION:</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">// Remember the previously selected view</span></span><br><span class="line">            <span class="keyword">index</span> = mSelectedPosition - mFirstPosition;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">index</span> &gt;= <span class="number">0</span> &amp;&amp; <span class="keyword">index</span> &lt; childCount) {</span><br><span class="line">                oldSel = getChildAt(<span class="keyword">index</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// Remember the previous first child</span></span><br><span class="line">            oldFirst = getChildAt(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (mNextSelectedPosition &gt;= <span class="number">0</span>) {</span><br><span class="line">                delta = mNextSelectedPosition - mSelectedPosition;</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// Caution: newSel might be null</span></span><br><span class="line">            newSel = getChildAt(<span class="keyword">index</span> + delta);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">boolean</span> dataChanged = mDataChanged;</span><br><span class="line">        <span class="keyword">if</span> (dataChanged) {</span><br><span class="line">            handleDataChanged();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">       <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> firstPosition = mFirstPosition;</span><br><span class="line">        <span class="keyword">final</span> RecycleBin recycleBin = mRecycler;</span><br><span class="line">        <span class="keyword">if</span> (dataChanged) {</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) {</span><br><span class="line">                recycleBin.addScrapView(getChildAt(i), firstPosition+i);</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            recycleBin.fillActiveViews(childCount, firstPosition);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Clear out old views</span></span><br><span class="line">        detachAllViewsFromParent();</span><br><span class="line">        recycleBin.removeSkippedScrap();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (mLayoutMode) {</span><br><span class="line">        <span class="comment">//......</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">if</span> (childCount == <span class="number">0</span>) {</span><br><span class="line">                <span class="keyword">if</span> (!mStackFromBottom) {</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> position = lookForSelectablePosition(<span class="number">0</span>, <span class="keyword">true</span>);</span><br><span class="line">                    setSelectedPositionInt(position);</span><br><span class="line">                    sel = fillFromTop(childrenTop);</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> position = lookForSelectablePosition(mItemCount - <span class="number">1</span>, <span class="keyword">false</span>);</span><br><span class="line">                    setSelectedPositionInt(position);</span><br><span class="line">                    sel = fillUp(mItemCount - <span class="number">1</span>, childrenBottom);</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="keyword">if</span> (mSelectedPosition &gt;= <span class="number">0</span> &amp;&amp; mSelectedPosition &lt; mItemCount) {</span><br><span class="line">                    sel = fillSpecific(mSelectedPosition,</span><br><span class="line">                            oldSel == <span class="keyword">null</span> ? childrenTop : oldSel.getTop());</span><br><span class="line">                } <span class="keyword">else</span> <span class="keyword">if</span> (mFirstPosition &lt; mItemCount) {</span><br><span class="line">                    sel = fillSpecific(mFirstPosition,</span><br><span class="line">                            oldFirst == <span class="keyword">null</span> ? childrenTop : oldFirst.getTop());</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    sel = fillSpecific(<span class="number">0</span>, childrenTop);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Flush any cached views that did not get reused above</span></span><br><span class="line">        recycleBin.scrapActiveViews();</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">       <span class="comment">//......</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5728;&#x4ECB;&#x7ECD;&#x4E4B;&#x524D;&#x6211;&#x4EEC;&#x5148;&#x770B;&#x4E0B;&#x5982;&#x4E0B;&#x4EE3;&#x7801;&#x7247;&#xFF1A;<br><figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> int firstPosition = mFirstPosition;</span><br><span class="line"><span class="keyword">final</span> RecycleBin recycleBin = mRecycler;</span><br><span class="line"><span class="keyword">if</span> (dataChanged) <span class="comment">{</span><br><span class="line">    for (int i = 0; i &lt; childCount; i++) {</span><br><span class="line">        recycleBin.addScrapView(getChildAt(i), firstPosition+i);</span><br><span class="line">    }</span></span><br><span class="line">} <span class="keyword">else</span> <span class="comment">{</span><br><span class="line">    recycleBin.fillActiveViews(childCount, firstPosition);</span><br><span class="line">}</span></span><br></pre></td></tr></table></figure></p>
<p>&#x6211;&#x4EEC;&#x9700;&#x8981;&#x4E86;&#x89E3;&#x4E0B;dataChanged&#x8FD9;&#x4E2A;&#x53D8;&#x91CF;&#x662F;&#x600E;&#x4E48;&#x63A7;&#x5236;&#x7684;&#xFF0C;&#x5176;&#x5B9E;&#x8FD9;&#x4E2A;&#x53D8;&#x91CF;&#x662F;&#x5728;Adapter&#x8C03;&#x7528;&#x4E86;notifyDataSetChanged&#x65B9;&#x6CD5;&#xFF0C;&#x901A;&#x77E5;Adapter&#x7684;&#x6570;&#x636E;&#x6E90;&#x53D1;&#x751F;&#x4E86;&#x53D8;&#x5316;&#xFF0C;&#x6B64;&#x65F6;dataChanged&#x53D8;&#x91CF;&#x5C31;&#x4E3A;true&#xFF0C;&#x8FD9;&#x65F6;&#x5019;&#x4F1A;&#x5C06;&#x5F53;&#x524D;&#x7684;&#x6240;&#x6709;&#x53EF;&#x89C6;item &#x901A;&#x8FC7;RecycleBin&#x7684;addScrapView&#x65B9;&#x6CD5;&#x5C06;&#x5176;&#x653E;&#x5165;RecycleBin&#x7684;&#x5E9F;&#x5F03;List&#x4E2D;&#xFF0C;&#x4F9B;&#x540E;&#x7EED;&#x590D;&#x7528;&#x3002;</p>
<p>&#x4E3A;&#x4E86;&#x8BA9;&#x5927;&#x5BB6;&#x5730;&#x66F4;&#x6E05;&#x695A;&#x6211;&#x628A;&#x90A3;&#x4E9B;&#x65E0;&#x7528;&#x7684;&#x4EE3;&#x7801;&#x5220;&#x9664;&#x6389;&#x4E86;&#xFF0C;&#x6211;&#x4EEC;&#x5148;&#x4ECE;&#x7B2C;&#x4E00;&#x6B21;layout&#x7684;&#x60C5;&#x5F62;&#x8FDB;&#x884C;&#x5206;&#x6790;&#xFF0C;&#x7B2C;&#x4E00;&#x6B21;layout&#x7684;&#x65F6;&#x5019;&#x5E03;&#x5C40;&#x4E0A;&#x662F;&#x6CA1;&#x6709;&#x5B50;&#x5143;&#x7D20;&#x7684;&#xFF0C;&#x8FD9;&#x65F6;&#x5019;dataChanged = false&#xFF0C;childCount = 0&#x6240;&#x4EE5;fillActiveViews&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E5F;&#x662F;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x4F5C;&#x7528;&#x7684;&#x3002;&#x6240;&#x4EE5;&#x4E0A;&#x9762;&#x7684;&#x6574;&#x4E2A;&#x5173;&#x952E;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (childCount == <span class="number">0</span>) {</span><br><span class="line">    <span class="keyword">if</span> (!mStackFromBottom) {</span><br><span class="line">        final <span class="keyword">int</span> position = lookForSelectablePosition(<span class="number">0</span>, <span class="literal">true</span>);</span><br><span class="line">        setSelectedPositionInt(position);</span><br><span class="line">        sel = fillFromTop(childrenTop);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        final <span class="keyword">int</span> position = lookForSelectablePosition(mItemCount - <span class="number">1</span>, <span class="literal">false</span>);</span><br><span class="line">        setSelectedPositionInt(position);</span><br><span class="line">        sel = fillUp(mItemCount - <span class="number">1</span>, childrenBottom);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x4E0A;&#x9762;&#x4EE3;&#x7801;&#x5C31;&#x662F;&#x6839;&#x636E;&#x5B9E;&#x9645;&#x7684;&#x65B9;&#x5411;&#x6765;&#x8C03;&#x7528;fillFromTop&#x8FD8;&#x662F;fillUp&#x8FD9;&#x4E24;&#x4E2A;&#x5176;&#x5B9E;&#x529F;&#x80FD;&#x90FD;&#x5DEE;&#x4E0D;&#x591A;&#xFF0C;&#x533A;&#x522B;&#x53EA;&#x662F;&#x5728;&#x4E8E;&#x65B9;&#x5411;&#x800C;&#x5DF2;&#xFF0C;&#x6211;&#x4EEC;&#x4EE5;fillFromTop&#x6765;&#x5206;&#x6790;&#xFF1A;</p>
<figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">/<span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Fills the list from top to bottom, starting with mFirstPosition</span><br><span class="line"> <span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> <span class="comment">@param nextTop The location where the top of the first item should be</span></span><br><span class="line"> <span class="keyword">*</span>        drawn</span><br><span class="line"> <span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> <span class="comment">@return The view that is currently selected</span></span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">private View fillFromTop(int nextTop) {</span><br><span class="line">    mFirstPosition = Math.min(mFirstPosition, mSelectedPosition);</span><br><span class="line">    mFirstPosition = Math.min(mFirstPosition, mItemCount - 1);</span><br><span class="line">    if (mFirstPosition <span class="variable">&lt; 0) {</span><br><span class="line">        mFirstPosition = 0;</span><br><span class="line">    }</span><br><span class="line">    return fillDown(mFirstPosition, nextTop);</span><br><span class="line">}</span></span><br></pre></td></tr></table></figure>
<p>&#x7247;&#x6BB5;&#x6CA1;&#x5B9E;&#x5728;&#x7684;&#x4F5C;&#x7528;&#xFF0C;&#x5B9E;&#x9645;&#x7684;&#x529F;&#x80FD;&#x4F4D;&#x4E8E;fillDown&#x4E2D;&#x3002;</p>
<figure class="highlight armasm"><table><tr><td class="code"><pre><span class="line"><span class="label">private</span> View fillDown(int pos, int nextTop) {</span><br><span class="line">    View <span class="keyword">selectedView </span>= null<span class="comment">;</span></span><br><span class="line">    int <span class="preprocessor">end</span> = (mBottom - mTop)<span class="comment">;</span></span><br><span class="line">    <span class="preprocessor">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) {</span><br><span class="line">        <span class="preprocessor">end</span> -= mListPadding.<span class="keyword">bottom;</span><br><span class="line"></span>    }</span><br><span class="line">    <span class="preprocessor">while</span> (nextTop &lt; <span class="preprocessor">end</span> &amp;&amp; pos &lt; mItemCount) {</span><br><span class="line">        // is this the <span class="keyword">selected </span><span class="keyword">item?</span><br><span class="line"></span>        <span class="keyword">boolean </span><span class="keyword">selected </span>= pos == mSelectedPosition<span class="comment">;</span></span><br><span class="line">        View child = makeAndAddView(pos, nextTop, true, mListPadding.left, <span class="keyword">selected);</span><br><span class="line"></span>        nextTop = child.getBottom() + mDividerHeight<span class="comment">;</span></span><br><span class="line">        <span class="preprocessor">if</span> (<span class="keyword">selected) </span>{</span><br><span class="line">            <span class="keyword">selectedView </span>= child<span class="comment">;</span></span><br><span class="line">        }</span><br><span class="line">        pos++<span class="comment">;</span></span><br><span class="line">    }</span><br><span class="line">    setVisibleRangeHint(mFirstPosition, mFirstPosition + getChildCount() - <span class="number">1</span>)<span class="comment">;</span></span><br><span class="line">    return <span class="keyword">selectedView;</span><br><span class="line"></span>}</span><br></pre></td></tr></table></figure>
<p>&#x5728;fillDown&#x4E2D;&#x4F1A;&#x4ECE;&#x5C4F;&#x5E55;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7D20;&#x5F00;&#x59CB;&#xFF0C;&#x904D;&#x5386;&#x586B;&#x5145;&#x6BCF;&#x4E2A;&#x5143;&#x7D20;&#xFF0C;&#x8FD9;&#x91CC;&#x6700;&#x5173;&#x952E;&#x7684;&#x4EE3;&#x7801;&#x662F;makeAndAddView</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function">View <span class="title">makeAndAddView</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">int</span> y, <span class="keyword">boolean</span> flow, <span class="keyword">int</span> childrenLeft,</span><br><span class="line">        <span class="keyword">boolean</span> selected)</span> </span>{</span><br><span class="line">    View child;</span><br><span class="line">    <span class="keyword">if</span> (!mDataChanged) {</span><br><span class="line">        <span class="comment">// Try to use an existing view for this position</span></span><br><span class="line">        child = mRecycler.getActiveView(position);</span><br><span class="line">        <span class="keyword">if</span> (child != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="comment">// Found it -- we&apos;re using an existing child</span></span><br><span class="line">            <span class="comment">// This just needs to be positioned</span></span><br><span class="line">            setupChild(child, position, y, flow, childrenLeft, selected, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> child;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// Make a new view for this position, or convert an unused view if possible</span></span><br><span class="line">    child = obtainView(position, mIsScrap);</span><br><span class="line">    <span class="comment">// This needs to be positioned and measured</span></span><br><span class="line">    setupChild(child, position, y, flow, childrenLeft, selected, mIsScrap[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">return</span> child;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5728;makeAndAddView&#x65B9;&#x6CD5;&#x4E2D;&#x5C1D;&#x8BD5;&#x4ECE;&#x4ECE;RecycleBin&#x5F53;&#x4E2D;&#x83B7;&#x53D6;&#x4E00;&#x4E2A;ActiveView&#xFF0C;&#x4F46;&#x662F;&#x5728;&#x7B2C;&#x4E00;&#x6B21;&#x5E03;&#x5C40;&#x65F6;&#x5019;RecycleBin&#x662F;&#x7A7A;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x8FD4;&#x56DE;&#x7684;&#x662F;null&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x76F4;&#x63A5;&#x8C03;&#x7528;obtainView&#x65B9;&#x6CD5;&#x521B;&#x5EFA;&#x6216;&#x8005;&#x5C1D;&#x8BD5;&#x4ECE;ScropView&#x4E2D;&#x6216;&#x5176;&#x4E00;&#x4E2A;&#x5B50;View&#x6765;&#x590D;&#x7528;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x65F6;&#x5019;ScropView&#x6570;&#x7EC4;&#x4E5F;&#x662F;&#x7A7A;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x53EA;&#x80FD;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#xFF0C;&#x8FD9;&#x4E2A;&#x5C31;&#x662F;&#x5728;obtainView&#x65B9;&#x6CD5;&#x4E2D;&#x5B9E;&#x73B0;&#x7684;&#x903B;&#x8F91;&#x4E86;&#xFF0C;&#x6211;&#x4EEC;&#x73B0;&#x5728;&#x8FD9;&#x91CC;&#x63D0;&#x4E0B;&#xFF0C;&#x7D27;&#x63A5;&#x7740;&#x5C31;&#x5C06;&#x83B7;&#x53D6;&#x5230;&#x7684;&#x5B50;View&#x901A;&#x8FC7;setupChild&#x6DFB;&#x52A0;&#x5230;ListView&#x4E2D;&#x3002;</p>
<p>&#x56E0;&#x6B64;&#x6211;&#x4EEC;&#x91CD;&#x70B9;&#x5173;&#x6CE8;&#x4E0B;obtainView&#xFF1A;</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="function">View <span class="title">obtainView</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">boolean</span>[] isScrap)</span> </span>{</span><br><span class="line">	<span class="comment">//.......</span></span><br><span class="line">    <span class="keyword">final</span> View scrapView = mRecycler.getScrapView(position);</span><br><span class="line">    <span class="keyword">final</span> View child = mAdapter.getView(position, scrapView, <span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (scrapView != <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">if</span> (child != scrapView) {</span><br><span class="line">            <span class="comment">// Failed to re-bind the data, return scrap to the heap.</span></span><br><span class="line">            mRecycler.addScrapView(scrapView, position);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            isScrap[<span class="number">0</span>] = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">// Finish the temporary detach started in addScrapView().</span></span><br><span class="line">            child.dispatchFinishTemporaryDetach();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">	<span class="comment">//.......</span></span><br><span class="line">    <span class="keyword">return</span> child;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>obtainView&#x65B9;&#x6CD5;&#x4E5F;&#x662F;&#x53C8;&#x81ED;&#x53C8;&#x957F;&#x4F46;&#x662F;&#x6211;&#x4EEC;&#x53EA;&#x770B;&#x5173;&#x952E;&#x7684;&#x3002;&#x5B83;&#x4F1A;&#x8C03;&#x7528;getScrapView&#x4ECE;mRecycler&#x7684;ScrapView&#x4E2D;&#x83B7;&#x53D6;&#x53EF;&#x4EE5;&#x590D;&#x7528;&#x7684;scrapView&#x4F46;&#x662F;&#x6211;&#x4EEC;&#x73B0;&#x5728;&#x7B2C;&#x4E00;&#x6B21;&#x4EC0;&#x4E48;&#x90FD;&#x6CA1;&#x6709;&#xFF0C;&#x6240;&#x4EE5;scrapView&#x4E3A;null&#x3002;&#x4E0B;&#x9762;&#x8FD9;&#x4E2A;&#x5927;&#x5BB6;&#x719F;&#x6089;&#x4E86;&#x628A;&#xFF0C;<br><figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> View child = mAdapter.getView(position, scrapView, <span class="keyword">this</span>);</span><br></pre></td></tr></table></figure></p>
<p>&#x4EC0;&#x4E48;&#x4E0D;&#x719F;&#x6089;&#xFF1F;&#x8FD9;&#x4E2A;&#x5C31;&#x662F;&#x8C03;&#x7528;Adapter&#x7684;getView&#x65B9;&#x6CD5;&#x554A;&#xFF0C;&#x7B2C;&#x4E8C;&#x4E2A;&#x53C2;&#x6570;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x7ECF;&#x5E38;&#x63D0;&#x5230;&#x7684;convertView&#x3002;&#x60F3;&#x5FC5;&#x770B;&#x4E86;&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x5927;&#x5BB6;&#x90FD;&#x4F1A;&#x6709;&#x5370;&#x8C61;&#x5427;&#xFF1A;<br><figure class="highlight processing"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> View getView(<span class="built_in">int</span> position, View convertView, ViewGroup parent) {</span><br><span class="line">    ViewHolder holder = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (convertView == <span class="keyword">null</span>) {</span><br><span class="line">        holder=<span class="keyword">new</span> ViewHolder();</span><br><span class="line">        convertView = mInflater.inflate(R.layout.vlist2, <span class="keyword">null</span>);</span><br><span class="line">        holder.img = (ImageView)convertView.findViewById(R.id.img);</span><br><span class="line">        holder.title = (TextView)convertView.findViewById(R.id.title);</span><br><span class="line">        holder.info = (TextView)convertView.findViewById(R.id.info);</span><br><span class="line">        holder.viewBtn =(Button)convertView.findViewById(R.id.view_btn);</span><br><span class="line">        convertView.setTag(holder);</span><br><span class="line">    }<span class="keyword">else</span> {</span><br><span class="line">        holder = (ViewHolder)convertView.getTag();</span><br><span class="line">    }</span><br><span class="line">    holder.img.setBackgroundResource((Integer)mData.<span class="built_in">get</span>(position).<span class="built_in">get</span>(<span class="string">&quot;img&quot;</span>));</span><br><span class="line">    holder.title.setText((<span class="keyword">String</span>)mData.<span class="built_in">get</span>(position).<span class="built_in">get</span>(<span class="string">&quot;title&quot;</span>));</span><br><span class="line">    holder.info.setText((<span class="keyword">String</span>)mData.<span class="built_in">get</span>(position).<span class="built_in">get</span>(<span class="string">&quot;info&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span> convertView;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x7B2C;&#x4E00;&#x6B21;layout&#x7684;&#x65F6;&#x5019;&#x6211;&#x4EEC;convertView&#x4E3A;&#x7A7A;&#x90A3;&#x4E48;&#x5C31;&#x4F1A;inflate&#x4E00;&#x4E2A;&#x4F5C;&#x4E3A;convertView&#x5E76;&#x8FD4;&#x56DE;&#x3002;makeAndAddView#setupChild&#x5C31;&#x5C06;&#x8FD9;&#x4E2A;convertView&#x6DFB;&#x52A0;&#x5230;&#x5E03;&#x5C40;&#x4E2D;&#x3002;</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupChild</span><span class="params">(View child, <span class="keyword">int</span> position, <span class="keyword">int</span> y, boolean flowDown, <span class="keyword">int</span> childrenLeft,</span><br><span class="line">        boolean selected, boolean recycled)</span> </span>{</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="keyword">if</span> ((recycled &amp;&amp; !p.forceAdd) || (p.recycledHeaderFooter</span><br><span class="line">            &amp;&amp; p.viewType == AdapterView.ITEM_VIEW_TYPE_HEADER_OR_FOOTER)) {</span><br><span class="line">        attachViewToParent(child, flowDown ? -<span class="number">1</span> : <span class="number">0</span>, p);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        p.forceAdd = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (p.viewType == AdapterView.ITEM_VIEW_TYPE_HEADER_OR_FOOTER) {</span><br><span class="line">            p.recycledHeaderFooter = <span class="literal">true</span>;</span><br><span class="line">        }</span><br><span class="line">        addViewInLayout(child, flowDown ? -<span class="number">1</span> : <span class="number">0</span>, p, <span class="literal">true</span>);</span><br><span class="line">    }</span><br><span class="line"> 	<span class="comment">//......</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>setupChild&#x65B9;&#x6CD5;&#x5F88;&#x7B80;&#x5355;&#x5C31;&#x662F;&#x8C03;&#x7528;&#x4E86;addViewInLayout&#x5C06;convertView&#x6DFB;&#x52A0;&#x5230;ListView&#x4E2D;&#x3002;</p>
<p><img src="/2016/07/27/Android-&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;ListView/2.png" alt=""></p>
<p>&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x770B;&#x4E0B;&#x5728;&#x7ECF;&#x8FC7;&#x7B2C;&#x4E00;&#x6B21;layout&#x540E;&#xFF0C;&#x5F80;&#x540E;&#x7684;&#x5E03;&#x5C40;&#x548C;&#x4E4B;&#x524D;&#x7684;&#x5E03;&#x5C40;&#x6709;&#x4EC0;&#x4E48;&#x4E0D;&#x4E00;&#x6837;&#x7684;&#x5730;&#x65B9;&#x3002;<br>&#x6211;&#x4EEC;&#x8FD8;&#x662F;&#x4ECE;layoutChildren&#x5F00;&#x59CB;&#xFF0C;&#x8FD9;&#x91CC;&#x548C;&#x4E0A;&#x9762;&#x7684;&#x533A;&#x522B;&#x662F;&#x7531;&#x4E8E;childCount&#x4E0D;&#x4E3A;0&#x6240;&#x4EE5;fillActiveViews&#x4F1A;&#x5C06;Child Item&#x6DFB;&#x52A0;&#x5230;ActiviteView&#x6570;&#x7EC4;&#x4E2D;&#xFF0C;<br>&#x7D27;&#x63A5;&#x7740;&#x8C03;&#x7528;fillSpecific&#xFF0C;&#x8FD9;&#x4E2A;&#x4F1A;&#x4ECE;&#x6307;&#x5B9A;&#x7684;&#x4F4D;&#x7F6E;&#x5F00;&#x59CB;&#x52A0;&#x8F7D;Child item&#x3002;&#x7D27;&#x63A5;&#x7740;&#x8C03;&#x7528;makeAndAddView&#xFF0C;&#x8FD9;&#x65F6;&#x5019;makeAndAddView&#x8DD1;&#x7684;&#x903B;&#x8F91;&#x5C31;&#x548C;&#x4E4B;&#x524D;&#x4E0D;&#x4E00;&#x6837;&#x4E86;&#xFF0C;&#x7531;&#x4E8E;mDataChanged&#x4E3A;false&#xFF08;&#x5047;&#x8BBE;&#x5F53;&#x524D;&#x6570;&#x636E;&#x96C6;&#x6BCF;&#x53D8;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x6CA1;&#x6709;&#x5BF9;&#x6570;&#x636E;&#x96C6;&#x8FDB;&#x884C;&#x589E;&#x5220;&#x7684;&#x64CD;&#x4F5C;&#xFF09;&#x8FD9;&#x6B21;&#x8C03;&#x7528;mRecycler.getActiveView&#x7684;&#x65F6;&#x5019;&#x8FD4;&#x56DE;&#x7684;&#x5C31;&#x4E0D;&#x662F;&#x7A7A;&#x4E86;&#xFF0C;&#x56E0;&#x4E3A;&#x524D;&#x9762;&#x6211;&#x4EEC;&#x8C03;&#x7528;&#x4E86;RecycleBin&#x7684;fillActiveViews()&#x65B9;&#x6CD5;&#x6765;&#x7F13;&#x5B58;ChildView&#x3002;&#x6240;&#x4EE5;&#x5C31;&#x4E0D;&#x4F1A;&#x518D;&#x8FDB;&#x5165;obtainView()&#x65B9;&#x6CD5;&#xFF0C;&#x800C;&#x662F;&#x4F1A;&#x76F4;&#x63A5;&#x8C03;&#x7528;setupChild()&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x907F;&#x514D;&#x4E86;&#x91CD;&#x65B0;inflate&#x3002;<br>&#x63A5;&#x4E0B;&#x6765;&#x770B;&#x4E0B;setupChild()&#xFF0C;&#x7531;&#x4E8E;&#x6211;&#x4EEC;&#x5728;&#x8FD9;&#x4E4B;&#x524D;&#x8C03;&#x7528;&#x4E86;detachAllViewsFromParent&#x6240;&#x4EE5;&#x5B50;View&#x5E94;&#x8BE5;&#x8C03;&#x7528;attachViewToParent()&#x65B9;&#x6CD5;&#x3002;&#x800C;&#x4E0D;&#x662F;&#x524D;&#x9762;&#x63D0;&#x5230;&#x7684;addViewInLayout&#x65B9;&#x6CD5;&#x3002;<br><img src="/2016/07/27/Android-&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;ListView/3.png" alt=""></p>
<p>&#x597D;&#x4E86;&#x6211;&#x4EEC;&#x770B;&#x5B8C;&#x4E0A;&#x9762;&#x4EE3;&#x7801;&#x53EF;&#x80FD;&#x89C9;&#x5F97;&#x8FD8;&#x662F;&#x6CA1;&#x6709;&#x63A5;&#x89E6;&#x5230;&#x6700;&#x6838;&#x5FC3;&#x7684;&#x7F13;&#x5B58;&#x673A;&#x5236;&#xFF0C;&#x6700;&#x5173;&#x952E;&#x7684;&#x90E8;&#x5206;&#x662F;&#x5728;&#x6ED1;&#x52A8;&#x7684;&#x65F6;&#x5019;&#x5982;&#x4F55;&#x7F13;&#x5B58;&#x7684;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x770B;&#x4E0B;&#x8FD9;&#x90E8;&#x5206;&#x903B;&#x8F91;&#xFF1A;<br>&#x6211;&#x4EEC;&#x77E5;&#x9053;&#x6211;&#x4EEC;&#x7684;&#x4EA4;&#x4E92;&#x4E8B;&#x4EF6;&#x90FD;&#x4F1A;&#x88AB;&#x4F20;&#x9012;&#x5230;onTouchEvent&#x4E2D;&#xFF0C;&#x5728;ListView&#x4E5F;&#x4E0D;&#x4F8B;&#x5916;&#xFF0C;onTouchEvent&#x6709;&#x5F88;&#x591A;&#x4E8B;&#x4EF6;&#xFF0C;&#x6211;&#x4EEC;&#x5173;&#x6CE8;ACTION_MOVE,&#x5728;&#x8FD9;&#x90E8;&#x5206;&#x4EE3;&#x7801;&#x4E2D;&#x6211;&#x4EEC;&#x91CD;&#x70B9;&#x5173;&#x6CE8;trackMotionScroll&#x65B9;&#x6CD5;&#xFF1A;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x987E;&#x540D;&#x601D;&#x4E49;&#x5C31;&#x662F;&#x8DDF;&#x8E2A;&#x6ED1;&#x52A8;&#x4E8B;&#x4EF6;&#xFF1A;&#x8FD9;&#x4E2A;&#x4EE3;&#x7801;&#x4E5F;&#x5F88;&#x957F;&#xFF0C;&#x6211;&#x4EEC;&#x8FD8;&#x662F;&#x4ECE;&#x4E2D;&#x5173;&#x6CE8;&#x91CD;&#x70B9;&#x3002;</p>
<figure class="highlight processing"><table><tr><td class="code"><pre><span class="line"><span class="built_in">boolean</span> trackMotionScroll(<span class="built_in">int</span> deltaY, <span class="built_in">int</span> incrementalDeltaY) {</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">int</span> childCount = getChildCount();</span><br><span class="line">    <span class="keyword">if</span> (childCount == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">int</span> firstTop = getChildAt(<span class="number">0</span>).getTop();</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">int</span> lastBottom = getChildAt(childCount - <span class="number">1</span>).getBottom();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Rect listPadding = mListPadding;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &quot;effective padding&quot; In this case is the amount of padding that affects</span></span><br><span class="line">    <span class="comment">// how much space should not be filled by items. If we don&apos;t clip to padding</span></span><br><span class="line">    <span class="comment">// there is no effective padding.</span></span><br><span class="line">    <span class="built_in">int</span> effectivePaddingTop = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">int</span> effectivePaddingBottom = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) {</span><br><span class="line">        effectivePaddingTop = listPadding.top;</span><br><span class="line">        effectivePaddingBottom = listPadding.bottom;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">     <span class="comment">// FIXME account for grid vertical spacing too?</span></span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">int</span> spaceAbove = effectivePaddingTop - firstTop;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">int</span> end = getHeight() - effectivePaddingBottom;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">int</span> spaceBelow = lastBottom - end;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">int</span> <span class="variable">height</span> = getHeight() - mPaddingBottom - mPaddingTop;</span><br><span class="line">    <span class="keyword">if</span> (deltaY &lt; <span class="number">0</span>) {</span><br><span class="line">        deltaY = Math.<span class="built_in">max</span>(-(<span class="variable">height</span> - <span class="number">1</span>), deltaY);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        deltaY = Math.<span class="built_in">min</span>(<span class="variable">height</span> - <span class="number">1</span>, deltaY);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (incrementalDeltaY &lt; <span class="number">0</span>) {</span><br><span class="line">        incrementalDeltaY = Math.<span class="built_in">max</span>(-(<span class="variable">height</span> - <span class="number">1</span>), incrementalDeltaY);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        incrementalDeltaY = Math.<span class="built_in">min</span>(<span class="variable">height</span> - <span class="number">1</span>, incrementalDeltaY);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">int</span> firstPosition = mFirstPosition;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update our guesses for where the first and last views are</span></span><br><span class="line">    <span class="keyword">if</span> (firstPosition == <span class="number">0</span>) {</span><br><span class="line">        mFirstPositionDistanceGuess = firstTop - listPadding.top;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        mFirstPositionDistanceGuess += incrementalDeltaY;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (firstPosition + childCount == mItemCount) {</span><br><span class="line">        mLastPositionDistanceGuess = lastBottom + listPadding.bottom;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        mLastPositionDistanceGuess += incrementalDeltaY;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">boolean</span> cannotScrollDown = (firstPosition == <span class="number">0</span> &amp;&amp;</span><br><span class="line">            firstTop &gt;= listPadding.top &amp;&amp; incrementalDeltaY &gt;= <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">boolean</span> cannotScrollUp = (firstPosition + childCount == mItemCount &amp;&amp;</span><br><span class="line">            lastBottom &lt;= getHeight() - listPadding.bottom &amp;&amp; incrementalDeltaY &lt;= <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cannotScrollDown || cannotScrollUp) {</span><br><span class="line">        <span class="keyword">return</span> incrementalDeltaY != <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">boolean</span> down = incrementalDeltaY &lt; <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">boolean</span> inTouchMode = isInTouchMode();</span><br><span class="line">    <span class="keyword">if</span> (inTouchMode) {</span><br><span class="line">        hideSelector();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">int</span> headerViewsCount = getHeaderViewsCount();</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">int</span> footerViewsStart = mItemCount - getFooterViewsCount();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> start = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (down) {</span><br><span class="line">        <span class="built_in">int</span> top = -incrementalDeltaY;</span><br><span class="line">        <span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) {</span><br><span class="line">            top += listPadding.top;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) {</span><br><span class="line">            <span class="keyword">final</span> View child = getChildAt(i);</span><br><span class="line">            <span class="keyword">if</span> (child.getBottom() &gt;= top) {</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                count++;</span><br><span class="line">                <span class="built_in">int</span> position = firstPosition + i;</span><br><span class="line">                <span class="keyword">if</span> (position &gt;= headerViewsCount &amp;&amp; position &lt; footerViewsStart) {</span><br><span class="line">                    <span class="comment">// The view will be rebound to new data, clear any</span></span><br><span class="line">                    <span class="comment">// system-managed transient state.</span></span><br><span class="line">                    child.clearAccessibilityFocus();</span><br><span class="line">                    mRecycler.addScrapView(child, position);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="built_in">int</span> bottom = getHeight() - incrementalDeltaY;</span><br><span class="line">        <span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) {</span><br><span class="line">            bottom -= listPadding.bottom;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = childCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) {</span><br><span class="line">            <span class="keyword">final</span> View child = getChildAt(i);</span><br><span class="line">            <span class="keyword">if</span> (child.getTop() &lt;= bottom) {</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                start = i;</span><br><span class="line">                count++;</span><br><span class="line">                <span class="built_in">int</span> position = firstPosition + i;</span><br><span class="line">                <span class="keyword">if</span> (position &gt;= headerViewsCount &amp;&amp; position &lt; footerViewsStart) {</span><br><span class="line">                    <span class="comment">// The view will be rebound to new data, clear any</span></span><br><span class="line">                    <span class="comment">// system-managed transient state.</span></span><br><span class="line">                    child.clearAccessibilityFocus();</span><br><span class="line">                    mRecycler.addScrapView(child, position);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    mMotionViewNewTop = mMotionViewOriginalTop + deltaY;</span><br><span class="line">    mBlockLayoutRequests = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>) {</span><br><span class="line">        detachViewsFromParent(start, count);</span><br><span class="line">        mRecycler.removeSkippedScrap();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// invalidate before moving the children to avoid unnecessary invalidate</span></span><br><span class="line">    <span class="comment">// calls to bubble up from the children all the way to the top</span></span><br><span class="line">    <span class="keyword">if</span> (!awakenScrollBars()) {</span><br><span class="line">       invalidate();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    offsetChildrenTopAndBottom(incrementalDeltaY);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (down) {</span><br><span class="line">        mFirstPosition += count;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">int</span> absIncrementalDeltaY = Math.<span class="built_in">abs</span>(incrementalDeltaY);</span><br><span class="line">    <span class="keyword">if</span> (spaceAbove &lt; absIncrementalDeltaY || spaceBelow &lt; absIncrementalDeltaY) {</span><br><span class="line">        fillGap(down);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!inTouchMode &amp;&amp; mSelectedPosition != INVALID_POSITION) {</span><br><span class="line">        <span class="keyword">final</span> <span class="built_in">int</span> childIndex = mSelectedPosition - mFirstPosition;</span><br><span class="line">        <span class="keyword">if</span> (childIndex &gt;= <span class="number">0</span> &amp;&amp; childIndex &lt; getChildCount()) {</span><br><span class="line">            positionSelector(mSelectedPosition, getChildAt(childIndex));</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (mSelectorPosition != INVALID_POSITION) {</span><br><span class="line">        <span class="keyword">final</span> <span class="built_in">int</span> childIndex = mSelectorPosition - mFirstPosition;</span><br><span class="line">        <span class="keyword">if</span> (childIndex &gt;= <span class="number">0</span> &amp;&amp; childIndex &lt; getChildCount()) {</span><br><span class="line">            positionSelector(INVALID_POSITION, getChildAt(childIndex));</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        mSelectorRect.setEmpty();</span><br><span class="line">    }</span><br><span class="line">    mBlockLayoutRequests = <span class="keyword">false</span>;</span><br><span class="line">    invokeOnItemScrollListener();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4F20;&#x5165;&#x4E24;&#x4E2A;&#x53C2;&#x6570;deltaY&#x8868;&#x793A;&#x4ECE;&#x624B;&#x6307;&#x6700;&#x521D;&#x6309;&#x4E0B;&#x65F6;&#x7684;&#x4F4D;&#x7F6E;&#x5230;&#x5F53;&#x524D;&#x624B;&#x6307;&#x6240;&#x5904;&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;incrementalDeltaY&#x5219;&#x8868;&#x793A;&#x76F8;&#x90BB;&#x4E24;&#x6B21;&#x5728;Y&#x65B9;&#x5411;&#x4E0A;&#x4F4D;&#x7F6E;&#x7684;&#x6539;&#x53D8;&#x91CF;&#xFF0C;incrementalDeltaY&#x7684;&#x6B63;&#x8D1F;&#x503C;&#x5C31;&#x53EF;&#x4EE5;&#x5224;&#x65AD;&#x6211;&#x4EEC;&#x5F53;&#x524D;&#x7684;&#x6ED1;&#x52A8;&#x65B9;&#x5411;&#x4E86;&#x3002;&#xFF08;incrementalDeltaY&#x5C0F;&#x4E8E;0&#xFF0C;&#x8868;&#x793A;&#x5411;&#x4E0B;&#x6ED1;&#x52A8;&#xFF0C;&#x5927;&#x4E8E;0&#x5C31;&#x662F;&#x5411;&#x4E0A;&#x6ED1;&#x52A8;&#xFF09;&#x5728;&#x8FD9;&#x4E2A;&#x90E8;&#x5206;&#x903B;&#x8F91;&#x4E2D;&#x5C06;&#x4F1A;&#x6839;&#x636E;&#x8FB9;&#x7F18;&#x4F5C;&#x4E3A;&#x5224;&#x65AD;&#x4F9D;&#x636E;&#x5982;&#x679C;&#x5B50;View&#x7684;bottom&#x503C;&#x5C0F;&#x4E8E;top&#x503C;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x8BF4;&#x660E;&#x8FD9;&#x4E2A;&#x5B50;View&#x79FB;&#x51FA;&#x5C4F;&#x5E55;&#x4E86;&#xFF0C;&#x8FD9;&#x65F6;&#x5019;&#x5C31;&#x4F1A;&#x8C03;&#x7528;RecycleBin&#x7684;addScrapView()&#x65B9;&#x6CD5;&#x5C06;&#x8FD9;&#x4E2A;View&#x52A0;&#x5165;&#x5230;&#x5E9F;&#x5F03;&#x7F13;&#x5B58;&#x5F53;&#x4E2D;&#xFF0C;&#x4E0A;&#x9762;&#x4ECB;&#x7ECD;&#x4E86;&#x79FB;&#x51FA;&#x5C4F;&#x5E55;&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x7531;&#x4E8E;&#x754C;&#x9762;&#x663E;&#x793A;&#x7684;&#x5B50;View&#x662F;&#x56FA;&#x5B9A;&#x7684;&#x6240;&#x4EE5;&#x6709;&#x79FB;&#x51FA;&#x5C31;&#x6709;&#x79FB;&#x5165;&#xFF0C;&#x6211;&#x4EEC;&#x63A5;&#x4E0B;&#x6765;&#x770B;&#x4E0B;&#x8FD9;&#x90E8;&#x5206;&#x903B;&#x8F91;&#xFF1A;<br>&#x5982;&#x679C;ListView&#x4E2D;&#x6700;&#x540E;&#x4E00;&#x4E2A;View&#x7684;&#x5E95;&#x90E8;&#x5DF2;&#x7ECF;&#x79FB;&#x5165;&#x4E86;&#x5C4F;&#x5E55;&#xFF0C;&#x6216;&#x8005;ListView&#x4E2D;&#x7B2C;&#x4E00;&#x4E2A;View&#x7684;&#x9876;&#x90E8;&#x79FB;&#x5165;&#x4E86;&#x5C4F;&#x5E55;&#xFF0C;&#x5C31;&#x4F1A;&#x8C03; &#x7528;fillGap()&#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x770B;&#x4E0B;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF1A;<br><figure class="highlight axapta"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> fillGap(<span class="keyword">boolean</span> down) {</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> <span class="keyword">count</span> = getChildCount();</span><br><span class="line">    <span class="keyword">if</span> (down) {</span><br><span class="line">        <span class="keyword">int</span> paddingTop = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) {</span><br><span class="line">            paddingTop = getListPaddingTop();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> startOffset = <span class="keyword">count</span> &gt; <span class="number">0</span> ? getChildAt(<span class="keyword">count</span> - <span class="number">1</span>).getBottom() + mDividerHeight :</span><br><span class="line">                paddingTop;</span><br><span class="line">        fillDown(mFirstPosition + <span class="keyword">count</span>, startOffset);</span><br><span class="line">        correctTooHigh(getChildCount());</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">int</span> paddingBottom = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) {</span><br><span class="line">            paddingBottom = getListPaddingBottom();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> startOffset = <span class="keyword">count</span> &gt; <span class="number">0</span> ? getChildAt(<span class="number">0</span>).getTop() - mDividerHeight :</span><br><span class="line">                getHeight() - paddingBottom;</span><br><span class="line">        fillUp(mFirstPosition - <span class="number">1</span>, startOffset);</span><br><span class="line">        correctTooLow(getChildCount());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x989D;&#xFF0C;&#x53C8;&#x56DE;&#x5230;&#x4E4B;&#x524D;&#x7684;&#x6D41;&#x7A0B;&#xFF0C;&#x5728;fillGap&#x53C8;&#x8C03;&#x7528;&#x4E86;fillDown/fillUp&#xFF0C;&#x6211;&#x4EEC;&#x77E5;&#x9053;&#x8FD9;&#x4E24;&#x4E2A;&#x65B9;&#x6CD5;&#x4F1A;&#x8C03;&#x7528;makeAndAddView&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x65F6;&#x5019;&#x7684;makeAndAddView&#x6D41;&#x7A0B;&#x53C8;&#x548C;&#x4E0A;&#x9762;&#x4E0D;&#x5927;&#x4E00;&#x6837;&#x4E86;&#x3002;&#x8FD9;&#x65F6;&#x5019;mRecycler.getActiveView&#x8FD4;&#x56DE;&#x7684;&#x662F;null</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function">View <span class="title">makeAndAddView</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">int</span> y, <span class="keyword">boolean</span> flow, <span class="keyword">int</span> childrenLeft,</span><br><span class="line">        <span class="keyword">boolean</span> selected)</span> </span>{</span><br><span class="line">    View child;</span><br><span class="line">    <span class="keyword">if</span> (!mDataChanged) {</span><br><span class="line">        <span class="comment">// Try to use an existing view for this position</span></span><br><span class="line">        child = mRecycler.getActiveView(position);</span><br><span class="line">        <span class="keyword">if</span> (child != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="comment">// Found it -- we&apos;re using an existing child</span></span><br><span class="line">            <span class="comment">// This just needs to be positioned</span></span><br><span class="line">            setupChild(child, position, y, flow, childrenLeft, selected, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> child;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// Make a new view for this position, or convert an unused view if possible</span></span><br><span class="line">    child = obtainView(position, mIsScrap);</span><br><span class="line">    <span class="comment">// This needs to be positioned and measured</span></span><br><span class="line">    setupChild(child, position, y, flow, childrenLeft, selected, mIsScrap[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">return</span> child;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x4E3A;&#x4EC0;&#x4E48;&#x662F;null&#x6211;&#x4EEC;&#x518D;&#x6765;&#x770B;&#x4E0B;getActiveView&#xFF1A;<br><figure class="highlight axapta"><table><tr><td class="code"><pre><span class="line">View getActiveView(<span class="keyword">int</span> position) {</span><br><span class="line">    <span class="keyword">int</span> <span class="keyword">index</span> = position - mFirstActivePosition;</span><br><span class="line">    <span class="keyword">final</span> View[] activeViews = mActiveViews;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">index</span> &gt;=<span class="number">0</span> &amp;&amp; <span class="keyword">index</span> &lt; activeViews.length) {</span><br><span class="line">        <span class="keyword">final</span> View match = activeViews[<span class="keyword">index</span>];</span><br><span class="line">        activeViews[<span class="keyword">index</span>] = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">return</span> match;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x7531;&#x4E8E;&#x4E4B;&#x524D;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x5DF2;&#x7ECF;&#x88AB;&#x8C03;&#x7528;&#x8FC7;&#x4E86;&#x5B83;&#x4F1A;&#x5C06;activeViews[index]&#x7F6E;&#x4E3A;null&#x6240;&#x4EE5;&#x8FD8;&#x4F1A;&#x8C03;&#x7528;obtainView&#xFF0C;&#x4E0A;&#x9762;&#x5DF2;&#x7ECF;&#x5BF9;&#x8BE5;&#x65B9;&#x6CD5;&#x505A;&#x4E86;&#x5206;&#x6790;&#xFF0C;&#x5B83;&#x4F1A;&#x8C03;&#x7528;getScrapView()&#x65B9;&#x6CD5;&#x6765;&#x5C1D;&#x8BD5;&#x4ECE;&#x5E9F;&#x5F03;&#x7F13;&#x5B58;&#x4E2D;&#x83B7;&#x53D6;&#x4E00;&#x4E2A;View&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x7684;&#x8BDD;&#x5219;&#x4F1A;inflate&#x4E00;&#x4E2A;&#x8FD4;&#x56DE;&#x3002;</p>
<h5 id="ListView&#x7684;&#x4F18;&#x5316;"><a href="#ListView&#x7684;&#x4F18;&#x5316;" class="headerlink" title="ListView&#x7684;&#x4F18;&#x5316;"></a>ListView&#x7684;&#x4F18;&#x5316;</h5><p>&#x4E0A;&#x9762;&#x4ECB;&#x7ECD;&#x7684;&#x53EA;&#x662F;ListView&#x7684;&#x7F13;&#x5B58;&#x673A;&#x5236;&#xFF0C;&#x4E86;&#x89E3;&#x4E86;&#x6574;&#x4E2A;&#x7F13;&#x5B58;&#x673A;&#x5236;&#x540E;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x5145;&#x5206;&#x5229;&#x7528;convertView&#x6765;&#x5224;&#x65AD;&#x662F;&#x5426;inflate&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x6574;&#x4E2A;ListView&#x53EA;&#x52A0;&#x8F7D;&#x4E00;&#x5C4F;&#x7684;&#x5E03;&#x5C40;&#xFF0C;&#x4E4B;&#x540E;&#x6ED1;&#x52A8;&#x51FA;&#x6765;&#x7684;item&#x4F7F;&#x7528;&#x7684;&#x662F;&#x4E4B;&#x524D;&#x5DF2;&#x7ECF;&#x52A0;&#x8F7D;&#x7684;&#x5E03;&#x5C40;&#x7684;&#x7F13;&#x5B58;&#xFF0C;&#x4F46;&#x662F;&#x6211;&#x4EEC;&#x770B;&#x4E0B;&#x4E0B;&#x9762;&#x7684;getView&#x6211;&#x4EEC;&#x4F7F;&#x7528;&#x4E86;ViewHolder&#xFF0C;&#x8FD8;&#x6709;set/getTag&#x8FD9;&#x662F;&#x5E72;&#x5565;&#x7528;&#x7684;&#xFF1F;</p>
<figure class="highlight processing"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> View getView(<span class="built_in">int</span> position, View convertView, ViewGroup parent) {</span><br><span class="line">    ViewHolder holder = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (convertView == <span class="keyword">null</span>) {</span><br><span class="line">        holder=<span class="keyword">new</span> ViewHolder();</span><br><span class="line">        convertView = mInflater.inflate(R.layout.vlist2, <span class="keyword">null</span>);</span><br><span class="line">        holder.img = (ImageView)convertView.findViewById(R.id.img);</span><br><span class="line">        holder.title = (TextView)convertView.findViewById(R.id.title);</span><br><span class="line">        holder.info = (TextView)convertView.findViewById(R.id.info);</span><br><span class="line">        holder.viewBtn =(Button)convertView.findViewById(R.id.view_btn);</span><br><span class="line">        convertView.setTag(holder);</span><br><span class="line">    }<span class="keyword">else</span> {</span><br><span class="line">        holder = (ViewHolder)convertView.getTag();</span><br><span class="line">    }</span><br><span class="line">    holder.img.setBackgroundResource((Integer)mData.<span class="built_in">get</span>(position).<span class="built_in">get</span>(<span class="string">&quot;img&quot;</span>));</span><br><span class="line">    holder.title.setText((<span class="keyword">String</span>)mData.<span class="built_in">get</span>(position).<span class="built_in">get</span>(<span class="string">&quot;title&quot;</span>));</span><br><span class="line">    holder.info.setText((<span class="keyword">String</span>)mData.<span class="built_in">get</span>(position).<span class="built_in">get</span>(<span class="string">&quot;info&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span> convertView;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5176;&#x5B9E;&#x4F7F;&#x7528;ViewHolder&#xFF0C;&#x8FD8;&#x6709;set/getTag&#x662F;&#x4E3A;&#x4E86;&#x8282;&#x7701;findViewById&#x7684;&#x65F6;&#x95F4;&#x3002;&#x5982;&#x679C;&#x4E0D;&#x4F7F;&#x7528;ViewHolder&#xFF0C;&#x6BCF;&#x6B21;getView&#x7684;&#x65F6;&#x5019;&#x90FD;&#x9700;&#x8981;&#x5F97;&#x5230;&#x4E00;&#x6B21;&#x5B50;&#x5E03;&#x5C40;&#xFF0C;&#x800C;&#x8FD9;&#x4E5F;&#x662F;&#x5F88;&#x8017;&#x65F6;&#x5E76;&#x4E14;&#x8017;&#x8D44;&#x6E90;&#x7684;&#xFF0C;&#x5982;&#x679C;&#x4F7F;&#x7528;&#x4E86;ViewHolder&#x4F5C;&#x4E3A;&#x5B50;&#x5E03;&#x5C40;&#x7684;&#x7F13;&#x5B58;&#xFF0C;&#x4F7F;&#x7528;View&#x7684;setTag&#x65B9;&#x6CD5;&#x5C06;&#x7F13;&#x5B58;&#x4E0E;&#x6BCF;&#x4E2A;item&#x7ED1;&#x5B9A;&#xFF0C;&#x5219;&#x4E5F;&#x53EF;&#x4EE5;&#x7701;&#x53BB;&#x4E86;findViewById&#x7684;&#x65F6;&#x95F4;&#xFF08;&#x8FD9;&#x91CC;&#x6211;&#x4E2A;&#x4EBA;&#x7684;&#x7406;&#x89E3;&#x662F;&#x5C06;id&#x4E0E;ViewHolder&#x4E2D;&#x7684;View&#x7ED1;&#x5B9A;&#x8D77;&#x6765;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x7406;&#x89E3;&#x9519;&#x8BEF;&#x6B22;&#x8FCE;&#x66F4;&#x6B63;&#xFF09;<br>&#x8FD9;&#x91CC;&#x8FD8;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x4E00;&#x70B9;&#x6211;&#x4EEC;&#x4E00;&#x822C;&#x9700;&#x8981;&#x5C06;ViewHolder&#x8BBE;&#x7F6E;&#x4E3A;&#x9759;&#x6001;&#x7684;&#x56E0;&#x4E3A;&#x56E0;&#x4E3A;&#x9759;&#x6001;&#x5185;&#x90E8;&#x7C7B;&#xFF0C;&#x4E0D;&#x6301;&#x6709;&#x5916;&#x90E8;&#x7C7B;&#x7684;&#x5F15;&#x7528;&#xFF0C;&#x4ECE;&#x800C;&#x907F;&#x514D;&#x5185;&#x5B58;&#x6CC4;&#x9732;&#x3002;</p>
<p>&#x603B;&#x7ED3;&#x5982;&#x4E0B;&#xFF1A;&#x57FA;&#x672C;&#x7684;&#x4F18;&#x5316;&#x65B9;&#x5F0F;</p>
<ul>
<li>&#x4F7F;&#x7528;ConvertView&#x590D;&#x7528;&#x673A;&#x5236;</li>
<li>&#x4F7F;&#x7528;ViewHolder</li>
<li>&#x4F7F;&#x7528;set/getTag</li>
</ul>
<p>ListView Item&#x5E26;&#x6709;&#x56FE;&#x7247;&#x7684;&#x60C5;&#x51B5;&#xFF1A;</p>
<p>&#x6211;&#x4EEC;&#x5728;&#x5F00;&#x53D1;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x9047;&#x5230;ListView&#x4E2D;&#x6BCF;&#x4E2A;item&#x90FD;&#x6709;&#x4E00;&#x4E2A;Image&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x8FD9;&#x4E2A;&#x5728;Music&#x5E94;&#x7528;&#x4E2D;&#x5341;&#x5206;&#x5E38;&#x89C1;&#xFF0C;<br>&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x4E00;&#x822C;&#x5BF9;&#x8FD9;&#x4E9B;&#x56FE;&#x50CF;&#x7684;&#x52A0;&#x8F7D;&#x4F7F;&#x7528;&#x56FE;&#x7247;&#x7F13;&#x5B58;&#xFF0C;&#x5E76;&#x4E14;&#x5728;&#x52A0;&#x8F7D;&#x8FD9;&#x4E9B;&#x56FE;&#x7247;&#x7684;&#x65F6;&#x5019;&#x4F7F;&#x7528;&#x5F02;&#x6B65;&#x52A0;&#x8F7D;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x4E5F;&#x9762;&#x4E34;&#x8FD9;&#x7A7A;&#x95F4;&#x548C;&#x65F6;&#x95F4;&#x7684;&#x5E73;&#x8861;&#x95EE;&#x9898;&#x3002;<br>&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x8FD8;&#x6709;&#x4E00;&#x79CD;&#x65B9;&#x6CD5;&#x5C31;&#x662F;&#x9488;&#x5BF9;&#x56FE;&#x7247;&#x8D44;&#x6E90;&#x8FDB;&#x884C;&#x4F18;&#x5316;&#x6BD4;&#x5982;&#x5728;&#x56FE;&#x7247;&#x89E3;&#x7801;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x964D;&#x4F4E;&#x50CF;&#x7D20;&#x989C;&#x8272;&#x4FE1;&#x606F;&#xFF0C;&#x53BB;&#x6389;&#x900F;&#x660E;&#x5EA6;&#x7B49;&#xFF0C;&#x6216;&#x8005;&#x5728;&#x8BBE;&#x8BA1;&#x8D44;&#x6E90;&#x7684;&#x65F6;&#x5019;&#x5C3D;&#x91CF;&#x51CF;&#x5C0F;&#x56FE;&#x7247;&#x8D44;&#x6E90;&#x7684;&#x5C3A;&#x5BF8;&#x3002;</p>
<p>&#x4E3A;&#x4E86;&#x907F;&#x514D;&#x4E0D;&#x9700;&#x8981;&#x52A0;&#x8F7D;&#x5728;&#x6211;&#x4EEC;&#x8FD8;&#x53EF;&#x4EE5;&#x8BBE;&#x7F6E;&#x5728;&#x6ED1;&#x52A8;&#x4E0D;&#x52A0;&#x8F7D;&#x56FE;&#x7247;&#x6ED1;&#x52A8;&#x505C;&#x6B62;&#x7684;&#x65F6;&#x5019;&#x52A0;&#x8F7D;&#x56FE;&#x7247;<br>&#x4E0B;&#x9762;&#x662F;&#x5BF9;&#x5E94;&#x7684;&#x5B9E;&#x73B0;&#x4F8B;&#x5B50;&#xFF1A;<br>&#x8F6C;&#x8F7D;&#x81EA; <a href="http://blog.csdn.net/yy1300326388/article/details/45153813" target="_blank" rel="external">http://blog.csdn.net/yy1300326388/article/details/45153813</a></p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="comment">//&#x5B9A;&#x4E49;&#x5F53;&#x524D;listview&#x662F;&#x5426;&#x5728;&#x6ED1;&#x52A8;&#x72B6;&#x6001;</span></span><br><span class="line"><span class="keyword">private</span>  <span class="keyword">boolean</span> scrollState=<span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">setScrollState</span><span class="params">(<span class="keyword">boolean</span> scrollState)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.scrollState = scrollState;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//&#x5B9E;&#x4F53;&#x7C7B;</span></span><br><span class="line">UserEnity userEnity=lists.<span class="keyword">get</span>(position);</span><br><span class="line"><span class="keyword">if</span> (!scrollState){<span class="comment">//&#x5982;&#x679C;&#x5F53;&#x524D;&#x4E0D;&#x662F;&#x6ED1;&#x52A8;&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x6211;&#x4EEC;&#x586B;&#x5145;&#x771F;&#x6570;&#x636E;</span></span><br><span class="line">    <span class="comment">//&#x586B;&#x5145;&#x6570;&#x636E;</span></span><br><span class="line">    viewHolder.tv_name.setText(userEnity.getName());</span><br><span class="line">    <span class="comment">//&#x8BBE;&#x7F6E;Tag&#x4E2D;&#x6570;&#x636E;&#x4E3A;&#x7A7A;&#x8868;&#x793A;&#x6570;&#x636E;&#x5DF2;&#x586B;&#x5145;</span></span><br><span class="line">    viewHolder.tv_name.setTag(<span class="literal">null</span>);</span><br><span class="line">    <span class="comment">//&#x52A0;&#x8F7D;&#x56FE;&#x7247;</span></span><br><span class="line">    ImageLoader.getInstance().displayImage(img_url,viewHolder.iv_icon);</span><br><span class="line">    <span class="comment">//&#x8BBE;&#x7F6E;tag&#x4E3A;1&#x8868;&#x793A;&#x5DF2;&#x52A0;&#x8F7D;&#x8FC7;&#x6570;&#x636E;</span></span><br><span class="line">    viewHolder.iv_icon.setTag(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line">}<span class="keyword">else</span>{<span class="comment">//&#x5982;&#x679C;&#x5F53;&#x524D;&#x662F;&#x6ED1;&#x52A8;&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x6211;&#x4EEC;&#x586B;&#x5145;&#x5047;&#x6570;&#x636E;</span></span><br><span class="line">    viewHolder.tv_name.setText(<span class="string">&quot;&#x52A0;&#x8F7D;&#x4E2D;&quot;</span>);</span><br><span class="line">    <span class="comment">//&#x5C06;&#x6570;&#x636E;name&#x4FDD;&#x5B58;&#x5728;Tag&#x5F53;&#x4E2D;</span></span><br><span class="line">    viewHolder.tv_name.setTag(userEnity.getName());</span><br><span class="line">    <span class="comment">//&#x5C06;&#x6570;&#x636E;image_url&#x4FDD;&#x5B58;&#x5728;Tag&#x5F53;&#x4E2D;</span></span><br><span class="line">    viewHolder.iv_icon.setTag(img_url);</span><br><span class="line">    <span class="comment">//&#x8BBE;&#x7F6E;&#x9ED8;&#x8BA4;&#x663E;&#x793A;&#x56FE;&#x7247;&#xFF08;&#x6700;&#x597D;&#x662F;&#x672C;&#x5730;&#x8D44;&#x6E90;&#x7684;&#x56FE;&#x7247;&#xFF09;</span></span><br><span class="line">    viewHolder.iv_icon.setImageResource(R.mipmap.ic_launcher);</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">&#x8BBE;&#x7F6E;&#x76D1;&#x542C;</span><br><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="typename">void</span> onScrollStateChanged(AbsListView view, <span class="typename">int</span> scrollState) {</span><br><span class="line">    <span class="keyword">switch</span> (scrollState){</span><br><span class="line">        <span class="keyword">case</span> AbsListView.OnScrollListener.<span class="string">SCROLL_STATE_IDLE:</span><span class="comment">//&#x505C;&#x6B62;&#x6EDA;&#x52A8;</span></span><br><span class="line">        {</span><br><span class="line">            <span class="comment">//&#x8BBE;&#x7F6E;&#x4E3A;&#x505C;&#x6B62;&#x6EDA;&#x52A8;</span></span><br><span class="line">            myAdapter.setScrollState(<span class="literal">false</span>);</span><br><span class="line">            <span class="comment">//&#x5F53;&#x524D;&#x5C4F;&#x5E55;&#x4E2D;listview&#x7684;&#x5B50;&#x9879;&#x7684;&#x4E2A;&#x6570;</span></span><br><span class="line">            <span class="typename">int</span> count = view.getChildCount();</span><br><span class="line">            Log.e(<span class="string">&quot;MainActivity&quot;</span>,count+<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="typename">int</span> i = <span class="number">0</span>; i &lt; count; i++) {</span><br><span class="line">                <span class="comment">//&#x83B7;&#x53D6;&#x5230;item&#x7684;name</span></span><br><span class="line">                TextView tv_name = (TextView) view.getChildAt(i).findViewById(R.id.main_item_tv_name);</span><br><span class="line">                <span class="comment">//&#x83B7;&#x53D6;&#x5230;item&#x7684;&#x5934;&#x50CF;</span></span><br><span class="line">                ImageView iv_show= (ImageView) view.getChildAt(i).findViewById(R.id.main_item_iv_icon);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (tv_name.getTag() != <span class="literal">null</span>) { <span class="comment">//&#x975E;null&#x8BF4;&#x660E;&#x9700;&#x8981;&#x52A0;&#x8F7D;&#x6570;&#x636E;</span></span><br><span class="line">                    tv_name.setText(tv_name.getTag().toString());<span class="comment">//&#x76F4;&#x63A5;&#x4ECE;Tag&#x4E2D;&#x53D6;&#x51FA;&#x6211;&#x4EEC;&#x5B58;&#x50A8;&#x7684;&#x6570;&#x636E;name&#x5E76;&#x4E14;&#x8D4B;&#x503C;</span></span><br><span class="line">                    tv_name.setTag(<span class="literal">null</span>);<span class="comment">//&#x8BBE;&#x7F6E;&#x4E3A;&#x5DF2;&#x52A0;&#x8F7D;&#x8FC7;&#x6570;&#x636E;</span></span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!iv_show.getTag().equals(<span class="string">&quot;1&quot;</span>)){<span class="comment">//!=&quot;1&quot;&#x8BF4;&#x660E;&#x9700;&#x8981;&#x52A0;&#x8F7D;&#x6570;&#x636E;</span></span><br><span class="line">                    String image_url=iv_show.getTag().toString();<span class="comment">//&#x76F4;&#x63A5;&#x4ECE;Tag&#x4E2D;&#x53D6;&#x51FA;&#x6211;&#x4EEC;&#x5B58;&#x50A8;&#x7684;&#x6570;&#x636E;image&#x2014;&#x2014;url</span></span><br><span class="line">                    ImageLoader.getInstance().displayImage(image_url, iv_show);<span class="comment">//&#x663E;&#x793A;&#x56FE;&#x7247;</span></span><br><span class="line">                    iv_show.setTag(<span class="string">&quot;1&quot;</span>);<span class="comment">//&#x8BBE;&#x7F6E;&#x4E3A;&#x5DF2;&#x52A0;&#x8F7D;&#x8FC7;&#x6570;&#x636E;</span></span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">case</span> AbsListView.OnScrollListener.<span class="string">SCROLL_STATE_FLING:</span><span class="comment">//&#x6EDA;&#x52A8;&#x505A;&#x51FA;&#x4E86;&#x629B;&#x7684;&#x52A8;&#x4F5C;</span></span><br><span class="line">        {</span><br><span class="line">            <span class="comment">//&#x8BBE;&#x7F6E;&#x4E3A;&#x6B63;&#x5728;&#x6EDA;&#x52A8;</span></span><br><span class="line">            myAdapter.setScrollState(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">case</span> AbsListView.OnScrollListener.<span class="string">SCROLL_STATE_TOUCH_SCROLL:</span><span class="comment">//&#x6B63;&#x5728;&#x6EDA;&#x52A8;</span></span><br><span class="line">        {</span><br><span class="line">            <span class="comment">//&#x8BBE;&#x7F6E;&#x4E3A;&#x6B63;&#x5728;&#x6EDA;&#x52A8;</span></span><br><span class="line">            myAdapter.setScrollState(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5C40;&#x90E8;&#x66F4;&#x65B0;&#xFF1A;<br><a href="http://blog.csdn.net/nupt123456789/article/details/39432781" target="_blank" rel="external">http://blog.csdn.net/nupt123456789/article/details/39432781</a><br><a href="http://www.cnblogs.com/liuling/p/2015-10-20-01.html" target="_blank" rel="external">http://www.cnblogs.com/liuling/p/2015-10-20-01.html</a><br><figure class="highlight fortran"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> void updateProgressPartly(<span class="built_in">int</span> progress,<span class="built_in">int</span> <span class="keyword">position</span>){</span><br><span class="line">    <span class="built_in">int</span> firstVisiblePosition = listview.getFirstVisiblePosition();</span><br><span class="line">    <span class="built_in">int</span> lastVisiblePosition = listview.getLastVisiblePosition();</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">position</span>&gt;=firstVisiblePosition &amp;&amp; <span class="keyword">position</span>&lt;=lastVisiblePosition){</span><br><span class="line">        View view = listview.getChildAt(<span class="keyword">position</span> - firstVisiblePosition);</span><br><span class="line">        <span class="keyword">if</span>(view.getTag() instanceof ViewHolder){</span><br><span class="line">            ViewHolder vh = (ViewHolder)view.getTag();</span><br><span class="line">            vh.pb.setProgress(progress);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x603B;&#x7ED3;&#x4E00;&#x4E0B;&#xFF1A;</p>
<p>&#x5176;&#x5B9E;ListView&#x4F18;&#x5316;&#x7684;&#x6700;&#x6839;&#x672C;&#x9014;&#x5F84;&#x5728;&#x4E8E;getView&#x65B9;&#x6CD5;&#x7684;&#x4F18;&#x5316;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x4F18;&#x5316;&#x5C31;&#x9700;&#x8981;&#x5C06;&#x4E00;&#x5207;&#x8017;&#x65F6;&#x7684;&#x64CD;&#x4F5C;&#x4ECE;getView&#x4E2D;&#x62BD;&#x79BB;&#xFF0C;&#x6BD4;&#x5982;&#x56FE;&#x7247;&#x52A0;&#x8F7D;&#xFF0C;&#x7F51;&#x7EDC;&#x6570;&#x636E;&#x52A0;&#x8F7D;&#xFF0C;&#x6587;&#x4EF6;&#x52A0;&#x8F7D;&#x3002;<br>&#x56E0;&#x6B64;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5982;&#x4E0B;&#x51E0;&#x79CD;&#x9014;&#x5F84;&#x6765;&#x4F18;&#x5316;&#xFF1A;</p>
<ol>
<li>&#x542F;&#x52A8;&#x7EBF;&#x7A0B;&#x6765;&#x5F02;&#x6B65;&#x52A0;&#x8F7D;&#x56FE;&#x7247;&#xFF0C;&#x5728;&#x56FE;&#x7247;&#x5C1A;&#x672A;&#x52A0;&#x8F7D;&#x5B8C;&#x6210;&#x4E4B;&#x524D;&#x5148;&#x7528;&#x7A7A;&#x767D;&#x56FE;&#x7247;&#x5360;&#x4F4D;</li>
<li>&#x6ED1;&#x52A8;&#x65F6;&#x4E0D;&#x52A0;&#x8F7D;&#x56FE;&#x7247;&#xFF0C;&#x505C;&#x6B62;&#x6ED1;&#x52A8;&#x65F6;&#x52A0;&#x8F7D;</li>
<li>&#x4F7F;&#x7528;&#x7F13;&#x5B58;&#x673A;&#x5236;&#x5C06;&#x5176;&#x7F13;&#x5B58;&#x5230;&#x5185;&#x5B58;&#x4E2D;&#xFF08;&#x6CE8;&#x610F;&#x4F7F;&#x7528;&#x5F31;&#x5F15;&#x7528;&#xFF09;</li>
<li>&#x5C40;&#x90E8;&#x5237;&#x65B0;</li>
<li>Item&#x4E2D;&#x7684;&#x63A7;&#x4EF6;&#x5BBD;&#x9AD8;&#x5C3D;&#x91CF;&#x5199;&#x6210;&#x56FA;&#x5B9A;&#x7684;&#x503C;&#x6216;&#x8005;math_parent&#xFF0C;&#x907F;&#x514D;&#x5F71;&#x54CD;&#x5176;&#x4ED6;&#x63A7;&#x4EF6;&#x7684;&#x4F4D;&#x7F6E;&#x5BFC;&#x81F4;&#x91CD;&#x65B0;&#x7ED8;&#x5236;</li>
<li>&#x51CF;&#x5C11;&#x5E03;&#x5C40;&#x5C42;&#x6B21;&#xFF0C;&#x7F29;&#x77ED;&#x7ED8;&#x5236;&#x65F6;&#x95F4;&#x3002;&#x614E;&#x7528; layout_weight &#x7C7B;&#x4F3C;&#x5C5E;&#x6027;&#xFF0C;&#x4EE5;&#x4FBF;&#x7F29;&#x77ED;&#x5E03;&#x5C40;&#x7684; Measure &#x65F6;&#x95F4;&#x3002;</li>
<li>&#x4F7F;&#x7528;RecyclerView&#xFF0C;RecyclerView&#x63D0;&#x4F9B;&#x4E86;&#x539F;&#x751F;&#x7684;&#x5C40;&#x90E8;&#x5237;&#x65B0;&#x529F;&#x80FD;</li>
<li>&#x5728;&#x52A0;&#x8F7D;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4E3A;ImageView&#x8BBE;&#x7F6E;&#x4E00;&#x4E2A;Tag&#xFF0C;&#x6BD4;&#x5982;imageView.setTag(image_url),&#x4E0B;&#x4E00;&#x6B21;&#x518D;&#x52A0;&#x8F7D;&#x4E4B;&#x524D;&#xFF0C;&#x9996;&#x5148;&#x83B7;&#x53D6;Tag&#xFF0C;&#x6BD4;&#x5982;imageUrl = imageView.getTag(),&#x5982;&#x679C;&#x6B64;&#x65F6;&#x7684;&#x5730;&#x5740;&#x548C;&#x4E4B;&#x524D;&#x7684;&#x5730;&#x5740;&#x4E00;&#x6837;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x4E0D;&#x9700;&#x8981;&#x52A0;&#x8F7D;&#x4E86;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x518D;&#x52A0;&#x8F7D;&#x3002;</li>
</ol>
<p>&#x6700;&#x540E;&#x662F;&#x4E4B;&#x524D;&#x5F00;&#x53D1;&#x4E2D;&#x9047;&#x5230;&#x7684;&#x4E24;&#x79CD;ListView&#x9519;&#x4F4D;&#x7684;&#x95EE;&#x9898;&#xFF1A;<br>&#x4E0B;&#x9762;&#x662F;&#x5F53;&#x65F6;&#x7684;&#x53C2;&#x8003;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#xFF0C;&#x540E;&#x7EED;&#x6709;&#x7A7A;&#x7684;&#x65F6;&#x5019;&#x518D;&#x5BF9;&#x8FD9;&#x90E8;&#x5206;&#x8FDB;&#x884C;&#x4E13;&#x95E8;&#x603B;&#x7ED3;&#xFF1A;<br><a href="http://www.cnblogs.com/lesliefang/p/3619223.html" target="_blank" rel="external">http://www.cnblogs.com/lesliefang/p/3619223.html</a><br><a href="http://www.runoob.com/w3cnote/android-tutorial-listview-checkbox.html" target="_blank" rel="external">http://www.runoob.com/w3cnote/android-tutorial-listview-checkbox.html</a><br><a href="http://www.trinea.cn/android/android-listview-display-error-image-when-scroll/" target="_blank" rel="external">http://www.trinea.cn/android/android-listview-display-error-image-when-scroll/</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android-源码分析/">Android 源码分析</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/AOSP-源码/">AOSP 源码</a>
  </div>

</div>



<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/07/27/Android-源码分析之ListView/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/07/27/Android-源码分析之ListView/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/07/26/Android-进阶之软引用和弱引用/" title="Android 进阶之软引用和弱引用" itemprop="url">Android 进阶之软引用和弱引用</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Edgar" target="_blank" itemprop="author">Edgar</a>
		
  <p class="article-time">
    <time datetime="2016-07-26T02:56:36.000Z" itemprop="datePublished"> 發表於 2016-07-26</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h4 id="&#x4E09;&#x79CD;&#x5F15;&#x7528;&#x5BF9;&#x6BD4;"><a href="#&#x4E09;&#x79CD;&#x5F15;&#x7528;&#x5BF9;&#x6BD4;" class="headerlink" title="&#x4E09;&#x79CD;&#x5F15;&#x7528;&#x5BF9;&#x6BD4;"></a>&#x4E09;&#x79CD;&#x5F15;&#x7528;&#x5BF9;&#x6BD4;</h4><table>
<thead>
<tr>
<th>&#x5F15;&#x7528;&#x7C7B;&#x578B;</th>
<th>&#x56DE;&#x6536;&#x65F6;&#x671F;</th>
</tr>
</thead>
<tbody>
<tr>
<td>&#x5F3A;&#x5F15;&#x7528;</td>
<td>&#x5F53;&#x4EE3;&#x7801;&#x4E2D;&#x663E;&#x793A;&#x6807;&#x793A;&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#x4E0D;&#x4F7F;&#x7528;&#x7684;&#x65F6;&#x5019;</td>
</tr>
<tr>
<td>&#x8F6F;&#x5F15;&#x7528;</td>
<td>&#x5185;&#x5B58;&#x4E0D;&#x8DB3;&#x7684;&#x65F6;&#x5019;</td>
</tr>
<tr>
<td>&#x5F31;&#x5F15;&#x7528;</td>
<td>&#x4E0D;&#x7BA1;&#x5185;&#x5B58;&#x662F;&#x5426;&#x5145;&#x8DB3;&#xFF0C;&#x53EA;&#x8981;&#x6267;&#x884C;gc&#x7684;&#x65F6;&#x5019;&#x5C31;&#x6709;&#x53EF;&#x80FD;&#x88AB;&#x56DE;&#x6536;</td>
</tr>
</tbody>
</table>
<p>&#x901A;&#x8FC7;&#x4E0A;&#x9762;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x9664;&#x4E86;&#x5F3A;&#x5F15;&#x7528;&#x5916;&#x5176;&#x4ED6;&#x4E24;&#x79CD;&#x5F15;&#x7528;&#x5728;&#x4F7F;&#x7528;&#x7684;&#x65F6;&#x5019;&#x90FD;&#x9700;&#x8981;&#x5224;&#x65AD;&#x662F;&#x5426;&#x88AB;&#x56DE;&#x6536;&#x3002;</p>
<h4 id="&#x8F6F;&#x5F15;&#x7528;&#x548C;&#x5F31;&#x5F15;&#x7528;&#x7684;&#x4F7F;&#x7528;&#x573A;&#x666F;&#x4E0A;&#x7684;&#x533A;&#x522B;&#xFF1A;"><a href="#&#x8F6F;&#x5F15;&#x7528;&#x548C;&#x5F31;&#x5F15;&#x7528;&#x7684;&#x4F7F;&#x7528;&#x573A;&#x666F;&#x4E0A;&#x7684;&#x533A;&#x522B;&#xFF1A;" class="headerlink" title="&#x8F6F;&#x5F15;&#x7528;&#x548C;&#x5F31;&#x5F15;&#x7528;&#x7684;&#x4F7F;&#x7528;&#x573A;&#x666F;&#x4E0A;&#x7684;&#x533A;&#x522B;&#xFF1A;"></a>&#x8F6F;&#x5F15;&#x7528;&#x548C;&#x5F31;&#x5F15;&#x7528;&#x7684;&#x4F7F;&#x7528;&#x573A;&#x666F;&#x4E0A;&#x7684;&#x533A;&#x522B;&#xFF1A;</h4><p>&#x5982;&#x679C;&#x53EA;&#x662F;&#x60F3;&#x907F;&#x514D;OutOfMemory&#x5F02;&#x5E38;&#x7684;&#x53D1;&#x751F;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x8F6F;&#x5F15;&#x7528;&#x3002;&#x5982;&#x679C;&#x5BF9;&#x4E8E;&#x5E94;&#x7528;&#x7684;&#x6027;&#x80FD;&#x66F4;&#x5728;&#x610F;&#xFF0C;&#x60F3;&#x5C3D;&#x5FEB;&#x56DE;&#x6536;&#x4E00;&#x4E9B;&#x5360;&#x7528;&#x5185;&#x5B58;&#x6BD4;&#x8F83;&#x5927;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x5F31;&#x5F15;&#x7528;&#x3002;<br>&#x53E6;&#x5916;&#x53EF;&#x4EE5;&#x6839;&#x636E;&#x5BF9;&#x8C61;&#x662F;&#x5426;&#x7ECF;&#x5E38;&#x4F7F;&#x7528;&#x6765;&#x5224;&#x65AD;&#x9009;&#x62E9;&#x8F6F;&#x5F15;&#x7528;&#x8FD8;&#x662F;&#x5F31;&#x5F15;&#x7528;&#x3002;&#x5982;&#x679C;&#x8BE5;&#x5BF9;&#x8C61;&#x53EF;&#x80FD;&#x4F1A;&#x7ECF;&#x5E38;&#x4F7F;&#x7528;&#x7684;&#xFF0C;&#x5C31;&#x5C3D;&#x91CF;&#x7528;&#x8F6F;&#x5F15;&#x7528;&#x3002;&#x5982;&#x679C;&#x8BE5;&#x5BF9;&#x8C61;&#x4E0D;&#x88AB;&#x4F7F;&#x7528;&#x7684;&#x53EF;&#x80FD;&#x6027;&#x66F4;&#x5927;&#x4E9B;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x7528;&#x5F31;&#x5F15;&#x7528;&#x3002;</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android进阶/">Android进阶</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/编程技巧/">编程技巧</a>
  </div>

</div>



<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/07/26/Android-进阶之软引用和弱引用/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/07/26/Android-进阶之软引用和弱引用/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/07/25/Android-进阶之加快启动速度/" title="Android 进阶之加快启动速度" itemprop="url">Android 进阶之加快启动速度</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Edgar" target="_blank" itemprop="author">Edgar</a>
		
  <p class="article-time">
    <time datetime="2016-07-25T03:10:48.000Z" itemprop="datePublished"> 發表於 2016-07-25</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h4 id="&#x4E24;&#x79CD;&#x542F;&#x52A8;&#x65B9;&#x5F0F;"><a href="#&#x4E24;&#x79CD;&#x542F;&#x52A8;&#x65B9;&#x5F0F;" class="headerlink" title="&#x4E24;&#x79CD;&#x542F;&#x52A8;&#x65B9;&#x5F0F;"></a>&#x4E24;&#x79CD;&#x542F;&#x52A8;&#x65B9;&#x5F0F;</h4><p>&#x5728;Android&#x7CFB;&#x7EDF;&#x4E2D;&#x6709;&#x4E24;&#x79CD;&#x542F;&#x52A8;&#x65B9;&#x5F0F;&#x5206;&#x522B;&#x4E3A;&#x51B7;&#x542F;&#x52A8;&#x548C;&#x70ED;&#x542F;&#x52A8;&#xFF0C;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<ul>
<li>&#x51B7;&#x542F;&#x52A8;&#xFF1A;&#x51B7;&#x542F;&#x52A8;&#x5C31;&#x662F;&#x901A;&#x8FC7;&#x70B9;&#x51FB;&#x684C;&#x9762;&#x56FE;&#x6807;&#x542F;&#x52A8;&#x5E94;&#x7528;&#xFF0C;&#x8FD9;&#x79CD;&#x542F;&#x52A8;&#x65B9;&#x5F0F;&#x7531;&#x4E8E;&#x540E;&#x53F0;&#x6CA1;&#x6709;&#x8BE5;&#x5E94;&#x7528;&#x7684;&#x8FDB;&#x7A0B;&#xFF0C;&#x7CFB;&#x7EDF;&#x4F1A;&#x4ECE;Zygote&#x8FDB;&#x7A0B;&#x4E2D;fork&#x521B;&#x5EFA;&#x51FA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x8FDB;&#x7A0B;&#x5206;&#x914D;&#x7ED9;&#x8BE5;&#x5E94;&#x7528;&#xFF0C;&#x4E4B;&#x540E;&#x4F1A;&#x4F9D;&#x6B21;&#x521B;&#x5EFA;&#x548C;&#x521D;&#x59CB;&#x5316;Application&#x7C7B;&#x3001;&#x521B;&#x5EFA;MainActivity&#x7C7B;&#x3001;&#x52A0;&#x8F7D;&#x4E3B;&#x9898;&#x6837;&#x5F0F;Theme&#x4E2D;&#x7684;windowBackground&#x7B49;&#x5C5E;&#x6027;&#x8BBE;&#x7F6E;&#x7ED9;MainActivity&#x4EE5;&#x53CA;&#x914D;&#x7F6E;Activity&#x5C42;&#x7EA7;&#x4E0A;&#x7684;&#x4E00;&#x4E9B;&#x5C5E;&#x6027;&#x3001;&#x518D;inflate&#x5E03;&#x5C40;&#x3001;&#x5F53;onCreate/onStart/onResume&#x65B9;&#x6CD5;&#x90FD;&#x8D70;&#x5B8C;&#x4E86;&#x540E;&#x6700;&#x540E;&#x624D;&#x8FDB;&#x884C;contentView&#x7684;measure/layout/draw&#x663E;&#x793A;&#x5728;&#x754C;&#x9762;&#x4E0A;&#x3002;<br>&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</li>
</ul>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">Application&#x6784;&#x9020; &#x2014;&#x2014;&gt; <span class="function"><span class="title">attachBaseContext</span><span class="params">()</span></span>&#x2014;&#x2014;&gt;<span class="function"><span class="title">onCreate</span><span class="params">()</span></span>&#x2014;&#x2014;&gt;Activity&#x7684;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x2014;&#x2014;&gt;<span class="function"><span class="title">onCreate</span><span class="params">()</span></span>&#x2014;&#x2014;&gt;&#x914D;&#x7F6E;&#x4E3B;&#x9898;&#x4E2D;&#x80CC;&#x666F;&#x7B49;&#x5C5E;&#x6027;&#x2014;&#x2014;&gt;<span class="function"><span class="title">onStart</span><span class="params">()</span></span>&#x2014;&#x2014;&gt;<span class="function"><span class="title">onResume</span><span class="params">()</span></span>&#x2014;&#x2014;&gt;&#x6D4B;&#x91CF;&#x5E03;&#x5C40;&#x7ED8;&#x5236;&#x663E;&#x793A;&#x5728;&#x754C;&#x9762;&#x4E0A;&#x3002;</span><br></pre></td></tr></table></figure>
<ul>
<li>&#x70ED;&#x542F;&#x52A8;&#xFF1A;&#x5F53;&#x542F;&#x52A8;&#x5E94;&#x7528;&#x65F6;&#xFF0C;&#x540E;&#x53F0;&#x5DF2;&#x6709;&#x8BE5;&#x5E94;&#x7528;&#x7684;&#x8FDB;&#x7A0B;&#xFF0C;&#x6240;&#x4EE5;&#x5728;&#x5DF2;&#x6709;&#x8FDB;&#x7A0B;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x8FD9;&#x79CD;&#x542F;&#x52A8;&#x4F1A;&#x4ECE;&#x5DF2;&#x6709;&#x7684;&#x8FDB;&#x7A0B;&#x4E2D;&#x6765;&#x542F;&#x52A8;&#x5E94;&#x7528;&#xFF0C;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x53EB;&#x70ED;&#x542F;&#x52A8;&#x3002;&#x70ED;&#x542F;&#x52A8;&#x56E0;&#x4E3A;&#x4F1A;&#x4ECE;&#x5DF2;&#x6709;&#x7684;&#x8FDB;&#x7A0B;&#x4E2D;&#x6765;&#x542F;&#x52A8;&#xFF0C;&#x6240;&#x4EE5;&#x70ED;&#x542F;&#x52A8;&#x5C31;&#x4E0D;&#x4F1A;&#x8D70;Application&#x8FD9;&#x6B65;&#x4E86;&#xFF0C;&#x800C;&#x662F;&#x76F4;&#x63A5;&#x8D70;MainActivity&#xFF08;&#x5305;&#x62EC;&#x4E00;&#x7CFB;&#x5217;&#x7684;&#x6D4B;&#x91CF;&#x3001;&#x5E03;&#x5C40;&#x3001;&#x7ED8;&#x5236;&#xFF09;&#xFF0C;&#x6240;&#x4EE5;&#x70ED;&#x542F;&#x52A8;&#x7684;&#x8FC7;&#x7A0B;&#x53EA;&#x9700;&#x8981;&#x521B;&#x5EFA;&#x548C;&#x521D;&#x59CB;&#x5316;&#x4E00;&#x4E2A;MainActivity&#x5C31;&#x884C;&#x4E86;&#xFF0C;&#x800C;&#x4E0D;&#x5FC5;&#x521B;&#x5EFA;&#x548C;&#x521D;&#x59CB;&#x5316;Application&#xFF0C;&#x56E0;&#x4E3A;&#x4E00;&#x4E2A;&#x5E94;&#x7528;&#x4ECE;&#x65B0;&#x8FDB;&#x7A0B;&#x7684;&#x521B;&#x5EFA;&#x5230;&#x8FDB;&#x7A0B;&#x7684;&#x9500;&#x6BC1;&#xFF0C;Application&#x53EA;&#x4F1A;&#x521D;&#x59CB;&#x5316;&#x4E00;&#x6B21;&#x3002;</li>
</ul>
<h4 id="&#x542F;&#x52A8;&#x65F6;&#x95F4;&#x548C;&#x542F;&#x52A8;&#x65F6;&#x95F4;&#x7684;&#x6D4B;&#x91CF;"><a href="#&#x542F;&#x52A8;&#x65F6;&#x95F4;&#x548C;&#x542F;&#x52A8;&#x65F6;&#x95F4;&#x7684;&#x6D4B;&#x91CF;" class="headerlink" title="&#x542F;&#x52A8;&#x65F6;&#x95F4;&#x548C;&#x542F;&#x52A8;&#x65F6;&#x95F4;&#x7684;&#x6D4B;&#x91CF;"></a>&#x542F;&#x52A8;&#x65F6;&#x95F4;&#x548C;&#x542F;&#x52A8;&#x65F6;&#x95F4;&#x7684;&#x6D4B;&#x91CF;</h4><p>&#x542F;&#x52A8;&#x65F6;&#x95F4;&#x6307;&#x7684;&#x662F;&#x4ECE;&#x70B9;&#x51FB;&#x5E94;&#x7528;&#x7684;&#x542F;&#x52A8;&#x56FE;&#x6807;&#x5F00;&#x59CB;&#x76F4;&#x5230;&#x6211;&#x4EEC;&#x770B;&#x5230;&#x4E86;&#x754C;&#x9762;&#x7684;&#x7B2C;&#x4E00;&#x5E27;&#xFF0C;&#x8FD9;&#x6BB5;&#x65F6;&#x95F4;&#x5C31;&#x662F;&#x5E94;&#x7528;&#x7684;&#x542F;&#x52A8;&#x65F6;&#x95F4;&#x3002;&#x5E94;&#x7528;&#x542F;&#x52A8;&#x65F6;&#x95F4;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5982;&#x4E0B;&#x65B9;&#x5F0F;&#x8FDB;&#x884C;&#x6D4B;&#x91CF;&#xFF1A;</p>
<figure class="highlight accesslog"><table><tr><td class="code"><pre><span class="line">adb shell am start -W <span class="string">[packageName]</span>/<span class="string">[packageName.MainActivity]</span></span><br></pre></td></tr></table></figure>
<h4 id="&#x51CF;&#x5C0F;&#x5E94;&#x7528;&#x542F;&#x52A8;&#x65F6;&#x95F4;&#x7684;&#x65B9;&#x6CD5;"><a href="#&#x51CF;&#x5C0F;&#x5E94;&#x7528;&#x542F;&#x52A8;&#x65F6;&#x95F4;&#x7684;&#x65B9;&#x6CD5;" class="headerlink" title="&#x51CF;&#x5C0F;&#x5E94;&#x7528;&#x542F;&#x52A8;&#x65F6;&#x95F4;&#x7684;&#x65B9;&#x6CD5;"></a>&#x51CF;&#x5C0F;&#x5E94;&#x7528;&#x542F;&#x52A8;&#x65F6;&#x95F4;&#x7684;&#x65B9;&#x6CD5;</h4><ul>
<li>&#x5728;Application&#x7684;onCreate()&#x65B9;&#x6CD5;&#x4E2D;&#x4E0D;&#x8981;&#x8FDB;&#x884C;&#x8017;&#x65F6;&#x64CD;&#x4F5C;&#x7684;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x5C3D;&#x91CF;&#x5C06;&#x8017;&#x65F6;&#x95F4;&#x64CD;&#x4F5C;&#x653E;&#x5728;&#x540E;&#x53F0;&#x7EBF;&#x7A0B;&#x5F02;&#x6B65;&#x5904;&#x7406;&#x3002;</li>
<li>&#x5BF9;&#x4E8E;MainActivity&#xFF0C;&#x7531;&#x4E8E;&#x5728;&#x83B7;&#x53D6;&#x5230;&#x7B2C;&#x4E00;&#x5E27;&#x524D;&#xFF0C;&#x9700;&#x8981;&#x5BF9;&#x5E03;&#x5C40;&#x8FDB;&#x884C;&#x6D4B;&#x91CF;&#x7ED8;&#x5236;&#x64CD;&#x4F5C;&#x6240;&#x4EE5;&#x5C3D;&#x91CF;&#x51CF;&#x5C11;&#x5E03;&#x5C40;&#x7684;&#x5C42;&#x6B21;&#xFF0C;&#x4EE5;&#x53CA;&#x91C7;&#x7528;ViewStab&#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#x7B56;&#x7565;&#xFF0C;&#x5E76;&#x5728;onCreate&#x3001;onStart&#x3001;onResume&#x65B9;&#x6CD5;&#x4E2D;&#x907F;&#x514D;&#x505A;&#x8017;&#x65F6;&#x64CD;&#x4F5C;&#x3002;</li>
<li>&#x7531;&#x4E8E;&#x5728;&#x51B7;&#x542F;&#x52A8;&#x65F6;&#x523B;&#xFF0C;WindowManager&#x4F1A;&#x5148;&#x52A0;&#x8F7D;app&#x4E3B;&#x9898;&#x6837;&#x5F0F;&#x4E2D;&#x7684;windowBackground&#x505A;&#x4E3A;app&#x7684;&#x9884;&#x89C8;&#x5143;&#x7D20;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x771F;&#x6B63;&#x53BB;&#x52A0;&#x8F7D;activity&#x7684;layout&#x5E03;&#x5C40;&#xFF0C;&#x6240;&#x4EE5;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x7ED9;windowBackground&#x8BBE;&#x7F6E;&#x4E00;&#x4E2A;&#x56FE;&#x7247;&#x5728;&#x89C6;&#x89C9;&#x4E0A;&#x6765;&#x9A97;&#x8FC7;&#x7528;&#x6237;</li>
</ul>
<p>&#x63A8;&#x8350;&#x4F7F;&#x7528;&#x5982;&#x4E0B;&#x7684;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#xFF0C;&#x6211;&#x8FD9;&#x8FB9;&#x5C1D;&#x8BD5;&#x4E86;&#x4E0B;&#x8FD8;&#x662F;&#x6709;&#x6548;&#x679C;&#x7684;&#xFF0C;&#x4F46;&#x662F;&#x5982;&#x679C;&#x672C;&#x8EAB;&#x5E94;&#x7528;&#x5728;&#x8FD9;&#x6BB5;&#x65F6;&#x95F4;&#x5982;&#x679C;&#x5C31;&#x6CA1;&#x5904;&#x7406;&#x4EC0;&#x4E48;&#x4E8B;&#x60C5;&#xFF0C;&#x5C31;&#x6BD4;&#x8F83;&#x96BE;&#x770B;&#x51FA;&#x8FD9;&#x4E2A;&#x6548;&#x679C;&#x4E86;&#xFF1A;<br><a href="https://github.com/DreaminginCodeZH/MaterialColdStart" target="_blank" rel="external">https://github.com/DreaminginCodeZH/MaterialColdStart</a></p>
<p>&#x82F1;&#x6587;&#x4E0D;&#x597D;&#x7684;&#x53EF;&#x4EE5;&#x770B;&#x4E0B;&#x4E0B;&#x9762;&#x8FD9;&#x7BC7;&#x535A;&#x5BA2;&#xFF1A;<br><a href="http://blog.csdn.net/ccsutofly/article/details/49990939" target="_blank" rel="external">http://blog.csdn.net/ccsutofly/article/details/49990939</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android进阶/">Android进阶</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Android性能优化/">Android性能优化</a>
  </div>

</div>



<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/07/25/Android-进阶之加快启动速度/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/07/25/Android-进阶之加快启动速度/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/07/25/Android进阶之Assets-目录与res目录的使用的区别/" title="Android-进阶之Assets 目录与res目录的使用的区别" itemprop="url">Android-进阶之Assets 目录与res目录的使用的区别</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Edgar" target="_blank" itemprop="author">Edgar</a>
		
  <p class="article-time">
    <time datetime="2016-07-25T02:52:26.000Z" itemprop="datePublished"> 發表於 2016-07-25</time>
    
  </p>
</header>
    <div class="article-content">
        
        <table>
<thead>
<tr>
<th>&#x5BF9;&#x6BD4;&#x9879;</th>
<th>assets</th>
<th>res/raw</th>
<th>res/drawable</th>
</tr>
</thead>
<tbody>
<tr>
<td>&#x83B7;&#x53D6;&#x8D44;&#x6E90;&#x65B9;&#x5F0F;</td>
<td>&#x8DEF;&#x5F84;+&#x6587;&#x4EF6;&#x540D;&#xFF08;&#x8FD9;&#x91CC;&#x7684;&#x8DEF;&#x5F84;&#x662F;&#x76F8;&#x5BF9;&#x4E8E;assets&#x7684;&#x8DEF;&#x5F84;&#xFF09;</td>
<td>R.raw.xxx</td>
<td>R.drawable.xxx</td>
</tr>
<tr>
<td>&#x662F;&#x5426;&#x88AB;&#x538B;&#x7F29;</td>
<td>NO</td>
<td>NO</td>
<td>YES</td>
</tr>
<tr>
<td>&#x662F;&#x5426;&#x652F;&#x6301;&#x591A;&#x7EA7;&#x5B50;&#x76EE;&#x5F55;</td>
<td>YES</td>
<td>NO</td>
<td>NO</td>
</tr>
</tbody>
</table>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android进阶/">Android进阶</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/杂类/">杂类</a>
  </div>

</div>



<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/07/25/Android进阶之Assets-目录与res目录的使用的区别/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/07/25/Android进阶之Assets-目录与res目录的使用的区别/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/"><span></span>Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="extend next" rel="next" href="/page/3/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="顯示側邊欄"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隱藏側邊欄"></a></div>
<aside class="clearfix">
<div id="authorInfo">
	
		<div class="author-img"></div>		
	
	<div class="social-info" class="clearfix">
		
		
		<a href="https://github.com/tbfungeek" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
		
		<a href="mailto:tbfungeek@163.com" target="_blank" class="icon-email" title="Email Me"></a>
		

	</div>
</div>

  
<div class="categorieslist">
	<p class="asidetitle">分類</p>
		<ul>
		
		  
			<li><a href="/categories/Android-小经验/" title="Android 小经验">Android 小经验<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android-源码分析/" title="Android 源码分析">Android 源码分析<sup>17</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android其他/" title="Android其他">Android其他<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android初步/" title="Android初步">Android初步<sup>21</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android进阶/" title="Android进阶">Android进阶<sup>100</sup></a></li>
		  
		
		  
			<li><a href="/categories/Hexo-使用/" title="Hexo 使用">Hexo 使用<sup>10</sup></a></li>
		  
		
		  
			<li><a href="/categories/OpenCV/" title="OpenCV">OpenCV<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/ROS/" title="ROS">ROS<sup>9</sup></a></li>
		  
		
		  
			<li><a href="/categories/个人收藏/" title="个人收藏">个人收藏<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/其他/" title="其他">其他<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/工作总结/" title="工作总结">工作总结<sup>1</sup></a></li>
		  
		
		  
		
		  
			<li><a href="/categories/树莓派/" title="树莓派">树莓派<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/版本控制/" title="版本控制">版本控制<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">標簽</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Android-设计模式/" title="Android 设计模式">Android 设计模式<sup>29</sup></a></li>
			
		
			
				<li><a href="/tags/Android基础/" title="Android基础">Android基础<sup>21</sup></a></li>
			
		
			
				<li><a href="/tags/AOSP-源码/" title="AOSP 源码">AOSP 源码<sup>17</sup></a></li>
			
		
			
				<li><a href="/tags/Android-常用第三方库/" title="Android 常用第三方库">Android 常用第三方库<sup>15</sup></a></li>
			
		
			
				<li><a href="/tags/Hexo-使用/" title="Hexo 使用">Hexo 使用<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/ROS/" title="ROS">ROS<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/Android-动画进阶/" title="Android 动画进阶">Android 动画进阶<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/Android性能优化/" title="Android性能优化">Android性能优化<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-绘图进阶/" title="Android 绘图进阶">Android 绘图进阶<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-JNI/" title="Android JNI">Android JNI<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/OpenCV/" title="OpenCV">OpenCV<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-自动化测试/" title="Android 自动化测试">Android 自动化测试<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-自定义View进阶/" title="Android 自定义View进阶">Android 自定义View进阶<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/树莓派/" title="树莓派">树莓派<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/重要控件/" title="重要控件">重要控件<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/工具的使用/" title="工具的使用">工具的使用<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Android质量管理工具/" title="Android质量管理工具">Android质量管理工具<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/编程技巧/" title="编程技巧">编程技巧<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Android-事件处理进阶/" title="Android 事件处理进阶">Android 事件处理进阶<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Android其他/" title="Android其他">Android其他<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">聯結</p>
    <ul>
        
          <li>
            
            	<a href="https://hexo.io" target="_blank" title="Hexo">Hexo</a>
            
          </li>
        
          <li>
            
            	<a href="https://pages.github.com/" target="_blank" title="GitHub">GitHub</a>
            
          </li>
        
          <li>
            
            	<a href="http://pf18.github.io/" target="_blank" title="PF18">PF18</a>
            
          </li>
        
          <li>
            
            	<a href="http://toutiao.io/" target="_blank" title="开发者头条">开发者头条</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.jcodecraeer.com/" target="_blank" title="泡在网上的日子">泡在网上的日子</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="atom.xml" target="_blank" title="rss">RSS 訂閱</a>
</div>

  
  <div class="tagcloudlist">
    <p class="asidetitle">標簽雲</p>
    <div class="tagcloudlist clearfix">
       <a href="/tags/AOSP-源码/" style="font-size: 18.18px;">AOSP 源码</a> <a href="/tags/Android-APK-签名/" style="font-size: 10px;">Android APK 签名</a> <a href="/tags/Android-JNI/" style="font-size: 13.64px;">Android JNI</a> <a href="/tags/Android-事件处理进阶/" style="font-size: 10.91px;">Android 事件处理进阶</a> <a href="/tags/Android-动画进阶/" style="font-size: 14.55px;">Android 动画进阶</a> <a href="/tags/Android-多线程开发/" style="font-size: 10px;">Android 多线程开发</a> <a href="/tags/Android-小经验/" style="font-size: 10px;">Android 小经验</a> <a href="/tags/Android-常用第三方库/" style="font-size: 17.27px;">Android 常用第三方库</a> <a href="/tags/Android-开发流程/" style="font-size: 10px;">Android 开发流程</a> <a href="/tags/Android-绘图进阶/" style="font-size: 13.64px;">Android 绘图进阶</a> <a href="/tags/Android-自动化测试/" style="font-size: 13.64px;">Android 自动化测试</a> <a href="/tags/Android-自定义View进阶/" style="font-size: 12.73px;">Android 自定义View进阶</a> <a href="/tags/Android-设计模式/" style="font-size: 20px;">Android 设计模式</a> <a href="/tags/Android其他/" style="font-size: 10px;">Android其他</a> <a href="/tags/Android基础/" style="font-size: 19.09px;">Android基础</a> <a href="/tags/Android开发流程/" style="font-size: 10px;">Android开发流程</a> <a href="/tags/Android性能优化/" style="font-size: 13.64px;">Android性能优化</a> <a href="/tags/Android混淆技术/" style="font-size: 10px;">Android混淆技术</a> <a href="/tags/Android质量管理工具/" style="font-size: 11.82px;">Android质量管理工具</a> <a href="/tags/Android逆向工程/" style="font-size: 10px;">Android逆向工程</a> <a href="/tags/Git-github/" style="font-size: 10px;">Git && github</a> <a href="/tags/Hexo-使用/" style="font-size: 16.36px;">Hexo 使用</a> <a href="/tags/Linux-使用/" style="font-size: 10px;">Linux 使用</a> <a href="/tags/OpenCV/" style="font-size: 13.64px;">OpenCV</a> <a href="/tags/ROS/" style="font-size: 15.45px;">ROS</a> <a href="/tags/工作总结/" style="font-size: 10px;">工作总结</a> <a href="/tags/工具的使用/" style="font-size: 11.82px;">工具的使用</a> <a href="/tags/杂类/" style="font-size: 10px;">杂类</a> <a href="/tags/树莓派/" style="font-size: 12.73px;">树莓派</a> <a href="/tags/编程技巧/" style="font-size: 10.91px;">编程技巧</a> <a href="/tags/网站收藏/" style="font-size: 10px;">网站收藏</a> <a href="/tags/重要控件/" style="font-size: 11.82px;">重要控件</a>
    </div>
  </div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
		
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/hsihohuang/kiddochan" target="_blank" title="Kiddochan">Kiddochan</a> © 2016 
		
		<a href="/about" target="_blank" title="Edgar">Edgar</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>










<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?bf2e977415bba8cfe0014075b580ec7b";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回頂部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
